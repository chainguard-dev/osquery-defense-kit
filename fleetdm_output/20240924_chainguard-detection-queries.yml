apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Catch DNS traffic going to machines other than the host-configured
    DNS server (event-based)
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - c2 - unexpected-dns-traffic-events
  observer_can_run: false
  platforms: ''
  query: |
    -- Catch DNS traffic going to machines other than the host-configured DNS server (event-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1071/004/ (C2: Application Layer Protocol: DNS)
    --
    -- interval: 300
    -- tags: persistent events net
    --
    -- NOTE: The interval above must match WHERE clause to avoid missing events
    --
    -- This only supports IPv4 traffic due to an osquery bug with 'dns_resolvers'
    -- The non-event version is unexpected-dns-traffic.sql
    SELECT
      protocol,
      s.remote_port,
      s.remote_address,
      s.local_port,
      s.local_address,
      s.action,
      s.status,
      p.name,
      COALESCE(REGEX_MATCH (p.path, '.*/(.*)', 1), p.path) AS basename,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      s.pid,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd,
      hash.sha256,
      CONCAT (p.name, ',', remote_address, ',', remote_port) AS exception_key
    FROM
      socket_events s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      s.time > (strftime('%s', 'now') -300)
      AND remote_port IN (53, 5353)
      AND remote_address NOT LIKE '%:%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '127.%'
      AND remote_address NOT IN (
        SELECT DISTINCT
          address
        FROM
          dns_resolvers
        WHERE
          type = 'nameserver'
          and address != ''
      )
      -- systemd-resolve sometimes shows up this way
      -- If we could narrow this down using 'sys_resolvers' I would, but it is misuse of GROUP_CONCAT
      AND NOT (
        s.pid = -1
        AND s.remote_port = 53
        and p.parent = ''
      )
      -- Some applications hard-code a safe DNS resolver, or allow the user to configure one
      AND s.remote_address NOT IN (
        '100.100.100.100', -- Tailscale Magic DNS
        '208.67.220.123', -- OpenDNS FamilyShield
        '75.75.75.75', -- Comcast
        '75.75.76.76', -- Comcast
        '68.105.28.13', -- Cox
        '80.248.7.1' -- 21st Century (NG)
      )
      -- Exceptions that specifically talk to one server
      AND exception_key NOT IN (
        'coredns,0.0.0.0,53',
        'syncthing,46.162.192.181,53',
        'Socket Process,8.8.8.8,53',
        'com.docker.backend,8.8.8.8,53',
        'ZoomPhone,8.8.8.8,53',
        'gvproxy,170.247.170.2,53',
        'CapCut,8.8.8.8,53',
        'ZaloCall,8.8.8.8,53',
        'Telegram,8.8.8.8,53',
        'com.docker.vpnkit,8.8.8.8,53',
        'WebexHelper,8.8.8.8,53',
        'Meeting Center,8.8.8.8,53',
        'ServiceExtension,8.8.8.8,53',
        'nuclei,1.0.0.1,53',
        'distnoted,8.8.8.8,53',
        'limactl,8.8.8.8,53',
        'adguard_dns,1.0.0.1,53',
        'coredns,8.8.8.8,53',
        'signal-desktop,8.8.8.8,53',
        'slack,8.8.8.8,53',
        'zed,8.8.8.8,53',
        'EpicWebHelper,8.8.4.4,53',
        'EpicWebHelper,8.8.8.8,53',
        'Signal Helper (Renderer),8.8.8.8,53',
        'plugin-container,8.8.8.8,53',
        'WhatsApp,1.1.1.1,53',
        'AssetCacheLocatorService,0.0.0.0,53'
      )
      -- Local DNS servers and custom clients go here
      AND basename NOT IN (
        'adguard_dns',
        'apk',
        'apko',
        'chrome',
        'com.apple.WebKit.Networking',
        'com.docker.backend',
        'go',
        'gvproxy',
        'IPNExtension',
        'Jabra Direct Helper',
        'limactl',
        'mDNSResponder',
        'melange',
        'nessusd',
        'nuclei',
        'systemd-resolved',
        'WhatsApp'
      )
      AND p.name NOT IN ('Jabra Direct Helper')
      -- Chromium/Electron apps seem to send stray packets out like nobodies business
      AND p.path NOT LIKE '%/%.app/Contents/MacOS/% Helper'
      -- Workaround for the GROUP_CONCAT subselect adding a blank ent
    GROUP BY
      s.remote_address,
      s.remote_port
    HAVING
      remote_address != ''
  tags: persistent, events, net
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Catch DNS traffic going to machines other than the host-configured
    DNS server (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - c2 - unexpected-dns-traffic
  observer_can_run: false
  platforms: ''
  query: |
    -- Catch DNS traffic going to machines other than the host-configured DNS server (state-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1071/004/ (C2: Application Layer Protocol: DNS)
    --
    -- tags: transient state net often dns
    --
    -- NOTE: This only supports IPv4 traffic due to an osquery bug with 'dns_resolvers'
    SELECT
      s.family,
      protocol,
      s.local_port,
      s.remote_port,
      s.local_address,
      s.remote_address,
      p.name,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      s.pid,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd,
      hash.sha256,
      GROUP_CONCAT(
        (
          SELECT DISTINCT
            address
          FROM
            dns_resolvers
          WHERE
            type = 'nameserver'
            AND address != ''
        ),
        ','
      ) AS sys_resolvers,
      CONCAT (p.name, ',', remote_address, ',', remote_port) AS exception_key
    FROM
      process_open_sockets s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      remote_port IN (53, 5353)
      AND remote_address NOT LIKE '%:%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '127.%'
      AND remote_address NOT IN (
        SELECT DISTINCT
          address
        FROM
          dns_resolvers
        WHERE
          type = 'nameserver'
          and address != ''
      )
      -- systemd-resolve sometimes shows up this way
      -- If we could narrow this down using 'sys_resolvers' I would, but it is misuse of GROUP_CONCAT
      AND NOT (
        s.pid = -1
        AND s.remote_port = 53
        and s.protocol = 17
        and p.parent = ''
      )
      -- Some applications hard-code a safe DNS resolver, or allow the user to configure one
      AND s.remote_address NOT IN (
        '1.1.1.1', -- Cloudflare
        '1.1.1.2', -- Cloudflare
        '8.8.8.8', -- Google
        '8.8.4.4', -- Google (backup)
        '208.67.222.222', -- OpenDNS
        '75.75.75.75', -- Comcast
        '68.105.28.13' -- Cox
      )
      -- Other exceptions
      AND exception_key NOT IN (
        'coredns,0.0.0.0,53',
        'nessusd,50.16.123.71,53',
        'Arc Helper,1.0.0.1,53',
        'syncthing,46.162.192.181,53'
      )
      -- Local DNS servers and custom clients go here
      AND p.path NOT IN (
        '/Applications/Evernote.app/Contents/MacOS/Evernote',
        '/Applications/Slack.app/Contents/Frameworks/Slack Helper.app/Contents/MacOS/Slack Helper',
        '/Applications/Spotify.app/Contents/Frameworks/Spotify Helper.app/Contents/MacOS/Spotify Helper',
        '/Applications/Tailscale.app/Contents/PlugIns/IPNExtension.appex/Contents/MacOS/IPNExtension',
        '/opt/podman/bin/gvproxy',
        '/System/Volumes/Preboot/Cryptexes/Incoming/OS/System/Library/Frameworks/WebKit.framework/Versions/A/XPCServices/com.apple.WebKit.Networking.xpc/Contents/MacOS/com.apple.WebKit.Networking',
        '/usr/bin/tailscaled',
        '/usr/lib/systemd/systemd-resolved',
        '/usr/sbin/mDNSResponder'
      )
      AND p.path NOT LIKE '/Applications/Google Chrome.app/Contents/Frameworks/Google Chrome Framework.framework/Versions/%/Helpers/Google Chrome Helper.app/Contents/MacOS/Google Chrome Helper'
      AND p.path NOT LIKE '%/podman/gvproxy'
      -- Workaround for the GROUP_CONCAT subselect adding a blank ent
      -- Workaround for the GROUP_CONCAT subselect adding a blank ent
    GROUP BY
      s.remote_address,
      s.remote_port
    HAVING
      remote_address != ''
  tags: transient, state, net, often, dns
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected programs communicating over HTTPS (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - c2 - unexpected-https-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Unexpected programs communicating over HTTPS (state-based)
    --
    -- This query is a bit awkward and hobbled due to the lack of osquery support
    -- for looking up binary signatures in Linux.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1071/ (C&C, Application Layer Protocol)
    --
    -- tags: transient state net often
    -- platform: linux
    SELECT
      s.remote_address,
      p.name,
      p.cgroup_path,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      pp.path AS parent_path,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd,
      s.local_address,
      s.local_port,
      s.state,
      hash.sha256,
      -- This intentionally avoids file.path, as it won't join across mount namespaces
      CONCAT (
        MIN(p.euid, 500),
        ',',
        REGEX_MATCH (p.path, '.*/(.*?)$', 1),
        ',',
        MIN(f.uid, 500),
        'u,',
        MIN(f.gid, 500),
        'g,',
        p.name
      ) AS exception_key
    FROM
      process_open_sockets s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      protocol IN (6, 17)
      AND s.remote_port = 443
      AND s.remote_address NOT IN ('127.0.0.1', '::ffff:127.0.0.1', '::1')
      AND s.remote_address NOT LIKE 'fe80:%'
      AND s.remote_address NOT LIKE '127.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '::ffff:172.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '::ffff:10.%'
      AND s.remote_address NOT LIKE 'fc00:%'
      AND p.path != ''
      AND NOT exception_key IN (
        '0,.tailscaled-wrapped,0u,0g,.tailscaled-wra',
        '0,agentbeat,0u,0g,agentbeat',
        '0,apk,u,g,apk',
        '0,applydeltarpm,0u,0g,applydeltarpm',
        '0,bash,0u,0g,bash',
        '0,bash,0u,0g,mkinitcpio',
        '0,bash,0u,0g,sh',
        '500,syft,500u,500g,syft',
        '500,krunner,0u,0g,krunner',
        '500,k9s,0u,0g,k9s',
        '0,canonical-livepatchd,0u,0g,canonical-livep',
        '0,chainctl,0u,0g,chainctl',
        '0,cmake,u,g,cmake',
        '0,containerd,u,g,containerd',
        '0,dirmngr,0u,0g,dirmngr',
        '0,dockerd,0u,0g,dockerd',
        '0,elastic-agent,0u,0g,elastic-agent',
        '0,elastic-agent,u,g,elastic-agent',
        '0,elastic-endpoint,0u,0g,elastic-endpoin',
        '0,filebeat,0u,0g,filebeat',
        '0,flatpak-system-helper,0u,0g,flatpak-system-',
        '0,git-remote-http,0u,0g,git-remote-http',
        '0,go,0u,0g,go',
        '0,gtk4-update-icon-cache,0u,0g,gtk-update-icon',
        '0,http,0u,0g,https',
        '0,ir_agent,0u,0g,ir_agent',
        '0,kmod,0u,0g,depmod',
        '0,launcher,0u,0g,launcher',
        '0,launcher,500u,500g,launcher',
        '0,ldconfig,0u,0g,ldconfig',
        '0,make,0u,0g,make',
        '0,metricbeat,0u,0g,metricbeat',
        '0,nessusd,0u,0g,nessusd',
        '0,nix,0u,0g,nix',
        '0,nix,0u,0g,nix-daemon',
        '0,orbit,0u,0g,orbit',
        '0,osqueryd,0u,0g,osqueryd',
        '0,packagekitd,0u,0g,packagekitd',
        '0,packetbeat,0u,0g,packetbeat',
        '0,pacman,0u,0g,pacman',
        '0,rapid7_endpoint_broker,0u,0g,rapid7_endpoint',
        '0,rpi-imager,0u,0g,rpi-imager',
        '0,snapd,0u,0g,snapd',
        '0,systemctl,0u,0g,systemctl',
        '0,tailscaled,0u,0g,tailscaled',
        '0,tailscaled,500u,500g,tailscaled',
        '0,velociraptor,0u,0g,velociraptor_cl',
        '0,yay,0u,0g,yay',
        '105,http,0u,0g,https',
        '106,geoclue,0u,0g,geoclue',
        '115,geoclue,0u,0g,geoclue',
        '120,fwupdmgr,0u,0g,fwupdmgr',
        '128,fwupdmgr,0u,0g,fwupdmgr',
        '129,fwupdmgr,0u,0g,fwupdmgr',
        '42,http,0u,0g,https',
        '500,1password,0u,0g,1password',
        '500,Brackets,0u,0g,Brackets',
        '500,Discord,0u,0g,Discord',
        '500,Discord,u,g,Discord',
        '500,Docker Desktop,0u,0g,Docker Desktop',
        '500,Keybase,0u,0g,Keybase',
        '500,Logseq,u,g,Logseq',
        '500,Melvor Idle,500u,500g,exe',
        '500,TJPP8_Vulkan,500u,500g,TJPP8_Vulkan',
        '500,WPILibInstaller,500u,500g,WPILibInstaller',
        '500,WebKitNetworkProcess,0u,0g,WebKitNetworkPr',
        '500,___go_build_main_go,500u,500g,___go_build_mai',
        '500,abrt-action-generate-core-backtrace,0u,0g,abrt-action-gen',
        '500,accountwizard,u,g,accountwizard',
        '500,act,0u,0g,act',
        '500,apk,500u,500g,apk',
        '500,apk,u,g,apk',
        '500,apko,500u,500g,apko',
        '500,apko,u,g,apko',
        '500,armcord,u,g,armcord',
        '500,aws,0u,0g,aws',
        '500,aws,500u,500g,aws',
        '500,bash,0u,0g,bash',
        '500,beeper,u,g,beeper',
        '500,bitwarden,u,g,bitwarden',
        '500,bom,500u,500g,bom',
        '500,bom-linux-amd64,500u,500g,bom-linux-amd64',
        '500,brave,0u,0g,brave',
        '500,buildkitd,500u,500g,buildkitd',
        '500,buildkite-agent,500u,500g,buildkite-agent',
        '500,cargo,0u,0g,cargo',
        '500,cargo,500u,500g,cargo',
        '500,cargo,u,g,cargo',
        '500,chainctl,0u,0g,chainctl',
        '500,chainctl,500u,100g,chainctl',
        '500,chainctl,500u,493g,chainctl',
        '500,chainctl,500u,500g,chainctl',
        '500,chainctl,500u,500g,docker-credenti',
        '500,chrome,0u,0g,chrome',
        '500,chrome,u,g,chrome',
        '500,chrome_crashpad_handler,0u,0g,chrome_crashpad',
        '500,cilium,500u,123g,cilium',
        '500,cloud_sql_proxy,0u,0g,cloud_sql_proxy',
        '500,code,0u,0g,code',
        '500,code,500u,500g,code',
        '500,code,u,g,code',
        '500,code-oss,u,g,code-oss',
        '500,com.docker.backend,0u,0g,com.docker.back',
        '500,com.docker.extensions,0u,0g,com.docker.exte',
        '500,containerd,u,g,containerd',
        '500,copilot-agent-linux,500u,500g,copilot-agent-l',
        '500,copy-from-gs,500u,500g,copy-from-gs',
        '500,cosign,500u,500g,cosign',
        '500,cosign-linux-amd64,0u,0g,cosign',
        '500,crane,0u,0g,crane',
        '500,crane,500u,500g,crane',
        '500,curl,0u,0g,curl',
        '500,deno,500u,500g,deno',
        '500,docker,0u,0g,docker',
        '500,docker-buildx,0u,0g,docker-buildx',
        '500,drkonqi,0u,0g,drkonqi',
        '500,eksctl,0u,0g,eksctl',
        '500,eksctl,500u,500g,eksctl',
        '500,electron,0u,0g,electron',
        '500,evolution-addressbook-factory,0u,0g,evolution-addre',
        '500,evolution-calendar-factory,0u,0g,evolution-calen',
        '500,evolution-source-registry,0u,0g,evolution-sourc',
        '500,extension-manager,0u,0g,extension-manag',
        '500,firefox,0u,0g,.firefox-wrappe',
        '500,firefox,0u,0g,Socket Process',
        '500,firefox,0u,0g,firefox',
        '500,firefox-bin,500u,500g,firefox-bin',
        '500,firefox-bin,u,g,firefox-bin',
        '500,flameshot,0u,0g,flameshot',
        '500,flatpak,0u,0g,flatpak',
        '500,flatpak-oci-authenticator,0u,0g,flatpak-oci-aut',
        '500,flux,500u,500g,flux',
        '500,fulcio,500u,500g,fulcio',
        '500,gcsfuse,500u,500g,gcsfuse',
        '500,gdb,0u,0g,gdb',
        '500,geoclue,0u,0g,geoclue',
        '500,gh,0u,0g,gh',
        '500,gh-dash,500u,500g,gh-dash',
        '500,git,0u,0g,git',
        '500,git-remote-http,0u,0g,git-remote-http',
        '500,git-remote-http,u,g,git-remote-http',
        '500,gitsign,0u,0g,gitsign',
        '500,gitsign,500u,0g,gitsign',
        '500,gitsign,500u,500g,gitsign',
        '500,gitsign,u,g,gitsign',
        '500,gitsign-credential-cache,500u,500g,gitsign-credent',
        '500,gjs-console,0u,0g,org.gnome.Maps',
        '500,gnome-recipes,0u,0g,gnome-recipes',
        '500,gnome-shell,0u,0g,gnome-shell',
        '500,gnome-software,0u,0g,gnome-software',
        '500,go,0u,0g,go',
        '500,go,500u,500g,go',
        '500,go,u,g,go',
        '500,goa-daemon,0u,0g,goa-daemon',
        '500,gobuster,500u,500g,gobuster',
        '500,grafana,u,g,grafana',
        '500,grype,0u,0g,grype',
        '500,grype,500u,500g,grype',
        '500,gsd-datetime,0u,0g,gsd-datetime',
        '500,gvfsd-google,0u,0g,gvfsd-google',
        '500,gvfsd-http,0u,0g,gvfsd-http',
        '500,helm,0u,0g,helm',
        '500,htop,0u,0g,htop',
        '500,hugo,500u,500g,hugo',
        '500,io.elementary.appcenter,0u,0g,io.elementary.a',
        '500,istioctl,500u,500g,istioctl',
        '500,java,0u,0g,java',
        '500,java,500u,500g,java',
        '500,java,u,g,java',
        '500,jcef_helper,500u,500g,jcef_helper',
        '500,jetbrains-toolbox,u,g,jetbrains-toolb',
        '500,k6,500u,500g,k6',
        '500,kbfsfuse,0u,0g,kbfsfuse',
        '500,keybase,0u,0g,keybase',
        '500,kioslave5,0u,0g,kioslave5',
        '500,ko,500u,500g,ko',
        '500,ko,u,g,ko',
        '500,kpromo,500u,500g,kpromo',
        '500,krel,500u,500g,krel',
        '500,kubectl,0u,0g,kubectl',
        '500,kubectl,500u,500g,kubectl',
        '500,lens,0u,0g,lens',
        '500,less,0u,0g,less',
        '500,license-detector,500u,500g,license-detecto',
        '500,limactl,0u,0g,limactl',
        '500,losslesscut,500u,500g,losslesscut',
        '500,mconvert,500u,500g,mconvert',
        '500,mediawriter,u,g,mediawriter',
        '500,melange,500u,500g,melange',
        '500,melange,u,g,melange',
        '500,minikube,0u,0g,minikube',
        '500,nami,500u,500g,nami',
        '500,nautilus,0u,0g,nautilus',
        '500,nerdctl,500u,500g,nerdctl',
        '500,nix,0u,0g,nix',
        '500,node,0u,0g,.node2nix-wrapp',
        '500,node,0u,0g,node',
        '500,node,0u,0g,npm install',
        '500,node,500u,500g,npm run start',
        '500,node,u,g,node',
        '500,nuclei,500u,500g,nuclei',
        '500,obs,0u,0g,obs',
        '500,obs,u,g,obs',
        '500,obs-browser-page,0u,0g,obs-browser-pag',
        '500,obs-ffmpeg-mux,0u,0g,obs-ffmpeg-mux',
        '500,obs-ffmpeg-mux,u,g,obs-ffmpeg-mux',
        '500,obsidian,0u,0g,obsidian',
        '500,obsidian,u,g,obsidian',
        '500,op,0u,500g,op',
        '500,packer-plugin-proxmox_v1.1.2_x5.0_linux_amd64,500u,500g,packer-plugin-p',
        '500,pacman,0u,0g,pacman',
        '500,php,0u,0g,php',
        '500,php8.1,0u,0g,php',
        '500,pingsender,0u,0g,pingsender',
        '500,plasma-discover,0u,0g,plasma-discover',
        '500,podman,0u,0g,podman',
        '500,promoter,500u,500g,promoter',
        '500,publish-release,500u,500g,publish-release',
        '500,python.test,500u,500g,python.test',
        '500,python3,0u,0g,python3',
        '500,python3,500u,500g,python3',
        '500,python3.10,0u,0g,aws',
        '500,python3.10,0u,0g,python',
        '500,python3.10,0u,0g,python3',
        '500,python3.11,0u,0g,aws',
        '500,python3.11,0u,0g,dnf',
        '500,python3.11,0u,0g,gnome-abrt',
        '500,python3.11,0u,0g,protonvpn',
        '500,python3.11,0u,0g,prowler',
        '500,python3.11,u,g,pip',
        '500,python3.12,0u,0g,dnf',
        '500,qemu-system-x86_64,0u,0g,qemu-system-x86',
        '500,reporter-ureport,0u,0g,reporter-urepor',
        '500,rpi-imager,0u,0g,rpi-imager',
        '500,rustup,0u,0g,rustup',
        '500,scoville,500u,500g,scoville',
        '500,signal-desktop,0u,0g,signal-desktop',
        '500,signal-desktop,u,g,signal-desktop',
        '500,skopeo,0u,0g,skopeo',
        '500,slack,0u,0g,slack',
        '500,slack,u,g,slack',
        '500,slirp4netns,0u,0g,slirp4netns',
        '500,slirp4netns,500u,500g,slirp4netns',
        '500,snap-store,0u,0g,snap-store',
        '500,snyk,500u,500g,snyk',
        '500,plasmashell,0u,0g,plasmashell',
        '500,spotify,0u,0g,spotify',
        '500,spotify,500u,500g,spotify',
        '500,spotify,u,g,spotify',
        '500,limactl,500u,500g,limactl',
        '500,tidal-hifi,u,g,tidal-hifi',
        '500,steam,500u,100g,steam',
        '0,skopeo,0u,0g,skopeo',
        '500,steam,500u,500g,steam',
        '500,steamwebhelper,500u,100g,steamwebhelper',
        '500,steamwebhelper,500u,500g,steamwebhelper',
        '500,step,500u,500g,step',
        '500,step-cli,0u,0g,step',
        '500,stern,500u,500g,stern',
        '500,syncthing,0u,0g,syncthing',
        '500,syncthing,u,g,syncthing',
        '500,synergy,0u,0g,synergy',
        '500,teams,0u,0g,teams',
        '500,terraform,0u,0g,terraform',
        '500,terraform,500u,500g,terraform',
        '500,terraform-ls,500u,500g,terraform-ls',
        '500,thunderbird,0u,0g,thunderbird',
        '500,thunderbird,u,g,thunderbird',
        '500,thunderbird-bin,u,g,thunderbird-bin',
        '500,tilt,500u,500g,tilt',
        '500,todoist,0u,0g,todoist',
        '500,trivy,0u,0g,trivy',
        '500,trivy,500u,500g,trivy',
        '500,ubuntu-report,0u,0g,ubuntu-report',
        '500,wget,0u,0g,wget',
        '500,ssh,0u,0g,ssh',
        '500,wine64-preloader,500u,500g,DaveTheDiver.ex',
        '500,wine64-preloader,500u,500g,Root.exe',
        '500,wolfictl,500u,500g,wolfictl',
        '500,xmobar,0u,0g,xmobar',
        '500,yay,0u,0g,yay',
        '500,zdup,500u,500g,zdup',
        '500,zoom,0u,0g,zoom',
        '500,zoom.real,u,g,zoom.real'
      ) -- Exceptions where we have to be more flexible for the process name
      AND NOT exception_key LIKE '0,python3.%,0u,0g,dnf'
      AND NOT exception_key LIKE '0,python3.%,0u,0g,dnf-automatic'
      AND NOT exception_key LIKE '0,python3.%,0u,0g,yum'
      AND NOT exception_key LIKE '500,python3.%,0u,0g,update-manager'
      AND NOT exception_key LIKE '500,cosign-%,500u,500g,cosign-%'
      AND NOT exception_key LIKE '500,node,0u,0g,npm exec %'
      AND NOT exception_key LIKE '500,node,0u,0g,npm install %'
      AND NOT exception_key LIKE '500,python3%,u,g,pip'
      AND NOT exception_key LIKE '500,python3.%,0u,0g,pip'
      AND NOT exception_key LIKE '500,terraform-provider-%,500u,500g,terraform-provi'
      AND NOT (
        exception_key LIKE '500,python3%,0u,0g,python%'
        AND (
          p.cmdline LIKE '%/gcloud.py %'
          OR p.cmdline LIKE "%pip install%"
          OR p.cmdline LIKE "%pip download%"
          OR p.cwd LIKE "/home/%/dev/%"
          OR p.cwd LIKE "/home/%/src/%"
          OR p.cwd LIKE "/home/%/github/%"
        )
      ) -- JetBrains
      AND NOT exception_key LIKE '500,___1go_build_%,500u,500g,___1go_build_%'
      AND NOT (
        p.path = '/usr/bin/mage'
        AND p.cmdline LIKE '/home/%/.magefile/%'
      )
      AND NOT p.path LIKE '/nix/store/%/bin/%'
      AND NOT (
        exception_key LIKE '500,%,500u,500g,%'
        AND p.path LIKE '/tmp/go-build%/exe/%'
      )
      AND NOT (
        exception_key = '0,curl,0u,0g,curl'
        AND p.cmdline LIKE 'curl --fail %'
      ) -- Exclude processes running inside of containers
      AND NOT p.cgroup_path LIKE '/system.slice/docker-%'
      AND NOT p.cgroup_path LIKE '/system.slice/system.slice:docker:%'
      AND NOT p.cgroup_path LIKE '/user.slice/user-%.slice/user@%.service/user.slice/nerdctl-%' -- Tests
      AND NOT p.path LIKE '/tmp/go-build%.test'
    GROUP BY
      p.cmdline
  tags: transient, state, net, often
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected programs communicating over HTTPS (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - c2 - unexpected-https-macos
  observer_can_run: false
  platforms: macos
  query: |
    -- Unexpected programs communicating over HTTPS (state-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1071/ (C&C, Application Layer Protocol)
    --
    -- tags: transient state net often
    -- platform: macos
    SELECT
      pos.protocol,
      pos.local_port,
      pos.remote_port,
      pos.remote_address,
      pos.local_port,
      pos.local_address,
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        REGEX_MATCH (p0.path, '.*/(.*?)$', 1),
        ',',
        p0.name,
        ',',
        s.authority,
        ',',
        s.identifier
      ) AS exception_key,
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        REGEX_MATCH (p0.path, '.*/(.*?)$', 1),
        ',',
        p0.name,
        ',',
        MIN(f.uid, 500),
        'u,',
        MIN(f.gid, 500),
        'g'
      ) AS alt_exception_key,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      s.authority AS p0_sauth,
      s.identifier AS p0_sid,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_sockets pos
      LEFT JOIN processes p0 ON pos.pid = p0.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN signature s ON p0.path = s.path
    WHERE
      pos.protocol IN (6, 17)
      AND pos.remote_port = 443
      AND pos.remote_address NOT IN ('127.0.0.1', '::ffff:127.0.0.1', '::1')
      AND pos.remote_address NOT LIKE 'fe80:%'
      AND pos.remote_address NOT LIKE '127.%'
      AND pos.remote_address NOT LIKE '192.168.%'
      AND pos.remote_address NOT LIKE '172.1%'
      AND pos.remote_address NOT LIKE '172.2%'
      AND pos.remote_address NOT LIKE '172.30.%'
      AND pos.remote_address NOT LIKE '172.31.%'
      AND pos.remote_address NOT LIKE '::ffff:172.%'
      AND pos.remote_address NOT LIKE '10.%'
      AND pos.remote_address NOT LIKE '::ffff:10.%'
      AND pos.remote_address NOT LIKE 'fdfd:%'
      AND pos.remote_address NOT LIKE 'fc00:%'
      AND pos.state != 'LISTEN' -- Ignore most common application paths
      AND p0.path NOT LIKE '/Applications/%.app/Contents/%'
      AND p0.path NOT LIKE '/Library/Apple/System/Library/%'
      AND p0.path NOT LIKE '/Library/Application Support/%/Contents/%'
      AND p0.path NOT LIKE '/System/Applications/%'
      AND p0.path NOT LIKE '/System/Library/%'
      AND p0.path NOT LIKE '/Users/%/Library/%.app/Contents/MacOS/%'
      AND p0.path NOT LIKE '/Users/%/code/%'
      AND p0.path NOT LIKE '/Users/%/src/%'
      AND p0.path NOT LIKE '/Users/%/bin/%'
      AND p0.path NOT LIKE '/System/%'
      AND p0.path NOT LIKE '/Users/%/Library/Caches/JetBrains/%/tmp/GoLand/___%'
      AND p0.path NOT LIKE '/opt/homebrew/Cellar/%/bin/%'
      AND p0.path NOT LIKE '/usr/libexec/%'
      AND p0.path NOT LIKE '/usr/sbin/%'
      AND p0.path NOT LIKE '/usr/local/kolide-k2/%'
      AND p0.path NOT LIKE '/private/var/folders/%/go-build%/%' -- Apple programs running from weird places, like the UpdateBrainService
      AND NOT (
        s.identifier LIKE 'com.apple.%'
        AND s.authority = 'Software Signing'
      )
      AND NOT exception_key IN (
        '0,AGSService,AGSService,Developer ID Application: Adobe Inc. (JQ525L2MZD),com.adobe.ags',
        '0,licenseDaemon,licenseDaemon,Developer ID Application: PACE Anti-Piracy, Inc. (TFZ8226T6X),com.paceap.eden.licenseDaemon',
        '500,agent,agent,Developer ID Application: Datadog, Inc. (JKFCB4CN7C),agent',
        '500,Authy,Authy,Apple iPhone OS Application Signing,com.authy',
        '500,bash,bash,,bash',
        '500,CrossyRoad,CrossyRoad,Apple iPhone OS Application Signing,com.hipsterwhale.crossy',
        '500,cloud_sql_proxy,cloud_sql_proxy,,a.out',
        '500,com.docker.backend,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R),com.docker.docker',
        '500,com.docker.build,com.docker.build,Developer ID Application: Docker Inc (9BNSXJN65R),com.docker',
        '500,copilot-language-server,copilot-language-server,Developer ID Application: GitHub (VEKTX9H2N7),copilot-language-server',
        '500,Fleet,~/Library/Caches/JetBrains/Fleet',
        '500,TextExpander,TextExpander,Developer ID Application: SmileOnMyMac, LLC (7PKJ6G4DXL),com.smileonmymac.textexpander',
        '500,gh,gh,,gh',
        '500,core,core,Developer ID Application: TPZ Solucoes Digitais Ltda (X37R283V2T),com.topaz.warsaw.core',
        '500,git-remote-http,git-remote-http,,git-remote-http-55554944748a32c47cdc35cfa7f071bb69a39ce4',
        '500,goland,goland,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),com.jetbrains.goland',
        '500,IterableRichNotifications,IterableRichNotifications,Apple iPhone OS Application Signing,com.plexapp.plex.IterableRichNotifications',
        '500,java,java,Developer ID Application: Oracle America, Inc. (VB5E2TV963),com.oracle.java.8u401.java',
        '500,Java Updater,Java Updater,Developer ID Application: Oracle America, Inc. (VB5E2TV963),com.oracle.java.Java-Updater',
        '500,jcef Helper,jcef Helper,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),org.jcef.jcef.helper',
        '500,Kindle,Kindle,TestFlight Beta Distribution,com.amazon.Lassen',
        '500,krisp Helper,krisp Helper,Developer ID Application: Krisp Technologies, Inc. (U5R26XM5Z2),ai.krisp.krispMac.helper',
        '500,krisp,krisp,Developer ID Application: Krisp Technologies, Inc. (U5R26XM5Z2),ai.krisp.krispMac',
        '500,kubectl,kubectl,Developer ID Application: Docker Inc (9BNSXJN65R),kubectl',
        '500,melange,melange,,a.out',
        '500,ngrok,ngrok,Developer ID Application: ngrok LLC (TEX8MHRDQ9),a.out',
        '500,node,node,Developer ID Application: Node.js Foundation (HX7739G8FX),node',
        '500,Paintbrush,Paintbrush,Developer ID Application: Michael Schreiber (G966ML7VBG),com.soggywaffles.paintbrush',
        '500,PlexMobile,PlexMobile,Apple iPhone OS Application Signing,com.plexapp.plex',
        '500,Plex,Plex,Developer ID Application: Plex Inc. (K4QJ56KR4A),tv.plex.desktop',
        '500,PowerPoint,PowerPoint,Apple Development: Zack Hoherchak (SS9PSPF8UF),PowerPoint',
        '500,process-agent,process-agent,Developer ID Application: Datadog, Inc. (JKFCB4CN7C),process-agent',
        '500,pycharm,pycharm,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),com.jetbrains.pycharm',
        '500,Realm,Realm,Apple iPhone OS Application Signing,camera.youpi.metareal',
        '500,sdaudioswitch,sdaudioswitch,,sdaudioswitch',
        '500,Skitch,Skitch,Developer ID Application: Skitch Inc (J8RPQ294UB),com.skitch.skitch',
        '500,Sky Go,Sky Go,Developer ID Application: Sky UK Limited (GJ24C8864F),com.bskyb.skygoplayer',
        '500,snyk-ls_darwin_arm64,snyk-ls_darwin_arm64,,a.out',
        '500,syncthing,syncthing,,syncthing',
        '500,.Telegram-wrapped,.Telegram-wrapped,,Telegram',
        '500,trunk,trunk,Developer ID Application: Trunk Technologies, Inc. (LDR5F9BL92),trunk-cli',
        '500,WebexHelper,WebexHelper,Developer ID Application: Cisco (DE8Y96K9QP),Cisco-Systems.SparkHelper',
        '500,zed,zed,Developer ID Application: Zed Industries, Inc. (MQ55VZLNZQ),dev.zed.Zed'
      )
      AND NOT alt_exception_key IN (
        '0,velociraptor,velociraptor,0u,0g',
        '0,velociraptor,velociraptor,0u,80g',
        '500,apko,apko,0u,0g',
        '500,apko,apko,500u,20g',
        '500,aws,aws,0u,0g',
        '500,cargo,cargo,500u,80g',
        '500,chainctl,chainctl,0u,0g',
        '500,chainctl,chainctl,500u,20g',
        '500,chainlink,chainlink,500u,20g',
        '500,cilium,cilium,500u,123g',
        '500,cloud-sql-proxy,cloud-sql-proxy,500u,20g',
        '500,cosign,cosign,0u,500g',
        '500,cosign,cosign,500u,20g',
        '500,cosign,cosign,500u,80g',
        '500,cpu,cpu,500u,20g',
        '500,crane,crane,0u,500g',
        '500,crane,crane,500u,80g',
        '500,docker-scout,docker-scout,500u,20g',
        '500,Emacs,Emacs,500u,80g',
        '500,gh-dash,gh-dash,500u,20g',
        '500,git-credential-osxkeychain,git-credential-osxkeychain,500u,80g',
        '500,git,git,0u,500g',
        '500,git-remote-http,git-remote-http,500u,20g',
        '500,git-remote-http,git-remote-http,500u,80g',
        '500,gitsign,gitsign,500u,20g',
        '500,go,go,500u,80g',
        '500,hugo,hugo,500u,20g',
        '500,istioctl,istioctl,500u,20g',
        '500,istioctl,istioctl,,a.out',
        '500,java,java,0u,0g',
        '500,log-streaming,log-streaming,500u,80g',
        '500,.man-wrapped,.man-wrapped,0u,500g',
        '500,nami,nami,0u,0g',
        '500,nix,nix,0u,500g',
        '500,nodegizmo,nodegizmo,500u,20g',
        '500,pprof,pprof,500u,80g',
        '500,pulumi-resource-gcp,pulumi-resource-gcp,500u,20g',
        '500,pulumi-resource-github,pulumi-resource-github,500u,20g',
        '500,sdaudioswitch,sdaudioswitch,500u,20g',
        '500,sdzoomplugin,sdzoomplugin,500u,20g',
        '500,session-manager-plugin,session-manager-plugin,0u,0g',
        '500,sm-agent,sm-agent,500u,20g',
        '500,snyk-macos-arm64,snyk-macos-arm64,500u,20g',
        '500,taplo-full-darwin-aarch64,taplo-full-darwin-aarch64,500u,20g',
        '500,taplo,taplo,500u,20g',
        '500,vexi,vexi,500u,20g',
        '500,vim,vim,0u,500g',
        '500,wolfibump,wolfibump,500u,20g',
        '500,wolfictl,wolfictl,0u,0g',
        '500,wolfictl,wolfictl,500u,20g'
      )
      AND NOT s.authority IN (
        'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: AgileBits Inc. (2BUA8C4S2C)',
        'Developer ID Application: ANCHORE, INC. (9MJHKYX5AT)',
        'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',
        'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4)',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Denver Technologies, Inc (2BBY89MBSN)',
        'Developer ID Application: TechSmith Corporation (7TQL462TU8)',
        'Developer ID Application: Ecamm Network, LLC (5EJH68M642)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: Farhan Ahmed (4RZN52RN5P)',
        'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK)',
        'Developer ID Application: GitHub (VEKTX9H2N7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Hashicorp, Inc. (D38WU7D763)',
        'Developer ID Application: Kandji, Inc. (P3FGV63VK7)',
        'Developer ID Application: Kolide, Inc (X98UFR7HA3)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Michael Schreiber (G966ML7VBG)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        'Developer ID Application: Panic, Inc. (VE8FC488U5)',
        'Developer ID Application: PSI Services LLC (73AT498HPV)',
        'Developer ID Application: Quiet Riddle Ventures LLC (U68MSDN6DR)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Reflect App, LLC (789ULN5MZB)',
        'Developer ID Application: Slack Technologies, Inc. (BQR82RBBHL)',
        'Developer ID Application: Spotify (2FNC3A47ZF)',
        'Developer ID Application: SteelSeries (6WGL6CHFH2)',
        'Developer ID Application: Sublime HQ Pty Ltd (Z6D26JE4Y4)',
        'Developer ID Application: Tailscale Inc. (W5364U7YZB)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Developer ID Application: Valve Corporation (MXGJJ98X76)',
        'Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3)',
        'Developer ID Application: Zwift, Inc (C2GM8Y9VFM)'
      )
      AND NOT alt_exception_key LIKE '500,terraform-provider-%,terraform-provider-%,500u,20g'
      AND NOT alt_exception_key LIKE '500,plugin_host-%,plugin_host-%,500u,20g'
      AND NOT alt_exception_key LIKE '500,sm-agent-%,sm-agent-%,500u,20g'
      AND NOT p0.path LIKE '/private/var/folders/%/T/GoLand/%'
      AND NOT (
        exception_key IN (
          '500,python3.11,python3.11,,python3.11',
          '500,python3.12,python3.12,,python3.12',
          '500,Python,Python,,',
          '500,Python,Python,0u,80g',
          '500,Python,Python,Developer ID Application: Ned Deily (DJ3H93M7VJ),org.python.python',
          '500,Python,Python,Developer ID Application: Python Software Foundation (BMM5U3QVKW),org.python.python',
          '500,Python,Python,,org.python.python',
          '500,Python,Python,,Python'
        )
        AND (
          p0_cmd LIKE '%/gcloud.py%'
          OR p0_cmd LIKE '%/google-cloud-sdk/bin/%'
          OR p0_cmd LIKE '%/google-cloud-sdk/platform/%'
          OR p0_cmd LIKE '%pip install%'
          OR p0_cmd LIKE '%pip3 install%'
          OR p0_cmd LIKE '%googlecloudsdk/core/metrics_reporter.py%'
          OR p0_cmd LIKE '%/bin/aws%'
          OR p0_cmd LIKE "%/gsutil/gsutil %"
          OR p0_cwd LIKE "/Users/%/github/%"
          OR p0_cwd LIKE "/Users/%/src/%"
          OR p0_cmd LIKE '%bin/chaingpt %'
          OR p0_cmd LIKE '%fetch_commits%'
          OR p0_cmd LIKE '%/Python update_plugins.py'
          OR p0_cmd LIKE '%/pydevd.py'
        )
      ) -- theScore and other iPhone apps
      AND NOT (
        s.authority = 'Apple iPhone OS Application Signing'
        AND p0.cwd = '/'
        AND p0.path = '/private/var/folders/%/Wrapper/%.app/%'
      ) -- nix socket inheritance
      AND NOT (
        p0.path LIKE '/nix/store/%/bin/%'
        AND p1.path LIKE '/nix/store/%/bin/%'
      )
    GROUP BY
      p0.cmdline
  tags: transient, state, net, often
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected programs speaking over ICMP (event-based)
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - c2 - unexpected-icmp-socket-events
  observer_can_run: false
  platforms: ''
  query: |
    -- Unexpected programs speaking over ICMP (event-based)
    --
    -- references:
    --   *https://attack.mitre.org/techniques/T1095/ (C2: Non-Application Layer Protocol)
    --
    -- interval: 300
    -- tags: transient events net extra
    SELECT
      se.*,
      p.path,
      p.cwd,
      p.euid,
      p.cmdline
    FROM
      socket_events se
      LEFT JOIN processes p ON se.pid = p.pid
    WHERE
      se.time > (strftime('%s', 'now') -300)
      AND family = 2 -- PF_INET
      AND protocol = 1 -- ICMP
      AND p.name NOT IN ('ping')
  tags: transient, events, net, extra
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected programs speaking over ICMP (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - c2 - unexpected-icmp-socket
  observer_can_run: false
  platforms: ''
  query: |
    -- Unexpected programs speaking over ICMP (state-based)
    --
    -- references:
    --   *https://attack.mitre.org/techniques/T1095/ (C2: Non-Application Layer Protocol)
    --
    -- tags: transient state net extra
    SELECT
      pop.pid AS p0_pid,
      pop.socket,
      pop.local_address,
      pop.remote_address,
      -- Child
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_sockets pop
      LEFT JOIN processes p0 ON pop.pid = p0.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      pop.family = 2 -- PF_INET
      AND pop.protocol = 1 -- ICMP
      AND p0.name NOT IN ('ping')
    GROUP BY
      p0_pid
  tags: transient, state, net, extra
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find programs processes which link against libcurl, common among cross-platform
    malware
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - c2 - unexpected-libcurl-user-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Find programs processes which link against libcurl, common among cross-platform malware
    --
    -- References:
    --  * https://objective-see.org/blog/blog_0x6C.html
    --  * https://objective-see.org/blog/blog_0x72.html
    --
    -- platform: linux
    -- tags: persistent state process seldom
    SELECT
      CONCAT (
        p0.name,
        ',',
        REPLACE(
          p0.path,
          COALESCE(
            REGEX_MATCH (p0.path, "/nix/store/(.*?)/.*", 1),
            REGEX_MATCH (p0.path, "(\d[\.\d]+)/.*", 1),
            "3.11"
          ),
          "__VERSION__"
        ),
        ',',
        p0.euid,
        ',',
        CONCAT (
          SPLIT (p0.cgroup_path, "/", 0),
          ",",
          SPLIT (p0.cgroup_path, "/", 1)
        ),
        ',',
        f.mode
      ) AS exception_key,
      -- Child
      p0.pid AS p0_pid,
      p0.start_time AS p0_start,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.start_time AS p1_start,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      JOIN process_memory_map pmm ON p0.pid = pmm.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.euid = 0
      AND pmm.path LIKE '%libcurl%'
      AND NOT exception_key IN (
        '0,0,/var/run/ublue-update.lock,regular,0755',
        'apache2,/usr/sbin/apache2,0,system.slice,apache2.service,0755',
        'dnf-automatic,/usr/bin/python3.12,0,system.slice,dnf-automatic-install.service,0755',
        'dnf-automatic,/usr/bin/python__VERSION__,0,system.slice,dnf-automatic-install.service,0755',
        'dnf,/usr/bin/python__VERSION__,0,system.slice,dnf-makecache.service,0755',
        'dnf,/usr/bin/python__VERSION__,0,user.slice,user-1000.slice,0755',
        'flatpak-system-,/usr/libexec/flatpak-system-helper,0,system.slice,flatpak-system-helper.service,0755',
        'fwupd,/usr/libexec/fwupd/fwupd,0,system.slice,fwupd.service,0755',
        'fwupd,/usr/lib/fwupd/fwupd,0,system.slice,fwupd.service,0755',
        'libvirtd,/usr/bin/libvirtd,0,system.slice,libvirtd.service,0755',
        'NetworkManager,/usr/bin/NetworkManager,0,system.slice,NetworkManager.service,0755',
        'NetworkManager,/usr/sbin/NetworkManager,0,system.slice,NetworkManager.service,0755',
        'nix-daemon,/nix/store/__VERSION__/bin/nix,0,system.slice,nix-daemon.service,0555',
        'ostree,/usr/bin/ostree,0,system.slice,ostree-finalize-staged-hold.service,0755',
        'packagekitd,/usr/libexec/packagekitd,0,system.slice,packagekit.service,0755',
        'pacman,/usr/bin/pacman,0,user.slice,user-1000.slice,0755',
        'rpm-ostree,/usr/bin/rpm-ostree,0,system.slice,rpm-ostreed.service,0755',
        'rpm-ostree,/usr/bin/rpm-ostree,0,system.slice,ublue-update.service,0755',
        'sddm-helper,/usr/libexec/sddm-helper,0,user.slice,user-1000.slice,0755',
        'sddm-helper,/usr/lib/sddm/sddm-helper,0,user.slice,user-1000.slice,0755',
        'sddm,/usr/bin/sddm,0,system.slice,sddm.service,0755',
        'virtlogd,/usr/bin/virtlogd,0,system.slice,virtlogd.service,0755',
        'virtqemud,/usr/sbin/virtqemud,0,system.slice,virtqemud.service,0755',
        'yum,/usr/bin/python__VERSION__,0,user.slice,user-1000.slice,0755',
        'zed,/nix/store/__VERSION__/bin/zed,0,system.slice,zfs-zed.service,0555',
        'zfs,/nix/store/__VERSION__/bin/zfs,0,system.slice,zfs-snapshot-frequent.service,0555'
      )
      AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
    GROUP BY
      p0.pid
  tags: persistent, state, process, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find programs processes which link against libcurl, common among cross-platform
    malware
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - c2 - unexpected-libcurl-user-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find programs processes which link against libcurl, common among cross-platform malware
    --
    -- References:
    --  * https://objective-see.org/blog/blog_0x6C.html
    --  * https://objective-see.org/blog/blog_0x72.html
    --
    -- platform: darwin
    -- tags: persistent state process seldom
    SELECT
      s.authority,
      s.identifier,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN process_memory_map pmm ON p0.pid = pmm.pid
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.euid = 0
      AND pmm.path LIKE '%libcurl%'
      AND p0.name NOT IN ('nix-daemon', 'nix')
    GROUP BY
      p0.pid
  tags: persistent, state, process, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected socket events
  discard_data: false
  interval: 601
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - c2 - unexpected-talker-events
  observer_can_run: false
  platforms: posix
  query: |
    -- Unexpected socket events
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1071/ (C&C, Application Layer Protocol)
    --
    -- tags: transient state net extra
    -- interval: 601
    -- platform: posix
    SELECT
      s.status,
      s.family,
      s.path,
      s.fd,
      REPLACE(s.remote_address, "::ffff:", "") AS remote_address,
      s.remote_port,
      s.local_port,
      COALESCE(REGEX_MATCH (s.path, '.*/(.*)', 1), s.path) AS basename,
      REPLACE(f.directory, u.directory, '~') AS homedir,
      CONCAT (
        MIN(s.auid, 500),
        ",",
        MIN(f.uid, 500),
        ",",
        MIN(s.remote_port, 32768),
        ",",
        COALESCE(REGEX_MATCH (s.path, '.*/(.*)', 1), s.path)
      ) as exception_key,
      RTRIM(
        COALESCE(
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?)/',
            1
          ),
          f.directory
        ),
        "/"
      ) AS top2_dir,
      -- Child
      s.path AS p0_path,
      s.pid AS p0_pid,
      s.auid AS p0_euid,
      TRIM(COALESCE(p.cmdline, pe.cmdline)) AS p0_cmd,
      TRIM(COALESCE(p.cwd, pe.cwd)) AS p0_cwd,
      hash.sha256 AS p0_sha256,
      -- Parent
      COALESCE(p.parent, pe.parent) AS p1_pid
    FROM
      socket_events AS s
      LEFT JOIN process_events pe ON s.pid = pe.pid
      AND pe.time > (strftime('%s', 'now') -7200)
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN file f ON s.path = f.path
      LEFT JOIN users u ON f.uid = u.uid
      LEFT JOIN hash ON s.path = hash.path
    WHERE
      s.time > (strftime('%s', 'now') -600)
      AND s.action = "connect"
      AND s.remote_port > 10
      AND s.remote_address NOT IN (
        '127.0.0.1',
        '::ffff:127.0.0.1',
        '::1',
        '::',
        '0.0.0.0'
      )
      AND s.remote_address NOT LIKE 'fe80:%'
      AND s.remote_address NOT LIKE '127.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '100.7%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '0000:%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '::ffff:172.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '::ffff:10.%'
      AND s.remote_address NOT LIKE '::ffff:192.168.%'
      AND s.remote_address NOT LIKE 'fc00:%'
      AND NOT s.path LIKE '/Applications/%' -- NOTE: Do not filter out /bin (bash) or /usr/bin (nc)
      AND NOT s.path LIKE '/private/var/folders/%/T/go-build%'
      AND NOT s.path = '/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Resources/Java Updater.app/Contents/MacOS/Java Updater'
      AND NOT top2_dir IN (
        '/Library/Apple',
        '/Library/Developer',
        '/Library/Application Support',
        '/Library/Kandji',
        '/opt/homebrew',
        '/System/Applications',
        '/System/Library',
        '/System/Volumes',
        '/usr/libexec',
        '/usr/local',
        '/usr/bin',
        '/usr/sbin',
        '/snap/firefox',
        '~/.provisio',
        '~/homebrew',
        '~/Applications',
        '~/Apps',
        '~/bin',
        '~/code',
        '~/github',
        '~/go',
        '~/src',
        '~/work'
      )
      AND NOT homedir IN (
        '~/Library/Application Support/Foxit Software/Addon/Foxit PDF Reader/FoxitPDFReaderUpdateService.app/Contents/MacOS',
        '/opt/spotify',
        '/usr/lib/google-cloud-sdk/platform/bundledpythonunix/bin'
      )
      AND NOT exception_key IN (
        '0,velociraptor,velociraptor,500u,80g',
        '500,0,110,syncthing',
        '500,0,123,sntp',
        '500,0,1234,spotify',
        '500,0,20480,com.adguard.mac.adguard.network-extension',
        '500,0,20480,io.tailscale.ipn.macsys.network-extension',
        '500,0,22,ssh',
        '500,0,27668,com.adguard.mac.adguard.network-extension',
        '500,0,31488,sntp',
        '500,0,32768,Authy',
        '500,0,32768,BDLDaemon',
        '500,0,32768,com.adguard.mac.adguard.network-extension',
        '500,0,32768,com.apple.MobileSoftwareUpdate.UpdateBrainService',
        '500,0,32768,com.apple.NRD.UpdateBrainService',
        '500,0,32768,elastic-endpoint',
        '500,0,32768,firefox',
        '500,0,32768,git-remote-http',
        '500,0,32768,io.tailscale.ipn.macsys.network-extension',
        '500,0,32768,ir_agent',
        '500,0,32768,ksfetch',
        '500,0,32768,networkQuality',
        '500,500,80,elastic-agent',
        '500,0,80,filebeat',
        '500,0,32768,syncthing',
        '500,0,3478,firefox',
        '500,0,4070,spotify',
        '500,0,43,whois',
        '500,0,443,Authy',
        '500,0,443,BDCoreIssues',
        '500,0,443,BDLDaemon',
        '500,0,443,BDUpdDaemon',
        '500,0,443,Brackets',
        '500,0,443,OneDriveStandaloneUpdater',
        '500,0,443,Python',
        '500,0,443,bdredline',
        '500,0,443,chrome',
        '500,0,443,chrome_crashpad_handler',
        '500,0,443,com.adguard.mac.adguard.network-extension',
        '500,0,443,com.apple.MobileSoftwareUpdate.UpdateBrainService',
        '500,0,443,com.apple.NRD.UpdateBrainService',
        '500,0,443,com.bitdefender.cst.net.dci.dci-network-extension',
        '500,0,443,com.fortinet.forticlient.macos.vpn.nwextension',
        '500,0,443,com.google.one.NetworkExtension',
        '500,0,443,curl',
        '500,0,443,docker-buildx',
        '500,0,443,elastic-agent',
        '500,0,443,elastic-endpoint',
        '500,0,443,electron',
        '500,0,443,filebeat',
        '500,0,443,firefox',
        '500,0,443,fwupdmgr',
        '500,0,443,git-remote-http',
        '500,0,443,gnome-software',
        '500,0,443,go',
        '500,0,443,http',
        '500,0,443,incusd',
        '500,0,443,io.tailscale.ipn.macsys.network-extension',
        '500,0,443,ir_agent',
        '500,0,443,kioslave5',
        '500,0,443,ksfetch',
        '500,0,443,launcher',
        '500,0,443,metricbeat',
        '500,0,443,nessusd',
        '500,500,32768,old',
        '500,0,443,networkQuality',
        '500,0,443,node',
        '500,0,443,packetbeat',
        '500,0,443,pingsender',
        '500,0,443,rapid7_endpoint_broker',
        '500,0,443,slack',
        '500,0,443,snapd',
        '500,0,443,spotify',
        '500,0,443,ssh',
        '500,0,443,syncthing',
        '500,0,443,terraform',
        '500,0,443,velociraptor',
        '500,0,443,wget',
        '500,0,5228,chrome',
        '500,0,443,packetbeat',
        '500,0,53,Brackets',
        '500,0,53,NetworkManager',
        '500,0,53,chrome',
        '500,0,53,electron',
        '500,0,53,firefox',
        '500,0,53,git',
        '500,0,53,launcher',
        '500,0,53,nessusd',
        '500,0,53,slack',
        '500,0,53,spotify',
        '500,0,53,wget',
        '500,0,5632,ssh',
        '500,0,80,BDUpdDaemon',
        '500,0,27668,com.adguard.mac.adguard.network-extension',
        '500,0,80,chrome',
        '500,0,80,com.adguard.mac.adguard.network-extension',
        '500,0,80,com.apple.NRD.UpdateBrainService',
        '500,0,80,com.bitdefender.cst.net.dci.dci-network-extension',
        '500,0,80,electron',
        '500,0,443,com.docker.backend',
        '500,0,80,firefox',
        '500,0,80,http',
        '500,0,80,incusd',
        '500,0,80,io.tailscale.ipn.macsys.network-extension',
        '500,0,80,ir_agent',
        '500,0,80,ksfetch',
        '500,0,80,metricbeat',
        '500,0,80,slack',
        '500,0,8080,com.bitdefender.cst.net.dci.dci-network-extension',
        '500,0,9,launcher',
        '500,0,9,snapd',
        '500,500,13568,Code Helper',
        '500,500,20480,Code Helper',
        '500,500,20480,Google Chrome Helper',
        '500,500,20480,GoogleUpdater',
        '500,500,20480,ksfetch',
        '500,500,22,ssh',
        '500,500,2304,cloud_sql_proxy',
        '500,500,2304,terraform-provider-google_v4.37.0_x5',
        '500,500,3024,ZwiftAppSilicon',
        '500,500,32768,Chromium Helper',
        '500,500,32768,Code Helper',
        '500,500,32768,DropboxMacUpdate',
        '500,500,32768,Electron',
        '500,500,32768,G2MUpdate',
        '500,500,32768,GoogleUpdater',
        '500,500,32768,Microsoft.VisualStudio.Code.Server',
        '500,500,32768,cloud-sql-proxy',
        '500,500,32768,java',
        '500,500,32768,ksfetch',
        '500,500,32768,melange',
        '500,500,32768,node',
        '500,500,32768,rzls',
        '500,500,32768,terraform-ls',
        '500,500,3307,cloud_sql_proxy',
        '500,500,4318,Code Helper (Plugin)',
        '500,500,443,Acrobat Updater',
        '500,500,443,Chromium Helper',
        '500,500,443,Cisco WebEx Start',
        '500,500,443,CleanMyMac X Updater',
        '500,500,443,Code Helper (Plugin)',
        '500,500,443,Code Helper (Renderer)',
        '500,500,443,Code Helper',
        '500,500,443,DropboxMacUpdate',
        '500,500,443,Electron',
        '500,500,443,GitX',
        '500,500,443,Google Chrome Helper',
        '500,500,443,GoogleUpdater',
        '500,500,443,Meeting Center',
        '500,500,443,Signal Helper (Renderer)',
        '500,500,443,Signal',
        '500,500,443,ZwiftAppSilicon',
        '500,500,443,apk',
        '500,500,443,aws',
        '500,500,443,chainctl',
        '500,500,443,cloud_sql_proxy',
        '500,500,443,copilot-agent-macos-arm64',
        '500,500,443,figma_agent',
        '500,500,443,gh',
        '500,500,443,git-remote-http',
        '500,500,443,gitsign',
        '500,500,443,go',
        '500,500,443,grype',
        '500,500,443,istioctl',
        '500,500,443,ksfetch',
        '500,500,443,kubectl',
        '500,500,443,minikube',
        '500,500,443,node',
        '500,500,443,old',
        '500,500,443,sublime_text',
        '500,500,443,syft',
        '500,500,443,webexmtaV2',
        '500,500,443,wolfibump',
        '500,500,443,wolfictl',
        '500,500,53,Code Helper',
        '500,500,53,Google Chrome Helper',
        '500,500,53,Meeting Center',
        '500,500,53,gitsign',
        '500,500,80,Code Helper (Plugin)',
        '500,500,80,Code Helper',
        '500,500,80,Google Chrome Helper',
        '500,500,80,GoogleUpdater',
        '500,500,80,cloud_sql_proxy',
        '500,500,80,copilot-agent-macos-arm64',
        '500,500,80,firefox-bin',
        '500,500,80,ksfetch',
        '500,500,80,node',
        '500,500,9000,Meeting Center',
        '500,500,32768,Microsoft.ServiceHub.Controller',
        '500,500,32768,Microsoft.VisualStudio.Code.ServiceHost',
        '500,99,13568,Slack Helper',
        '500,99,32768,Slack Helper',
        '500,99,32768,Slack',
        '500,99,443,Slack Helper',
        '500,99,443,Slack',
        '500,99,53,Slack Helper'
      )
      AND NOT exception_key LIKE '500,500,443,terraform%'
      AND NOT exception_key LIKE '500,500,32768,terraform-provider-%'
      AND NOT exception_key LIKE '500,500,2304,terraform%'
      AND NOT exception_key LIKE '500,500,53,terraform%'
      AND NOT exception_key LIKE '500,500,80,terraform%'
      AND NOT exception_key LIKE '500,0,%,syncthing'
      AND NOT exception_key LIKE '500,0,%,chrome'
      AND NOT exception_key LIKE '500,500,443,___%_%'
      AND NOT exception_key LIKE '500,500,%,chrome'
      AND NOT exception_key LIKE '500,500,%,Google Chrome Helper'
      AND NOT exception_key LIKE '500,500,443,kubectl.%'
      AND NOT p0_path LIKE '/Users/%/code/%'
      AND NOT p0_path LIKE '/Users/%/go/%'
      AND NOT p0_path LIKE '/Users/%/src/%'
      AND NOT p0_path LIKE '/Users/%/Library/Caches/JetBrains/GoLand%'
      AND NOT p0_path LIKE '/Users/%/dev/%'
      AND NOT p0_path LIKE '/System/%'
      AND NOT p0_path LIKE '/private/var/folders/%/T/AppTranslocation/%/%.app/Contents/MacOS/%'
      AND NOT (
        basename = "Python"
        AND (
          p0_cmd LIKE '%/gcloud.py%'
          OR p0_cmd LIKE '%/google-cloud-sdk/%'
          OR p0_cmd LIKE '%pip install%'
          OR p0_cmd LIKE '%googlecloudsdk/%'
          OR p0_cmd LIKE '%/bin/aws%'
          OR p0_cmd LIKE "%/gsutil/%"
        )
      )
    GROUP BY
      s.pid,
      exception_key
  tags: transient, state, net, extra
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected programs communicating over non-HTTPS protocols (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - c2 - unexpected-talkers-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Unexpected programs communicating over non-HTTPS protocols (state-based)
    --
    -- This query is a bit awkward and hobbled due to the lack of osquery support
    -- for looking up binary signatures in Linux.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1071/ (C&C, Application Layer Protocol)
    --
    -- tags: transient state net rapid
    -- platform: linux
    SELECT
      s.remote_address,
      s.remote_port,
      s.local_port,
      s.local_address,
      p.name,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      pp.path AS parent_path,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd,
      p.cgroup_path,
      s.state,
      hash.sha256,
      -- This intentionally avoids file.path, as it won't join across mount namespaces
      CONCAT (
        MIN(s.remote_port, 32768),
        ',',
        s.protocol,
        ',',
        MIN(p.euid, 500),
        ',',
        REGEX_MATCH (p.path, '.*/(.*?)$', 1),
        ',',
        MIN(f.uid, 500),
        'u,',
        MIN(f.gid, 500),
        'g,',
        p.name
      ) AS exception_key
    FROM
      process_open_sockets s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      protocol > 0
      AND s.remote_port > 0 -- See unexpected-https-client
      AND NOT (
        s.remote_port = 443
        AND protocol IN (6, 17)
      ) -- See unexpected-dns-traffic
      AND NOT (
        s.remote_port = 53
        AND protocol IN (6, 17)
      )
      AND s.remote_address NOT IN (
        '127.0.0.1',
        '::ffff:127.0.0.1',
        '::1',
        '::',
        '0.0.0.0'
      )
      AND s.remote_address NOT LIKE 'fe80:%'
      AND s.remote_address NOT LIKE '127.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '100.7%'
      AND s.remote_address NOT LIKE '169.254.%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '::ffff:172.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '::ffff:10.%'
      AND s.remote_address NOT LIKE '::ffff:192.168.%'
      AND s.remote_address NOT LIKE 'fc00:%'
      AND p.path != ''
      AND NOT (
        s.remote_address LIKE '100.%'
        AND s.local_address LIKE '100.%'
        AND exception_key = '32768,6,%,sshd,0u,0g,sshd'
      )
      AND NOT exception_key IN (
        '123,17,500,chronyd,0u,0g,chronyd',
        '4070,6,500,spotify,u,g,spotify',
        '49152,6,500,ContinuityCaptureAgent,Software Signing',
        '67,17,0,NetworkManager,0u,0g,NetworkManager',
        '8000,6,500,brave,0u,0g,brave',
        '8000,6,500,chrome,0u,0g,chrome',
        '8000,6,500,firefox,0u,0g,firefox',
        '80,6,0,grep,0u,0g,grep',
        '80,6,0,incusd,0u,0g,incusd',
        '80,6,0,kmod,0u,0g,depmod',
        '80,6,0,kubelet,u,g,kubelet',
        '80,6,0,ldconfig,0u,0g,ldconfig',
        '80,6,0,NetworkManager,0u,0g,NetworkManager',
        '80,6,0,packagekitd,0u,0g,packagekitd',
        '80,6,0,pacman,0u,0g,pacman',
        '80,6,0,pdftex,0u,0g,pdftex',
        '80,6,0,python3.10,0u,0g,dnf',
        '80,6,0,python3.10,0u,0g,dnf-automatic',
        '80,6,0,python3.10,0u,0g,yum',
        '80,6,0,python3.11,0u,0g,dnf',
        '80,6,0,python3.11,0u,0g,dnf-automatic',
        '80,6,0,python3.11,0u,0g,yum',
        '80,6,0,python3.12,0u,0g,dnf',
        '80,6,0,python3.12,0u,0g,yum',
        '80,6,0,python3.9,u,g,yum',
        '80,6,0,rpm-ostree,0u,0g,rpm-ostree',
        '80,6,0,sort,0u,0g,sort',
        '80,6,0,systemd-hwdb,0u,0g,systemd-hwdb',
        '80,6,0,tailscaled,0u,0g,tailscaled',
        '80,6,0,wget,0u,0g,wget',
        '80,6,0,zstd,0u,0g,zstd',
        '80,6,100,http,0u,0g,http',
        '80,6,105,http,0u,0g,http',
        '80,6,42,http,0u,0g,http',
        '80,6,500,aws-iam-authenticator,0u,0g,aws-iam-authent',
        '80,6,500,brave,0u,0g,brave',
        '80,6,500,chrome,0u,0g,chrome',
        '80,6,500,chrome,u,g,chrome',
        '80,6,500,cloud_sql_proxy,0u,0g,cloud_sql_proxy',
        '80,6,500,code,0u,0g,code',
        '80,6,500,code-oss,u,g,code-oss',
        '80,6,500,copilot-agent-linux,500u,500g,copilot-agent-l',
        '80,6,500,curl,0u,0g,curl',
        '80,6,500,electron,0u,0g,electron',
        '80,6,500,firefox,0u,0g,firefox',
        '80,6,500,firefox,0u,0g,.firefox-wrappe',
        '80,6,500,firefox-bin,0u,0g,firefox-bin',
        '80,6,500,firefox-bin,500u,500g,firefox-bin',
        '80,6,500,firefox-bin,u,g,firefox-bin',
        '80,6,500,flatpak,0u,0g,flatpak',
        '80,6,500,git-remote-http,0u,0g,git-remote-http',
        '80,6,500,gnome-software,0u,0g,gnome-software',
        '80,6,500,http,u,g,http',
        '80,6,500,java,0u,0g,java',
        '80,6,500,java,u,g,java',
        '80,6,500,main,500u,500g,main',
        '80,6,500,mconvert,500u,500g,mconvert',
        '80,6,500,mediawriter,u,g,mediawriter',
        '80,6,500,melange,500u,500g,melange',
        '80,6,500,obs-browser-page,u,g,obs-browser-pag',
        '80,6,500,pacman,0u,0g,pacman',
        '80,6,500,python3.10,0u,0g,aws',
        '80,6,500,python3.10,0u,0g,yum',
        '80,6,500,python3.11,0u,0g,abrt-action-ins',
        '80,6,500,python3.11,0u,0g,dnf',
        '80,6,500,python3.11,0u,0g,yum',
        '80,6,500,python3.12,0u,0g,pull-lp-source',
        '80,6,500,qemu-system-x86_64,0u,0g,qemu-system-x86',
        '80,6,500,qemu-system-x86_64,500u,500g,qemu-system-x86',
        '80,6,500,rpi-imager,0u,0g,rpi-imager',
        '80,6,500,signal-desktop,0u,0g,signal-desktop',
        '80,6,500,signal-desktop,u,g,signal-desktop',
        '80,6,500,slack,0u,0g,slack',
        '80,6,500,slirp4netns,500u,500g,slirp4netns',
        '80,6,500,spotify,0u,0g,spotify',
        '80,6,500,spotify,500u,500g,spotify',
        '80,6,500,spotify-launcher,0u,0g,spotify-launche',
        '80,6,500,spotify,u,g,spotify',
        '80,6,500,steam,500u,100g,steam',
        '80,6,500,steam,500u,500g,steam',
        '80,6,500,steamwebhelper,500u,500g,steamwebhelper',
        '80,6,500,terraform,0u,0g,terraform',
        '80,6,500,terraform,500u,500g,terraform',
        '80,6,500,thunderbird,0u,0g,thunderbird',
        '80,6,500,thunderbird-bin,u,g,thunderbird-bin',
        '80,6,500,thunderbird,u,g,thunderbird',
        '80,6,500,WebKitNetworkProcess,0u,0g,WebKitNetworkPr',
        '80,6,500,wget,0u,0g,wget',
        '80,6,500,wine64-preloader,0u,0g,control.exe',
        '80,6,500,zoom,0u,0g,zoom',
        '80,6,500,zoom.real,u,g,zoom.real',
        '8080,6,500,brave,0u,0g,brave',
        '8080,6,500,chrome,0u,0g,chrome',
        '8080,6,500,firefox,0u,0g,firefox',
        '8080,6,500,python3.11,0u,0g,speedtest-cli',
        '8080,6,500,speedtest,500u,500g,speedtest',
        '8443,6,500,chrome,0u,0g,chrome',
        '8443,6,500,firefox,0u,0g,firefox',
        '8801,17,500,zoom,0u,0g,zoom',
        '8801,17,500,zoom.real,u,g,zoom.real',
        '88,6,500,syncthing,0u,0g,syncthing',
        '8987,6,500,whois,0u,0g,whois',
        '9,17,0,launcher,0u,0g,launcher',
        '9418,6,500,git,0u,0g,git',
        '993,6,500,evolution,0u,0g,evolution',
        '993,6,500,thunderbird,0u,0g,thunderbird',
        '993,6,500,thunderbird,u,g,thunderbird',
        '9999,6,500,firefox,0u,0g,firefox'
      )
      AND NOT exception_key LIKE '80,6,500,terraform_1.1.5,500u,500g,terraform'
      AND NOT exception_key LIKE '%,6,500,nuclei,500u,500g,nuclei'
      AND NOT exception_key LIKE '%,6,500,ssh,0u,0g,ssh'
      AND NOT (
        p.name = 'java'
        AND p.cmdline LIKE '/home/%/.local/share/JetBrains/Toolbox/%'
        AND s.remote_port > 1024
        AND s.protocol = 6
        AND p.euid > 500
      )
      AND NOT (
        p.name = 'ruby'
        AND p.cmdline LIKE '%fluentd%'
        AND s.remote_port > 1024
        AND s.protocol = 6
        AND p.euid > 500
      )
      AND NOT (
        p.name IN ('java', 'jcef_helper')
        AND p.cmdline LIKE '/home/%/PhpStorm%'
        AND s.remote_port > 79
        AND s.protocol = 6
        AND p.euid > 500
      )
      AND NOT (
        p.name = 'syncthing'
        AND f.filename = 'syncthing'
        AND s.remote_port > 900
        AND s.protocol = 6
        AND p.euid > 500
      )
      AND NOT (
        p.name = 'chrome'
        AND f.filename = 'chrome'
        AND s.remote_port > 1024
        AND s.protocol IN (6, 17)
        AND p.euid > 500
      )
      AND NOT (
        p.name = 'steam'
        AND f.filename = 'steam'
        AND s.remote_port > 27000
        AND s.protocol IN (6, 17)
        AND p.euid > 500
      )
      AND NOT (
        p.name = 'brave'
        AND f.filename = 'brave'
        AND s.remote_port > 3000
        AND s.protocol IN (6, 17)
        AND p.euid > 500
      )
      AND NOT (
        p.name IN ('firefox', 'firefox-bin')
        AND f.filename IN ('firefox', 'firefox-bin')
        AND s.remote_port > 3000
        AND s.protocol IN (6, 17)
        AND p.euid > 500
      ) -- TODO: Move this to a custom override overlay, as it is extremely obscure (small ISP)
      AND NOT (
        exception_key = '32768,6,500,ssh,0u,0g,ssh'
        AND s.remote_port = 40022
      ) -- Qualys
      AND NOT (
        exception_key = '80,6,0,curl,0u,0g,curl'
        AND p.cgroup_path = '/system.slice/qualys-cloud-agent.service'
        AND child_cmd LIKE ' curl -sS -H Metadata:true http://169.254.169.254/metadata/instance%'
      )
      AND NOT (
        s.remote_port = 80
        AND (
          p.cgroup_path LIKE '/system.slice/docker-%'
          OR p.cgroup_path LIKE '/user.slice/user-%.slice/user@%.service/user.slice/nerdctl-%'
        )
      )
    GROUP BY
      p.cmdline
  tags: transient, state, net, rapid
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected programs communicating over HTTPS (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - c2 - unexpected-talkers-macos
  observer_can_run: false
  platforms: macos
  query: |
    -- Unexpected programs communicating over HTTPS (state-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1071/ (C&C, Application Layer Protocol)
    --
    -- tags: transient state net often
    -- platform: macos
    SELECT
      pos.protocol,
      pos.local_port,
      pos.remote_port,
      pos.remote_address,
      pos.local_port,
      pos.local_address,
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        pos.protocol,
        ',',
        MIN(pos.remote_port, 32768),
        ',',
        REGEX_MATCH (p0.path, '.*/(.*?)$', 1),
        ',',
        p0.name,
        ',',
        s.authority,
        ',',
        s.identifier
      ) AS exception_key,
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        pos.protocol,
        ',',
        MIN(pos.remote_port, 32768),
        ',',
        REGEX_MATCH (p0.path, '.*/(.*?)$', 1),
        ',',
        p0.name,
        ',',
        MIN(f.uid, 500),
        'u,',
        MIN(f.gid, 500),
        'g'
      ) AS alt_exception_key,
      CONCAT (s.authority, ',', s.identifier) AS id_exception_key,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      s.authority AS p0_sauth,
      s.identifier AS p0_sid,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_sockets pos
      LEFT JOIN processes p0 ON pos.pid = p0.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN signature s ON p0.path = s.path
    WHERE
      pos.protocol > 0
      AND NOT (
        pos.remote_port IN (53, 443)
        AND pos.protocol IN (6, 17)
      )
      AND pos.remote_address NOT IN (
        '0.0.0.0',
        '::127.0.0.1',
        '127.0.0.1',
        '::ffff:127.0.0.1',
        '::1',
        '::'
      )
      AND pos.remote_address NOT LIKE 'fe80:%'
      AND pos.remote_address NOT LIKE '127.%'
      AND pos.remote_address NOT LIKE '192.168.%'
      AND pos.remote_address NOT LIKE '172.1%'
      AND pos.remote_address NOT LIKE '172.2%'
      AND pos.remote_address NOT LIKE '169.254.%'
      AND pos.remote_address NOT LIKE '172.30.%'
      AND pos.remote_address NOT LIKE '172.31.%'
      AND pos.remote_address NOT LIKE '::ffff:172.%'
      AND pos.remote_address NOT LIKE '10.%'
      AND pos.remote_address NOT LIKE '::ffff:10.%'
      AND pos.remote_address NOT LIKE 'fc00:%'
      AND pos.remote_address NOT LIKE 'fdfd:%'
      AND pos.state != 'LISTEN' -- Ignore most common application paths
      AND p0.path NOT LIKE '/Library/Apple/System/Library/%'
      AND p0.path NOT LIKE '/Library/Application Support/%/Contents/%'
      AND p0.path NOT LIKE '/System/Applications/%'
      AND p0.path NOT LIKE '/System/Library/%'
      AND p0.path NOT LIKE '/System/%'
      AND p0.path NOT LIKE '/usr/libexec/%'
      AND p0.path NOT LIKE '/Users/%/go/bin/%'
      AND p0.path NOT LIKE '/usr/sbin/%' -- Apple programs running from weird places, like the UpdateBrainService
      AND NOT (
        s.identifier LIKE 'com.apple.%'
        AND s.authority = 'Software Signing'
      )
      AND NOT exception_key IN (
        '0,6,7300,safeqclientcore,safeqclientcore,Developer ID Application: Y Soft Corporation, a.s. (3CPED8WGS9),safeqclientcore',
        '0,6,80,fcconfig,fcconfig,Developer ID Application: Fortinet, Inc (AH4XFXJ7DK),fcconfig',
        '0,6,80,prl_naptd,prl_naptd,Developer ID Application: Parallels International GmbH (4C6364ACXT),com.parallels.naptd',
        '0,6,853,at.obdev.littlesnitch.networkextension,at.obdev.littlesnitch.networkextension,Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R),at.obdev.littlesnitch.networkextension',
        '500,17,123,agent,agent,Developer ID Application: Datadog, Inc. (JKFCB4CN7C),agent',
        '500,17,123,Garmin Express,Garmin Express,Developer ID Application: Garmin International (72ES32VZUA),com.garmin.renu.client',
        '500,17,32768,Luna Display,Luna Display,Developer ID Application: Astro HQ LLC (8356ZZ8Y5K),com.astro-hq.LunaDisplayMac',
        '500,17,68,com.docker.backend,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R),com.docker.docker',
        '500,17,8801,zoom.us,zoom.us,Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3),us.zoom.xos',
        '500,17,9000,Meeting Center,Meeting Center,Developer ID Application: Cisco (DE8Y96K9QP),com.webex.meetingmanager',
        '500,6,21,Cyberduck,Cyberduck,Developer ID Application: David Kocher (G69SCX94XU),ch.sudo.cyberduck',
        '500,6,22,Cyberduck,Cyberduck,Developer ID Application: David Kocher (G69SCX94XU),ch.sudo.cyberduck',
        '500,6,22,devpod-provider-gcloud-darwin-arm64,devpod-provider-gcloud-darwin-arm64,,a.out',
        '500,6,22,goland,goland,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),com.jetbrains.goland',
        '500,6,22,Transmit,Transmit,Developer ID Application: Panic, Inc. (VE8FC488U5),com.panic.Transmit',
        '500,6,2869,Spotify,Spotify,Developer ID Application: Spotify (2FNC3A47ZF),com.spotify.client',
        '500,6,32000,Spotify Helper,Spotify Helper,Developer ID Application: Spotify (2FNC3A47ZF),com.spotify.client.helper',
        '500,6,32400,PlexMobile,PlexMobile,Apple iPhone OS Application Signing,com.plexapp.plex',
        '500,6,32768,IPNExtension,IPNExtension,Apple Mac OS Application Signing,io.tailscale.ipn.macos.network-extension',
        '500,6,32768,MobileDevicesService,MobileDevicesService,Developer ID Application: GUILHERME RAMBO (8C7439RJLG),codes.rambo.AirBuddy.MobileDevicesService',
        '500,6,3306,dbeaver,dbeaver,Developer ID Application: DBeaver Corporation (42B6MDKMW8),org.jkiss.dbeaver.core.product',
        '500,6,3389,Microsoft Remote Desktop,Microsoft Remote Desktop,Apple Mac OS Application Signing,com.microsoft.rdc.macos',
        '500,6,3389,Microsoft Remote Desktop,Microsoft Remote Desktop,Developer ID Application: Microsoft Corporation (UBF8T346G9),com.microsoft.rdc.macos',
        '500,6,4070,Spotify,Spotify,Developer ID Application: Spotify (2FNC3A47ZF),com.spotify.client',
        '500,6,4317,flyctl,flyctl,,a.out',
        '500,6,4318,Code Helper (Plugin),Code Helper (Plugin),Developer ID Application: Microsoft Corporation (UBF8T346G9),com.github.Electron.helper',
        '500,6,5053,bridge,bridge,Developer ID Application: Proton Technologies AG (6UN54H93QT),bridge',
        '500,6,5091,ZoomPhone,ZoomPhone,Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3),us.zoom.ZoomPhone',
        '500,6,5222,Telegram,Telegram,Apple Mac OS Application Signing,ru.keepcoder.Telegram',
        '500,6,5222,WhatsApp,WhatsApp,Apple Mac OS Application Signing,net.whatsapp.WhatsApp',
        '500,6,5222,WhatsApp,WhatsApp,Developer ID Application: WhatsApp Inc. (57T9237FN3),net.whatsapp.WhatsApp',
        '500,6,5223,KakaoTalk,KakaoTalk,Apple Mac OS Application Signing,com.kakao.KakaoTalkMac',
        '500,6,5228,Clay,Clay,Developer ID Application: Clay Software, Inc. (C68GA48KN3),com.clay.mac',
        '500,6,5228,com.adguard.mac.adguard.network-extension,com.adguard.mac.adguard.network-extension,0u,0g',
        '500,6,5228,com.adguard.mac.adguard.network-extension,com.adguard.mac.adguard.network-extension,Developer ID Application: Adguard Software Limited (TC3Q7MAJXF),com.adguard.mac.adguard.network-extension',
        '500,6,7881,zed,zed,Developer ID Application: Zed Industries, Inc. (MQ55VZLNZQ),dev.zed.Zed',
        '500,6,8009,Spotify Helper,Spotify Helper,Developer ID Application: Spotify (2FNC3A47ZF),com.spotify.client.helper',
        '500,6,8080,goland,goland,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),com.jetbrains.goland',
        '500,6,8080,Speedtest,Speedtest,Apple Mac OS Application Signing,com.ookla.speedtest-macos',
        '500,6,80,AdobeAcrobat,AdobeAcrobat,Developer ID Application: Adobe Inc. (JQ525L2MZD),com.adobe.Acrobat.Pro',
        '500,6,80,agent,agent,Developer ID Application: Datadog, Inc. (JKFCB4CN7C),agent',
        '500,6,80,Arc Helper,Arc Helper,Developer ID Application: The Browser Company of New York Inc. (S6N382Y83G),company.thebrowser.browser.helper',
        '500,6,80,Brackets,Brackets,Developer ID Application: CORE.AI SCIENTIFIC TECHNOLOGIES PRIVATE LIMITED (8F632A866K),io.brackets.appshell',
        '500,6,80,Camtasia 2022,Camtasia 2022,Developer ID Application: TechSmith Corporation (7TQL462TU8),com.techsmith.camtasia2022',
        '500,6,80,CEPHtmlEngine Helper,CEPHtmlEngine Helper,Developer ID Application: Adobe Inc. (JQ525L2MZD),com.adobe.cep.CEPHtmlEngine Helper',
        '500,6,80,Chromium Helper,Chromium Helper,,Chromium Helper',
        '500,6,80,Code Helper (Plugin),Code Helper (Plugin),Developer ID Application: Microsoft Corporation (UBF8T346G9),com.github.Electron.helper',
        '500,6,80,Code - Insiders Helper (Plugin),Code - Insiders Helper (Plugin),Developer ID Application: Microsoft Corporation (UBF8T346G9),com.github.Electron.helper',
        '500,6,80,com.docker.backend,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R),com.docker',
        '500,6,80,Creative Cloud UI Helper,Creative Cloud UI Helper,Developer ID Application: Adobe Inc. (JQ525L2MZD),com.adobe.acc.HEXHelper',
        '500,6,80,Discord Helper,Discord Helper,Developer ID Application: Discord, Inc. (53Q6R32WPB),com.hnc.Discord.helper',
        '500,6,80,firefox,firefox,Developer ID Application: Mozilla Corporation (43AQ936H96),org.mozilla.firefox',
        '500,6,80,Google Drive Helper,Google Drive Helper,Developer ID Application: Google LLC (EQHXZ8M8AV),com.google.drivefs.helper',
        '500,6,80,IPNExtension,IPNExtension,Apple Mac OS Application Signing,io.tailscale.ipn.macos.network-extension',
        '500,6,80,Jabra Direct,Jabra Direct,Developer ID Application: GN Audio AS (55LV32M29R),com.jabra.directonline',
        '500,6,80,jcef Helper,jcef Helper,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),org.jcef.jcef.helper',
        '500,6,80,KakaoTalk,KakaoTalk,Apple Mac OS Application Signing,com.kakao.KakaoTalkMac',
        '500,6,80,ksfetch,ksfetch,Developer ID Application: Google LLC (EQHXZ8M8AV),ksfetch',
        '500,6,80,launcher-Helper,launcher-Helper,Developer ID Application: Mojang AB (HR992ZEAE6),com.mojang.mclauncher.helper',
        '500,6,80,Loom Helper,Loom Helper,Developer ID Application: Loom, Inc (QGD2ZPXZZG),com.loom.desktop.helper',
        '500,6,80,Mem Helper,Mem Helper,Developer ID Application: Kevin Moody (9ZLK8RSRVN),org.memlabs.Mem.helper',
        '500,6,80,ngrok,ngrok,Developer ID Application: ngrok LLC (TEX8MHRDQ9),a.out',
        '500,6,80,node,node,Developer ID Application: Node.js Foundation (HX7739G8FX),node',
        '500,6,80,rpi-imager,rpi-imager,Developer ID Application: Floris Bos (WYH7G79LM6),org.raspberrypi.imagingutility',
        '500,6,80,Signal Helper (Renderer),Signal Helper (Renderer),Developer ID Application: Quiet Riddle Ventures LLC (U68MSDN6DR),org.whispersystems.signal-desktop.helper.Renderer',
        '500,6,80,Sky Go,Sky Go,Developer ID Application: Sky UK Limited (GJ24C8864F),com.bskyb.skygoplayer',
        '500,6,80,Slack Helper,Slack Helper,Apple Mac OS Application Signing,com.tinyspeck.slackmacgap.helper',
        '500,6,80,Snagit 2020,Snagit 2020,Apple Mac OS Application Signing,com.TechSmith.Snagit2020',
        '500,6,80,Snagit 2023,Snagit 2023,Developer ID Application: TechSmith Corporation (7TQL462TU8),com.TechSmith.Snagit2023',
        '500,6,80,Snagit 2024,Snagit 2024,Developer ID Application: TechSmith Corporation (7TQL462TU8),com.TechSmith.Snagit2024',
        '500,6,80,SnagitHelper2020,SnagitHelper2020,Apple Mac OS Application Signing,com.techsmith.snagit.capturehelper2020',
        '500,6,80,SnagitHelper2023,SnagitHelper2023,Developer ID Application: TechSmith Corporation (7TQL462TU8),com.techsmith.snagit.capturehelper2023',
        '500,6,80,Spark Desktop Helper,Spark Desktop Helper,Developer ID Application: Readdle Technologies Limited (3L68KQB4HG),com.readdle.SparkDesktop.helper',
        '500,6,80,Spotify,Spotify,Developer ID Application: Spotify (2FNC3A47ZF),com.spotify.client',
        '500,6,80,Telegram,Telegram,Apple Mac OS Application Signing,ru.keepcoder.Telegram',
        '500,6,80,thunderbird,thunderbird,Defveloper ID Application: Mozilla Corporation (43AQ936H96),org.mozilla.thunderbird',
        '500,6,80,TIDAL Helper,TIDAL Helper,Developer ID Application: TIDAL Music AS (GK2243L7KB),com.tidal.desktop.helper',
        '500,6,80,Twitter,Twitter,Apple Mac OS Application Signing,maccatalyst.com.atebits.Tweetie2',
        '500,6,80,Wavebox Helper,Wavebox Helper,Developer ID Application: Bookry Ltd (4259LE8SU5),com.bookry.wavebox.helper',
        '500,6,80,WhatsApp,WhatsApp,Developer ID Application: WhatsApp Inc. (57T9237FN3),WhatsApp',
        '500,6,9123,Elgato Control Center,Elgato Control Center,Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5),com.corsair.ControlCenter',
        '500,6,993,Mimestream,Mimestream,Developer ID Application: Mimestream, LLC (P2759L65T8),com.mimestream.Mimestream',
        '500,6,993,Spark Desktop Helper,Spark Desktop Helper,Developer ID Application: Readdle Technologies Limited (3L68KQB4HG),com.readdle.SparkDesktop.helper',
        '500,6,993,thunderbird,thunderbird,Developer ID Application: Mozilla Corporation (43AQ936H96),org.mozilla.thunderbird',
        '500,6,995,KakaoTalk,KakaoTalk,Apple Mac OS Application Signing,com.kakao.KakaoTalkMac'
      ) -- Useful for unsigned binaries
      AND NOT alt_exception_key IN (
        '0,6,80,tailscaled,tailscaled,500u,80g',
        '500,6,22,ssh,ssh,0u,500g',
        '500,6,5432,psql,psql,500u,80g',
        '500,6,22,ssh,ssh,500u,0g',
        '500,17,123,limactl,limactl,500u,80g',
        '500,17,123,gvproxy,gvproxy,500u,80g',
        '500,6,80,qemu-system-x86_64,qemu-system-x86_64,500u,80g',
        '500,6,22,ssh,ssh,500u,20g',
        '500,6,22,ssh,ssh,500u,80g',
        '500,6,80,git-remote-http,git-remote-http,500u,20g',
        '500,6,3307,cloud_sql_proxy,cloud_sql_proxy,0u,0g',
        '500,6,3307,cloud-sql-proxy,cloud-sql-proxy,500u,20g',
        '500,6,3307,cloud_sql_proxy,cloud_sql_proxy,500u,20g',
        '500,6,80,chainlink,chainlink,500u,20g',
        '500,6,80,copilot-agent-macos-arm64,copilot-agent-macos-arm64,500u,20g',
        '500,6,80,firefox,firefox,500u,20g',
        '500,6,80,qemu-system-aarch64,qemu-system-aarch64,500u,80g'
      )
      AND NOT alt_exception_key LIKE '500,6,22,packer-plugin-amazon%,packer-plugin-amazon_%,500u,20g'
      AND NOT (
        alt_exception_key LIKE '500,6,%,syncthing,syncthing,0u,500g'
        AND remote_port > 79
      )
      AND NOT (
        alt_exception_key LIKE '500,6,%,nuclei,nuclei,500u,80g'
        AND remote_port > 20
        AND remote_port < 32000
      )
      AND NOT (
        exception_key LIKE '500,6,%,syncthing,syncthing,Developer ID Application: Kastelo AB (LQE5SYM783),syncthing'
        AND remote_port > 24
      )
      AND NOT (
        exception_key LIKE '500,6,%,syncthing,syncthing,Developer ID Application: Jakob Borg (LQE5SYM783),syncthing'
        AND remote_port > 24
      )
      AND NOT (
        alt_exception_key = '500,6,80,main,main,500u,20g'
        AND p0.path LIKE '/var/folders/%/T/go-build%/b001/exe/main'
      ) -- Wider
      AND NOT (
        (
          pos.remote_port IN (80, 123, 587, 999)
          OR pos.remote_port > 1024
        )
        AND id_exception_key IN (
          'Apple Mac OS Application Signing,com.microsoft.OneDrive-mac',
          'Apple Mac OS Application Signing,com.ookla.speedtest-macos',
          'Apple Mac OS Application Signing,net.whatsapp.WhatsApp.ServiceExtension',
          'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF),com.adguard.mac.adguard.network-extension',
          'Developer ID Application: Adobe Inc. (JQ525L2MZD),com.adobe.AdobeResourceSynchronizer',
          'Developer ID Application: Adobe Inc. (JQ525L2MZD),com.adobe.lightroomCC',
          'Developer ID Application: Adobe Inc. (JQ525L2MZD),com.adobe.Reader',
          'Developer ID Application: Bitdefender SRL (GUNFMW623Y),com.bitdefender.cst.net.dci.dci-network-extension',
          'Developer ID Application: Bookry Ltd (4259LE8SU5),com.bookry.wavebox.helper',
          'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4),com.brave.Browser.helper',
          'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4),com.brave.Browser.nightly.helper',
          'Developer ID Application: Cisco (DE8Y96K9QP),Cisco-Systems.SparkHelper',
          'Developer ID Application: Cloudflare Inc. (68WVV388M8),CloudflareWARP',
          'Developer ID Application: Docker Inc (9BNSXJN65R),com.docker',
          'Developer ID Application: Docker Inc (9BNSXJN65R),com.docker.docker',
          'Developer ID Application: Epic Games International, S.a.r.l. (96DBZ92D3Y),com.epicgames.EpicGamesLauncher',
          'Developer ID Application: Epic Games International, S.a.r.l. (96DBZ92D3Y),com.epicgames.UE4EditorServices',
          'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK),fctupdate',
          'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D),com.googlecode.iterm2',
          'Developer ID Application: Google LLC (EQHXZ8M8AV),com.google.Chrome.helper',
          'Developer ID Application: Google LLC (EQHXZ8M8AV),com.google.GoogleUpdater',
          'Developer ID Application: Google LLC (EQHXZ8M8AV),com.google.one.NetworkExtension',
          'Developer ID Application: GUILHERME RAMBO (8C7439RJLG),codes.rambo.AirBuddy.MobileDevicesService',
          'Developer ID Application: Loom, Inc (QGD2ZPXZZG),com.loom.desktop',
          'Developer ID Application: Microsoft Corporation (UBF8T346G9),com.microsoft.edgemac.helper',
          'Developer ID Application: Microsoft Corporation (UBF8T346G9),com.microsoft.teams2.helper',
          'Developer ID Application: Microsoft Corporation (UBF8T346G9),com.microsoft.VSCode.helper',
          'Developer ID Application: Microsoft Corporation (UBF8T346G9),net.java.openjdk.java',
          'Developer ID Application: Mozilla Corporation (43AQ936H96),org.mozilla.firefox',
          'Developer ID Application: Mozilla Corporation (43AQ936H96),org.mozilla.firefoxdeveloperedition',
          'Developer ID Application: Mozilla Corporation (43AQ936H96),org.mozilla.thunderbird',
          'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R),at.obdev.littlesnitch.networkextension',
          'Developer ID Application: Opera Software AS (A2P9LX4JPN),com.operasoftware.Opera.helper',
          'Developer ID Application: Oracle America, Inc. (VB5E2TV963),net.java.openjdk.java',
          'Developer ID Application: Parallels International GmbH (4C6364ACXT),com.parallels.naptd',
          'Developer ID Application: Private Internet Access, Inc. (5357M5NW9W),com.privateinternetaccess.vpn',
          'Developer ID Application: Red Hat, Inc. (HYSCB8KRL2),gvproxy',
          'Developer ID Application: Shanghai Lunkuo Technology Co., Ltd (T3UBR9Y3B2),com.bambulab.bambu-studio',
          'Developer ID Application: Skype Communications S.a.r.l (AL798K98FX),com.skype.skype.Helper',
          'Developer ID Application: Slack Technologies, Inc. (BQR82RBBHL),com.tinyspeck.slackmacgap.helper',
          'Developer ID Application: Spotify (2FNC3A47ZF),com.spotify.client',
          'Developer ID Application: Spotify (2FNC3A47ZF),com.spotify.client.helper',
          'Developer ID Application: Tailscale Inc. (W5364U7YZB),io.tailscale.ipn.macsys.network-extension',
          'Developer ID Application: TechSmith Corporation (7TQL462TU8),com.techsmith.camtasia2024',
          'Developer ID Application: TechSmith Corporation (7TQL462TU8),com.techsmith.snagit.capturehelper2020',
          'Developer ID Application: TechSmith Corporation (7TQL462TU8),com.techsmith.snagit.capturehelper2024',
          'Developer ID Application: The Browser Company of New York Inc. (S6N382Y83G),company.thebrowser.Browser',
          'Developer ID Application: The Browser Company of New York Inc. (S6N382Y83G),company.thebrowser.browser.helper',
          'Developer ID Application: Valve Corporation (MXGJJ98X76),com.valvesoftware.steam',
          'Developer ID Application: Valve Corporation (MXGJJ98X76),com.valvesoftware.steam.helper',
          'Developer ID Application: Vivaldi Technologies AS (4XF3XNRN6Y),com.vivaldi.Vivaldi.helper',
          'Developer ID Application: Vladimir Prelovac (TFVG979488),com.apple.WebKit.Networking',
          'Developer ID Application: WhatsApp Inc. (57T9237FN3),net.whatsapp.WhatsApp',
          'Developer ID Application: WhatsApp Inc. (57T9237FN3),net.whatsapp.WhatsApp.ServiceExtension',
          'Developer ID Application: Wizards of the Coast LLC (63JKFDP62M),com.wizards.mtga',
          'Developer ID Application: Zed Industries, Inc. (MQ55VZLNZQ),dev.zed.Zed-Preview',
          'Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3),us.zoom.xos',
          'Developer ID Application: Zwift, Inc (C2GM8Y9VFM),ZwiftAppSilicon'
        )
      )
    GROUP BY
      p0.cmdline
  tags: transient, state, net, often
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Surface when a machine has downloaded an unusual number of files from
    Google Drive
  discard_data: false
  interval: 3600
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - collection - excess-google-drive-downloads-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Surface when a machine has downloaded an unusual number of files from Google Drive
    --
    -- platform: darwin
    -- tags: persistent filesystem spotlight
    -- interval: 3600
    SELECT
      COUNT(DISTINCT file.path) AS num_downloads,
      GROUP_CONCAT(DISTINCT file.path) AS paths,
      SUM(file.size) AS total_size,
      MIN(file.btime) AS first_btime,
      MAX(file.atime) AS last_atime
    FROM
      mdfind
      JOIN file ON mdfind.path = file.path
      JOIN extended_attributes ea ON mdfind.path = ea.path
      AND ea.key = "where_from"
    WHERE
      query = "kMDItemFSCreationDate >= $time.now(-86400)"
      -- For some reason relying on kMDItemWhereFroms omitted download word docs, so
      -- this does it the slow way.
      AND ea.value LIKE "https://doc-%googleusercontent.com%"
      -- this seems excessive, but I was having issues with kMDItemFSCreationDate not filtering appropriately
      AND MAX(file.btime, file.ctime, file.mtime) > (strftime('%s', 'now') -86400)
      -- Common, low-risk for exfil
      AND file.filename NOT LIKE '%.csv'
      -- "GROUP BY" should be unnecessary, but Kolide seems to require it
    GROUP BY
      ea.key
    HAVING
      num_downloads > 8
  tags: persistent, filesystem, spotlight
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Surface when a machine has downloaded an unusual number of zip exports
    from Google Drive
  discard_data: false
  interval: 3600
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - collection - excess-google-drive-folder-exports-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Surface when a machine has downloaded an unusual number of zip exports from Google Drive
    --
    -- platform: darwin
    -- tags: persistent filesystem spotlight
    -- interval: 3600
    SELECT
      COUNT(DISTINCT file.path) AS num_exports,
      GROUP_CONCAT(DISTINCT file.path) AS paths,
      SUM(file.size) AS total_size,
      MIN(file.btime) AS first_btime,
      MAX(file.atime) AS last_atime
    FROM
      mdfind
      JOIN file ON mdfind.path = file.path
      JOIN hash ON file.path = hash.path
      JOIN extended_attributes ea ON mdfind.path = ea.path
    WHERE
      mdfind.query = "kMDItemWhereFroms == 'https://*-drive-data-export.googleusercontent.com*' AND 'kMDItemFSCreationDate >= $time.now(-604800)'"
      -- this seems excessive, but I was having issues with kMDItemFSCreationDate not filtering appropriately
      AND MAX(file.btime, file.ctime, file.mtime) > (strftime('%s', 'now') -604800)
      -- "GROUP BY" should be unnecessary, but Kolide seems to require it
    GROUP BY
      ea.key
    HAVING
      total_size > (100 * 1024 * 1024)
      OR num_exports > 1
    ORDER BY
      file.path ASC
  tags: persistent, filesystem, spotlight
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Programs which are writing an unusually large amount of data
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - collection - high-disk-bytes-written
  observer_can_run: false
  platforms: ''
  query: |
    -- Programs which are writing an unusually large amount of data
    --
    -- Can be used to detect ransomware
    --
    -- false positives:
    --   * Package managers
    --   * Backup software
    --   * Build tools
    --
    -- references:
    --   * https://attack.mitre.org/tactics/TA0009/ (Collection)
    --
    -- tags: transient process
    SELECT
      -- WARNING: Writes to tmpfs are not reflected against this counter
      p0.disk_bytes_written AS bytes_written,
      (strftime('%s', 'now') - p0.start_time) AS age,
      p0.disk_bytes_written / (strftime('%s', 'now') - p0.start_time) AS bytes_written_rate,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cgroup_path AS p0_cgroup,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      -- On my Linux machine, creating a gzip archive clocks in at 6780210
      bytes_written_rate > 4000000
      AND age > 180
      AND p0.pid > 2
      AND p0.parent != 2
      AND p0.path NOT IN (
        '/Library/Application Support/Adobe/Adobe Desktop Common/HDBox/Setup',
        '/bin-busybox',
        '/bin/bash',
        '/bin/sh',
        '/opt/homebrew/bin/qemu-system-aarch64',
        '/opt/osquery/lib/osquery.app/Contents/MacOS/osqueryd',
        '/usr/bin/apt',
        '/usr/bin/aptd',
        '/usr/bin/bash',
        '/usr/bin/bwrap',
        '/usr/bin/curl',
        '/usr/bin/darktable',
        '/usr/bin/dockerd',
        '/usr/bin/fish',
        '/usr/bin/git',
        '/usr/bin/gnome-disks',
        '/usr/bin/gnome-shell',
        '/usr/bin/gnome-software',
        '/usr/bin/gnome-text-editor',
        '/usr/bin/make',
        '/usr/bin/melange',
        '/usr/bin/pacman',
        '/usr/bin/qemu-system-x86_64',
        '/usr/bin/yay',
        '/usr/bin/zsh',
        '/usr/lib/baloo_file',
        '/usr/lib/baloo_file_extractor',
        '/usr/lib/flatpak-system-helper',
        '/usr/lib/snapd/snapd',
        '/usr/lib/systemd/systemd',
        '/usr/lib/systemd/systemd-journald',
        '/usr/lib64/thunderbird/thunderbird',
        '/usr/libexec/coreduetd',
        '/usr/libexec/flatpak-system-helper',
        '/usr/libexec/logd_helper',
        '/usr/libexec/packagekitd',
        '/usr/libexec/rosetta/oahd',
        '/usr/libexec/secd',
        '/usr/libexec/sharingd',
        '/usr/sbin/screencapture',
        '/usr/share/spotify-client/spotify'
      )
      AND NOT (
        p0.name LIKE 'jbd%/dm-%'
        AND p0.on_disk = -1
      )
      AND NOT (
        p0.name = 'bindfs'
        AND p0.cmdline LIKE 'bindfs -f -o fsname=%'
      )
      AND NOT (
        p0.name = 'btrfs-transaction'
        AND p0.on_disk = -1
      )
      AND NOT (
        p0.name = 'kernel_task'
        AND p0.path = ''
        AND p0.parent IN (0, 1)
        AND p0.on_disk = -1
      )
      AND NOT (
        p0.name = 'launchd'
        AND p0.path = '/sbin/launchd'
        AND p0.parent = 0
      )
      AND NOT (
        p0.name = 'logd'
        AND p0.cmdline = '/usr/libexec/logd'
        AND p0.parent = 1
      )
      AND NOT (
        p0.name = 'aptd'
        AND p0.cmdline = '/usr/bin/python3 /usr/sbin/aptd'
      )
      AND NOT p0.name IN (
        'GoogleUpdater',
        'Install',
        'baloo_file_extr',
        'bincapz',
        'bwrap',
        'cargo',
        'chrome',
        'code',
        'com.apple.MobileSoftwareUpdate.UpdateBrainService',
        'com.apple.NRD.UpdateBrainService',
        'containerd',
        'containerd-',
        'containerd-shim',
        'darkfiles',
        'dlv',
        'dnf',
        'dnf-automatic',
        'docker-index',
        'esbuild',
        'firefox',
        'osqueryd',
        'flatpak-session',
        'fsdaemon',
        'git',
        'go',
        'goland',
        'golangci-lint-v',
        'gopls',
        'qemu-system-x86',
        'grype',
        'idea',
        'java',
        'jetbrains-toolb',
        'kandji-daemon',
        'launcher',
        'limactl',
        'logioptionsplus_updater',
        'mediawriter',
        'melange',
        'melange-run',
        'monorail',
        'nessusd',
        'ninja',
        'node',
        'photorec',
        'qemu-system-aarch64',
        'qemu-system-x86_64',
        'rpm-ostree',
        'rsync',
        'rust-analyzer',
        'rustup',
        'slack',
        'snyk',
        'snyk-macos',
        'spotify',
        'staticcheck',
        'steam',
        'steam_osx',
        'syft',
        'terraform',
        'terraform-provider-apko',
        'tmux:server',
        'tracker-miner-f',
        'trivy',
        'trivy-db',
        'unattended-upgr',
        'wineserver',
        'wolfictl',
        'yum'
      )
      AND p0.path NOT LIKE '/Applications/%.app/Contents/%'
      AND p0.path NOT LIKE '/home/%/.local/share/Steam'
      AND p0.path NOT LIKE '/nix/store/%/bin/%sh'
      AND p0.path NOT LIKE '/nix/store/%/bin/nix'
      AND p0.path NOT LIKE '/System/Applications/%'
      AND p0.path NOT LIKE "%/terraform-provider-%"
      AND p0.path NOT LIKE '/System/Library/%'
      AND p0.path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
      AND p0.path NOT LIKE '/var/kolide-k2/%/osqueryd'
      AND p0.path NOT LIKE '/nix/store/%kolide-launcher-%/bin/launcher'
      AND NOT p0.cmdline LIKE '%/lib/gcloud.py components update'
      AND NOT p0.cmdline LIKE '%/gsutil %rsync%'
      AND NOT p0.cmdline LIKE '%brew.rb upgrade'
      AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
  tags: transient, process
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find database exports. Will need tuning based on your table names.
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - collection - spotlight-database-export-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find database exports. Will need tuning based on your table names.
    --
    -- false positives:
    --   * none observed
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1530/ (Data from Cloud Storage Object )
    --
    -- platform: darwin
    -- tags: persistent filesystem spotlight
    SELECT
      f.path,
      f.size,
      datetime(f.btime, 'unixepoch') AS file_created,
      magic.data
    FROM
      file f
      JOIN mdfind ON mdfind.path = f.path
      LEFT JOIN magic ON f.path = magic.path
    WHERE
      (
        (
          mdfind.query = 'kMDItemFSName == ''*enforce*'' && kMDItemTextContent == ''CREATE TABLE'''
        )
        OR (
          mdfind.query = 'kMDItemFSName == ''*iam*'' && kMDItemTextContent == ''CREATE TABLE'''
        )
        OR (
          mdfind.query = 'kMDItemFSName == ''*tenant*'' && kMDItemTextContent == ''CREATE TABLE'''
        )
      )
      AND f.path NOT LIKE '%mysql-test/suite/%'
      AND f.path NOT LIKE '%.json'
      AND f.path NOT LIKE '%.log'
      AND f.size > 32768
  tags: persistent, filesystem, spotlight
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find programs that are sniffing keyboard events on macOS
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - credentials - macos_keyboard_sniffer
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find programs that are sniffing keyboard events on macOS
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1056/001/ (Input Capture: Keylogging)
    --
    -- platform: darwin
    -- tags: persistent state sniffer
    SELECT
      et.enabled,
      et.process_being_tapped,
      et.tapping_process,
      CONCAT (
        REPLACE(
          p0.path,
          RTRIM(p0.path, REPLACE(p0.path, '/', '')),
          ''
        ),
        ',',
        s.identifier,
        ',',
        s.authority
      ) AS exception_key,
      ---
      s.authority,
      s.identifier,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      event_taps et
      LEFT JOIN processes p0 ON et.tapping_process = p0.pid
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      et.event_tapped IN ('EventKeyDown', 'EventKeyUp')
      AND s.authority != 'Software Signing' -- Popular programs that sniff keyboard events, but do not appear to be malware.
      AND NOT exception_key IN (
        'Alfred,com.runningwithcrayons.Alfred,Developer ID Application: Running with Crayons Ltd (XZZXE9SED4)',
        'BetterDisplay,pro.betterdisplay.BetterDisplay,Developer ID Application: Istvan Toth (299YSU96J7)',
        'BetterTouchTool,com.hegenberg.BetterTouchTool,Developer ID Application: folivora.AI GmbH (DAFVSXZ82P)',
        'Contexts,com.contextsformac.Contexts,Developer ID Application: Usman Khalid (RZ7E748ZSC)',
        'Grammarly Desktop,com.grammarly.ProjectLlama,Developer ID Application: Grammarly, Inc (W8F64X92K3)',
        'HueSync,com.lighting.huesync,Developer ID Application: Signify Netherlands B.V. (PREPN2W95S)',
        'Hyperkey,com.knollsoft.Hyperkey,Developer ID Application: Ryan Hanson (XSYZ3E4B7D)',
        'Lunar,fyi.lunar.Lunar,Developer ID Application: Alin Panaitiu (RDDXV84A73)',
        'MonitorControl,me.guillaumeb.MonitorControl,Developer ID Application: Joni Van Roost (CYC8C8R4K9)',
        'Rocket,net.matthewpalmer.Rocket,Developer ID Application: Matthew Palmer (Z4JV2M65MH)',
        'Superkey,com.knollsoft.Superkey,Developer ID Application: Ryan Hanson (XSYZ3E4B7D)',
        'TextExpander,com.smileonmymac.textexpander,Developer ID Application: SmileOnMyMac, LLC (7PKJ6G4DXL)',
        'iTerm2,com.googlecode.iterm2,Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'lghub_agent,com.logi.ghub.agent,Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'logioptionsplus_agent,com.logi.cp-dev-mgr,Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'osqueryd,io.osquery.agent,Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'polyrecorder,polyrecorder,Developer ID Application: Adam Pietrasiak (SXF593CX2N)',
        'skhd,skhd,',
        'LinearMouse,com.lujjjh.LinearMouse,Developer ID Application: Jiahao Lu (C5686NKYJ7)',
        'synergy-core,synergy-core,Developer ID Application: Symless Ltd (4HX897Y6GJ)'
      )
    GROUP BY
      p0.path
  tags: persistent, state, sniffer
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Detects unexpected programs opening files in /dev on Linux
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - credentials - unexpected-dev-opener-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Detects unexpected programs opening files in /dev on Linux
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1056/001/ (Input Capture: Keylogging)
    --
    -- false positives:
    --   * any program which needs access to device drivers
    --
    -- platform: linux
    -- tags: persistent state sniffer
    SELECT
      pof.path AS device,
      CONCAT (
        IIF(
          REGEX_MATCH (
            TRIM(REPLACE(pof.path, ' (deleted)', '')),
            '(/dev/.*)[\d ]+$',
            1
          ) != '',
          REGEX_MATCH (
            TRIM(REPLACE(pof.path, ' (deleted)', '')),
            '(/dev/.*)[\d ]+$',
            1
          ),
          TRIM(REPLACE(pof.path, ' (deleted)', ''))
        ),
        ',',
        REPLACE(
          p0.path,
          RTRIM(p0.path, REPLACE(p0.path, '/', '')),
          ''
        )
      ) AS path_exception,
      CONCAT (
        TRIM(
          REPLACE(
            pof.path,
            CONCAT (
              '/',
              REPLACE(
                pof.path,
                RTRIM(pof.path, REPLACE(pof.path, '/', '')),
                ''
              )
            ),
            ''
          )
        ),
        ',',
        REPLACE(
          p0.path,
          RTRIM(p0.path, REPLACE(p0.path, '/', '')),
          ''
        )
      ) AS dir_exception,
      -- Child
      p0.pid AS p0_pid,
      p0.start_time AS p0_start,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_files pof
      LEFT JOIN processes p0 ON pof.pid = p0.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      pof.path LIKE '/dev/%'
      AND pof.path NOT IN (
        '/dev/dri/card0',
        '/dev/dri/card1',
        '/dev/dri/card2',
        '/dev/dri/renderD128',
        '/dev/dri/renderD129',
        '/dev/fuse',
        '/dev/io8log',
        '/dev/io8logmt',
        '/dev/io8logtemp',
        '/dev/null',
        '/dev/nvidia-modeset',
        '/dev/nvidia-uvm',
        '/dev/nvidia0',
        '/dev/nvidiactl',
        '/dev/ptmx',
        '/dev/pts/ptmx',
        '/dev/shm/u1000-ValveIPCSharedObj-Steam',
        '/dev/random',
        '/dev/rfkill',
        '/dev/snd/seq',
        '/dev/urandom',
        '/dev/vga_arbiter',
        '/dev/video10' -- workaround for poor regex management (ffmpeg)
      )
      AND pof.path NOT LIKE '/dev/pts/%'
      AND pof.path NOT LIKE '/dev/snd/%'
      AND pof.path NOT LIKE '/dev/tty%'
      AND pof.path NOT LIKE '/dev/hidraw%'
      AND pof.path NOT LIKE '/dev/shm/.com.google.Chrome.%'
      AND pof.path NOT LIKE '/dev/shm/.org.chromium.Chromium.%'
      -- Zoom
      AND pof.path NOT LIKE '/dev/shm/aomshm.%'
      AND pof.path NOT LIKE '/dev/shm/authentik_%'
      AND NOT dir_exception IN (
        '/dev/bus/usb,pcscd',
        '/dev/input,acpid',
        '/dev/input,gnome-shell',
        '/dev/input,Hyprland',
        '/dev/input,kwin_wayland',
        '/dev/input,systemd',
        '/dev/input,systemd-logind',
        '/dev/input,thermald',
        '/dev/input,upowerd',
        '/dev/input,Xorg',
        '/dev/net,tailscaled',
        '/dev/net,.tailscaled-wrapped',
        '/dev/net/tun,qemu-system-x86_64',
        '/dev/shm,1password',
        '/dev/shm,Brackets',
        '/dev/shm,chrome',
        '/dev/shm,code',
        '/dev/shm,electron',
        '/dev/shm,firefox',
        '/dev/shm,gameoverlayui',
        '/dev/shm,gopls',
        '/dev/shm,hl2_linux',
        '/dev/shm,Hyprland',
        '/dev/shm,java',
        '/dev/shm,jcef_helper',
        '/dev/shm,Melvor Idle',
        '/dev/shm,osqueryd',
        '/dev/shm,reaper',
        '/dev/shm,slack',
        '/dev/shm,spotify',
        '/dev/shm,steam',
        '/dev/shm,steamwebhelper',
        '/dev/shm,Tabletop Simulator.x86_64',
        '/dev/shm,wine64-preloader',
        '/dev/shm,winedevice.exe',
        '/dev/shm,xdg-desktop-portal-hyprland',
        '/dev/snd,alsactl',
        '/dev/snd,pipewire',
        '/dev/snd,pulseaudio',
        '/dev/snd,.pulseaudio-wrapped',
        '/dev/snd,wireplumber',
        '/dev/usb,apcupsd',
        '/dev/usb,upowerd'
      )
      AND NOT path_exception IN (
        '/dev/autofs,systemd',
        '/dev/console,agetty',
        '/dev/cpu/0/msr,nvidia-powerd',
        '/dev/drm_dp_aux,fwupd',
        '/dev/fb,Xorg',
        '/dev/hidraw,chrome',
        '/dev/hvc,agetty',
        '/dev/hwrng,rngd',
        '/dev/input/event,thermald',
        '/dev/input/event,touchegg',
        '/dev/input/event,Xorg',
        '/dev/kmsg,bpfilter_umh',
        '/dev/kmsg,dmesg',
        '/dev/kmsg,k3s',
        '/dev/kmsg,_k3s-inner',
        '/dev/kmsg,kubelet',
        '/dev/kmsg,systemd',
        '/dev/kmsg,systemd-coredump',
        '/dev/kmsg,systemd-journald',
        '/dev/kvm,qemu-system-x86_64',
        '/dev/mapper/control,dockerd',
        '/dev/mapper/control,gpartedbin',
        '/dev/mapper/control,multipathd',
        '/dev/mcelog,mcelog',
        '/dev/media0,pipewire',
        '/dev/media0,wireplumber',
        '/dev/media,pipewire',
        '/dev/media,wireplumber',
        '/dev/net/tun,openvpn',
        '/dev/net/tun,qemu-system-x86_64',
        '/dev/net/tun,slirp4netns',
        '/dev/pts,incusd',
        '/dev/sda,ntfs-3g',
        '/dev/shm/envoy_shared_memory_1,envoy',
        '/dev/tpmrm,launcher',
        '/dev/udmabuf,gnome-shell-portal-helper',
        '/dev/tty,agetty',
        '/dev/tty,gdm-wayland-session',
        '/dev/tty,gdm-x-session',
        '/dev/tty,systemd-logind',
        '/dev/tty,Xorg',
        '/dev/uhid,bluetoothd',
        '/dev/uinput,bluetoothd',
        '/dev/usb/hiddev,apcupsd',
        '/dev/usb/hiddev,upowerd',
        '/dev/vhost-net,qemu-system-x86_64',
        '/dev/vhost-vsock,qemu-system-x86_64',
        '/dev/video0,chrome',
        '/dev/video,brave',
        '/dev/video,cheese',
        '/dev/video,chrome',
        '/dev/video,ffmpeg',
        '/dev/video,firefox',
        '/dev/video,firefox-bin',
        '/dev/video,guvcview',
        '/dev/video,obs',
        '/dev/video,obs-ffmpeg-mux',
        '/dev/video,pipewire',
        '/dev/video,signal-desktop',
        '/dev/video,slack',
        '/dev/video,v4l2-relayd',
        '/dev/video,vlc',
        '/dev/video,wireplumber',
        '/dev/video,zoom',
        '/dev/video,zoom.real',
        '/dev/wwan0mbim,mbim-proxy',
        '/dev/zfs,',
        '/dev/zfs,zed',
        '/dev/zfs,zfs',
        '/dev/zfs,zpool'
      )
      -- Halflife
      AND path_exception NOT LIKE '/dev/shm/u1000-Shm_%,bash'
      -- lvmdbusd / gcloud / gsutil
      AND path_exception NOT LIKE '/dev/shm/pym-%python3%'
      -- celery
      AND path_exception NOT LIKE '/dev/shm/pymp-%,python3.%'
      AND dir_exception NOT LIKE '/dev/shm/byobu-%/status.tmux,'
      AND NOT (
        pof.path = "/dev/uinput"
        AND p0.name LIKE "solaar%"
        AND p0.path LIKE '/usr/bin/python%'
      )
      AND NOT (
        pof.path LIKE "/dev/input/event%"
        AND p0.name = "openrazer-daemo"
      )
      AND NOT (
        pof.path LIKE '/dev/bus/usb/%'
        AND p0.name IN (
          'adb',
          'fprintd',
          'fwupd',
          'gphoto2',
          'gvfsd-gphoto2',
          'gvfsd-mtp',
          'gvfs-gphoto2-vo',
          'gvfs-gphoto2-volume-monitor',
          'pcscd',
          'streamdeck',
          'usbmuxd'
        )
      )
    GROUP BY
      pof.pid
  tags: persistent, state, sniffer
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Detects unexpected programs opening files in /dev on Linux
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - credentials - unexpected-dev-opener-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Detects unexpected programs opening files in /dev on Linux
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1056/001/ (Input Capture: Keylogging)
    --
    -- platform: darwin
    -- tags: persistent state sniffer
    SELECT
      pof.pid,
      pof.path AS device,
      s.authority,
      s.identifier,
      CONCAT (
        IIF(
          REGEX_MATCH (pof.path, '(/dev/.*)\d+$', 1) != '',
          REGEX_MATCH (pof.path, '(/dev/.*)\d+', 1),
          pof.path
        ),
        ',',
        REPLACE(
          p0.path,
          RTRIM(p0.path, REPLACE(p0.path, '/', '')),
          ''
        ),
        ',',
        s.authority,
        ',',
        s.identifier
      ) AS exception_key,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_files pof
      LEFT JOIN processes p0 ON pof.pid = p0.pid
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      pof.path LIKE '/dev/%'
      AND pof.path NOT IN (
        '/dev/null',
        '/dev/ptmx',
        '/dev/random',
        '/dev/zero',
        '/dev/tty',
        '/dev/urandom'
      )
      AND pof.path NOT LIKE '/dev/ttys%'
      -- Assume SIP
      AND p0.path NOT LIKE '/System/%'
      AND p0.path NOT LIKE '/usr/libexec/%'
      AND p0.path NOT LIKE '/usr/sbin/%'
      AND exception_key NOT IN (
        '/dev/afsc_type,revisiond,Software Signing,com.apple.revisiond',
        '/dev/auditpipe,ir_agent,Developer ID Application: Rapid7 LLC (UL6CGN7MAL),ir_agent',
        '/dev/auditpipe,osqueryd,Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF),io.osquery.agent',
        '/dev/auditpipe,osqueryd,Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF),osqueryd',
        '/dev/auditsessions,GSSCred,Software Signing,com.apple.GSSCred',
        '/dev/bpf,packetbeat,Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z),packetbeat',
        '/dev/auditsessions,TouchBarServer,Software Signing,com.apple.touchbarserver',
        '/dev/auditsessions,authd,Software Signing,com.apple.authd',
        '/dev/auditsessions,securityd,Software Signing,com.apple.securityd',
        '/dev/autofs,automountd,Software Signing,com.apple.automountd',
        '/dev/bpf,BDLDaemon,Developer ID Application: Bitdefender SRL (GUNFMW623Y),com.bitdefender.epsecurity.BDLDaemonApp',
        '/dev/bpf,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/bpf,core,Developer ID Application: TPZ Solucoes Digitais Ltda (X37R283V2T),com.topaz.warsaw.core',
        '/dev/bpf,packetbeat,Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z),packetbeat',
        '/dev/console,dbeaver,Developer ID Application: DBeaver Corporation (42B6MDKMW8),org.jkiss.dbeaver.core.product',
        '/dev/console,kernelmanagerd,Software Signing,com.apple.kernelmanagerd',
        '/dev/console,launchd,Software Signing,com.apple.xpc.launchd',
        '/dev/console,launchd_sim,Software Signing,com.apple.xpc.launchd',
        '/dev/cu.BLTH,bluetoothd,Software Signing,com.apple.bluetoothd',
        '/dev/io,ControlCenter,Software Signing,com.apple.controlcenter',
        '/dev/bpf,MHLinkServer,Developer ID Application: Metric Halo Distribution, Inc. (X7EY8SFM86),com.mhlabs.mhlink.server',
        '/dev/io,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',
        '/dev/io,WiFiAgent,Software Signing,com.apple.wifi.WiFiAgent',
        '/dev/io,WirelessRadioManagerd,Software Signing,com.apple.WirelessRadioManagerd',
        '/dev/io,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/io,symptomsd,Software Signing,com.apple.symptomsd',
        '/dev/io8log,ControlCenter,Software Signing,com.apple.controlcenter',
        '/dev/io8log,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',
        '/dev/io8log,WiFiAgent,Software Signing,com.apple.wifi.WiFiAgent',
        '/dev/io8log,WirelessRadioManagerd,Software Signing,com.apple.WirelessRadioManagerd',
        '/dev/io8log,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/io8log,symptomsd,Software Signing,com.apple.symptomsd',
        '/dev/io8logmt,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/io8logtemp,ControlCenter,Software Signing,com.apple.controlcenter',
        '/dev/io8logtemp,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',
        '/dev/io8logtemp,WiFiAgent,Software Signing,com.apple.wifi.WiFiAgent',
        '/dev/io8logtemp,WirelessRadioManagerd,Software Signing,com.apple.WirelessRadioManagerd',
        '/dev/io8logtemp,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/io8logtemp,symptomsd,Software Signing,com.apple.symptomsd',
        '/dev/kbfuse,kbfs,Developer ID Application: Keybase, Inc. (99229SGT5K),kbfs',
        '/dev/kbfuse,keybase-redirector,Developer ID Application: Keybase, Inc. (99229SGT5K),keybase-redirector',
        '/dev/klog,syslogd,Software Signing,com.apple.syslogd',
        '/dev/macfuse,gcsfuse,,a.out',
        '/dev/macfuse,rclone,,a.out',
        '/dev/auditpipe,osqueryd,,',
        '/dev/oslog,logd,Software Signing,com.apple.logd',
        '/dev/pf,CloudflareWARP,Developer ID Application: Cloudflare Inc. (68WVV388M8),CloudflareWARP',
        '/dev/pf,mullvad-daemon,Developer ID Application: Mullvad VPN AB (CKG9MXH72F),mullvad-daemon',
        '/dev/shm,python3',
        '/dev/zero,bash,Software Signing,com.apple.bash',
        '/dev/tty.usbmodem21430,Bazecor Helper (Renderer),,',
        '/dev/xcpm,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',
        '/dev/xcpm,systemstats,Software Signing,com.apple.systemstats',
        '/dev/xcpm,thermald,Software Signing,com.apple.thermald'
      )
    GROUP BY
      pof.pid
  tags: persistent, state, sniffer
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected programs accessing sensitive data stores (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - credentials - unexpected-sensitive-file-access-linux
  observer_can_run: false
  platforms: ''
  query: |
    -- Unexpected programs accessing sensitive data stores (state-based)
    --
    -- This query is unfortunately of limited use, as the query is slow (250ms)
    -- and it requires catching a program at the exact moment it has
    -- the file open. An event-based version is advised.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1555/ (Credentials from Password Stores)
    --
    -- tags: transient state file access
    SELECT
      pof.pid,
      pof.fd,
      pof.path,
      f.uid AS file_uid,
      p.cwd AS cwd,
      p.euid,
      p.start_time,
      p.uid AS process_uid,
      p.name AS program_name,
      p.cmdline AS cmdline,
      pp.name AS parent_name,
      pp.cwd AS parent_cwd,
      pp.path AS parent_path,
      pf.filename AS program_base,
      hash.sha256,
      REPLACE(f.directory, u.directory, '~') AS dir,
      CONCAT (
        pf.filename,
        ',',
        p.name,
        ',',
        IIF(
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ) != '',
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ),
          REPLACE(f.directory, u.directory, '~')
        )
      ) AS exception_key
    FROM
      -- Starting with processes is just slightly faster than starting with pof
      processes p
      LEFT JOIN process_open_files pof ON p.pid = pof.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file f ON pof.path = f.path
      LEFT JOIN file pf ON p.path = pf.path
      LEFT JOIN users u ON p.uid = u.uid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash hp ON pp.path = hp.path
    WHERE
      -- minor optimization: filtering out low parents saves us another 5% of runtime
      p.parent > 2
      -- Large files are probably not secrets
      AND pf.filename != ''
      AND f.size < 1000000
      AND (
        pof.path IN ('/var/run/docker.sock')
        OR pof.path LIKE '/home/%/.ssh/%'
        OR pof.path LIKE '/home/%/.mozilla/firefox/%'
        OR pof.path LIKE '/home/%/.config/google-chrome/%'
        OR pof.path LIKE '/root/.ssh/%'
        OR pof.path LIKE '/root/.bash_history'
        OR pof.path LIKE '/home/%/.config/gcloud/%'
        OR pof.path LIKE '/home/%/.config/Slack/%'
        OR pof.path LIKE '/home/%/.bash_history'
        OR pof.path LIKE '/home/%/.cache/mozilla/firefox%'
        OR pof.path LIKE '/home/%/.config/mozilla/firefox%'
        OR pof.path LIKE '/home/%/.aws%'
      )
      AND NOT p.cmdline LIKE 'less %id_rsa.pub'
      AND NOT (
        file_uid == process_uid
        AND exception_key IN (
          'aws,aws,~/.aws',
          'chrome,chrome,~/.config/google-chrome',
          'chrome_crashpad_handler,chrome_crashpad,',
          'chrome_crashpad_handler,chrome_crashpad,~/.config/google-chrome',
          'firefox-bin,file:// Content,~/.mozilla/firefox',
          'firefox-bin,firefox-bin,~/.cache/mozilla',
          'firefox-bin,firefox-bin,~/.mozilla/firefox',
          'firefox-bin,Isolated Servic,~/.mozilla/firefox',
          'firefox-bin,Isolated Web Co,~/.mozilla/firefox',
          'firefox-bin,Privileged Cont,~/.mozilla/firefox',
          'firefox-bin,WebExtensions,~/.mozilla/firefox',
          'firefox,file:// Content,~/.cache/mozilla',
          'firefox,file:// Content,~/.mozilla/firefox',
          'firefox,file:// Content,~/snap/firefox',
          'firefox,firefox,~/.cache/mozilla',
          'firefox,firefox,~/.mozilla/firefox',
          'firefox,firefox,~/snap/firefox',
          'firefox,.firefox-wrappe,~/.cache/mozilla',
          'firefox,.firefox-wrappe,~/.mozilla/firefox',
          'firefox,Isolated Servic,~/.cache/mozilla',
          'firefox,Isolated Servic,~/.mozilla/firefox',
          'firefox,Isolated Servic,~/snap/firefox',
          'firefox,Isolated Web Co,~/.cache/mozilla',
          'firefox,Isolated Web Co,~/.mozilla/firefox',
          'firefox,Isolated Web Co,~/snap/firefox',
          'firefox,Privileged Cont,~/.cache/mozilla',
          'firefox,Privileged Cont,~/.mozilla/firefox',
          'firefox,Privileged Cont,~/snap/firefox',
          'firefox,Privileged Mozi,~/.mozilla/firefox',
          'firefox,Sandbox Forked,~/snap/firefox',
          'firefox,Web Content,~/.cache/mozilla',
          'firefox,Web Content,~/.mozilla/firefox',
          'firefox,Web Content,~/snap/firefox',
          'firefox,WebExtensions,~/.cache/mozilla',
          'firefox,WebExtensions,~/.mozilla/firefox',
          'firefox,WebExtensions,~/snap/firefox',
          'plugin-container,MainThread,~/.mozilla/firefox',
          'plugin-container,MainThread,~/snap/firefox',
          'python3.10,python3,~/.config/gcloud',
          'python3.11,python3,~/.config/gcloud',
          'python3.12,python3,~/.config/gcloud',
          'python3,python3,~/.config/gcloud',
          'slack,slack,~/.config/Slack',
          'slack,slack,~/snap/slack',
          'soffice.bin,soffice.bin,~/.mozilla/firefox',
          'updater,updater,~/.cache/mozilla',
          'updater,updater,~/.mozilla/firefox',
          'vim,vim,~/.aws'
        )
      )
    GROUP BY
      pof.pid,
      pof.path
  tags: transient, state, file, access
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected programs accessing sensitive data stores (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - credentials - unexpected-sensitive-file-access-macos
  observer_can_run: false
  platforms: ''
  query: |
    -- Unexpected programs accessing sensitive data stores (state-based)
    --
    -- This query is unfortunately of limited use, as the query is slow (250ms)
    -- and it requires catching a program at the exact moment it has
    -- the file open. An event-based version is advised.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1555/ (Credentials from Password Stores)
    --
    -- tags: transient often state file access
    SELECT
      pof.pid,
      pof.fd,
      pof.path,
      f.uid AS file_uid,
      p.cwd AS cwd,
      p.euid,
      p.uid AS process_uid,
      p.name AS program_name,
      p.cmdline AS cmdline,
      pp.name AS parent_name,
      pp.cwd AS parent_cwd,
      pp.path AS parent_path,
      pf.filename AS program_base,
      hash.sha256,
      REPLACE(f.directory, u.directory, '~') AS dir,
      CONCAT (
        pf.filename,
        ',',
        p.name,
        ',',
        IIF(
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ) != '',
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ),
          REPLACE(f.directory, u.directory, '~')
        )
      ) AS exception_key
    FROM
      -- Starting with processes is just slightly faster than starting with pof
      processes p
      LEFT JOIN process_open_files pof ON p.pid = pof.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file f ON pof.path = f.path
      LEFT JOIN file pf ON p.path = pf.path
      LEFT JOIN users u ON p.uid = u.uid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash hp ON pp.path = hp.path
    WHERE
      -- minor optimization: filtering out low parents saves us another 5% of runtime
      p.parent > 2
      -- Large files are probably not secrets
      AND pf.filename != ''
      AND f.size < 1000000
      AND (
        pof.path IN ('/var/run/docker.sock')
        OR pof.path LIKE '/home/%/.ssh/%'
        OR pof.path LIKE '/home/%/.mozilla/firefox/%'
        OR pof.path LIKE '/home/%/.config/google-chrome/%'
        OR pof.path LIKE '/root/.ssh/%'
        OR pof.path LIKE '/root/.bash_history'
        OR pof.path LIKE '/home/%/.config/gcloud/%'
        OR pof.path LIKE '/home/%/.config/Slack/%'
        OR pof.path LIKE '/home/%/.bash_history'
        OR pof.path LIKE '/home/%/.cache/mozilla/firefox%'
        OR pof.path LIKE '/home/%/.config/mozilla/firefox%'
        OR pof.path LIKE '/home/%/.aws%'
      )
      AND NOT (
        file_uid == process_uid
        AND exception_key IN (
          'aws,aws,~/.aws',
          'chrome,chrome,~/.config/google-chrome',
          'chrome_crashpad_handler,chrome_crashpad,',
          'chrome_crashpad_handler,chrome_crashpad,~/.config/google-chrome',
          'firefox,file:// Content,~/.cache/mozilla',
          'firefox,file:// Content,~/.mozilla/firefox',
          'firefox,file:// Content,~/snap/firefox',
          'firefox,firefox,~/.cache/mozilla',
          'firefox,firefox,~/.mozilla/firefox',
          'firefox,firefox,~/snap/firefox',
          'firefox,.firefox-wrappe,~/.cache/mozilla',
          'firefox,.firefox-wrappe,~/.mozilla/firefox',
          'firefox,Isolated Servic,~/.cache/mozilla',
          'firefox,Isolated Servic,~/.mozilla/firefox',
          'firefox,Isolated Servic,~/snap/firefox',
          'firefox,Isolated Web Co,~/.cache/mozilla',
          'firefox,Isolated Web Co,~/.mozilla/firefox',
          'firefox,Isolated Web Co,~/snap/firefox',
          'firefox,Privileged Cont,~/.cache/mozilla',
          'firefox,Privileged Cont,~/.mozilla/firefox',
          'firefox,Privileged Cont,~/snap/firefox',
          'firefox,Web Content,~/.cache/mozilla',
          'firefox,Web Content,~/.mozilla/firefox',
          'firefox,Web Content,~/snap/firefox',
          'firefox,WebExtensions,~/.cache/mozilla',
          'firefox,WebExtensions,~/.mozilla/firefox',
          'firefox,WebExtensions,~/snap/firefox',
          'plugin-container,MainThread,~/.mozilla/firefox',
          'plugin-container,MainThread,~/snap/firefox',
          'python3.10,python3,~/.config/gcloud',
          'python3.11,python3,~/.config/gcloud',
          'python3.12,python3,~/.config/gcloud',
          'python3,python3,~/.config/gcloud',
          'slack,slack,~/.config/Slack',
          'slack,slack,~/snap/slack',
          'soffice.bin,soffice.bin,~/.mozilla/firefox',
          'vim,vim,~/.aws'
        )
      )
    GROUP BY
      pof.pid,
      pof.path
  tags: transient, often, state, file, access
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Look for sketchy mounted disk images, inspired by Shlayer
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - credentials - yara-mounted-stealer
  observer_can_run: false
  platforms: darwin
  query: |
    -- Look for sketchy mounted disk images, inspired by Shlayer
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1566/001/ (Phishing: Spearphishing Attachment)
    --   * https://attack.mitre.org/techniques/T1204/002/ (User Execution: Malicious File)
    --   * https://www.crowdstrike.com/blog/how-crowdstrike-uncovered-a-new-macos-browser-hijacking-campaign/
    --
    -- tags: volume filesystem
    -- platform: darwin
    SELECT
      RTRIM(file.path, '/') AS f,
      file.bsd_flags AS f_flags,
      file.gid AS f_gid,
      file.mode AS f_mode,
      file.size AS f_size,
      file.type AS f_type,
      REGEX_MATCH (file.filename, '.*\.(.*?)$', 1) AS f_ext,
      file.uid AS f_uid,
      hash.sha256 AS f_sha256,
      magic.data AS f_data,
      mdfind.path AS probable_source,
      mdhash.sha256 AS probable_source_sha256,
      ea.value AS probable_url,
      REGEX_MATCH (file.path, '/Volumes/(.*?)/', 1) AS vol_name,
      signature.authority AS s_auth,
      signature.identifier AS s_id,
      yara.*
    FROM
      file
      JOIN yara ON file.path = yara.path
      LEFT JOIN mdfind ON mdfind.query = "kMDItemFSName == '*" || REGEX_MATCH (file.path, '/Volumes/(\w+)', 1) || "*.dmg'"
      LEFT JOIN extended_attributes ea ON mdfind.path = ea.path
      AND ea.key = 'where_from'
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN hash mdhash ON mdfind.path = mdhash.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE
      file.path IN (
        SELECT
          file.path
        FROM
          block_devices
          JOIN mounts ON mounts.device = block_devices.name
          JOIN file ON file.directory = mounts.path
          OR file.directory LIKE mounts.path || "/%.app/Contents/MacOS/"
          OR file.directory LIKE mounts.path || "/%.app/Contents/Resources/"
          OR file.directory LIKE mounts.path || "/%/%.app/Contents/MacOS/"
          OR file.directory LIKE mounts.path || "/%/%.app/Contents/Library/LaunchServices"
          OR file.directory LIKE mounts.path || "/%/%.app/Contents/Resources/"
        WHERE
          model = 'Disk Image'
          AND parent != ""
          AND mounts.path LIKE "/Volumes/%"
          -- osquery will traverse symlinks, this prevents following symlinks to /Applications (poorly)
          AND file.path NOT LIKE "/Volumes/%/Applications/%"
          AND (
            file.mode LIKE "%7%"
            OR file.mode LIKE "%5%"
            OR file.mode LIKE "%1%"
          )
          AND file.type = "regular"
      )
      AND magic.data LIKE "%Executable%"
      AND yara.sigrule = '
        rule stealer {
        strings:
            $data_stealers = "data_stealers" ascii
            $library_keychains = "/Library/Keychains" ascii
            $cookies_sqlite = "cookies.sqlite" ascii
            $moz_cookies = "moz_cookies" ascii
            $operagx = "OperaGX" ascii
            $brave_software = "BraveSoftware" ascii
            $osascript = "osascript" ascii
            $find_generic_password = "find-generic-password" ascii

        condition:
            2 of them
    }'
      AND yara.count > 0
    GROUP BY
      file.path
  tags: volume, filesystem
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find root-run processes which link against libpf
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - discovery - unexpected-bpf-user
  observer_can_run: false
  platforms: posix
  query: |
    -- Find root-run processes which link against libpf
    --
    -- WARNING: This check consumes an unusual amount of system memory (up to 225MB)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1205/001/ (Traffic Signaling: Port Knocking)
    --
    -- platform: posix
    -- tags: persistent state process sniffer
    SELECT
      pmm.pid,
      pmm.path AS lib_path,
      p.path,
      p.name,
      p.cmdline,
      p.cwd,
      p.euid,
      p.parent,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.cwd AS parent_cwd,
      pp.euid AS parent_euid,
      hash.sha256 AS child_sha256,
      phash.sha256 AS parent_sha256
      -- Using processes is much faster than process_memory_map
    FROM
      processes p
      LEFT JOIN process_memory_map pmm ON p.pid = pmm.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash AS phash ON pp.path = phash.path
    WHERE
      p.euid = 0
      AND (
        lib_path LIKE '%:bpf%'
        OR lib_path LIKE '%libbpf%'
      )
      AND p.path NOT IN (
        '/usr/bin/qemu-system-x86_64',
        '/usr/lib/systemd/systemd',
        '/opt/Elastic/Endpoint/elastic-endpoint'
      )
      AND p.cmdline != '/usr/bin/python3 /usr/sbin/execsnoop-bpfcc'
      AND p.path NOT LIKE '/nix/store/%/lib/systemd/systemd'
    GROUP BY
      pmm.pid
  tags: persistent, state, process, sniffer
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Suspicious parenting of network utilities (event-based)
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - discovery - unexpected-netutil-calls-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Suspicious parenting of network utilities (event-based)
    --
    -- refs:
    --   * https://attack.mitre.org/techniques/T1016/ (System Network Configuration Discovery)
    --
    -- tags: transient process state often
    -- platform: linux
    -- interval: 300
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.time,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      uptime.total_seconds > 30
      AND pe.path IN (
        '/usr/bin/ifconfig',
        '/usr/bin/ip',
        '/usr/bin/iptables',
        '/usr/bin/ufw',
        '/usr/bin/nft',
        '/bin/ifconfig',
        '/bin/ip',
        '/bin/iptables',
        '/bin/ufw',
        '/bin/nft',
        '/sbin/ifconfig',
        '/sbin/ip',
        '/sbin/iptables',
        '/sbin/ufw',
        '/sbin/nft'
      )
      AND pe.cmdline != ''
      AND pe.time > (strftime('%s', 'now') -300)
      AND NOT (
        pe.euid > 500
        AND p1_name IN ('sh', 'fish', 'zsh', 'bash', 'dash', 'nu')
        AND p2_name IN (
          'alacritty',
          'gnome-terminal-',
          'kitty',
          'login',
          'roxterm',
          'tmux',
          'newgrp',
          'tmux:server',
          'wezterm-gui',
          'zsh'
        )
      )
      AND NOT p1_cmd IN (
        '/opt/incus/bin/incusd --group incus-admin --logfile /var/log/incus/incusd.log',
        '/bin/sh /etc/network/if-up.d/avahi-autoipd',
        '/usr/bin/libvirtd --timeout 120'
      )
      AND NOT p1_path IN (
        '/usr/libexec/gvfsd',
        '/opt/incus/bin/incusd',
        '/usr/libexec/incus/incusd'
      )
      AND NOT p0_cmd LIKE '%ip route add % dev % metric 1000 scope link'
      AND NOT p0_cmd LIKE '%ip link set lo netns -1'
    GROUP BY
      pe.pid
  tags: transient, process, state, often
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Suspicious parenting of fetch tools (event-based)
  discard_data: false
  interval: 600
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - discovery - unexpected-netutil-calls-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Suspicious parenting of fetch tools (event-based)
    --
    -- refs:
    --   * https://attack.mitre.org/techniques/T1016/ (System Network Configuration Discovery)
    --
    -- tags: transient process state often
    -- platform: darwin
    -- interval: 600
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.time AS p0_time,
      pe.euid AS p0_euid,
      s.authority AS p0_authority,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      pe_sig1.authority AS p1_authority,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(
        p1_p2_sig.authority,
        pe1_p2_sig.authority,
        pe1_pe2_sig.authority
      ) AS p2_authority,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN signature s ON pe.path = s.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      LEFT JOIN signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path
      LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path
      LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path
    WHERE
      pe.path IN (
        '/sbin/ifconfig',
        '/usr/sbin/netstat',
        '/usr/bin/nscurl',
        '/sbin/pfctl',
        '/usr/libexec/ApplicationFirewall/socketfilterfw'
      )
      AND uptime.total_seconds > 30
      AND pe.time > (strftime('%s', 'now') -600)
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND pe.status == 0
      AND NOT (
        pe.euid > 500
        AND p1_name IN ('sh', 'fish', 'zsh', 'bash', 'dash')
        AND p2_name IN (
          'kitty',
          'login',
          'tmux',
          'ShellLauncher',
          'sudo',
          'tmux:server',
          'zsh'
        )
      )
      AND NOT exception_key IN (
        'ifconfig,0,cloud-provider-kind,sudo',
        'ifconfig,0,pia-daemon,launchd',
        'ifconfig,0,pia-openvpn,pia-daemon',
        'ifconfig,500,dotnet,dotnet',
        'ifconfig,500,dotnet,zsh',
        'ifconfig,500,Python,Code Helper (Plugin)',
        'ifconfig,500,zsh,stable',
        'netstat,0,io.tailscale.ipn.macsys.network-extension,launchd',
        'netstat,0,metricbeat,elastic-agent',
        'netstat,0,pia-daemon,launchd',
        'netstat,500,AccountSubscriber,launchd',
        'netstat,500,coresymbolicationd,launchd',
        'netstat,500,IPNExtension,launchd',
        'pfctl,0,bash,pia-daemon',
        'pfctl,0,pia-daemon,launchd',
        'socketfilterfw,0,launcher,launchd'
      )
      AND p1_cmd NOT IN ('/bin/sh /etc/periodic/daily/420.status-network')
      AND p1_authority != 'Software Signing'
    GROUP BY
      pe.pid
  tags: transient, process, state, often
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find root-run processes which link against libpcap
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - discovery - unexpected-pcap-user-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Find root-run processes which link against libpcap
    --
    -- WARNING: This check consumes an unusual amount of system memory (up to 225MB)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1205/001/ (Traffic Signaling: Port Knocking)
    --
    -- platform: linux
    -- tags: persistent state process sniffer
    SELECT
      pmm.pid,
      p.uid,
      p.gid,
      pmm.path AS lib_path,
      p.path AS child_path,
      p.name AS child_name,
      p.cmdline AS child_cmd,
      p.cwd AS child_cwd,
      h.sha256 AS child_sha256,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      pp.euid AS parent_euid,
      ph.sha256 AS parent_sha256
      -- Using processes is much faster than process_memory_map
    FROM
      processes p
      LEFT JOIN process_memory_map pmm ON p.pid = pmm.pid
      LEFT JOIN hash h ON p.path = h.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash AS ph ON pp.path = ph.path
    WHERE
      p.euid = 0
      AND pmm.path LIKE '%libpcap%'
      AND child_path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
      AND child_path NOT LIKE '/nix/store/%-systemd-%/lib/systemd/systemd%'
      AND child_path NOT LIKE '/nix/store/%-systemd-%/bin/udevadm'
      AND child_path NOT LIKE '/System/Library/%'
      AND child_path NOT LIKE '/nix/store/%/bin/nix'
      AND child_path NOT IN (
        '/usr/libexec/UserEventAgent',
        '/usr/sbin/systemstats',
        '/usr/bin/libvirtd',
        '/usr/bin/tcpdump',
        '/usr/sbin/cupsd',
        '/run/current-system/systemd/lib/systemd/systemd'
      )
      AND child_cmd NOT IN (
        '/nix/var/nix/profiles/default/bin/nix-daemon',
        '/run/current-system/systemd/lib/systemd/systemd'
      )
      AND child_cmd NOT LIKE '/usr/bin/python3 -s%/usr/sbin/firewalld%'
    GROUP BY
      p.pid
  tags: persistent, state, process, sniffer
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find root-run processes which link against libpcap
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - discovery - unexpected-pcap-user-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find root-run processes which link against libpcap
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1205/001/ (Traffic Signaling: Port Knocking)
    --
    -- platform: darwin
    -- tags: persistent state process sniffer
    SELECT
      s.authority,
      s.identifier,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN process_memory_map pmm ON p0.pid = pmm.pid
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          euid = 0
          AND path NOT LIKE '/System/%'
          AND path NOT LIKE '/Library/Apple/%'
          AND path NOT LIKE '/usr/libexec/%'
          AND path NOT LIKE '/usr/sbin/%'
          AND path NOT LIKE '/sbin/%'
          AND path NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'
          AND path NOT LIKE '/usr/bin/%'
          AND path NOT LIKE '/nix/store/%/bin/nix'
          AND path NOT LIKE '/opt/homebrew/Cellar/vim/%/bin/vim'
          AND path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
          AND path NOT LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/Kolide.app/Contents/MacOS/launcher'
          AND path NOT LIKE '/opt/homebrew/Cellar/socket_vmnet/%/bin/socket_vmnet'
          AND path NOT LIKE '/usr/local/Cellar/htop/%/bin/htop'
          AND path NOT LIKE '/opt/homebrew/Cellar/btop/%/bin/btop'
          AND path NOT IN (
            '/opt/socket_vmnet/bin/socket_vmnet',
            '/usr/local/sbin/velociraptor'
          )
      )
      AND pmm.path LIKE '%libpcap%'
      -- These are all protected directories
      AND NOT s.authority IN (
        'Software Signing',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Apple Mac OS Application Signing',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)'
      )
      AND NOT p0.path LIKE '/opt/homebrew/Cellar/kubernetes-cli/%/bin/kubectl'
    GROUP BY
      p0.pid
  tags: persistent, state, process, sniffer
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find programs which spawn root children without propagating environment
    variables
  discard_data: false
  interval: 600
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - empty_root_environ_linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Find programs which spawn root children without propagating environment variables
    --
    -- references:
    --   * https://www.sandflysecurity.com/blog/bpfdoor-an-evasive-linux-backdoor-technical-analysis/
    --
    -- tags: persistent state daemon process
    -- interval: 600
    -- platform: linux
    SELECT
      COUNT(key) AS count,
      p.pid,
      p.path,
      p.name,
      p.on_disk,
      p.cgroup_path,
      hash.sha256,
      p.parent,
      p.cmdline,
      p.cwd,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd
      -- Processes is 20X faster to scan than process_envs
    FROM
      processes p
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN process_envs pe ON p.pid = pe.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
    WHERE
      p.euid = 0
      -- This time should match the interval
      AND p.start_time > (strftime('%s', 'now') - 601)
      -- Filter out transient processes that may not have an envs entry by the time we poll for it
      AND p.start_time < (strftime('%s', 'now') - 1)
      AND p.parent NOT IN (0, 2)
      AND NOT p.path IS NULL
      AND p.name NOT IN (
        '1Password-Keyri',
        'abrt-handle-eve',
        'applydeltarpm',
        'bwrap',
        'crond',
        'cupsd',
        'dhcpcd',
        'dnf',
        'fprintd',
        'gdm-session-wor',
        'gdm-x-session',
        'packagekit-dnf-',
        'gpg-agent',
        'ir_agent',
        'modprobe',
        'nginx',
        'osqueryi',
        'realmd',
        'dbus-daemon',
        'sedispatch',
        'ssh',
        'sshd',
        'sudo',
        'launcher',
        'systemd',
        'elastic-agent',
        'systemd-udevd',
        'systemd-userdbd',
        'systemd-userwor',
        '(udev-worker)',
        'Xorg',
        'zfs',
        'zypak-sandbox'
      )
      AND NOT pp.name IN (
        'systemd-userdbd',
        'crond',
        'systemd',
        'systemd-udevd',
        '(udev-worker)'
      )
      AND NOT (
        p.name LIKE 'systemd-%'
        AND p.parent = 1
      )
      AND NOT p.cgroup_path IN ('/system.slice/cronie.service')
      AND NOT pp.cmdline LIKE 'bwrap %'
      AND NOT p.cmdline LIKE '%--type=zygote%'
      AND NOT p.cmdline LIKE '%--disable-seccomp-filter-sandbox%'
      AND NOT p.cgroup_path LIKE '/system.slice/docker-%'
      AND NOT (
        p.name = 'sh'
        AND p.cgroup_path = '/system.slice/znapzend.service'
      )
    GROUP BY
      p.pid
    HAVING
      count == 0;
  tags: persistent, state, daemon, process
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find programs which spawn root children without propagating environment
    variables
  discard_data: false
  interval: 600
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - empty_root_environ_macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find programs which spawn root children without propagating environment variables
    --
    -- references:
    --   * https://www.sandflysecurity.com/blog/bpfdoor-an-evasive-linux-backdoor-technical-analysis/
    --
    -- tags: persistent state daemon process seldom disabled
    -- platform: darwin
    -- interval: 600
    SELECT
      COUNT(key) AS count,
      p.pid,
      p.path,
      p.name,
      p.euid,
      p.on_disk,
      p.parent,
      p.cmdline,
      p.cwd,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd,
      signature.identifier,
      signature.authority,
      hash.sha256,
      CONCAT (
        MIN(p.euid, 500),
        ',',
        p.name,
        ',',
        signature.identifier,
        ',',
        signature.authority
      ) AS exception_key
    FROM
      processes p
      LEFT JOIN process_envs pe ON p.pid = pe.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN signature ON p.path = signature.path
    WHERE
      p.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          euid = 0
          AND start_time > (strftime('%s', 'now') - 601)
          AND start_time < (strftime('%s', 'now') - 1)
          AND path NOT LIKE '/System/Library/%'
          AND path NOT LIKE '/opt/homebrew/Cellar/%'
      )
      AND signature.authority NOT IN (
        'Software Signing',
        'Apple Mac OS Application Signing',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: GitHub (VEKTX9H2N7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: Node.js Foundation (HX7739G8FX)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Mozilla Corporation (43AQ936H96)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: Parallels International GmbH (4C6364ACXT)',
        'Developer ID Application: Yubico Limited (LQA3CS5MM7)'
      )
    GROUP BY
      p.pid
    HAVING
      count == 0;
  tags: persistent, state, daemon, process, seldom, disabled
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Programs which claim to be from the future, based on (btime,ctime,mtime)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - executables-from-the-future
  observer_can_run: false
  platforms: ''
  query: |
    -- Programs which claim to be from the future, based on (btime,ctime,mtime)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/006/ (Indicator Removal on Host: Timestomp)
    --
    -- false positives:
    --   * Badly distributed software
    --
    -- tags: persistent state process
    SELECT
      p.pid,
      p.path,
      p.name,
      p.cmdline,
      p.cwd,
      p.euid,
      p.parent,
      f.ctime,
      f.btime,
      f.mtime,
      p.start_time,
      f.mtime > (strftime('%s', 'now') + 43200) AS mtime_newer,
      f.ctime > (strftime('%s', 'now') + 43200) AS ctime_newer,
      f.btime > (strftime('%s', 'now') + 43200) AS btime_newer,
      f.mtime - strftime('%s', 'now') AS mtime_diff,
      f.ctime - strftime('%s', 'now') AS ctime_diff,
      f.btime - strftime('%s', 'now') AS btime_diff,
      strftime('%s', 'now') AS now_ts,
      hash.sha256 AS child_hash256,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      (
        mtime_newer == 1
        OR ctime_newer == 1
        OR btime_newer == 1
      )
      AND NOT p.path LIKE '/Applications/Signal.app%'
      AND NOT p.path LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'
      -- 2038
      AND NOT f.mtime > 2153484373
  tags: persistent, state, process
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Programs running with a hidden current working directory (event-based)
  discard_data: false
  interval: 600
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - hidden-cwd-events-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Programs running with a hidden current working directory (event-based)
    --
    -- false positives:
    --   * Users rummaging through their configuration files
    --
    -- NOTES:
    --   * Disabled on macOS, as the cwd field as NULL there
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1564/001/ (Hide Artifacts: Hidden Files and Directories)
    --
    -- tags: transient extra
    -- platform: linux
    -- interval: 600
    SELECT
      COALESCE(
        REGEX_MATCH (TRIM(pe.cwd, '"'), "/(\..*?)\/", 1),
        REGEX_MATCH (TRIM(pe.cwd, '"'), "/(\..*)", 1)
      ) AS hidden_base,
      REGEX_MATCH (TRIM(pe.cwd, '"'), "/(\..*)", 1) AS hidden_part,
      COALESCE(
        REGEX_MATCH (TRIM(pe.cwd, '"'), '.*/(.*)', 1),
        pe.cwd
      ) AS basename,
      CONCAT (
        COALESCE(
          REGEX_MATCH (TRIM(pe.path, '"'), '.*/(.*)', 1),
          pe.path
        ),
        ',',
        REGEX_MATCH (TRIM(pe.cwd, '"'), "/(\..*?)\/", 1),
        REGEX_MATCH (TRIM(pe.cwd, '"'), "/(\..*)", 1)
      ) AS exception_key,
      -- Child
      pe.path AS p0_path,
      COALESCE(REGEX_MATCH (pe.path, '.*/(.*)', 1), pe.path) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      TRIM(pe.cwd, '"') AS p0_cwd,
      pe.status AS p0_status,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      p1.cwd AS p1_cwd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name
    FROM
      process_events pe
      LEFT JOIN users u ON pe.uid = u.uid
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.time > (strftime('%s', 'now') -60660)
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
    WHERE
      pe.time > (strftime('%s', 'now') -60600)
      AND pe.cwd LIKE '%/.%'
      AND NOT (
        hidden_base IN (
          '.cache',
          '.cargo',
          '.gradle',
          '.kotlin',
          '.npm',
          '.git',
          '.linuxbrew',
          '.gimme',
          '.vscode',
          '.vim',
          '.docker',
          '.config',
          '.vscode-oss',
          '.local',
          '.github',
          '.provisio',
          '.terraform.d',
          '.emacs.d',
          '.gmailctl',
          '.oh-my-zsh',
          '.zsh'
        )
        OR exception_key LIKE '%sh,~/.Trash'
        OR exception_key IN ('git,.test')
      )
      AND NOT pe.cwd LIKE '%/build/%'
      AND NOT pe.cwd LIKE '%/out/%'
    GROUP BY
      p.cmdline,
      p.cwd;
  tags: transient, extra
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Programs running with a hidden current working directory (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - hidden-cwd
  observer_can_run: false
  platforms: posix
  query: |
    -- Programs running with a hidden current working directory (state-based)
    --
    -- false positives:
    --   * Users rummaging through their configuration files
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1564/001/ (Hide Artifacts: Hidden Files and Directories)
    --
    -- tags: transient often
    -- platform: posix
    SELECT
      REPLACE(p0.cwd, u.directory, '~') AS dir,
      REGEX_MATCH (
        REPLACE(p0.cwd, u.directory, '~'),
        '([/~].*?/.*?)/',
        1
      ) AS top_dir,
      CONCAT (
        p0.name,
        ',',
        IIF(
          REGEX_MATCH (
            REPLACE(p0.cwd, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ) != '',
          REGEX_MATCH (
            REPLACE(p0.cwd, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ),
          REPLACE(p0.cwd, u.directory, '~')
        )
      ) AS exception_key,
      -- Child
      p0.pid AS p0_pid,
      p0.cgroup_path AS p0_cgroup,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.cgroup_path AS p1_cgroup,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN users u ON p0.uid = u.uid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT DISTINCT
          pid
        FROM
          processes
        WHERE
          cwd LIKE '%/.%'
          AND NOT name IN (
            'apfsd',
            'bindfs',
            'code',
            'Code Helper',
            'find',
            'git',
            'gitsign',
            'nvim',
            'terraform',
            'updatedb',
            'vim'
          )
          AND NOT cgroup_path LIKE '/system.slice/docker-%'
          AND NOT cgroup_path LIKE '/system.slice/system.slice:docker:%'
      )
      AND NOT (
        exception_key IN (
          'Arduino IDE Helper,/private/var/folders',
          'Electron,~/.vscode/extensions',
          'arduino-language-server,/private/var/folders',
          'as,~/.cache/yay',
          'bash,~/.Trash',
          'bash,~/.local/share',
          'bash,~/go/src',
          'c++,~/.cache/yay',
          'cc1,/home/build/.cache',
          'cc1plus,~/.cache/yay',
          'cgo,~/.gimme/versions',
          'clangd,/private/var/folders',
          'conmon,/var~/.local/share',
          'mysqld,/var~/.local/share',
          'dirhelper,/private/var/folders',
          'fileproviderd,~/Library/Mobile Documents',
          'fish,~/.Trash',
          'fish,~/.local/share',
          'git,~/.local/share',
          'java,/home/build/.gradle',
          'java,/home/build/.kotlin',
          'java,~/.gradle/daemon',
          'java,~/.local/share',
          'make,~/.cache/yay',
          'makepkg,~/.cache/yay',
          'mysqld,~/.local/share',
          'npm install,~/.npm/_cacache',
          'opera_autoupdate,/private/var/folders',
          'rm,/private/var/folders',
          'rust-analyzer-p,~/.cargo/registry',
          'rustc,/home/build/.cargo',
          'vet,/home/build/.cache',
          'zsh,~/.Trash'
        )
        OR exception_key LIKE '%sh,~/.Trash/%'
        OR exception_key LIKE '%sh,~/dev/%'
        OR exception_key LIKE 'wineserver,/tmp/.wine-1000/server-%'
        OR exception_key LIKE 'java,/.gradle/%'
        OR dir IN (
          '~/.config',
          '~/.local/bin',
          '/var/home/linuxbrew/.linuxbrew/Cellar',
          '~/.vim',
          '~/dev/extra-packages/.chainguard',
          '~/.provisio',
          '~/.terraform.d',
          '~/.cache/yay',
          '~/.emacs.d',
          '~/.local/share/chezmoi',
          '~/.local/share/Steam',
          '~/.local/share/nvim',
          '~/.gmailctl',
          '~/.oh-my-zsh',
          '~/.hunter/_Base',
          '~/.zsh'
        )
        OR top_dir IN ('~/Sync')
        OR dir LIKE '/Library/Apple/System/Library/InstallerSandboxes/.PKInstallSandboxManager-SystemSoftware/%'
        OR dir LIKE '/opt/homebrew/%/.cache/%'
        OR dir LIKE '~/%enterprise-packages/.chainguard'
        OR dir LIKE '/private/tmp/%/.git'
        OR dir LIKE '/tmp/.mount_%'
        OR dir LIKE '/tmp/%/.git'
        OR dir LIKE '~/%/.tests/%'
        OR dir LIKE '/tmp/%/.github/workflows'
        OR dir LIKE '~/%/.terragrunt-cache/%'
        OR dir LIKE '%/.build'
        OR dir LIKE '%/.cargo/%'
        OR dir LIKE '%/.git'
        OR dir LIKE '%/.git/%'
        OR dir LIKE '%/.gradle'
        OR dir LIKE '%/.github/%'
        OR dir LIKE '%/.cache/melange%'
        OR dir LIKE '%/.github'
        OR dir LIKE '%/.venv'
        OR dir LIKE '/home/build/.cache%'
        OR dir LIKE '~/.%'
        OR dir LIKE '~/.gradle/%'
        OR dir LIKE '~/%/.config/nvim'
        OR dir LIKE '~/%/.docker%'
        OR dir LIKE '/.gradle/%'
        OR dir LIKE '~/%/.modcache/%'
        OR dir LIKE '~/%/.terraform%'
        OR dir LIKE '~/%/.vercel%'
        OR dir LIKE '~/%/github.com/%'
        OR dir LIKE '~/%/node_modules/.pnpm/%'
        OR dir LIKE '~/%/src/%'
        OR dir LIKE '~/%google-cloud-sdk/.install/.backup%'
        OR dir LIKE '~/code/%'
        OR dir LIKE '~/dev/%/dots/%/.config%'
        OR dir LIKE '~/src/%'
        -- For sudo calls to other things
        OR (
          dir LIKE '/home/.terraform.d/%'
          AND p0.euid = 0
        )
      )
    GROUP BY
      p0.pid
  tags: transient, often
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Programs running with a hidden file path or process name
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - hidden-executable
  observer_can_run: false
  platforms: posix
  query: |
    -- Programs running with a hidden file path or process name
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1564/001/ (Hide Artifacts: Hidden Files and Directories)
    --
    -- tags: transient
    -- platform: posix
    SELECT
      f.directory,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_sockets pop
      LEFT JOIN processes p0 ON pop.pid = p0.pid
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      (
        p0.name LIKE '.%'
        OR f.filename LIKE '.%'
        OR f.directory LIKE '%/.%'
      )
      AND NOT f.directory LIKE '/Applications/Corsair iCUE5 Software/.cuepkg-%'
      AND NOT f.directory LIKE '%/Applications/PSI Bridge Secure Browser.app/Contents/Resources/.apps/darwin/%'
      AND NOT f.directory LIKE '%/.bin'
      AND NOT f.directory LIKE '%/.bin-unwrapped'
      AND NOT f.directory LIKE '%/.cargo/bin'
      AND NOt f.directory LIKE '%/.config/Code/User/globalStorage/ms-dotnettools.vscode-dotnet-runtime/.dotnet/%'
      AND NOT f.directory LIKE '%/.config/Code/User/globalStorage/sourcegraph.cody-ai/cody-engine'
      AND NOT f.directory LIKE '%/.config/nvm/%/bin'
      AND NOT f.directory LIKE '%/.cursor/%'
      AND NOT f.directory LIKE '%/.deno/bin'
      AND NOT f.directory LIKE '%/.devpod/contexts/%'
      AND NOT f.directory LIKE '%/.linuxbrew/Cellar/%/bin'
      AND NOT f.directory LIKE '%/.docker/cli-plugins'
      AND NOT f.directory LIKE '%/.fig/bin'
      AND NOT f.directory LIKE '%/.linkerd2/bin'
      AND NOT f.directory LIKE '%/.go/bin'
      AND NOT f.directory LIKE '%/.sdkman/%'
      AND NOT f.directory LIKE '%/.goenv/%/bin'
      AND NOT f.directory LIKE '%/.goenv/%/pkg/%'
      AND NOT f.directory LIKE '%/.gradle/jdks/%'
      AND NOT f.directory LIKE '/home/%/.pyenv/versions/%/bin'
      AND NOT f.directory LIKE '%/.local/%'
      AND NOT f.directory LIKE '%/node_modules/.bin/%'
      AND NOT f.directory LIKE '%/.nvm/versions/%/bin'
      AND NOT f.directory LIKE '%/.pnpm/%'
      AND NOT f.directory LIKE '%/.provisio/bin/%'
      AND NOT f.directory LIKE '%/.rustup/%'
      AND NOT f.directory LIKE '%/.rbenv/%'
      AND NOT f.directory LIKE '%/.supermaven/%'
      AND NOT f.directory LIKE '%/.steampipe/db/%'
      AND NOT f.directory LIKE '%/.terraform%'
      AND NOT f.directory LIKE '%/.tflint.d/%'
      AND NOT f.directory LIKE '/Users/%/Library/Application Support/Code/User/globalStorage/ms-dotnettools.vscode-dotnet-runtime/.dotnet/%'
      AND NOT f.directory LIKE '%/.vscode/extensions/%'
      AND NOT f.directory LIKE '%/.vscode-insiders/extensions/%'
      AND NOT f.directory LIKE '%/.vs-kubernetes/%'
      AND NOT f.directory LIKE '%/.yardstick/%'
      AND NOT f.directory LIKE '/var/home/linuxbrew/.linuxbrew/Cellar/%'
      AND NOT f.path LIKE '/home/%/.config/bluejeans-v2/BluejeansHelper'
      AND NOT f.path LIKE '/nix/store/%/%-wrapped'
      AND NOT (
        f.path LIKE '/nix/store/%'
        AND p0.name LIKE '%-wrappe%'
      )
      AND NOt f.path LIKE '/private/var/root/.Trash/OneDrive %.app/Contents/StandaloneUpdater.app/Contents/MacOS'
    GROUP BY
      f.path
  tags: transient
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected hidden files in a users config directory
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - hidden-home-config-dir
  observer_can_run: false
  platforms: posix
  query: |
    -- Find unexpected hidden files in a users config directory
    --
    -- references:
    --   * https://www.sentinelone.com/blog/xcsset-malware-update-macos-threat-actors-prepare-for-life-without-python/
    --
    -- false positives:
    --   * programs which create new Library directories
    --
    -- tags: persistent state filesystem
    -- platform: posix
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE "/home/%/.config/.%"
        OR file.path LIKE '/home/%/.config/%%/.%/%'
        OR file.path LIKE '/home/%/.config/.%/%'
        OR file.path LIKE '/home/%/.config/%%/.%/.%'
        OR file.path LIKE '/root/.config/%%/.%/%'
        OR file.path LIKE '/root/.config/.%/%'
        OR file.path LIKE '/root/.config/%%/.%/.%'
        OR file.path LIKE '/root/.%/.%/%'
      )
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND file.path NOT LIKE '/root/.cache/.flatpak/%'
      AND file.path NOT LIKE '/root/.debug/.build-id/%'
      AND file.path NOT LIKE '/home/%/.config/%/.git%'
      AND file.path NOT LIKE '/home/%/.config/.gsd-keyboard.settings-ported'
      AND file.path NOT LIKE '/home/%/.config/.org.chromium.Chromium.%'
  tags: persistent, state, filesystem
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected hidden files in a users Application Support directory
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - hidden-home-libappsupport
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find unexpected hidden files in a users Application Support directory
    --
    -- references:
    --   * https://objective-see.org/blog/blog_0x73.html
    --
    -- false positives:
    --   * programs with unusual self-updaters
    --
    -- tags: persistent state filesystem
    -- platform: darwin
    SELECT
      file.path,
      file.filename,
      file.type,
      file.mode,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      REPLACE(file.path, u.directory, '~') AS homepath,
      REPLACE(file.directory, u.directory, '~') AS homedir,
      file.gid,
      hash.sha256,
      magic.data,
      signature.identifier,
      signature.authority
    FROM
      file
      JOIN hash ON file.path = hash.path
      JOIN users u ON file.uid = u.uid
      JOIN magic ON file.path = magic.path
      JOIN signature ON file.path = signature.path
    WHERE
      file.path IN (
        SELECT
          path
        FROM
          file
        WHERE
          (
            path LIKE '/Users/%/Library/Application Support/%/.%'
            OR path LIKE '/Users/%/Library/Application Support/.%'
          )
          AND NOT file.filename IN ('.', '..', '.updaterId', '.DS_Store')
          AND size > 0
      )
      AND NOT homedir IN (
        '~/Library/Application Support/1Password',
        '~/Library/Application Support/Adobe',
        '~/Library/Application Support/Beeper',
        '~/Library/Application Support/BetterTouchTool',
        '~/Library/Application Support/CleanMyMac X Menu',
        '~/Library/Application Support/CleanMyMac X',
        '~/Library/Application Support/Code',
        '~/Library/Application Support/nuclei',
        '~/Library/Application Support/Docker Desktop',
        '~/Library/Application Support/DropboxElectron',
        '~/Library/Application Support/GitHub Desktop',
        '~/Library/Application Support/Jabra Direct',
        '~/Library/Application Support/Keybase',
        '~/Library/Application Support/Lens',
        '~/Library/Application Support/Loom',
        '~/Library/Application Support/Presenting',
        '~/Library/Application Support/Slack',
        '~/Library/Application Support/ZaloApp',
        '~/Library/Application Support/ZaloData',
        '~/Library/Application Support/ZaloPC',
        '~/Library/Application Support/com.apple.spotlight',
        '~/Library/Application Support/com.bohemiancoding.sketch3',
        '~/Library/Application Support/com.intelliscapesolutions.caffeine',
        '~/Library/Application Support/com.operasoftware.Opera',
        '~/Library/Application Support/com.psiexams.psi-bridge-secure-browser',
        '~/Library/Application Support/com.tinyapp.TablePlus',
        '~/Library/Application Support/discord',
        '~/Library/Application Support/lghub'
      )
      AND NOT homepath IN (
        '~/Library/Application Support/.Shadowland5.5',
        '~/Library/Application Support/.com.contextsformac.Contexts.plist',
        '~/Library/Application Support/.settings'
      )
      AND NOT homepath LIKE '~/Library/Application Support/.syssettings%'
      AND NOT magic.data = 'XML 1.0 document, ASCII text'
      -- Capture One
      AND NOT (
        file.mode = "0666"
        AND size > 1200
        AND size < 4000
        AND REGEX_MATCH (file.filename, "^(\.[0-9A-Z]{32})$", 0) != ""
      )
    GROUP BY
      file.path
  tags: persistent, state, filesystem
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected hidden files in a users Library directory
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - hidden-home-library-dir
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find unexpected hidden files in a users Library directory
    --
    -- references:
    --   * https://www.sentinelone.com/blog/xcsset-malware-update-macos-threat-actors-prepare-for-life-without-python/
    --
    -- false positives:
    --   * programs which create new Library directories
    --
    -- tags: persistent state filesystem
    -- platform: darwin
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      REPLACE(file.directory, u.directory, '~') AS homedir,
      file.gid,
      hash.sha256,
      magic.data,
      signature.identifier,
      signature.authority
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN users u ON file.uid = u.uid
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE
      (
        file.path LIKE '/Users/%/Library/%%/.%/%%'
        OR file.path LIKE '/Users/%/Library/.%/%%'
        OR file.path LIKE '/Users/%/Library/%%/.%/.%'
      )
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND NOT homedir IN (
        '~/Library/Accessibility/.com.apple.RTTTranscripts_SUPPORT/_EXTERNAL_DATA',
        '~/Library/Application Support/.keymapp',
        '~/Library/Caches/.sigstore/gitsign',
        '~/Library/com.apple.groupkitd/.syncedGroupStore_SUPPORT/_EXTERNAL_DATA',
        '~/Library/com.apple.groupkitd/.syncedGroupStore_SUPPORT/_EXTERNAL_DATA/',
        '~/Library/Finance/.finance_cloud_SUPPORT/_EXTERNAL_DATA',
        '~/Library/Finance/.finance_dropbox_SUPPORT/_EXTERNAL_DATA',
        '~/Library/Finance/.finance_local_SUPPORT/_EXTERNAL_DATA',
        '~/Library/GroupContainersAlias/.SiriTodayViewExtension',
        '~/Library/GroupContainersAlias/.SiriTodayViewExtension/Library',
        '~/Library/Group Containers/.SiriTodayViewExtension',
        '~/Library/Group Containers/.SiriTodayViewExtension/Library',
        '~/Library/HomeKit/.core-cloudkit-shared_SUPPORT/_EXTERNAL_DATA',
        '~/Library/HomeKit/.core-cloudkit_SUPPORT/_EXTERNAL_DATA',
        '~/Library/Preferences/.wrangler',
        '~/Library/Preferences/.wrangler/config',
        '~/Library/Saved Searches/.DockTags',
        '~/Library/Stickers/.stickers_SUPPORT/_EXTERNAL_DATA'
      )
      AND NOT homedir LIKE '~/Library/.icedove/%'
      AND NOT homedir LIKE '~/Library/Mobile Documents/.Trash%'
      AND NOT homedir LIKE '~/Library/%/.%_SUPPORT/_EXTERNAL_DATA'
      AND NOT homedir LIKe '~/Library/Caches/.git%'
      -- ugh
      AND NOT file.path LIKE '/Library/Application Scripts/.%-%-%-%-%/.%'
      AND NOT homedir LIKE '~/Library/Application Scripts/.%-%-%-%-%/.%'
      AND NOT homedir LIKE '~/Library/Application Scripts/.%-%-%-%-%'
  tags: persistent, state, filesystem
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Reveal launchd services which are located in a hidden directory.
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - hidden-launchd-files-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Reveal launchd services which are located in a hidden directory.
    --
    -- This query was written because osquery can't see these entries currently.
    -- See https://github.com/osquery/osquery/issues/7703
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/004/ (Create or Modify System Process: Launch Daemon)
    --   * https://attack.mitre.org/techniques/T1564/001/ (Hide Artifacts: Hidden Files and Directories)
    --
    -- platform: darwin
    -- tags: persistent daemon
    SELECT
      file.path,
      file.type,
      file.filename,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      signature.identifier,
      signature.authority
    FROM
      file
      LEFT JOIN signature ON file.path = signature.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      (
        file.path LIKE '/Library/LaunchAgents/.%'
        OR file.path LIKE '/Users/%/Library/LaunchAgents/.%'
        OR file.path LIKE '/Users/%/Library/LaunchDaemons/.%'
      )
      AND file.filename NOT IN ('.', '..', '.DS_Store')
      AND NOT (
        file.filename = '.DS_Store'
        AND hash.sha256 = 'd65165279105ca6773180500688df4bdc69a2c7b771752f0a46ef120b7fd8ec3'
      )
  tags: persistent, daemon
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Processes that do not exist on disk, running in osquery's namespace
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - missing-from-disk-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Processes that do not exist on disk, running in osquery's namespace
    --
    -- false positives:
    --   * none observed
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/004/ (Indicator Removal on Host: File Deletion)
    --
    -- tags: persistent process state
    -- platform: linux
    SELECT
      p.pid,
      p.euid,
      p.cmdline,
      p.path,
      p.cgroup_path,
      mnt_namespace,
      p.cwd,
      p.on_disk,
      p.state,
      file.inode,
      pp.on_disk AS parent_on_disk,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmdline,
      pp.cwd AS parent_cwd,
      ph.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN process_namespaces ON p.pid = process_namespaces.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ph ON pp.path = ph.path
    WHERE
      p.on_disk != 1
      AND p.path != ''
      -- use osquery as the reference mount namespace
      AND mnt_namespace IN (
        SELECT DISTINCT
          (mnt_namespace)
        FROM
          process_namespaces
          JOIN processes ON processes.pid = process_namespaces.pid
        WHERE
          processes.name IN ('osqueryi', 'osqueryd')
      )
      -- This is truly a missing program, not just one that has been updated with a new binary.
      AND file.inode IS NULL
      AND p.path != '/bpfilter_umh'
      -- Snap packages?
      AND p.path NOT LIKE '/tmp/.mount_%'
      AND p.path NOT LIKE '/home/%/.cache/yay/1password-cli/pkg/1password-cli/usr/bin/op'
      AND p.path NOT IN (
        '/usr/bin/python3.10',
        '/opt/google/chrome/nacl_helper',
        '/opt/Synergy/resources/synergy-tray'
      )
  tags: persistent, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Processes that do not exist on disk
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - missing-from-disk-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Processes that do not exist on disk
    --
    -- false positives:
    --   * Self-updating programs that remain running
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/004/ (Indicator Removal on Host: File Deletion)
    --
    -- platform: darwin
    -- tags: persistent process state
    SELECT
      p.pid,
      p.path,
      p.name,
      p.parent,
      p.state,
      p.cwd,
      p.gid,
      p.uid,
      p.euid,
      p.cmdline AS cmd,
      p.cwd,
      p.on_disk,
      p.state,
      strftime('%s', 'now') - p.start_time AS age,
      pp.on_disk AS parent_on_disk,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON pp.path = hash.path
    WHERE
      p.on_disk != 1 -- false positives from recently spawned processes
      AND (strftime('%s', 'now') - p.start_time) > 900
      AND p.pid > 0
      AND p.parent != 2 -- kthreadd
      AND p.state != 'Z' -- The kernel no longer has enough tracking information for this alert to be useful
      AND NOT (
        p.parent = 1
        AND p.path = ''
      )
      AND NOT (
        p.gid = 20
        AND (
          -- NOTE: p.path is typically empty when on_disk != 1, so don't depend on it.
          cmd LIKE '/Library/Apple/System/%'
          OR cmd LIKE '/Applications/%/Contents/%'
          OR cmd LIKE '/Library/Apple/System/%'
          OR cmd LIKE '/Library/Application Support/Logitech.localized/%'
          OR cmd LIKE '/Library/Developer/CommandLineTools/%'
          OR p.path IN (
            '/Applications/Slack.app/Contents/Frameworks/Slack Helper.app/Contents/MacOS/Slack Helper',
            '/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper.app/Contents/MacOS/Code Helper',
            '/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Renderer).app/Contents/MacOS/Code Helper (Renderer)'
          )
          OR cmd LIKE '/opt/homebrew/Cellar/%'
          OR p.path LIKE '/Users/%/Library/Application Support/Steam/Steam.AppBundle/Steam/Contents/MacOS/ipcserver.old'
          OR p.path LIKE '/opt/homebrew/Cellar/%/bin/%'
          OR p.path LIKE '/private/var/kolide-k2/k2device.kolide.com/updates/%'
          OR p.path LIKE '/Users/%/homebrew/Cellar/%'
          OR p.path LIKE '/usr/local/Cellar/%/bin/%'
          OR p.path LIKE '/private/var/folders/zz/%/T/PKInstallSandboxTrash/%.sandboxTrash/%'
          OR p.path LIKE '/Users/%/node_modules/.pnpm/%'
          OR p.path LIKE '/Users/%/go/bin/%'
          OR p.path LIKE '/Users/%/homebrew/Cellar/%/bin/%'
          OR p.path LIKE '/Users/%/.terraform/providers/%/terraform-provider-%'
          OR p.path LIKE '/Users/%/.local/share/nvim/mason/packages/%'
          OR cmd LIKE '/opt/homebrew/opt/%'
          OR cmd LIKE '/private/var/folders/%/Visual Studio Code.app/Contents/%'
          OR cmd LIKE '/Users/%/homebrew/opt/mysql/bin/%' -- Sometimes cmd is empty also :(
          OR cmd LIKE '%/go/src/github.com/%'
          OR cmd LIKE '%/.terraform/providers/%'
          OR cmd LIKE ''
          OR parent_cmd LIKE '/Applications/Google Chrome.app/%'
        )
      )
      AND NOT (
        p.name = ''
        AND parent_cmd = '/Applications/Firefox Developer Edition.app/Contents/MacOS/firefox -foreground'
      )
      AND NOt cmd LIKE '/opt/homebrew/opt/%'
  tags: persistent, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Processes that have an unrelated name in the process tree than the
    program on disk.
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - name_path_mismatch
  observer_can_run: false
  platforms: ''
  query: |
    -- Processes that have an unrelated name in the process tree than the program on disk.
    --
    -- false positives:
    --   * new software, particularly those using interpreted languages
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1036/004/ (Masquerade Task or Service)
    --
    -- tags: persistent process
    SELECT
      SUBSTR(
        COALESCE(
          -- TODO: Fix to not require filename!
          REGEX_MATCH (f.filename, '(.*?)\W', 1),
          f.filename
        ),
        0,
        6
      ) AS short_filename,
      COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path) AS basename,
      COALESCE(
        REGEX_MATCH (p0.path, '.*/([a-zA-Z]+)', 1),
        p0.path
      ) AS base_letters,
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path),
        ',',
        p0.name
      ) AS exception_key,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.path != ''
      AND NOT p0.name == basename
      AND NOT (
        LENGTH(basename) > 1
        AND basename == short_filename
      )
      AND NOT (
        LENGTH(p0.name) > 2
        AND INSTR(LOWER(basename), LOWER(p0.name)) > 0
      )
      AND NOT (
        LENGTH(short_filename) > 2
        AND INSTR(LOWER(p0.name), LOWER(short_filename)) > 0
      ) -- Extremely common and unpredictable process name setters
      AND NOT base_letters IN (
        'bash',
        'dash',
        'busybox',
        'electron',
        'firefox',
        'node',
        'vim',
        'perl',
        'python',
        'ruby',
        'thunderbird'
      )
      AND NOT exception_key IN (
        '0,udevadm,systemd-udevd',
        '0,udevadm,(udev-worker)',
        '120,systemd-executor,(sd-pam)',
        '42,systemd-executor,(sd-pam)',
        '500,busybox,sh',
        '500,chainctl,docker-credenti',
        '500,coreutils,tail',
        '500,gjs-console,daemon.js',
        '500,gjs-console,gnome-character',
        '500,nc.openbsd,nc',
        '500,netcat,nc',
        '500,plugin-container,MainThread',
        '500,pyrogenesis,main',
        '500,rootlesskit,exe',
        '500,rootlessport,exe',
        '500,systemd-executor,(sd-pam)',
        '500,udevadm,systemd-udevd',
        '500,vim.basic,vi',
        '500,vim.nox,vi',
        '500,vim.tiny,vi',
        '500,x86_64-linux-gnu-as,as'
      )
      AND NOT exception_key LIKE '%,systemd,(sd-pam)'
      AND NOT (
        p0.path = '/usr/lib/xfce4/panel/wrapper-2.0'
        AND exception_key LIKE '500,wrapper-2.0,panel-%'
      )
      AND NOT p0.path IN ('/usr/lib/systemd/systemd')
      AND NOT p0_cgroup LIKE '/system.slice/docker-%'
    GROUP by
      exception_key
  tags: persistent, process
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Alert on programs running that are unusually old
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - old-binaries-running
  observer_can_run: false
  platforms: ''
  query: |
    -- Alert on programs running that are unusually old
    --
    -- false positive:
    --   * legimitely ancient programs. For instance, printer drivers.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/006/ (Indicator Removal on Host: Timestomp)
    --
    -- tags: transient process state
    SELECT
      p.path,
      p.cmdline,
      p.cwd,
      p.pid,
      p.name,
      f.mtime,
      f.ctime,
      p.cgroup_path,
      ((strftime('%s', 'now') - f.ctime) / 86400) AS ctime_age_days,
      ((strftime('%s', 'now') - f.mtime) / 86400) AS mtime_age_days,
      ((strftime('%s', 'now') - f.btime) / 86400) AS btime_age_days,
      h.sha256,
      f.uid,
      m.data,
      f.gid
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN hash h ON p.path = h.path
      LEFT JOIN magic m ON p.path = m.path
    WHERE
      (
        ctime_age_days > 1050
        OR mtime_age_days > 1050
      )
      -- Jan 1st, 1980 (the source of many false positives)
      AND f.mtime > 315561600
      AND f.path NOT LIKE '/home/%/idea-IU-223.8214.52/%'
      AND f.directory NOT LIKE '/Applications/%.app/Contents/MacOS'
      AND f.directory NOT LIKE '/Applications/%.app/Contents/Frameworks/%/Resources'
      AND f.directory NOT LIKE '/opt/homebrew/Cellar/%/bin'
      AND f.path NOT IN (
        '/Applications/Gitter.app/Contents/Library/LoginItems/GitterHelperApp.app/Contents/MacOS/GitterHelperApp',
        '/Applications/Pandora.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Resources/crashpad_handler',
        '/Applications/Skitch.app/Contents/Library/LoginItems/J8RPQ294UB.com.skitch.SkitchHelper.app/Contents/MacOS/J8RPQ294UB.com.skitch.SkitchHelper',
        '/Library/Application Support/Logitech/com.logitech.vc.LogiVCCoreService/LogiVCCoreService.app/Contents/MacOS/LogiVCCoreService',
        '/Library/Printers/Brother/Utilities/BrStatusMonitor.app/Contents/MacOS/BrStatusMonitor',
        '/Library/Application Support/Razer/RzUpdater.app/Contents/MacOS/RzUpdater',
        '/Library/Printers/Brother/Utilities/Server/LOGINserver.app/Contents/MacOS/LOGINserver',
        '/Library/Printers/Brother/Filter/rastertobrother2300.bundle/Contents/MacOS/rastertobrother2300',
        '/Applications/Vimari.app/Contents/PlugIns/Vimari Extension.appex/Contents/MacOS/Vimari Extension',
        '/Library/Printers/Brother/Utilities/Server/NETserver.app/Contents/MacOS/NETserver',
        '/Library/Printers/Brother/Utilities/Server/USBAppControl.app/Contents/MacOS/USBAppControl',
        '/Library/Application Support/EPSON/Scanner/ScannerMonitor/Epson Scanner Monitor.app/Contents/MacOS/Epson Scanner Monitor',
        '/Library/Printers/Brother/Utilities/Server/USBserver.app/Contents/MacOS/USBserver',
        '/Library/Printers/Brother/Utilities/Server/WorkflowAppControl.app/Contents/MacOS/WorkflowAppControl',
        '/snap/brackets/138/opt/brackets/Brackets',
        '/snap/brackets/138/opt/brackets/Brackets-node',
        '/usr/bin/i3blocks',
        '/usr/bin/sshfs',
        '/usr/bin/mono-sgen',
        '/usr/bin/xclip',
        '/usr/bin/xsel',
        '/usr/bin/pavucontrol',
        '/usr/bin/espeak',
        '/usr/bin/unpigz',
        '/usr/bin/xss-lock',
        '/usr/bin/i3lock',
        '/usr/bin/xbindkeys',
        '/usr/local/bin/dive'
      )
      AND p.name NOT IN (
        'buildkitd',
        'Flycut',
        'kail',
        'Vimari Extension',
        'Android File Transfer Agent',
        'BluejeansHelper',
        'J8RPQ294UB.com.skitch.SkitchHelper',
        'Pandora',
        'Pandora Helper',
        'dlv'
      )
      AND f.path NOT LIKE '/private/var/folders/%/T/AppTranslocation/%/d/Skitch.app/Contents/MacOS/Skitch'
      AND p.cgroup_path NOT LIKE '/system.slice/docker-%'
      AND p.cgroup_path NOT LIKE '/user.slice/user-%.slice/user@%.service/user.slice/nerdctl-%'
    GROUP BY
      p.pid,
      p.path
  tags: transient, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Processes with a memory map that suggests they might be code smuggling.
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - overwritten-memory-map-ddexec-linux
  observer_can_run: false
  platforms: ''
  query: |
    -- Processes with a memory map that suggests they might be code smuggling.
    --
    -- references:
    --   * https://github.com/arget13/DDexec
    --
    -- tags: persistent daemon seldom
    SELECT
      pmm.path AS mmap_path,
      pmm.start as mmap_start,
      pmm.end AS mmap_end,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN process_memory_map pmm ON p0.pid = pmm.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.path != ""
      AND pmm.offset = 0
      AND pmm.device = '00:00'
      AND pmm.permissions = 'r--p'
      AND pmm.pseudo = 0
      and pmm.start LIKE '0x0%'
    GROUP BY
      p0.pid;
  tags: persistent, daemon, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: A program where the parent PID is not on disk
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - parent-missing-from-disk-linux
  observer_can_run: false
  platforms: ''
  query: |
    -- A program where the parent PID is not on disk
    --
    -- Reveals boopkit if a child is spawned
    -- TODO: Make mount namespace aware
    --
    -- false positives:
    --   * none observed
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/004/ (Indicator Removal on Host: File Deletion)
    --
    -- false positives:
    --   * none observed
    --
    -- tags: persistent daemon
    SELECT -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p1.on_disk != 1
      AND p0.on_disk = 1
      AND NOT p0.pid IN (1, 2)
      AND NOT p1.pid IN (1, 2) -- launchd, kthreadd
      AND NOT p1.path IN (
        '/opt/brave.com/brave/brave',
        '/opt/google/chrome/chrome',
        '/usr/bin/alacritty',
        '/usr/bin/roxterm',
        '/usr/bin/doas',
        '/usr/bin/dockerd',
        '/usr/bin/fusermount3',
        '/usr/libexec/at-spi-bus-launcher',
        '/usr/bin/gnome-shell',
        '/usr/bin/ibus-daemon',
        '/usr/bin/kitty',
        '/usr/lib/electron22/electron',
        '/usr/bin/osqueryd',
        '/usr/libexec/gvfsd',
        '/usr/bin/sudo',
        '/usr/bin/tmux',
        '/usr/bin/yay',
        '/usr/libexec/gdm-wayland-session',
        '/usr/libexec/gdm-x-session',
        '/usr/libexec/gnome-terminal-server',
        '/usr/lib/gnome-session-binary',
        '/usr/lib/systemd/systemd',
        '/usr/lib/xdg-document-portal',
        '/usr/sbin/auditd',
        '/usr/sbin/gdm3',
        '/usr/sbin/sshd',
        '/usr/share/code/code'
      ) -- long-running launchers
      AND NOT p1.name IN (
        'bash',
        'dnf',
        'electron',
        'fish',
        'gnome-shell',
        'kubelet',
        'kube-proxy',
        'lightdm',
        'nvim',
        'sh',
        'slack'
      ) -- These alerts were unfortunately useless - lots of spam on macOS
      AND NOT (
        p1.path LIKE '/app/%'
        AND p1.cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/%'
      )
      AND NOT p2.name = 'bwrap'
      AND p1.cgroup_path NOT LIKE '/system.slice/docker-%'
      AND p1.cgroup_path NOT IN (
        '/system.slice/docker.service',
        '/system.slice/containerd.service'
      )
      AND p1.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
      AND p1.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/libpod-%'
      AND p1.cgroup_path NOT LIKE '/lxc.monitor.n%'
      AND p1.path NOT LIKE '/opt/homebrew/Cellar/%'
      AND p1.path NOT LIKE '/tmp/.mount_%/%'
      AND p1.path NOT LIKE '%google-cloud-sdk/.install/.backup%'
      AND NOT (
        p1.name LIKE 'kworker/%+events_unbound'
        AND p0.name IN ('modprobe')
      )
  tags: persistent, daemon
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: A program where the parent PID is not on disk
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - parent-missing-from-disk-macos
  observer_can_run: false
  platforms: ''
  query: |
    -- A program where the parent PID is not on disk
    --
    -- Reveals boopkit if a child is spawned
    -- TODO: Make mount namespace aware
    --
    -- false positives:
    --   * none observed
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/004/ (Indicator Removal on Host: File Deletion)
    --
    -- false positives:
    --   * none observed
    --
    -- tags: persistent daemon
    SELECT
      s.authority AS p0_auth,
      s.identifier AS p0_id,
      DATETIME(f.ctime, 'unixepoch') AS p0_changed,
      DATETIME(f.mtime, 'unixepoch') AS p0_modified,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          p.pid
        FROM
          processes p
          -- NOTE: This is an expensive join on macOS
          JOIN processes pp ON p.parent = pp.pid
        WHERE
          p.parent NOT IN (0, 1, 2)
          AND p.path != ""
          -- macOS Optimization
          AND p.path NOT LIKE '/System/%'
          AND p.path NOT LIKE '/usr/libexec/%'
          AND p.path NOT LIKE '/usr/bin/%'
          AND p.path NOT LIKE '/sbin/%'
          -- Exceptions
          AND pp.path NOT LIKE '/opt/homebrew/Cellar/%'
          AND pp.path NOT LIKE '%google-cloud-sdk/.install/.backup%'
          AND pp.path NOT LIKE '/private/var/folders/%/T/PKInstallSandboxTrash/%.sandboxTrash/%'
          AND pp.path NOT IN (
            "",
            "/sbin/launchd",
            "/var/lib/incus/containers",
            '/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper.app/Contents/MacOS/Code Helper',
            "/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code Helper (Plugin)",
            "/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper.app/Contents/MacOS/Code Helper"
          )
          AND pp.on_disk != 1
      );
  tags: persistent, daemon
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find a process which has a parent that is not listed in the process
    table
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - parent-pid-missing-from-procfs
  observer_can_run: false
  platforms: ''
  query: |
    -- Find a process which has a parent that is not listed in the process table
    --
    -- Works well for revealing boopkit, so long as boopkit has a child process.
    --
    -- references:
    --   * https://github.com/krisnova/boopkit
    --   * https://attack.mitre.org/techniques/T1014/ (Rootkit)
    --
    -- false positives:
    --   * Can by racy if child and parent exit at the right time
    --
    -- tags: persistent daemon
    SELECT
      p.*,
      hash.sha256,
      GROUP_CONCAT(DISTINCT pof.path) AS open_files
    FROM
      processes p
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN process_open_files pof ON p.pid = pof.pid
    WHERE -- Prevent false positives by avoiding short-lived commands
      p.start_time < (strftime('%s', 'now') -300)
      AND p.parent NOT IN (
        SELECT
          pid
        FROM
          processes
      )
      AND p.parent != 0
      AND p.parent IS NOT NULL
    GROUP BY
      p.pid
  tags: persistent, daemon
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Finds processes that are apparently hidden by a rootkit
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - pid-hidden-by-rootkit
  observer_can_run: false
  platforms: linux
  query: |
    -- Finds processes that are apparently hidden by a rootkit
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1014/ (Rootkit)
    --
    -- Confirmed to catch revenge-rtkit
    --
    -- false positives:
    --   * custom kernel modules
    --
    -- tags: persistent kernel state
    -- platform: linux
    WITH RECURSIVE
      cnt (x) AS (
        SELECT
          1
        UNION ALL
        SELECT
          x + 1
        FROM
          cnt
        LIMIT
          32768
      )
    SELECT
      p.*
    FROM
      cnt
      JOIN processes p ON x = p.pid
    WHERE
      x NOT IN (
        SELECT
          pid
        FROM
          processes
      )
      AND p.start_time < (strftime('%s', 'now') - 1) -- Improve how we filter tasks out.
      -- This is not very precise. What we really want to do is verify that
      -- this pid is not listed as a task of any other pid
      AND (
        p.pgroup = p.pid
        OR (
          p.pid = p.parent
          AND p.threads = 1
        )
      )
  tags: persistent, kernel, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find ssh sessions that are hiding from 'w'/'who'
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - ssh-notty
  observer_can_run: false
  platforms: posix
  query: |
    -- Find ssh sessions that are hiding from 'w'/'who'
    --
    -- false positives:
    --   * ssh-driven automation which disables the terminal, such as Znapzend
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1021/004/ (Remote Services: SSH)
    --   * https://attack.mitre.org/techniques/T1564/ (Hide Artifacts)
    --
    -- tags: transient process state
    -- platform: posix
    SELECT
      *
    FROM
      (
        SELECT
          p.pid,
          p.name,
          p.cmdline AS cmd,
          p.start_time,
          p.cwd,
          cp.name AS child_name,
          cp.cmdline AS child_cmd,
          gcp.name AS grandchild_name,
          gcp.cmdline AS grandchild_cmd,
          GROUP_CONCAT(DISTINCT pof.path) AS open_files
        FROM
          processes p
          LEFT JOIN process_open_files pof ON p.pid = pof.pid
          LEFT JOIN processes cp ON p.pid = cp.parent
          LEFT JOIN processes gcp ON cp.pid = gcp.parent
        WHERE
          p.name = 'sshd'
        GROUP BY
          p.pid
      )
    WHERE
      (
        INSTR(cmd, '@notty') > 0
        OR (
          open_files != '/dev/null'
          AND INSTR(open_files, '/dev/ptmx') = 0
        )
      )
      -- You must specifically check for NULL here, or risk inadvertently filtering everything out.
      AND (
        grandchild_name IS NULL
        OR grandchild_name != 'zfs'
      )
      AND child_name IS NOT NULL
      AND child_name NOT IN ('', 'zfs')
      AND child_cmd NOT LIKE '%osquery-defense-kit%make verify'
      AND grandchild_cmd NOT LIKE '%osquery-defense-kit%make verify'
      AND cmd != 'sshd: docker@notty'
  tags: transient, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Programs which were spawned by an executable containing a matching
    ctime & mtime, which
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - touched-executable-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Programs which were spawned by an executable containing a matching ctime & mtime, which
    -- on Linux only generally occurs occurs if you run 'touch <bin>'
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/006/ (Timestomping)
    --
    -- tags: transient process state
    -- platform: linux
    SELECT
      p.pid,
      p.path,
      p.name,
      p.cmdline,
      p.cwd,
      p.euid,
      p.parent,
      f.ctime,
      f.btime,
      f.mtime,
      p.start_time,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      hash.sha256 AS sha256
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      f.ctime = f.mtime
      AND p.path != '/'
      AND f.path NOT IN (
        '/opt/google/endpoint-verification/bin/apihelper',
        '/opt/Elastic/Endpoint/elastic-endpoint',
        '/opt/resolve/bin/resolve',
        '/var/opt/velociraptor/bin/velociraptor',
        '/usr/bin/melange'
      )
      AND f.path NOT LIKE '/home/%'
      AND f.path NOT LIKe '/var/home/%'
      AND f.path NOT LIKE '/snap/%'
      AND f.path NOT LIKE '/tmp/%go-build%/exe/%'
      AND f.path NOT LIKE '/usr/local/bin/%'
      AND f.path NOT LIKE '/opt/rapid7/ir_agent/%'
      AND f.path NOT LIKE '/var/home/linuxbrew/.linuxbrew/%'
      AND f.path NOT LIKE '/opt/Elastic/Agent/data/elastic-agent%'
      AND f.path NOT LIKE '/usr/local/aws-cli/%/dist/aws'
      AND f.path NOT LIKE '/usr/local/kolide-k2/bin/%-updates/%'
      AND f.path NOT LIKE '/var/kolide-k2/k2device.kolide.com/updates/%'
      AND f.path NOT LIKE '/tmp/go-build%'
      AND f.path NOT LIKE '/var/home/linuxbrew/.linuxbrew/Cellar/%/bin/%'
      AND p.name NOT LIKE 'osqtool%'
      AND f.path NOT LIKE '%/go/bin/%'
      AND f.path NOT LIKE '%/osqueryi'
    GROUP by
      p.pid
  tags: transient, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Programs which appear to have been touched on macOS
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - touched-executable-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Programs which appear to have been touched on macOS
    --
    -- This check is probably not very useful as there are plenty of legit reasons why
    -- the dates (in particular, 'btime'), gets doctored.
    --
    -- false positives:
    --   * Programs which are packaged weirdly and don't follow the typical Apple app layout
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/006/ (Timestomping)
    --
    -- tags: transient seldom filesystem state
    -- platform: darwin
    SELECT
      p.path,
      p.name,
      p.cmdline,
      p.euid,
      DATETIME(p.start_time, 'unixepoch') AS started,
      DATETIME(f.ctime, 'unixepoch') AS changed,
      DATETIME(f.btime, 'unixepoch') AS birthed,
      DATETIME(f.mtime, 'unixepoch') AS modified,
      DATETIME(f.atime, 'unixepoch') AS accessed,
      (f.btime - f.ctime) / 86400 AS btime_ctime_days_diff,
      (p.start_time - f.atime) / 86400 AS start_atime_days_diff,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      hash.sha256 AS sha256,
      signature.identifier,
      signature.authority
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN signature ON p.path = signature.path
    WHERE
      p.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          path NOT LIKE '/System/%'
          AND path NOT LIKE '/Library/Apple/%'
          AND path NOT LIKE '/usr/libexec/%'
          AND path NOT LIKE '/usr/sbin/%'
          AND path NOT LIKE '/sbin/%'
          AND path NOT LIKE '/Volumes/%'
          AND path NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'
          AND path NOT LIKE '/usr/bin/%'
          AND path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
          AND path NOT LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/Kolide.app/Contents/MacOS/launcher'
      )
      AND f.btime == f.mtime
      AND (
        -- change time is older than birth time
        btime_ctime_days_diff > 0 -- change time is older than birth time, but not 1970
        OR (
          (btime_ctime_days_diff < -365)
          AND (btime_ctime_days_diff < -1000)
        )
        -- access time is older than start time
        OR start_atime_days_diff > 90
      ) -- Vendors that create software packages that look like a touched file.
      AND NOT signature.authority IN (
        'Apple Mac OS Application Signing',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4)',
        'Developer ID Application: Brother Industries, LTD. (5HCL85FLGW)',
        'Developer ID Application: Bryan Jones (49EYHPJ4Q3)',
        'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Emmanouil Konstantinidis (3YP8SXP3BF)',
        'Developer ID Application: Fumihiko Takayama (G43BCU2T37)', -- Karibiner
        'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'Developer ID Application: Galvanix (5BRAQAFB8B)',
        'Developer ID Application: General Arcade (Pte. Ltd.) (S8JLSG5ES7)',
        'Developer ID Application: GitHub (VEKTX9H2N7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Michael Jones (YD6LEYT6WZ)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: Reflect App, LLC (789ULN5MZB)',
        'Developer ID Application: RescueTime, Inc (FSY4RB8H39)',
        'Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',
        'Developer ID Application: Slack Technologies, Inc. (BQR82RBBHL)',
        'Developer ID Application: Sublime HQ Pty Ltd (Z6D26JE4Y4)',
        'Developer ID Application: Yubico Limited (LQA3CS5MM7)',
        'Developer ID Application: Zoom Video Communications, Inc.',
        'Software Signing'
      )
      AND NOT (
        p.euid > 500
        AND (
          p.path IN (
            '/Applications/Canon Utilities/IJ Scan Utility/Canon IJ Scan Utility Lite.app/Contents/Library/LoginItems/CIJSULAgent.app/Contents/MacOS/CIJSULAgent',
            '/Applications/Canon Utilities/Inkjet Extended Survey Program/Inkjet Extended Survey Program.app/Contents/MacOS/ESPController.app/Contents/Library/LoginItems/CanonIJExtendedSurveyLaunchAgent.app/Contents/MacOS/CanonIJExtendedSurveyLaunchAgent',
            '/Applications/Divvy.app/Contents/MacOS/Divvy',
            '/opt/homebrew/share/google-cloud-sdk/bin/log-streaming',
            '/usr/local/bin/node',
            '/Applications/Sourcetree.app/Contents/MacOS/Sourcetree',
            '/Library/CoreMediaIO/Plug-Ins/DAL/LogiCapture.plugin/Contents/MacOS/Assistant',
            '/Library/Printers/Brother/Utilities/BrStatusMonitor.app/Contents/MacOS/BrStatusMonitor'
          )
          OR p.path LIKE '/Users/%/Library/Application Support/com.elgato.StreamDeck/Plugins/%'
          OR p.path LIKE '/private/var/folders/%/T/AppTranslocation/%/Contents/MacOS/%'
          OR p.path LIKE '/Applications/%.app/Contents/MacOS/%'
          OR p.path LIKE '/Applications/%.app/Contents/Frameworks/%/Versions/A/Resources/%'
          OR p.path LIKE '/opt/homebrew/Cellar/%/bin/%'
          OR p.path LIKE '/opt/homebrew/Caskroom/%/bin/%'
          OR p.path LIKE '/Users/%/google-cloud-sdk/bin/%'
          OR p.path LIKE '/Users/%/J8RPQ294UB.com.skitch.SkitchHelper'
        )
      )
      AND NOT (
        p.euid > 300
        AND p.path LIKE '/nix/store/%'
      )
      AND NOT (
        p.euid > 300
        -- Electron
        AND p.path LIKE '% Helper'
      )
      AND NOT (
        p.euid = 0
        AND (
          p.path LIKE '/nix/store/%/bin/nix'
          OR p.path LIKE '/nix/store/%/bin/nix-daemon'
        )
      )
    GROUP by
      p.pid
  tags: transient, seldom, filesystem, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: macOS application layer firewall (ALF) service exceptions.
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-alf-exceptions-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- macOS application layer firewall (ALF) service exceptions.
    --
    -- false positives:
    --   * locally built software
    --
    -- tags: persistent state filesystem
    -- platform: darwin
    SELECT
      ae.path,
      ae.state,
      file.mtime,
      file.ctime,
      file.uid,
      file.directory,
      file.size,
      file.type,
      hash.sha256,
      signature.identifier,
      signature.authority,
      CONCAT (
        signature.authority,
        ',',
        signature.identifier,
        ',',
        ae.path,
        ',',
        MIN(file.uid, 501)
      ) AS exception_key
    FROM
      alf_exceptions ae
      LEFT JOIN file ON ae.path = file.path
      LEFT JOIN hash ON ae.path = hash.path
      LEFT JOIN signature ON ae.path = signature.path
    WHERE -- Filter out stock exceptions to decrease overhead
      ae.path NOT IN (
        '/System/Library/CoreServices/UniversalControl.app/',
        '/System/Library/PrivateFrameworks/Admin.framework/Versions/A/Resources/readconfig',
        '/System/Library/PrivateFrameworks/EmbeddedOSInstall.framework/Versions/A/XPCServices/EmbeddedOSInstallService.xpc/',
        '/usr/bin/nmblookup',
        '/usr/libexec/bootpd',
        '/usr/libexec/configd',
        '/usr/libexec/discoveryd',
        '/usr/libexec/xartstorageremoted',
        '/usr/sbin/mDNSResponder',
        '/usr/sbin/racoon'
      ) -- Ignore files that ahve already been removed
      AND file.filename NOT NULL
      AND exception_key NOT IN (
        ',a.out,/opt/homebrew/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/bin/kubectl,501',
        ',a.out,/opt/homebrew/Cellar/go/1.20.4/libexec/pkg/tool/darwin_arm64/trace,501',
        ',a.out,/private/tmp/learning-labs-static/server,501',
        ',a.out,/Users/amouat/proj/learning-labs-static/server,501',
        ',a.out,/Users/dlorenc/.wash/downloads/nats-server,501',
        'Apple Mac OS Application Signing,com.anydo.mac,/Applications/Anydo.app/,0',
        'Apple Mac OS Application Signing,com.apple.garageband10,/Applications/GarageBand.app/,0',
        'Apple Mac OS Application Signing,com.busymac.busycal3,/Applications/BusyCal.app/,0',
        'Apple Mac OS Application Signing,com.evernote.Evernote,/Applications/Evernote.app/,0',
        'Apple Mac OS Application Signing,com.joeallen.teleprompter.mac,/Applications/Teleprompter.app/,0',
        'Apple Mac OS Application Signing,com.utmapp.QEMULauncher,/Applications/UTM.app/Contents/XPCServices/QEMUHelper.xpc/Contents/MacOS/QEMULauncher.app/,0',
        'Apple Mac OS Application Signing,io.tailscale.ipn.macos.network-extension,/Applications/Tailscale.app/Contents/PlugIns/IPNExtension.appex/,0',
        'Apple Mac OS Application Signing,io.tailscale.ipn.macos.network-extension,/Applications/Tailscale.localized/Tailscale.app/Contents/PlugIns/IPNExtension.appex/,0',
        ',,/Applications/Google%20Chrome.app/,',
        ',,/Applications/IntelliJ%20IDEA.app/,',
        ',,/Applications/ProtonMail%20Bridge.app/,',
        ',,/Applications/Visual%20Studio%20Code.app/,',
        ',,/Applications/Visual%20Studio%20Code.app/Contents/Frameworks/Code%20Helper.app/,',
        'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF),com.adguard.mac.adguard.network-extension,/Library/SystemExtensions/AD3BCA34-237A-4135-B7A4-0F7477D9144C/com.adguard.mac.adguard.network-extension.systemextension/,0',
        'Developer ID Application: Any.DO inc. (FW4RAPJ9FF),com.anydo.mac,/Applications/Anydo.app/,501',
        'Developer ID Application: Bearly Inc (NK6K4BACCF),com.bearly.app,/Applications/Bearly.app/,501',
        'Developer ID Application: Bohemian Coding (WUGMZZ5K46),com.bohemiancoding.sketch3,/Applications/Sketch.app/,501',
        'Developer ID Application: Bohemian Coding (WUGMZZ5K46),com.bohemiancoding.SketchMirrorHelper,/Applications/Sketch.app/Contents/XPCServices/SketchMirrorHelper.xpc/,501',
        'Developer ID Application: Brother Industries, LTD. (5HCL85FLGW),com.brother.utility.WorkflowAppControlServer,/Library/Printers/Brother/Utilities/Server/WorkflowAppControl.app/,0',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59),com.canonical.multipass.,/Applications/Multipass.app/,0',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5),com.elgato.WaveLink,/Applications/WaveLink.app/,0',
        'Developer ID Application: Crul, Inc. (5PTD6R25S6),com.electron.crul,/Applications/crul.app/,501',
        'Developer ID Application: DBeaver Corporation (42B6MDKMW8),org.jkiss.dbeaver.core.product,/Applications/DBeaver.app/,501',
        'Developer ID Application: Docker Inc (9BNSXJN65R),com.docker.docker,/Applications/Docker.app/,501',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK),com.getdropbox.dropbox,/Applications/Dropbox.app/,501',
        'Developer ID Application: Evernote Corporation (Q79WDW8YH9),com.evernote.Evernote,/Applications/Evernote.app/,501',
        'Developer ID Application: folivora.AI GmbH (DAFVSXZ82P),com.hegenberg.BetterTouchTool,/Applications/BetterTouchTool.app/,501',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),com.jetbrains.goland,/Applications/GoLand.app/,501',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),com.jetbrains.pycharm,/Applications/PyCharm.app/,501',
        'Developer ID Application: Shanghai Lunkuo Technology Co., Ltd (T3UBR9Y3B2),com.bambulab.bambu-studio,/Applications/BambuStudio.app/,501',
        'Developer ID Application: Loom, Inc (QGD2ZPXZZG),com.loom.desktop,/Applications/Loom.app/,501',
        'Developer ID Application: Martijn Smit (GX645XXEAX),com.mutedeck.mac,/Applications/MuteDeck/MuteDeck.app/,501',
        'Developer ID Application: Opentest, Inc. (QGD2ZPXZZG),com.loom.desktop,/Applications/Loom.app/,501',
        'Developer ID Application: Postdot Technologies, Inc (H7H8Q7M5CK),com.postmanlabs.mac,/Applications/Postman.app/,501',
        'Developer ID Application: Python Software Foundation (BMM5U3QVKW),org.python.python,/Library/Frameworks/Python.framework/Versions/3.11/Resources/Python.app/,0',
        'Developer ID Application: Python Software Foundation (BMM5U3QVKW),org.python.python,/Library/Frameworks/Python.framework/Versions/3.12/Resources/Python.app/,0',
        'Developer ID Application: Raycast Technologies Inc (SY64MV22J9),com.raycast.macos,/Applications/Raycast.app/,501',
        'Developer ID Application: RescueTime, Inc (FSY4RB8H39),c]om.rescuetime.RescueTime,/Applications/RescueTime.app/,0',
        'Developer ID Application: Sonos, Inc. (2G4LW83Q3E),com.sonos.macController,/Applications/Sonos.app/,501',
        'Developer ID Application: Spotify (2FNC3A47ZF),com.spotify.client,/Applications/Spotify.app/,501',
        'Developer ID Application: Tailscale Inc. (W5364U7YZB),io.tailscale.ipn.macsys.network-extension,/Library/SystemExtensions/A30AF854-E980-4345-A658-17000BF66D00/io.tailscale.ipn.macsys.network-extension.systemextension/,0',
        'Developer ID Application: VNG ONLINE CO.,LTD (CVB6BX97VM),com.vng.zalo,/Applications/Zalo.app/,501',
        'Developer ID Application: Voicemod Sociedad Limitada. (S2MC4XQDSM),net.voicemod.desktop,/Applications/Voicemod.app/,0',
        'Developer ID Application: Zed Industries, Inc. (MQ55VZLNZQ),dev.zed.Zed,/Applications/Zed.app/,501',
        'Developer ID Application: Zed Industries, Inc. (MQ55VZLNZQ),dev.zed.Zed,/Volumes/Zed/Zed.app/,501',
        ',dnsmasq,/opt/homebrew/Cellar/dnsmasq/2.88/sbin/dnsmasq,0',
        ',java,/opt/homebrew/Cellar/openjdk/19/libexec/openjdk.jdk/Contents/Home/bin/java,501',
        ',net.java.openjdk.java,/usr/local/Cellar/openjdk/21.0.2/libexec/openjdk.jdk/Contents/Home/bin/java,501',
        'Software Signing,com.apple.audio.AUHostingService.arm64e,/System/Library/Frameworks/AudioToolbox.framework/XPCServices/AUHostingServiceXPC_arrow.xpc/,0',
        'Software Signing,com.apple.audio.AUHostingService.x86-64,/System/Library/Frameworks/AudioToolbox.framework/XPCServices/AUHostingServiceXPC.xpc/,0',
        'Software Signing,com.apple.audio.InfoHelper,/System/Library/Frameworks/AudioToolbox.framework/XPCServices/com.apple.audio.InfoHelper.xpc/,0',
        'Software Signing,com.apple.controlcenter,/System/Library/CoreServices/ControlCenter.app/,0',
        'Software Signing,com.apple.Music,/System/Applications/Music.app/,0',
        'Software Signing,com.apple.nc,/usr/bin/nc,0',
        'Software Signing,com.apple.netbiosd,/usr/sbin/netbiosd,0',
        'Software Signing,com.apple.python3,/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.9/Resources/Python.app/,0',
        'Software Signing,com.apple.python3,/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/Resources/Python.app/,0',
        'Software Signing,com.apple.rapportd,/usr/libexec/rapportd,0',
        'Software Signing,com.apple.rpc,/usr/sbin/rpc.lockd,0',
        'Software Signing,com.apple.Terminal,/System/Applications/Utilities/Terminal.app/,0',
        'Software Signing,com.apple.WebKit.Networking,/System/Library/Frameworks/WebKit.framework/Versions/A/XPCServices/com.apple.WebKit.Networking.xpc/,0',
        'Software Signing,com.apple.WebKit.Networking,/System/Volumes/Preboot/Cryptexes/OS/System/Library/Frameworks/WebKit.framework/Versions/A/XPCServices/com.apple.WebKit.Networking.xpc/,0',
        'Software Signing,com.apple.xartstorageremoted,/usr/libexec/xartstorageremoted,0',
        '/System/Volumes/Preboot/Cryptexes/OS/System/Library/Frameworks/WebKit.framework/Versions/A/XPCServices/com.apple.WebKit.Networking.xpc/',
        ',,/Users/cpanato/code/src/github.com/sigstore/docs/node_modules/.bin/hugo/hugo,501'
      )
      AND NOT exception_key LIKE ',a.out,/Users/%/dev/%,501'
      AND NOT exception_key LIKE ',a.out,/Users/%/hugo,501'
      AND NOT exception_key LIKE 'Developer ID Application: Cypress.Io, Inc. (7D655LWGLY),com.electron.cypress,/Users/%/Library/Caches/Cypress/13.12.0/Cypress.app/,501'
      AND NOT exception_key LIKE 'Developer ID Application: The Foundry (82R497YNSK),org.python.python,/Applications/Nuke%/Contents/Frameworks/Python.framework/Versions/%/Resources/Python.app/,501'
      AND NOT exception_key LIKE 'Developer ID Application: Tailscale Inc. (W5364U7YZB),io.tailscale.ipn.macsys.network-extension,/Library/SystemExtensions/%'
      AND NOT exception_key LIKE ',org.python.python,/opt/homebrew/Cellar/python%/Frameworks/Python.framework/Versions/%/Resources/Python.app/,501'
      AND NOT exception_key LIKE ',a.out,/Users/%/act/dist/local/act,501'
      AND NOT exception_key LIKE ',git-daemon-%,/opt/homebrew/Cellar/git/%/libexec/git-core/git-daemon,501'
      AND NOT exception_key LIKE ',org.python.python,/opt/homebrew/Cellar/python@%/Frameworks/Python.framework/Versions/3.11/Resources/Python.app/,501'
      AND NOT exception_key LIKE ',a.out,/opt/homebrew/Cellar/podman/%/libexec/podman/gvproxy,501'
      AND NOT exception_key LIKE ',net.java.openjdk.java,/opt/homebrew/Cellar/openjdk%/libexec/openjdk.jdk/Contents/Home/bin/java,501'
      AND NOT exception_key LIKE ',a.out,/private/var/folders/%/T/GoLand/%,501'
      AND NOT exception_key LIKE ',a.out,/Users/%/cloud-provider-kind,501'
      AND NOT exception_key LIKE ',a.out,/Users/%/GolandProjects/documentation-code-examples/debuggingTutorial/myApp,501'
      AND NOT exception_key LIKE ',node,/opt/homebrew/Cellar/nvm/%/versions/node/v%/bin/node,501'
      AND NOT exception_key LIKE ',java,/opt/homebrew/Cellar/openjdk/%/libexec/openjdk.jdk/Contents/Home/bin/java,501'
      AND NOT exception_key LIKE ',python3.%,/nix/store/%-python3-3%/bin/python3.%,0'
      AND NOT exception_key LIKE 'Developer ID Application: Cypress.Io, Inc. (7D655LWGLY),com.electron.cypress,/Users/%/Library/Caches/Cypress/12.9.0/Cypress.app/,501'
      AND NOT signature.authority IN (
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: The Foundry (82R497YNSK)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: OpenAI, L.L.C. (2DC432GLL2)'
      )
      AND NOT (
        signature.identifier LIKE 'cargo-%'
        AND ae.path LIKE '/Users/%/.rustup/%'
      )
      AND NOT (
        signature.identifier LIKE 'fake-%'
        AND ae.path LIKE '%/exe/fake'
      )
      AND NOT (
        signature.identifier LIKE 'mariadbd-%'
        AND ae.path LIKE '/opt/homebrew/%/mariadbd'
      )
      AND NOT (
        signature.identifier = 'netcat'
        AND ae.path LIKE '/Users/%/homebrew/Cellar/netcat/%/bin/netcat'
      )
      AND NOT (
        signature.identifier = 'syncthing'
        AND ae.path LIKE '/nix/store/%-syncthing-%/bin/syncthing'
      )
      AND NOT (
        signature.identifier = 'nix'
        AND ae.path LIKE '/nix/store/%-nix-%/bin/nix'
      )
      AND NOT (
        ae.path LIKE '/Users/%/Library/Application%20Support/Steam/Steam.AppBundle/Steam/'
      )
      AND NOT (
        signature.authority = ''
        AND signature.identifier = 'org.chromium.Chromium'
        AND ae.path LIKE '/Users/%/Library/pnpm/global/%/.pnpm/carlo@%/node_modules/carlo/lib/.local-data/mac-%/chrome-mac/Chromium.app/'
      )
      AND NOT (
        (
          signature.identifier = 'a.out'
          OR signature.identifier LIKE '%-%'
        )
        AND file.uid > 500
        AND (
          file.directory LIKE '/opt/homebrew/Cellar/%/bin'
          OR file.directory LIKE '/Users/%/bin'
          OR file.directory LIKE '/Users/%/code/%'
          OR file.directory LIKE '/Users/%/src/%'
          OR file.directory LIKE '/Users/%/gh/%'
          OR file.directory LIKE '/Users/%/debug/%'
          OR file.directory LIKE '/Users/%/target/%'
          OR file.directory LIKE '/Users/%/tmp/%'
          OR file.directory LIKE '/Users/%/sigstore/%'
          OR file.directory LIKE '/Users/%/node_modules/.bin/%'
          OR file.directory LIKE '/Users/%/git/%'
          OR file.directory LIKE '/Users/%/%-cli'
          OR file.directory LIKE '/private/var/folders/%/T/go-build%/exe'
        )
      )
    GROUP BY
      exception_key
  tags: persistent, state, filesystem
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected files in /dev
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-dev-entries
  observer_can_run: false
  platforms: posix
  query: |
    -- Find unexpected files in /dev
    --
    -- references:
    --   * https://www.sandflysecurity.com/blog/bpfdoor-an-evasive-linux-backdoor-technical-analysis/
    --
    -- false positives:
    --   * programs which have legimate uses for /dev/shm (Chrome, etc)
    --
    -- tags: persistent state filesystem
    -- platform: posix
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE '/dev/shm/%%'
        OR file.path LIKE '/dev/%/.%'
        OR file.path LIKE '/dev/.%'
        OR file.path LIKE '/dev/.%/%'
        OR file.path LIKE '/dev/%%/.%/%'
        OR file.path LIKE '/dev/mqueue/%%'
      ) -- We should also use uid for making decisions here
      AND NOT (
        file.uid > 499
        AND (
          file.path LIKE '/dev/shm/.com.google.%'
          OR file.path LIKE '/dev/shm/.org.chromium.%'
          OR file.path LIKE '/dev/shm/wayland.mozilla.%'
          OR file.path LIKE '/dev/shm/byobu-%'
          OR file.path LIKE '/dev/shm/shm-%-%-%'
          OR file.path LIKE '/dev/shm/pulse-shm-%'
          OR file.path LIKE '/dev/shm/u1000-Shm%'
          OR file.path LIKE '/dev/shm/sem.%autosave'
          OR file.path LIKE '/dev/shm/u1000-Valve%'
          OR file.path LIKE '/dev/shm/aomshm.%'
          OR file.path LIKE '/dev/shm/jack_db%'
        )
      )
      AND file.path NOT LIKE '/dev/shm/lttng-ust-wait-%'
      AND file.path NOT LIKE '/dev/shm/flatpak-%'
      AND file.path NOT LIKE '/dev/shm/libpod_rootless_lock_%'
      AND file.path NOT LIKE '/dev/shm/sem.mp-%'
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND file.path NOT IN ('/dev/.mdadm/', '/dev/shm/libpod_lock')
  tags: persistent, state, filesystem
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected executables in /dev
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-dev-executables-linux
  observer_can_run: false
  platforms: ''
  query: |
    -- Find unexpected executables in /dev
    --
    -- references:
    --   * https://www.sandflysecurity.com/blog/bpfdoor-an-evasive-linux-backdoor-technical-analysis/
    --
    -- tags: persistent state filesystem
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        -- This list is the result of multiple queries combined and can likely be minimized
        file.path LIKE '/dev/%%'
        OR file.path LIKE '/dev/%%/%%'
        OR file.path LIKE '/dev/mqueue/%%'
        OR file.path LIKE '/dev/mqueue/.%/%%'
        OR file.path LIKE '/dev/mqueue/%/%%'
        OR file.path LIKE '/dev/mqueue/%/%/.%'
        OR file.path LIKE '/dev/mqueue/%/.%/%%'
        OR file.path LIKE '/dev/shm/%%'
        OR file.path LIKE '/dev/shm/.%/%%'
        OR file.path LIKE '/dev/shm/%/%%'
        OR file.path LIKE '/dev/shm/%/%/.%'
        OR file.path LIKE '/dev/shm/%/.%/%%'
      )
      AND file.type = 'regular'
      AND file.size > 64
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND (
        file.mode LIKE '%7%'
        or file.mode LIKE '%5%'
        or file.mode LIKE '%1%'
      ) -- Seen on Ubuntu
      AND NOT (
        file.uid = 1000
        AND file.gid = 1000
        AND file.mode = '0700'
        AND (
          magic.data IS NULL
          OR magic.data = 'data'
        )
        AND file.path LIKE '/dev/shm/pulse-shm-%'
        AND file.size > 60000000
      ) -- Seen with Steam
      AND NOT (
        file.uid = 1000
        AND file.gid IN (100, 1000)
        AND file.mode IN ('0755', '0775')
        AND file.path LIKE '/dev/shm/u1000-Shm_%'
        AND (
          magic.data IS NULL
          OR magic.data NOT LIKE "%executable%"
          OR magic.data IN (
            'data',
            'Applesoft BASIC program data, first line number 86',
            'mc68k executable (shared)',
            'DOS executable (COM)'
          )
        )
      )
      AND NOT (
        file.uid = 1000
        AND file.gid IN (100, 1000)
        AND file.mode IN ('0755', '0775')
        AND magic.data IS NULL
        AND file.path LIKE '/dev/shm/u1000-Shm_%'
      )
      AND NOT (
        file.uid = 1000
        AND file.gid IN (100, 1000)
        AND file.mode IN ('0755', '0775')
        AND file.path = '/dev/shm/u1000-ValveIPCSharedObj-Steam'
        AND file.size > 2000000
      )
      AND NOT (
        file.uid = 1000
        AND file.mode = '0755'
        AND file.path LIKE '/dev/shm/flatpak-com.valvesoftware.Steam-%/u1000-Shm_%'
        AND file.size > 1000000
      )
  tags: persistent, state, filesystem
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected executables in /etc
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-etc-executables
  observer_can_run: false
  platforms: posix
  query: |
    -- Find unexpected executables in /etc
    --
    -- references:
    --   * https://blog.lumen.com/chaos-is-a-go-based-swiss-army-knife-of-malware/
    --
    -- tags: persistent
    -- platform: posix
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (file.path LIKE '/etc/%%')
      AND file.type = 'regular'
      AND (
        file.mode LIKE '%7%'
        or file.mode LIKE '%5%'
        or file.mode LIKE '%1%'
      )
      AND file.directory NOT IN (
        '/etc/acpi',
        '/etc/acpi/actions',
        '/etc/alternatives',
        '/etc/apcupsd',
        '/etc/apm/resume.d',
        '/etc/apm/scripts.d',
        '/etc/apm/suspend.d',
        '/etc/avahi',
        '/etc/bash_completion.d',
        '/etc/brltty/Contraction',
        '/etc/ca-certificates/update.d',
        '/etc/chromium/native-messaging-hosts',
        '/etc/cifs-utils',
        '/etc/cloud/clean.d/99-installer-use-networkmanager',
        '/etc/console-setup',
        '/etc/cron.daily',
        '/etc/cron.hourly',
        '/etc/cron.monthly',
        '/etc/cron.weekly',
        '/etc/dhcp/dhclient.d',
        '/etc/dhcp/dhclient-enter-hooks.d',
        '/etc/dhcp/dhclient-exit-hooks.d',
        '/etc/dkms',
        '/etc/flatpak/remotes.d',
        '/etc/gdm',
        '/etc/gdm3',
        '/etc/gdm3/Init',
        '/etc/gdm3/PostLogin',
        '/etc/gdm3/PostSession',
        '/etc/gdm3/PreSession',
        '/etc/gdm3/Prime',
        '/etc/gdm3/PrimeOff',
        '/etc/gdm/Init',
        '/etc/gdm/PostLogin',
        '/etc/gdm/PostSession',
        '/etc/gdm/PreSession',
        '/etc/grub.d',
        '/etc/httpd/modules',
        '/etc/ifplugd',
        '/etc/ifplugd/action.d',
        '/etc/init.d',
        '/etc/initramfs/post-update.d',
        '/etc/kde/shutdown',
        '/etc/kernel/header_postinst.d',
        '/etc/kernel/install.d',
        '/etc/kernel/postinst.d',
        '/etc/kernel/postrm.d',
        '/etc/kernel/preinst.d',
        '/etc/kernel/prerm.d',
        '/etc/lightdm',
        '/etc/localtime',
        '/etc/mc',
        '/etc/mcelog/triggers',
        '/etc/menu-methods',
        '/etc/needrestart/hook.d',
        '/etc/needrestart/notify.d',
        '/etc/needrestart/restart.d',
        '/etc/network',
        '/etc/network/if-down.d',
        '/etc/network/if-post-down.d',
        '/etc/network/if-pre-up.d',
        '/etc/network/if-up.d',
        '/etc/NetworkManager/dispatcher.d',
        '/etc/nix/result',
        '/etc/nix/result/sw/bin',
        '/etc/openvpn',
        '/etc/periodic/daily',
        '/etc/periodic/monthly',
        '/etc/periodic/weekly',
        '/etc/pinentry',
        '/etc/pki/tls/misc',
        '/etc/pm/sleep.d',
        '/etc/pop-os/update-motd.d',
        '/etc/ppp',
        '/etc/ppp/ip-down.d',
        '/etc/ppp/ip-up.d',
        '/etc/ppp/ipv6-up.d',
        '/etc/profile.d',
        '/etc/qemu-ga',
        '/etc/rc0.d',
        '/etc/rc1.d',
        '/etc/rc2.d',
        '/etc/rc3.d',
        '/etc/rc4.d',
        '/etc/rc5.d',
        '/etc/rc6.d',
        '/etc/rc.d/init.d',
        '/etc/rc.d/rc0.d',
        '/etc/rc.d/rc1.d',
        '/etc/rc.d/rc2.d',
        '/etc/rc.d/rc3.d',
        '/etc/rc.d/rc4.d',
        '/etc/rc.d/rc5.d',
        '/etc/rc.d/rc6.d',
        '/etc/rcS.d',
        '/etc/rdnssd',
        '/etc/redhat-lsb',
        '/etc/resolvconf/update.d',
        '/etc/resolvconf/update-libc.d',
        '/etc/schroot/setup.d',
        '/etc/security',
        '/etc/skel',
        '/etc/smartmontools',
        '/etc/ssl/certs',
        '/etc/ssl/misc',
        '/etc/ssl/trust-source',
        '/etc/sysconfig/network-scripts',
        '/etc/systemd/system',
        '/etc/systemd/system/graphical.target.wants',
        '/etc/systemd/system-shutdown',
        '/etc/udev/rules.d',
        '/etc/update-motd.d',
        '/etc/vmware-tools',
        '/etc/vmware-tools/scripts/vmware',
        '/etc/vpnc',
        '/etc/wpa_supplicant',
        '/etc/X11',
        '/etc/X11/xinit',
        '/etc/X11/xinit/xinitrc.d',
        '/etc/xdg/Xwayland-session.d',
        '/etc/zfs-fuse',
        '/etc/zfs/zed.d',
        '/etc/zfs/zpool.d'
      )
      AND file.path NOT IN (
        '/etc/cloud/clean.d/99-installer',
        '/etc/cloud/clean.d/99-installer-use-networkmanager',
        '/etc/grub2.cfg',
        '/etc/grub2-efi.cfg',
        '/etc/hibernate.sh',
        '/etc/pcp/pmie/rc',
        '/etc/sddm/wayland-session',
        '/etc/libpaper.d/texlive-base',
        '/etc/modulefiles/vpl',
        '/etc/nftables.conf',
        '/etc/opt/chrome/native-messaging-hosts/com.google.endpoint_verification.api_helper.json',
        '/etc/paths.d/100-rvictl',
        '/etc/pcp/pmcd/rc.local',
        '/etc/pcp/pmlogger/rc',
        '/etc/pcp/pmproxy/rc',
        '/etc/pki/tls/certs/make-dummy-cert',
        '/etc/pki/tls/certs/renew-dummy-cert',
        '/etc/postfix/postfix-script',
        '/etc/postfix/post-install',
        '/etc/profile',
        '/etc/pwrstatd.conf',
        '/etc/qemu-ifdown',
        '/etc/qemu-ifup',
        '/etc/rmt',
        '/etc/sddm/Xsetup',
        '/etc/sddm/Xstop',
        '/etc/shutdown.sh',
        '/etc/sudoers.d/lima',
        '/etc/sv/ssh/finish',
        '/etc/sv/ssh/run',
        '/etc/udev/powersave.sh',
        '/etc/vpl/vars.sh'
      )
      -- Nix (on macOS) -- actually a symbolic link
      AND file.path NOT LIKE '/etc/profiles/per-user/%/bin/%'
      AND file.path NOT LIKE '/etc/pwrstatd-%.sh'
      AND file.path NOT LIKE '/etc/pwrstatd-%.sh'
  tags: persistent
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected hidden directories in operating-system foldersbin/
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-hidden-system-paths
  observer_can_run: false
  platforms: posix
  query: |
    -- Find unexpected hidden directories in operating-system foldersbin/
    --
    -- references:
    --   * https://themittenmac.com/what-does-apt-activity-look-like-on-macos/
    --
    -- false positives:
    --   * unusual installers
    --
    -- platform: posix
    -- tags: persistent filesystem state
    SELECT
      file.path,
      file.inode,
      file.directory,
      uid,
      gid,
      mode,
      atime,
      btime,
      mtime,
      ctime,
      type,
      size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE '/lib/.%'
        OR file.path LIKE '/.%'
        OR file.path LIKE '/bin/%/.%'
        OR file.path LIKE '/dev/.%'
        OR file.path LIKE '/etc/.%'
        OR file.path LIKE '/etc/%/.%'
        OR file.path LIKE '/lib/%/.%'
        OR file.path LIKE '/libexec/.%'
        OR file.path LIKE '/Library/.%'
        OR file.path LIKE '/sbin/.%'
        OR file.path LIKE '/sbin/%/.%'
        OR file.path LIKE '/tmp/.%'
        OR file.path LIKE '/usr/bin/.%'
        OR file.path LIKE '/usr/lib/.%'
        OR file.path LIKE '/usr/lib/%/.%'
        OR file.path LIKE '/usr/libexec/.%'
        OR file.path LIKE '/usr/local/bin/.%'
        OR file.path LIKE '/usr/local/lib/.%'
        OR file.path LIKE '/usr/local/lib/.%'
        OR file.path LIKE '/usr/local/libexec/.%'
        OR file.path LIKE '/usr/local/sbin/.%'
        OR file.path LIKE '/usr/sbin/.%'
        OR file.path LIKE '/var/.%'
        OR file.path LIKE '/var/%/.%'
        OR file.path LIKE '/var/lib/.%'
        OR file.path LIKE '/var/tmp/.%'
      )
      AND file.path NOT LIKE '%/../'
      AND file.path NOT LIKE '%/./' -- Avoid mentioning extremely temporary files
      AND strftime('%s', 'now') - file.ctime > 20
      AND file.path NOT IN (
        '/.autorelabel',
        '/dev/.mdadm/',
        '/.equarantine/',
        '/etc/.bootcount',
        '/etc/.clean',
        '/etc/.java/',
        '/etc/.resolv.conf.systemd-resolved.bak',
        '/etc/selinux/.config_backup',
        '/etc/skel/.local/',
        '/etc/skel/.mozilla/',
        '/etc/skel/.var/',
        '/etc/.#sudoers',
        '/.file',
        '/.lesshst',
        '/lib/jvm/.java-1.17.0-openjdk-amd64.jinfo',
        '/.mozilla/',
        '/tmp/.accounts-agent/',
        '/tmp/.audio-agent/',
        '/tmp/.bazelci/',
        '/tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress',
        '/tmp/.content-agent/',
        '/tmp/._contentbarrier_installed',
        '/tmp/.dl.log',
        '/tmp/.docker/',
        '/tmp/.docker-tmp/',
        '/tmp/.dotnet/',
        '/tmp/.dracula-tmux-data',
        '/tmp/.dracula-tmux-weather.lock',
        '/tmp/.DS_Store',
        '/tmp/.eos-update-notifier.log',
        '/tmp/.featureflags-agent/',
        '/tmp/.font-unix/',
        '/tmp/.go-version',
        '/tmp/.ICE-unix/',
        '/tmp/.last_survey_prompt.yaml',
        '/tmp/.last_update_check.json',
        '/tmp/.metrics-agent/',
        '/tmp/.PKGINFO',
        '/tmp/.searcher.tmp/',
        '/tmp/.settings-agent/',
        '/tmp/.SIGN.RSA.chainguard-enterprise.rsa.pub',
        '/tmp/.SIGN.RSA..local-melange.rsa.pub',
        '/tmp/.SIGN.RSA.local-melange.rsa.pub',
        '/tmp/.SIGN.RSA.wolfi-signing.rsa.pub',
        '/tmp/.terraform/',
        '/tmp/.terraform.lock.hcl',
        '/tmp/.Test-unix/',
        '/tmp/.touchpaddefaults',
        '/tmp/.ui-agent/',
        '/var/roothome/.dbus/',
        '/tmp/.updater-agent/',
        '/tmp/.vbox-t-ipc/',
        '/tmp/.vscode.dmypy_status/',
        '/tmp/.wsdl/',
        '/tmp/.helmrepo',
        '/tmp/.X0-lock',
        '/tmp/.X11-unix/',
        '/tmp/.X1-lock',
        '/tmp/.X2-lock',
        '/tmp/.XIM-unix/',
        '/usr/lib/jvm/.java-1.17.0-openjdk-amd64.jinfo',
        '/usr/local/bin/.swtpm',
        '/usr/local/libexec/.ksysguard/',
        '/var/db/.AppleInstallType.plist',
        '/var/db/.AppleUpgrade',
        '/var/db/.com.apple.iokit.graphics',
        '/var/db/.com.intego.netupdate.serviceId',
        '/var/db/.EntReg',
        '/var/db/.GKRearmTimer',
        '/var/db/.InstallerTMExcludes.plist',
        '/var/db/.intl8859cache.db',
        '/var/db/.LastGKApp',
        '/var/db/.LastGKReject',
        '/var/db/.lvm_setupdone',
        '/var/db/.MASManifest',
        '/var/db/.RunLanguageChooserToo',
        '/var/db/.SoftwareUpdateOptions',
        '/var/db/.StagedAppleUpgrade',
        '/var/db/.SystemPolicy-default',
        '/var/mail/.cache/',
        '/var/.ntw_cache',
        '/var/.Parallels_swap/',
        '/var/.pwd_cache',
        '/var/root/.bash_history',
        '/var/root/.bash_profile',
        '/var/root/.cache/',
        '/var/root/.CFUserTextEncoding',
        '/var/root/.docker/',
        '/var/root/.forward',
        '/var/roothome/.bash_history',
        '/var/roothome/.bash_logout',
        '/var/roothome/.bash_profile',
        '/var/roothome/.bashrc',
        '/var/roothome/.cache/',
        '/var/roothome/.config/',
        '/var/roothome/.justfile',
        '/var/roothome/.local/',
        '/var/roothome/.osquery/',
        '/var/roothome/.ssh/',
        '/var/roothome/.viminfo',
        '/var/root/.lesshst',
        '/var/root/.nix-channels',
        '/var/root/.nix-defexpr/',
        '/var/root/.nix-profile/',
        '/var/root/.osquery/',
        '/var/root/.PenTablet/',
        '/var/root/.provisio',
        '/var/root/.Trash/',
        '/var/root/.viminfo',
        '/var/root/.zsh_history',
        '/var/run/.heim_org.h5l.kcm-socket',
        '/var/run/.sim_diagnosticd_socket',
        '/var/run/.vfs_rsrc_streams_0x2b725bbfb94ba4ef0/',
        '/var/setup/.AppleSetupUser',
        '/var/setup/.TemporaryItems',
        '/var/setup/.TemporaryItems/',
        '/var/tmp/.ses',
        '/var/tmp/.ses.bak',
        '/.vol/',
        '/.VolumeIcon.icns'
      )
      AND file.directory NOT IN (
        '/etc/skel',
        '/etc/skel/.config',
        '/var/root/.provisio'
      )
      AND file.path NOT LIKE '/%bin/bootstrapping/.default_components'
      AND file.path NOT LIKE '/tmp/.#%'
      AND file.path NOT LIKE '/lib/jvm/.java-%.jinfo'
      AND file.path NOT LIKE '/tmp/.lark_cache_%'
      AND file.path NOT LIKE '/tmp/.cdx.json%'
      AND file.path NOT LIKE '/var/roothome/.xauth%'
      AND file.path NOT LIKE '/tmp/.wine-%'
      AND file.path NOT LIKE '/tmp/.%.gcode'
      AND file.path NOT LIKE '/tmp/.vbox-%-ipc/'
      AND file.path NOT LIKE '/tmp/.io.nwjs.%'
      AND file.path NOT LIKE '/tmp/.xfsm-ICE-%'
      AND file.path NOT LIKE '/tmp/.com.google.Chrome.%'
      AND file.path NOT LIKE '/tmp/.org.chromium.Chromium%'
      AND file.path NOT LIKE '/var/run/.vfs_rsrc_streams_%/'
      AND file.path NOT LIKE '/tmp/.X1%-lock'
      AND file.path NOT LIKE '/usr/local/%/.keepme'
      AND file.path NOT LIKE '%/.build-id/'
      AND file.path NOT LIKE '%/.dwz/'
      AND file.path NOT LIKE '%/.updated'
      AND file.filename NOT LIKE '.%.swo'
      AND file.filename NOT LIKE '.%.swp'
      AND file.path NOT LIKE '%/google-cloud-sdk/.install/'
      AND file.path NOT LIKE '/usr/lib/jvm/.java-%-openjdk-%.jinfo'
      AND NOT (
        type = 'regular'
        AND (
          filename LIKE '%.swp'
          OR size < 2
        )
      )
      AND NOT (
        type = 'regular'
        AND filename IN ('.placeholder', '.abignore', '.gitignore')
      ) -- A curious addition seen on NixOS and Fedora machines
      AND NOT (
        file.path = '/.cache/'
        AND file.uid = 0
        AND file.gid = 0
        AND file.mode IN ('0755', '0700')
        AND file.size < 4
      ) -- Ecamm Live
      AND NOT (
        file.path LIKE "/tmp/.elive%"
        AND file.size < 7
      )
      AND NOT (
        file.path = '/.config/'
        AND file.uid = 0
        AND file.gid = 0
        AND file.mode IN ('0755', '0700')
        AND file.size = 4
      )
      AND NOT (
        file.path LIKE '/tmp/.java_pid%'
        AND file.type = 'socket'
        AND file.size = 0
      )
      AND NOT (
        file.path = '/var/root/.oracle_jre_usage/'
        AND file.size = 96
      )
      AND NOT (
        file.path LIKE '/tmp/.ssh-%'
        AND file.type = "socket"
        AND file.mode = '0600'
      )
      -- still not sure what the hell this is
      AND NOT (
        file.path LIKE '/tmp/.%3D'
        AND file.size < 35000
        AND file.size > 20000
        AND file.mode = '0644'
        AND uid = 501
        AND gid = 0
      )
  tags: persistent, filesystem, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected 3rd-party kernel extensions
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-kernel-extensions-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find unexpected 3rd-party kernel extensions
    --
    -- false positives:
    --   * none known
    --
    -- platform: darwin
    -- tags: persistent seldom kernel
    SELECT
      linked_against,
      name,
      path,
      size,
      version,
      path || ',' || name || ',' || version || ',' || linked_against AS exception_key
    FROM
      kernel_extensions
    WHERE
      path NOT LIKE '/System/Library/Extensions/%'
      AND NOT (
        idx = 0
        AND name = '__kernel__'
      )
      AND exception_key NOT IN (
        '/Library/StagedExtensions/Library/Extensions/CalDigitUSBHubSupport.kext,com.CalDigit.USBHubSupport,1,<3>',
        '/Library/StagedExtensions/Library/Filesystems/macfuse.fs/Contents/Extensions/14/macfuse.kext,io.macfuse.filesystems.macfuse,2128.20,<1 3 4 5 7>',
        '/Library/StagedExtensions/Library/Filesystems/kbfuse.fs/Contents/Extensions/13/kbfuse.kext,com.github.kbfuse.filesystems.kbfuse,2113.21,<1 3 4 5 7>'
      )
      AND exception_key NOT LIKE '/Library/StagedExtensions/Library/Extensions/ufsd_NTFS.kext,com.paragon-software.filesystems.ntfs,%'
      AND exception_key NOT LIKE '/Library/StagedExtensions/Library/Filesystems/macfuse.fs/Contents/Extensions/12/macfuse.kext,io.macfuse.filesystems.macfuse,%'
      AND exception_key NOT LIKE '/Library/StagedExtensions/Library/Extensions/ufsd_ExtFS.kext,com.paragon-software.filesystems.extfs,%'
      AND exception_key NOT LIKE '/Library/StagedExtensions/Library/Extensions/UAD2System.kext,com.uaudio.driver.UAD2System,%'
  tags: persistent, seldom, kernel
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find kernel modules that are not part of the expected list
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-kernel-modules-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Find kernel modules that are not part of the expected list
    --
    -- false positives:
    --   * operating-system updates
    --
    -- platform: linux
    -- tags: latent seldom kernel
    SELECT
      *
    FROM
      kernel_modules
    WHERE
      -- Filter out kernel modules that are required by another kernel module to reduce false-positives
      used_by != NULL
      AND name NOT IN (
        '8021q',
        'ac97_bus',
        'acpi_cpufreq',
        'acpi_pad',
        'acpi_tad',
        'acpi_thermal_rel',
        'aesni_intel',
        'af_alg',
        'af_packet',
        'agpgart',
        'ahci',
        'algif_aead',
        'algif_hash',
        'algif_skcipher',
        'amdgpu',
        'amd_pmc',
        'apple_mfi_fastcharge',
        'asn1_encoder',
        'asus_ec_sensors',
        'asus_wmi',
        'ath',
        'ath10k_core',
        'ath10k_pci',
        'atkbd',
        'authenc',
        'autofs4',
        'backlight',
        'battery',
        'binfmt_misc',
        'bluetooth',
        'bnep',
        'bpf_preload',
        'bridge',
        'br_netfilter',
        'btbcm',
        'btintel',
        'btmtk',
        'btrtl',
        'btusb',
        'button',
        'cbc',
        'ccm',
        'ccp',
        'cdc_ether',
        'cdrom',
        'cec',
        'cfg80211',
        'cmac',
        'configfs',
        'coretemp',
        'cpuid',
        'cqhci',
        'crc16',
        'crc32c_generic',
        'crc32c_intel',
        'crc32_pclmul',
        'crc_t10dif',
        'crct10dif_common',
        'crct10dif_generic',
        'crct10dif_pclmul',
        'cros_ec',
        'cros_ec_chardev',
        'cros_ec_debugfs',
        'cros_ec_dev',
        'cros_ec_ishtp',
        'cros_ec_lpcs',
        'cros_ec_sysfs',
        'cros_usbpd_charger',
        'cros_usbpd_logger',
        'cros_usbpd_notify',
        'cryptd',
        'crypto_simd',
        'crypto_user',
        'ctr',
        'dca',
        'dcdbas',
        'deflate',
        'dell_laptop',
        'dell_smbios',
        'dell_smm_hwmon',
        'dell_wmi',
        'dell_wmi_descriptor',
        'des_generic',
        'dm_bio_prison',
        'dm_bufio',
        'dm_crypt',
        'dm_mod',
        'dm_multipath',
        'dm_persistent_data',
        'dm_thin_pool',
        'drm',
        'drm_buddy',
        'drm_display_helper',
        'drm_dp_helper',
        'drm_kms_helper',
        'drm_ttm_helper',
        'ecb',
        'ecc',
        'ecdh_generic',
        'edac_core',
        'edac_mce_amd',
        'ee1004',
        'eeepc_wmi',
        'efi_pstore',
        'efivarfs',
        'encrypted_keys',
        'essiv',
        'evdev',
        'exfat',
        'ext4',
        'fat',
        'fb_sys_fops',
        'firmware_attributes_class',
        'fuse',
        'garmin_gps',
        'gf128mul',
        'ghash_clmulni_intel',
        'gigabyte_wmi',
        'gpio_amdpt',
        'gpio_generic',
        'gpu_sched',
        'hid',
        'hid_apple',
        'hid_generic',
        'hid_jabra',
        'hid_logitech_dj',
        'hid_logitech_hidpp',
        'hid_multitouch',
        'hid_sensor_als',
        'hid_sensor_custom',
        'hid_sensor_hub',
        'hid_sensor_iio_common',
        'hid_sensor_trigger',
        'hwmon_vid',
        'i2c_algo_bit',
        'i2c_core',
        'i2c_designware_core',
        'i2c_designware_platform',
        'i2c_hid',
        'i2c_hid_acpi',
        'i2c_i801',
        'i2c_piix4',
        'i2c_scmi',
        'i2c_smbus',
        'i8042',
        'i915',
        'icp',
        'idma64',
        'igb',
        'igc',
        'igen6_edac',
        'industrialio',
        'industrialio_triggered_buffer',
        'input_leds',
        'int3400_thermal',
        'int3403_thermal',
        'int340x_thermal_zone',
        'intel_cstate',
        'intel_gtt',
        'intel_hid',
        'intel_ish_ipc',
        'intel_ishtp',
        'intel_ishtp_hid',
        'intel_ishtp_loader',
        'intel_lpss',
        'intel_lpss_pci',
        'intel_pch_thermal',
        'intel_pmc_bxt',
        'intel_pmt',
        'intel_powerclamp',
        'intel_rapl_common',
        'intel_rapl_msr',
        'intel_soc_dts_iosf',
        'intel_spi',
        'intel_spi_pci',
        'intel_tcc_cooling',
        'intel_uncore',
        'intel_vsec',
        'intel_wmi_thunderbolt',
        'intel_xhci_usb_role_switch',
        'iommu_v2',
        'ip6table_filter',
        'ip6table_mangle',
        'ip6table_nat',
        'ip6table_raw',
        'ip6_tables',
        'ip6table_security',
        'ip6t_REJECT',
        'ip6t_rpfilter',
        'ip6t_rt',
        'ipheth',
        'ipmi_devintf',
        'ipmi_msghandler',
        'ip_set',
        'iptable_filter',
        'iptable_mangle',
        'iptable_nat',
        'iptable_raw',
        'ip_tables',
        'iptable_security',
        'ipt_REJECT',
        'ipt_rpfilter',
        'ip_vs',
        'ip_vs_rr',
        'ip_vs_sh',
        'ip_vs_wrr',
        'irqbypass',
        'isofs',
        'iTCO_vendor_support',
        'iTCO_wdt',
        'iwlmei',
        'iwlmvm',
        'iwlwifi',
        'jbd2',
        'jc42',
        'joydev',
        'k10temp',
        'kfifo_buf',
        'kvm',
        'kvm_amd',
        'kvm_intel',
        'led_class',
        'ledtrig_audio',
        'libaes',
        'libahci',
        'libarc4',
        'libata',
        'libcrc32c',
        'libdes',
        'libphy',
        'libps2',
        'llc',
        'loop',
        'lp',
        'mac80211',
        'mac_hid',
        'macvlan',
        'mbcache',
        'mc',
        'md4',
        'mdio_devres',
        'md_mod',
        'mei',
        'mei_hdcp',
        'mei_me',
        'mei_pxp',
        'mei_wdt',
        'mii',
        'mmc_block',
        'mmc_core',
        'mousedev',
        'msr',
        'mtd',
        'mxm_wmi',
        'nct6775',
        'nct6775_core',
        'netlink_diag',
        'nf_conntrack',
        'nf_conntrack_broadcast',
        'nf_conntrack_netbios_ns',
        'nf_conntrack_netlink',
        'nf_defrag_ipv4',
        'nf_defrag_ipv6',
        'nf_log_syslog',
        'nf_nat',
        'nfnetlink',
        'nfnetlink_log',
        'nfnetlink_queue',
        'nf_reject_ipv4',
        'nf_reject_ipv6',
        'nf_tables',
        'nft_chain_nat',
        'nft_compat',
        'nft_counter',
        'nft_ct',
        'nft_fib',
        'nft_fib_inet',
        'nft_fib_ipv4',
        'nft_fib_ipv6',
        'nft_limit',
        'nft_objref',
        'nft_reject',
        'nft_reject_inet',
        'nls_cp437',
        'nls_iso8859_1',
        'nvidia',
        'nvidia_drm',
        'nvidia_modeset',
        'nvidia_uvm',
        'nvme',
        'nvme_common',
        'nvme_core',
        'nvram',
        'overlay',
        'parport',
        'parport_pc',
        'pcspkr',
        'pinctrl_amd',
        'pinctrl_sunrisepoint',
        'pinctrl_tigerlake',
        'pkcs8_key_parser',
        'platform_profile',
        'pmt_class',
        'pmt_telemetry',
        'polyval_clmulni',
        'polyval_generic',
        'ppdev',
        'pps_core',
        'processor_thermal_device',
        'processor_thermal_device_pci',
        'processor_thermal_device_pci_legacy',
        'processor_thermal_mbox',
        'processor_thermal_rapl',
        'processor_thermal_rfim',
        'psmouse',
        'pstore',
        'pstore_blk',
        'pstore_zone',
        'ptp',
        'qrtr',
        'r8152',
        'r8153_ecm',
        'r8169',
        'raid0',
        'ramoops',
        'rapl',
        'raydium_i2c_ts',
        'rc_core',
        'realtek',
        'reed_solomon',
        'rfcomm',
        'rfkill',
        'rndis_host',
        'rndis_wlan',
        'rng_core',
        'roles',
        'rtc_cmos',
        'rtsx_pci',
        'rtsx_pci_sdmmc',
        'rtw89_8852a',
        'rtw89_8852ae',
        'rtw89_core',
        'rtw89_pci',
        'sch_fq_codel',
        'scsi_common',
        'scsi_mod',
        'sdhci',
        'sdhci_pci',
        'serio',
        'serio_raw',
        'sg',
        'snd',
        'snd_acp3x_pdm_dma',
        'snd_acp3x_rn',
        'snd_acp_config',
        'snd_compress',
        'snd_ctl_led',
        'snd_hda_codec',
        'snd_hda_codec_generic',
        'snd_hda_codec_hdmi',
        'snd_hda_codec_idt',
        'snd_hda_codec_realtek',
        'snd_hda_core',
        'snd_hda_ext_core',
        'snd_hda_intel',
        'snd_hrtimer',
        'snd_hwdep',
        'snd_intel_dspcfg',
        'snd_intel_sdw_acpi',
        'snd_pci_acp3x',
        'snd_pci_acp5x',
        'snd_pci_acp6x',
        'snd_pcm',
        'snd_pcm_dmaengine',
        'snd_rawmidi',
        'snd_rn_pci_acp3x',
        'snd_seq',
        'snd_seq_device',
        'snd_seq_dummy',
        'snd_seq_midi',
        'snd_seq_midi_event',
        'snd_soc_acpi',
        'snd_soc_acpi_intel_match',
        'snd_soc_avs',
        'snd_soc_core',
        'snd_soc_dmic',
        'snd_soc_hdac_hda',
        'snd_soc_hdac_hdmi',
        'snd_soc_hda_codec',
        'snd_soc_intel_hda_dsp_common',
        'snd_soc_skl',
        'snd_soc_skl_hda_dsp',
        'snd_soc_sst_dsp',
        'snd_soc_sst_ipc',
        'snd_sof',
        'snd_sof_amd_acp',
        'snd_sof_amd_renoir',
        'snd_sof_intel_hda',
        'snd_sof_intel_hda_common',
        'snd_sof_pci',
        'snd_sof_pci_intel_tgl',
        'snd_sof_utils',
        'snd_sof_xtensa_dsp',
        'snd_timer',
        'snd_usb_audio',
        'snd_usbmidi_lib',
        'soundcore',
        'soundwire_bus',
        'soundwire_cadence',
        'soundwire_generic_allocation',
        'soundwire_intel',
        'sp5100_tco',
        'sparse_keymap',
        'spi_intel',
        'spi_intel_pci',
        'spi_nor',
        'spl',
        'squashfs',
        'stp',
        'sunrpc',
        'syscopyarea',
        'sysfillrect',
        'sysimgblt',
        't10_pi',
        'tap',
        'tee',
        'thermal',
        'think_lmi',
        'thinkpad_acpi',
        'thunderbolt',
        'tiny_power_button',
        'tls',
        'tpm',
        'tpm_crb',
        'tpm_tis',
        'tpm_tis_core',
        'trusted',
        'ttm',
        'tun',
        'typec',
        'typec_ucsi',
        'uas',
        'ucsi_acpi',
        'uhid',
        'uinput',
        'usb_common',
        'usbcore',
        'usbhid',
        'usbnet',
        'usb_storage',
        'uvcvideo',
        'v4l2loopback',
        'veth',
        'vfat',
        'video',
        'videobuf2_common',
        'videobuf2_memops',
        'videobuf2_v4l2',
        'videobuf2_vmalloc',
        'videodev',
        'vivaldi_fmap',
        'watchdog',
        'wmi',
        'wmi_bmof',
        'x86_pkg_temp_thermal',
        'xfrm_algo',
        'xfrm_user',
        'xfs',
        'xhci_hcd',
        'xhci_pci',
        'xhci_pci_renesas',
        'x_tables',
        'xt_addrtype',
        'xt_comment',
        'xt_conntrack',
        'xt_hl',
        'xt_limit',
        'xt_LOG',
        'xt_mark',
        'xt_MASQUERADE',
        'xt_nat',
        'xt_pkttype',
        'xt_statistic',
        'xt_tcpudp',
        'zavl',
        'zcommon',
        'zfs',
        'zlua',
        'znvpair',
        'zram',
        'zunicode',
        'zzstd'
      )
  tags: latent, seldom, kernel
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected ld.so.conf files
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-ld-so-files-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Find unexpected ld.so.conf files
    --
    -- If you have Augeas available, you may want to use that in conjunction with this more limited check.
    --
    -- false positives:
    --   * none known
    --
    -- tags: persistent seldom
    -- platform: linux
    SELECT
      file.path,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      CONCAT (file.path, ',', mode, ',', size, ',', sha256) AS exception_key
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path IN ('/etc/ld.so.conf', '/etc/ld.so.preload')
        OR file.path LIKE '/etc/ld.so.conf.d/%'
        OR file.path LIKE '/etc/ld.so.conf.d/.%'
      )
      AND file.filename NOT IN ('.', '..')
      AND exception_key NOT IN (
        '/etc/ld.so.conf,0644,117,dad04a370e488aa85fb0a813a5c83cf6fd981ce01883fc59685447b092de84b5',
        '/etc/ld.so.conf,0644,154,785c6c3614a27ae6115a27c1ca55bbf333654780997c4ba7e181172b021d1bf3',
        '/etc/ld.so.conf,0644,28,239c865e4c0746a01f82b03d38d620853bab2a2ba8e81d6f5606c503e0ea379f',
        '/etc/ld.so.conf,0644,34,d4b198c463418b493208485def26a6f4c57279467b9dfa491b70433cedb602e8',
        '/etc/ld.so.conf.d/000_cuda.conf,0644,41,a9327cff9435220eac872cffedc7f6144d915bdcb70d985304c72f4c3cb9a7d3',
        '/etc/ld.so.conf.d/989_cuda-11.conf,0644,44,915b1ed4caa95cf65a62a74d8255c5ef80ef864cc2767933c85e240a78957167',
        '/etc/ld.so.conf.d/bind-export-x86_64.conf,0644,26,efeec53def06657c947f064463d5ebdb68f7c6f9e40cc2e72fc11c263484942e',
        '/etc/ld.so.conf.d/cuda.conf,0644,66,a65f7d96e2447eb40b1be9586b90eb0bd776a8938c93d21f9606d2880b548b28',
        '/etc/ld.so.conf.d/dyninst-x86_64.conf,0644,19,a4c740c1f59176d816ba18d429ba823317d3db416accf6d79a9cb0ac845d9d50',
        '/etc/ld.so.conf.d/fakechroot-x86_64-linux-gnu.conf,0644,37,b31d4e51d547996eaad550223d078701016504cdf6571abd2b37ece9db3caac7',
        '/etc/ld.so.conf.d/fakeroot.conf,0644,21,564c4c4d369d005702d825d34edc5e5568cb1ab6ee1b19fa03d0d672fb8b3aee',
        '/etc/ld.so.conf.d/fakeroot-x86_64-linux-gnu.conf,0644,38,af7edc777dd224bade078ba540538444db69856533c02e18a7f9fbbdd23bd181',
        '/etc/ld.so.conf.d/gds-11-8.conf,0644,46,2b48cb0abd03ff1d8926eca02a71540f4ee00ebccad5515e4d28a542dae8438a',
        '/etc/ld.so.conf.d/homebrew.conf,0644,33,f4972e79fa4966d9976487a5b5d4152c4cd7020b236b173ad1f2a3d2fa86f74a',
        '/etc/ld.so.conf.d/i386-linux-gnu.conf,0644,168,023231b8d6d21a7f4b1a59b875576604395041c814c0fd640d4a1d3d29455e6a',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-dpcpp-cpp-runtime.conf,0644,48,c0c6efda46a86b0d0cbc620b910cec4ba455d09a2bc7a39adf45ce113093366d',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-dpcpp-cpp-runtime.conf,0644,92,c4f62f0bfed45e548755c60b5e012e79c9062bb2a993c041db661951eb994476',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-dpcpp-cpp-runtime-libs.conf,0644,44,9f123b367c8afdcd116047d24f91339a95724d6f6cd189967696d2eb8eda63b4',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-shared-opencl-cpu.conf,0644,92,c4f62f0bfed45e548755c60b5e012e79c9062bb2a993c041db661951eb994476',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-shared-runtime.conf,0644,157,0b4a1c81fcab2d345f99e0187f29cf28f085ae67bf42c86d7b509c06b345186e',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-shared-runtime.conf,0644,92,c4f62f0bfed45e548755c60b5e012e79c9062bb2a993c041db661951eb994476',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-shared-runtime-libs.conf,0644,65,0e9c472578fe009314f02ab64613fc41114f4d07cfd3a805191a5b755d780a43',
        '/etc/ld.so.conf.d/intel-oneapi-openmp.conf,0644,155,160358af96f4a1a92e624fa84a1776d45c1a2c4695c8b96070374f6d66bf6061',
        '/etc/ld.so.conf.d/intel-oneapi-openmp.conf,0644,155,76736fa4deb3f3f4a7a96a068eb01b610faf9492814d47d36b3acbc1b4fb9fd3',
        '/etc/ld.so.conf.d/intel-oneapi-tbb.conf,0644,48,ab4d154371df8bf81c4fd8f079137994c5c9a60f43bef4132e6ffcbfbb08e99d',
        '/etc/ld.so.conf.d/kernel-3.10.0-1160.83.1.el7.x86_64.conf,0444,63,37cb41e22b4cb69bb7b8652111c59d3d07b6522ac1f4a635e794ca7eaf411dd7',
        '/etc/ld.so.conf.d/kernel-3.10.0-1160.el7.x86_64.conf,0444,63,37cb41e22b4cb69bb7b8652111c59d3d07b6522ac1f4a635e794ca7eaf411dd7',
        '/etc/ld.so.conf.d/lib32-glibc.conf,0644,11,c27424154a6096ae32c0824b785e05de6acef33d9224fd6147d1936be9b4962b',
        '/etc/ld.so.conf.d/libc.conf,0644,44,90d4c7e43e7661cd116010eb9f50ad5817e43162df344bd1ad10898851b15d41',
        '/etc/ld.so.conf.d/libiscsi-x86_64.conf,0644,17,fa3839c3cb893d3a589a020a0a9a010de1332b8385ee8139660e2da8bcc932a3',
        '/etc/ld.so.conf.d/llvm13-x86_64.conf,0644,22,4da62e9ec76b030c527e2ea87ccfab1baeff7d0f9092f980231e49961bb97de0',
        '/etc/ld.so.conf.d/llvm15-x86_64.conf,0644,22,30e995961d9e382d287469acce7e168d15811356bf20971fc17bb582a8d62afa',
        '/etc/ld.so.conf.d/llvm16-x86_64.conf,0644,22,3ddda874af4dd14e9e873da09d082031abfacd4b5094982c28f53e1fd50a5fe3',
        '/etc/ld.so.conf.d/llvm17-x86_64.conf,0644,22,3aceee0a4efb8cc2b0f981035cdbb6f28be48634f72f9b6fb98c1e282d32347c',
        '/etc/ld.so.conf.d/mariadb-x86_64.conf,0644,17,598466b4954bc66c6f45f1f119211b0698d4a549f6c01b5d9a933a2511b82626',
        '/etc/ld.so.conf.d/mingw64-hostlib.conf,0644,29,df1b65371bead6dddc703346f56dde023e22d52d9f071a3b646beaaec75a53c9',
        '/etc/ld.so.conf.d/nessus.conf,0644,16,5a9dc65a4a0daa50ce9dd70ff3973fcceef9660cc3fdf5bb0beec8e0b6c57708',
        '/etc/ld.so.conf.d/opencollada.conf,0644,21,2fc9656a2b881ca4528416daa91fc525adaa97d73e96a18b41aa7856270eba1f',
        '/etc/ld.so.conf.d/perf.conf,0644,14,c67f871bdc72182dc75c160b16ca3b5371fdab76a27199a29f14b52a5aed1d3f',
        '/etc/ld.so.conf.d/pipewire-jack-x86_64.conf,0644,30,cf4cb69feaa8ec8b99558c4e1123518831b3c56488981cbc34a662fe218ef221',
        '/etc/ld.so.conf.d/tix-x86_64.conf,0644,18,b2ef4843990ded5fd96e417fc08027a785fac59bd70eca6a26dd7b057542273a',
        '/etc/ld.so.conf.d/x86_64-linux-gnu.conf,0644,100,f03e4740e6922b4f4a1181cd696b52f62f9f10d003740a8940f7121795c59c98',
        '/etc/ld.so.conf.d/zz_i386-biarch-compat.conf,0644,56,4e3c617050427d51497a0e5969b0159421580cf5e7c9649e39f45b5e2fcb47b6',
        '/etc/ld.so.conf.d/zz_x32-biarch-compat.conf,0644,58,af55087d2769067a6a7c9069fd70f9ac2adb0e0ae29bfbd4e9df7504396c9bf2'
      )
  tags: persistent, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected files in /Library
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-library-entries-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find unexpected files in /Library
    --
    -- references:
    --   * https://www.intezer.com/blog/incident-response/new-backdoor-sysjoker/
    --
    -- false positives:
    --   * programs which create new Library directories
    --
    -- tags: persistent state filesystem seldom
    -- platform: darwin
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE '/Library/%'
        OR file.path LIKE '/Library/.%'
        OR file.path LIKE '/Library/%/.%'
        OR file.path LIKE '/Library/WebServer/%'
        OR file.path LIKE '/Library/WebServer/Documents/%%'
        OR file.path LIKE '/Library/WebServer/CGI-Executables/%%'
      )
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND file.size > 1
      AND file.path NOT IN (
        '/Library/Apple/',
        '/Library/Application Support/',
        '/Library/Audio/',
        '/Library/AutoBugCapture/',
        '/Library/Automator/',
        '/Library/Bluetooth/',
        '/Library/Caches/',
        '/Library/Catacomb/',
        '/Library/ColorPickers/',
        '/Library/ColorSync/',
        '/Library/Components/',
        '/Library/Compositions/',
        '/Library/Compositions/.localized',
        '/Library/Contextual Menu Items/',
        '/Library/CoreAnalytics/',
        '/Library/CoreMediaIO/',
        '/Library/Desktop Pictures/',
        '/Library/Desktop Pictures/.localizations/',
        '/Library/Desktop Pictures/.thumbnails/',
        '/Library/Developer/',
        '/Library/DirectoryServices/',
        '/Library/Documentation/',
        '/Library/DriverExtensions/',
        '/Library/DropboxHelperTools/',
        '/Library/Extensions/',
        '/Library/Filesystems/',
        '/Library/Fonts/',
        '/Library/Fonts/.uuid',
        '/Library/Frameworks/',
        '/Library/Google/',
        '/Library/GPUBundles/',
        '/Library/Graphics/',
        '/Library/Image Capture/',
        '/Library/Input Methods/',
        '/Library/InstallerSandboxes/',
        '/Library/InstallerSandboxes/.metadata_never_index',
        '/Library/InstallerSandboxes/.PKInstallSandboxManager/',
        '/Library/Internet Plug-Ins/',
        '/Library/Java/',
        '/Library/KernelCollections/',
        '/Library/KernelCollections/.file',
        '/Library/Keyboard Layouts/',
        '/Library/Keychains/',
        '/Library/LaunchAgents/',
        '/Library/LaunchDaemons/',
        '/Library/.localized',
        '/Library/Logs/',
        '/Library/Mail/',
        '/Library/Managed Preferences/',
        '/Library/Microsoft/',
        '/Library/Modem Scripts/',
        '/Library/Nessus/',
        '/Library/Objective-See/',
        '/Library/OpenDirectory/',
        '/Library/OSAnalytics/',
        '/Library/OSAnalytics/.DS_Store',
        '/Library/Parallels/',
        '/Library/PDF Services/',
        '/Library/Perl/',
        '/Library/ThunderboltAccessoryFirmwareUpdates/',
        '/Library/Plug-Ins/',
        '/Library/PreferencePanes/',
        '/Library/Preferences/',
        '/Library/Preferences/.GlobalPreferences.plist',
        '/Library/Printers/',
        '/Library/PrivilegedHelperTools/',
        '/Library/Python/',
        '/Library/QuickLook/',
        '/Library/Receipts/',
        '/Library/Ruby/',
        '/Library/Sandbox/',
        '/Library/Screen Savers/',
        '/Library/ScriptingAdditions/',
        '/Library/Scripts/',
        '/Library/Security/',
        '/Library/Services/',
        '/Library/Speech/',
        '/Library/Spotlight/',
        '/Library/StagedDriverExtensions/',
        '/Library/StagedExtensions/',
        '/Library/StartupItems/',
        '/Library/SystemExtensions/',
        '/Library/SystemExtensions/.staging/',
        '/Library/SystemMigration/',
        '/Library/SystemProfiler/',
        '/Library/Tailscale/',
        '/Library/TeX/',
        '/Library/Updates/',
        '/Library/User Pictures/',
        '/Library/User Template/',
        '/Library/Video/',
        '/Library/WebServer/',
        '/Library/WebServer/CGI-Executables/',
        '/Library/WebServer/Documents/',
        '/Library/WebServer/Documents/index.html.en',
        '/Library/WebServer/share/'
      )
      -- Probably Adobe copy protection, my guess is the host serial number or MAC addr.
      AND NOT REGEX_MATCH (
        file.path,
        '^/Library/Caches/\.([0-9ABCDEF]{12})$',
        1
      ) != ""
      AND NOT (
        file.path = '/Library/Caches/.DS_Store'
        AND magic.data = 'Apple Desktop Services Store'
        AND file.size < 9000
      )
  tags: persistent, state, filesystem, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Processes that have an unusual extension
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-process-extension-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Processes that have an unusual extension
    --
    -- false positives:
    --   * none observed
    --
    -- references:
    --   * https://www.uptycs.com/blog/new-poc-exploit-backdoor-malware
    --
    -- tags: persistent process state
    -- platform: linux
    SELECT
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      REGEX_MATCH (p0.path, '.*\/(.*?)$', 1) AS basename,
      REGEX_MATCH (p0.path, '.*\.(\w+)$', 1) AS extension,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      extension IS NOT NULL
      AND extension NOT IN (
        '1',
        '2',
        '3',
        '4',
        '5',
        '10',
        '11',
        '12',
        '13',
        '14',
        '15',
        '16',
        '17',
        '18',
        '19',
        '20',
        '21',
        '22',
        '23',
        '24',
        '25',
        '26',
        '27',
        '28',
        '29',
        '30',
        'backend',
        'build',
        'bin',
        'nox',
        'basic',
        'real',
        'AppImage',
        'ext'
      )
      AND NOT basename LIKE 'python3.%'
      AND NOT basename LIKE 'python2.%'
      AND NOT basename LIKE 'terraform-provider%'
      AND NOT basename LIKE 'ld-%.so'
  tags: persistent, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected files in ~/Public
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-public-files_macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find unexpected files in ~/Public
    --
    -- references:
    --   * https://www.elastic.co/security-labs/inital-research-of-jokerspy
    --
    -- false positives:
    --   * Files dropped in via File Sharing
    --
    -- tags: persistent state filesystem seldom
    -- platform: darwin
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.btime,
      file.mode,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data,
      RTRIM(
        COALESCE(
          REGEX_MATCH (file.directory, '(/.*?/.*?/.*?/)', 1),
          file.directory
        ),
        "/"
      ) AS top3_dir
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.directory LIKE '/Users/%/Public'
        OR file.directory LIKE '/Users/%/Public/%%'
        OR file.directory LIKE '/Users/%/Public/.%'
      )
      AND NOT (
        file.type = 'directory'
        OR file.path LIKE '%/../%'
        OR file.path LIKE '%/./%'
        OR file.path LIKE '/Users/%/Public/Drop Box/.localized'
      )
  tags: persistent, state, filesystem, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected executables in temp directories, often used by malware
    droppers
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-tmp-executables-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Find unexpected executables in temp directories, often used by malware droppers
    --
    -- tags: persistent
    -- platform: linux
    SELECT DISTINCT
      file.path,
      uid,
      gid,
      mode,
      REGEX_MATCH (file.filename, '.*\.(.*?)$', 1) AS extension,
      file.btime,
      file.ctime,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE -- Optimization: don't join things until we have a whittled down list of files
      file.path IN (
        SELECT DISTINCT
          path
        FROM
          file
        WHERE
          (
            file.directory = '/tmp'
            OR file.directory LIKE '/tmp/.%'
          ) -- Prevent weird recursion
          AND NOT file.directory LIKE '%/../%'
          AND NOT file.directory LIKE '%/./%' -- Exclude very temporary files
          AND NOT (strftime('%s', 'now') - ctime) < 60 -- Only executable files
          AND file.type = 'regular'
          AND (
            file.mode LIKE '%7%'
            or file.mode LIKE '%5%'
            or file.mode LIKE '%1%'
          )
          AND NOT (
            uid > 500
            AND (
              file.path LIKE '%/go-build%'
              OR file.directory LIKE '/tmp/%/out'
              OR file.path IN ('/tmp/mkinitramfs', '/tmp/mission')
              OR file.path LIKE '%/bin/%'
              OR file.path LIKE "%/bin/bash"
              OR file.path LIKE "%/bin/busybox"
              OR file.path LIKE '%/checkout/%'
              OR file.path LIKE '%/ci/%'
              OR file.path LIKE '%/configure'
              OR file.path LIKE '%/debug/%'
              OR file.path LIKE '%/dist/%'
              OR file.path LIKE '%/flow/%.npmzS_cacachezStmpzSgit-clone%'
              OR file.path LIKE '%/git/%'
              OR file.path LIKE '%/github/%'
              OR file.path LIKE '%/go.%.sum'
              OR file.path LIKE "%/%/gradlew"
              OR file.path LIKE '%/guile-%/guile-%'
              OR file.path LIKE '%integration_test%'
              OR file.path LIKE '%/ko/%'
              OR file.path LIKE '%/kots/%'
              OR file.path LIKE "%/lib/%.so"
              OR file.path LIKE "%/lib/%.so.%"
              OR file.path LIKE "%/melange%"
              OR file.path LIKE '%/melange-guest-%'
              OR file.path LIKE '%/pdf-tools/%'
              OR file.path LIKE '%/Rakefile'
              OR file.path LIKE '%-release%/%'
              OR file.path LIKE '%/site-packages/markupsafe/_speedups.cpython-%'
              OR file.path LIKE '%/src/%'
              OR file.path LIKE '%/target/%'
              OR file.path LIKE '%/terraformer/%'
              OR file.path LIKE '%test_script'
              OR file.path LIKE '%/tmp/epdf%'
              OR file.path LIKE '/tmp/GoLand/___go_build_%_go'
              OR file.path LIKE '/tmp/ko%/out'
              OR file.path LIKE "/tmp/lima/%"
              OR file.path LIKE '/tmp/lima/%/out/%'
              OR file.path LIKE '/tmp/wolfi%'
            )
          )
          AND NOT (
            file.path LIKE "%/lib/%.so"
            OR file.path LIKE "%/lib/%.so.%"
            OR file.path LIKE "%/lib64/%.so.%"
            OR file.path LIKE "%/lib64/%.so"
            OR file.path LIKE '/tmp/staged-updates%launcher'
            OR file.path LIKE "%/melange%"
            OR file.path LIKE "%/sbin/%"
            OR file.path LIKE "%/bin/busybox"
            OR file.path LIKE "%/bin/bash"
          )
          -- Nix
          AND NOT (
            file.directory LIKE '/tmp/tmp%'
            AND gid = 0
            AND uid > 300
            AND uid < 350
          ) -- Babel
          AND NOT (
            file.directory LIKE '/tmp/babel-%/sh-script-%'
            AND gid > 900
            AND uid = 1000
            AND size < 1024
          ) -- Random Testdata
          AND NOT (
            gid > 900
            AND uid = 1000
            AND (
              file.directory LIKE '/tmp/%/test'
              OR file.directory LIKE '/tmp/%/testdata'
            )
          ) -- Don't alert if the file is only on disk for a moment
          AND NOT (
            uid > 500
            AND file.path LIKE '/tmp/terraform_%/terraform'
          )
          AND NOT (
            file.path LIKE '/tmp/%compressed'
            AND size < 4000
            AND uid > 500
          ) -- Executables too small to even hold '#!/bin/sh\nuid'
          AND NOT (
            file.type = 'regular'
            AND size < 10
          ) -- Weird cert
          AND NOT (
            file.path LIKE '/tmp/tmp.%/ssl/default-fake-certificate.pem'
            AND file.size < 4096
          ) -- Binaries we might actually see legitimately
          AND NOT (
            file.path LIKE '/tmp/%'
            AND file.uid > 500
            AND (
              file.filename LIKE "%ctl"
              OR file.filename LIKE "%adm"
              OR file.filename LIKE "%-cli"
            )
          )
          AND NOT (
            file.directory LIKE "%/lib"
            OR file.directory LIKE "%/lib64"
            AND file.uid > 500
            AND (
              file.filename LIKE "%.so.%"
              OR file.filename LIKE "%.so"
            )
          )
      ) -- All checks with magic.data must first check for a lack of NULL value,
      -- otherwise you filter out platforms without magic.data.
      AND NOT (
        file.uid > 500
        AND magic.data IS NOT NULL
        AND (
          magic.data IN (
            "POSIX shell script, ASCII text executable",
            "libtool library file, ASCII text",
            "ASCII text",
            "JSON data"
          )
          OR magic.data LIKE "Unicode text%"
          OR magic.data LIKE "ELF 64-bit LSB shared object,%"
          OR magic.data LIKE "gzip compressed data%" -- Exotic platforms
          OR magic.data LIKE 'ELF 64-bit MSB pie executable, IBM S/390%'
          OR magic.data LIKE 'ELF 32-bit LSB pie executable, ARM, EABI5%'
          OR magic.data LIKE 'symbolic link to %'
        )
      )
      AND NOT (
        file.uid = 0
        AND magic.data IS NOT NULL
        AND (
          magic.data LIKE 'symbolic link to %'
          OR magic.data IN (
            "ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-x86_64.so.1, stripped",
            "libtool library file, ASCII text"
          )
        )
      )
      AND NOT (
        file.size < 65000
        AND file.uid > 500
        AND file.filename LIKE "%.%"
        AND extension IN (
          'adoc',
          'api',
          'authn',
          'bat',
          'erb',
          'iam',
          'java',
          'js',
          'json',
          'log',
          'nib',
          'pem',
          'perl',
          'pl',
          'py',
          'rb',
          'pub',
          'registry',
          'script',
          'sh',
          'strings',
          'txt',
          'yaml',
          'yml'
        )
      )
  tags: persistent
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected executables in temp directories, often used by malware
    droppers
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-tmp-executables-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find unexpected executables in temp directories, often used by malware droppers
    --
    -- false positives:
    --   * developers building code out of /tmp
    --
    -- tags: persistent seldom
    -- platform: darwin
    SELECT DISTINCT
      file.path,
      uid,
      gid,
      mode,
      REGEX_MATCH (RTRIM(file.path, '/'), '.*\.(.*?)$', 1) AS extension,
      file.btime,
      file.ctime,
      file.mtime,
      file.type,
      file.size,
      hash.sha256,
      magic.data,
      signature.identifier,
      signature.authority
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE -- Optimization: don't join things until we have a whittled down list of files
      file.path IN (
        SELECT
          path
        FROM
          file
        WHERE
          (
            file.directory = '/tmp'
            OR file.directory LIKE '/tmp/%'
            OR file.directory LIKE '/tmp/%/%'
            OR file.directory LIKE '/tmp/%/.%'
            OR file.directory LIKE '/tmp/.%'
            OR file.directory LIKE '/tmp/.%/%'
            or file.directory LIKE '/tmp/.%/.%'
          ) -- Prevent weird recursion
          AND NOT file.directory LIKE '%/../%'
          AND NOT file.directory LIKE '%/./%' -- Exclude very temporary files
          AND NOT (strftime('%s', 'now') - ctime) < 60 -- Only executable files
          AND file.type = 'regular'
          AND (
            file.mode LIKE '%7%'
            or file.mode LIKE '%5%'
            or file.mode LIKE '%1%'
          )
          AND NOT (
            uid > 500
            AND (
              file.path LIKE '%/go-build%'
              OR file.path LIKE '%/bin/%'
              OR file.path LIKE '%/sbin/%'
              OR file.path LIKE '/tmp/%ctl'
              OR file.path LIKE '%/CCLBS/%'
              OR file.path LIKE '%/checkout/%'
              OR file.path LIKE '/tmp/lima/%'
              OR file.path LIKE '%/ci/%'
              OR file.path LIKE '%/debug/%'
              OR file.path LIKE '%/dist/%'
              OR file.path LIKE '%/etc/network/if-up.d/%'
              OR file.path LIKE '%/flow/%.npmzS_cacachezStmpzSgit-clone%'
              OR file.path LIKE '/tmp/GoLand/___Test%.test'
              OR file.path LIKE '%/git/%'
              OR file.path LIKE '%/github/%'
              OR file.path LIKE '%/elastic-agent-%'
              OR file.path LIKE '%/go.%.sum'
              OR file.path LIKE "%/%/gradlew"
              OR file.path LIKE '%/guile-%/guile-%'
              OR file.path LIKE '%/ko/%'
              OR file.path LIKE '%/nix/%'
              OR file.path LIKE '%/kots/%'
              OR file.path LIKE '/tmp/KSInstallAction.%/m/.keystone_install'
              OR file.path LIKE '/tmp/%/AdobePIM.dylib'
              OR file.path LIKE "%/lib/%.so"
              OR file.path LIKE '/tmp/melange%'
              OR file.path LIKE "%/lib/%.so.%"
              OR file.path LIKE '%/pdf-tools/%'
              OR file.path LIKE '%/Photoshop Installer.app/Contents/%'
              OR file.path LIKE '%-release%/%'
              OR file.path LIKE '%/site-packages/markupsafe/_speedups.cpython-%'
              OR file.path LIKE '%/src/%'
              OR file.path LIKE '%/target/%'
              OR file.path LIKE '%/terraformer/%'
              OR file.path LIKE '/tmp/com.apple.installer%'
              OR file.path LIKE '%.tfstate.sh'
              OR file.path LIKE '%/tmp/epdf%'
              OR file.path LIKE '/tmp/flow/%.npmzS_cacachezStmpzSgit-clone%'
              OR file.filename IN (
                'mysqld_exporter',
                'goreleaser',
                'golangci-lint',
                'cosign',
                'grype',
                'chainctl',
                'configure'
              )
            )
          )
          -- Melange
          AND NOT file.directory LIKE '/tmp/melange-guest-%'
          -- Nix
          AND NOT (
            file.directory LIKE '/tmp/tmp%'
            AND gid = 0
            AND uid > 300
            AND uid < 350
          ) -- Babel
          AND NOT (
            file.directory LIKE '/tmp/babel-%/sh-script-%'
            AND gid > 900
            AND uid = 1000
            AND size < 1024
          ) -- Random Testdata
          AND NOT (
            gid > 900
            AND uid = 1000
            AND (
              file.directory LIKE '/tmp/%/test'
              OR file.directory LIKE '/tmp/%/testdata'
            )
          ) -- macOS updates
          AND NOT file.directory LIKE '/tmp/msu-target-%' -- I don't know man. I don't work here.
          AND NOT file.directory LIKE '/tmp/UpdateBrain-%/AssetData/com.apple.MobileSoftwareUpdate.UpdateBrainService.xpc/Contents/MacOS' -- terraform
          AND NOT file.directory LIKE '/tmp/staged-updates%'
          AND NOT (
            uid > 500
            AND file.path LIKE '/tmp/terraform_%/terraform'
          )
          AND NOT (
            file.path LIKE '/tmp/%compressed'
            AND size < 4000
            AND uid > 500
          ) -- Executables too small to even hold '#!/bin/sh\nuid'
          AND NOT (
            file.type = 'regular'
            AND size < 10
          ) -- TODO: Remove this hardcoded entry after Apr 2023
          AND NOT (
            file.path = '/tmp/policy-tester'
            AND file.uid = 501
            AND file.gid = 20
            AND file.size = 90921938
          )
      )
      AND NOT signature.authority IN (
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)'
      )
      AND NOT (
        magic.data IN ('JSON data', 'ASCII text')
        OR magic.data LIKE 'ELF %-bit %SB executable%'
        OR magic.data LIKE 'symbolic link to %'
        OR magic.data LIKE 'ELF %-bit LSB shared object%'
        OR magic.data LIKE 'libtool library file,%'
        OR magic.data LIKE "POSIX shell script, ASCII text executable%"
        OR (
          file.size < 50000
          AND file.uid > 500
          AND extension IN (
            'adoc',
            'md',
            'bat',
            'java',
            'js',
            'json',
            'log',
            'nib',
            'pem',
            'conf',
            'perl',
            'pl',
            'rb',
            'py',
            'script',
            'sh',
            'status',
            'strings',
            'txt',
            'yaml',
            'yml'
          )
          AND (
            magic.data IS NULL
            OR magic.data NOT LIKE "%Mach-O%"
          )
        )
      )
  tags: persistent, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected in unexpected places under /Users
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-user-executables-macos
  observer_can_run: false
  platforms: darwin
  query: "-- Find unexpected in unexpected places under /Users\n--\n-- references:\n\
    --   * https://www.elastic.co/security-labs/inital-research-of-jokerspy\n--  \
    \ * https://www.elastic.co/security-labs/DPRK-strikes-using-a-new-variant-of-rustbucket\n\
    --\n-- false positives:\n--   * none known\n--\n-- tags: persistent seldom\n--\
    \ platform: darwin\nSELECT\n  f.path,\n  f.directory,\n  f.uid,\n  f.gid,\n  f.mode,\n\
    \  f.mtime,\n  f.atime,\n  f.btime,\n  f.ctime,\n  f.size,\n  hash.sha256,\n \
    \ REPLACE(f.directory, u.directory, '~') AS homedir,\n  REPLACE(f.path, u.directory,\
    \ '~') AS homepath,\n  RTRIM(\n    COALESCE(\n      REGEX_MATCH (\n        REPLACE(f.directory,\
    \ u.directory, '~'),\n        '(.*?/.*?/.*?/)',\n        1\n      ),\n      REPLACE(f.directory,\
    \ u.directory, '~')\n    ),\n    \"/\"\n  ) AS top2_homedir,\n  magic.data,\n\
    \  signature.authority,\n  signature.identifier\nFROM\n  file f\n  LEFT JOIN hash\
    \ on f.path = hash.path\n  LEFT JOIN users u ON f.uid = u.uid\n  LEFT JOIN magic\
    \ ON f.path = magic.path\n  LEFT JOIN signature ON f.path = signature.path\nWHERE\n\
    \  -- Optimization: don't join things until we have a whittled down list of files\n\
    \  f.path IN (\n    SELECT DISTINCT\n      path\n    FROM\n      file\n    WHERE\n\
    \      (\n        directory = '/Users/Shared/'\n        OR directory LIKE '/Users/Shared/%'\n\
    \        OR directory LIKE '/Users/Shared/.%'\n        OR directory = '/var/root/'\n\
    \        OR directory LIKE '/var/root/%%'\n        OR directory LIKE '/var/root/.%'\n\
    \        OR directory LIKE '/Users/%/Library'\n        OR directory LIKE '/Users/%/Library/%'\n\
    \        OR directory LIKE '/Users/%/Library/%/.%'\n        OR directory LIKE\
    \ '/Users/%/Library/%/%'\n        OR directory LIKE '/Users/%/Library/.%'\n  \
    \      OR directory LIKE '/Users/%/Public'\n        OR directory LIKE '/Users/%/Public/%'\n\
    \        OR directory LIKE '/Users/%/Public/.%'\n        OR directory LIKE '/Users/%/Photos'\n\
    \        OR directory LIKE '/Users/%/Photos/%'\n        OR directory LIKE '/Users/%/Photos/.%'\n\
    \        OR directory LIKE '/Users/%/.%'\n        OR directory LIKE '/Users/%/.%/%'\n\
    \      )\n      AND (\n        type = 'regular'\n        AND size > 32\n     \
    \   AND (\n          mode LIKE '%7%'\n          OR mode LIKE '%5%'\n         \
    \ OR mode LIKE '%1%'\n        )\n      )\n      -- Prevent weird recursion\n \
    \     AND NOT path LIKE '%/../%'\n      AND NOT path LIKE '%/./%' -- Exclude very\
    \ temporary files\n      AND NOT directory LIKE '/Users/%/.bin/'\n      AND NOT\
    \ directory LIKE '/Users/%/.cargo/bin/'\n      AND NOT directory LIKE '/Users/%/.go/bin/'\n\
    \      AND NOT directory LIKE '/Users/%/Library/Mobile Documents/com~apple~CloudDocs/'\n\
    \      AND NOT directory LIKE '/Users/%/Library/Application Support/AutoFirma/certutil/'\n\
    \      AND NOT directory LIKE '/Users/%/Library/Caches/chainctl/'\n      AND NOT\
    \ directory LIKE '/Users/%/Library/Containers/%'\n      AND NOT directory LIKE\
    \ '/Users/%/Library/Daemon Containers/%'\n      AND NOT directory LIKE '/Users/%/Library/Mobile\
    \ Documents/com~apple~shoebox/%'\n      AND NOT directory LIKE '/Users/%/.local/bin/'\n\
    \      AND NOT directory LIKE '/Users/%/.minikube/bin/'\n      AND NOT directory\
    \ LIKE '/Users/%/.crc/bin/'\n      AND NOT directory LIKE '/Users/Shared/LGHUB/%'\n\
    \      AND NOT directory LIKE '/Users/Shared/LogiOptionsPlus/%'\n      AND NOT\
    \ directory LIKE '/Users/%/.Trash/%'\n      AND NOT directory LIKE '/Users/%/.vim/backup/'\n\
    \      AND NOT directory IN (\n        '/Users/Shared/LogiOptionsPlus/cache/',\n\
    \        '/Users/Shared/logitune/',\n        '/Users/Shared/Red Giant/Uninstall/'\n\
    \      )\n      AND NOT (strftime('%s', 'now') - ctime) < 60 -- Only executable\
    \ files\n  )\n  AND (\n    magic.data IS NULL\n    OR magic.data LIKE \"%executable%\"\
    \n    OR magic.data LIKE \"%shared library%\"\n  ) -- Filter out downloaded Linux\
    \ binaries\n  AND NOT (\n    magic.data IS NOT NULL\n    AND magic.data LIKE \"\
    ELF %LSB %\"\n  )\n  AND NOT (\n    magic.data IS NOT NULL\n    AND magic.data\
    \ LIKE \"0420 Alliant virtual executable%\"\n  )\n  AND NOT (\n    magic.data\
    \ IS NOT NULL\n    AND magic.data LIKE \"%shell script%\"\n  )\n  AND NOT (\n\
    \    magic.data IS NULL\n    AND f.size < 50000\n  )\n  AND NOT homedir LIKE '~/%/bin'\n\
    \  AND NOT homedir LIKE '~/%/shims'\n  AND NOT homedir LIKE '~/%/plugins'\n  AND\
    \ NOT homedir LIKE '/Users/%/.provisio'\n  AND NOT homedir IN (\n    '/Users/Shared/LGHUB',\n\
    \    '/Users/Shared/LogiOptionsPlus',\n    '/Users/Shared/logitune',\n    '/var/root/.PenTablet',\n\
    \    '~/.PenTablet',\n    '~/.amplify/bin',\n    '~/.asdf/shims',\n    '~/.bazel/bin',\n\
    \    '~/.bin',\n    '~/.cache/gitstatus',\n    '~/.config/kn',\n    '~/.config/nvim.bak',\n\
    \    '~/.docker/cli-plugins',\n    '~/.docker/scout',\n    '~/.dotnet/tools',\n\
    \    '~/.emacs.d.bak/bin',\n    '~/.emacs.d/backups',\n    '~/.fig/bin',\n   \
    \ '~/.fzf',\n    '~/.fzf/bin',\n    '~/.gvm/bin',\n    '~/.kn/plugins',\n    '~/.kuberlr/darwin-amd64',\n\
    \    '~/.npm/sentry-cli',\n    '~/.oh-my-zsh/tools',\n    '~/.provisio',\n   \
    \ '~/.pulumi-dev/bin',\n    '~/.pyenv/shims',\n    '~/.rbenv/shims',\n    '~/.venv/bin',\n\
    \    '~/.vs-tekton',\n    '~/.wash/downloads',\n    '~/.wrangler/bin',\n    '~/.zed/gopls',\n\
    \    '~/.zsh_snap/zsh-autocomplete',\n    '~/.zsh_snap/zsh-snap',\n    '~/Library/ApplicationSupport/iTerm2',\n\
    \    '~/Library/Dropbox/DropboxMacUpdate.app/Contents/MacOS',\n    '~/Library/Group\
    \ Containers/group.com.apple.wifi.logs/previous',\n    '~/Library/Logs/Adobe',\n\
    \    '~/Library/Logs/com.logmein.GoToOpener',\n    '~/Library/Mobile Documents/com~apple~CloudDocs'\n\
    \  )\n  AND NOT top2_homedir IN (\n    '~/.antigen',\n    '~/.docker.old/cli-plugins',\n\
    \    '~/.fzf/test',\n    '~/.iterm2',\n    '~/.kuberlr/darwin-arm64',\n    '~/Library/Application\
    \ Support',\n    '~/Library/Caches',\n    '~/Library/CloudStorage',\n    '~/Library/helm',\n\
    \    '~/Library/pnpm',\n    '~/Library/Printers',\n    '~/Library/Python',\n \
    \   '~/Library/QuickLook',\n    '~/Library/Screen Savers',\n    '~/Library/Services',\n\
    \    '~/Library/Thunderbird',\n    '~/.magefile',\n    '~/.nvm',\n    '~/.revox/updates',\n\
    \    '~/.sdkman/libexec',\n    '~/.terraform.d',\n    '~/.terraform.versions',\n\
    \    '/Users/Shared/LGHUB/cache',\n    '/Users/Shared/LogiOptionsPlus/cache',\n\
    \    '/Users/Shared/Red Giant/Uninstall'\n  )\n  AND NOT homepath IN (\n    '~/.config/nvm/nvm.sh',\n\
    \    '~/Library/Assistant/SiriAnalytics.db',\n    '~/Library/Calendars/Calendar.sqlitedb',\n\
    \    '~/Library/Calendars/Calendar.sqlitedb-wal',\n    '~/Library/com.apple.iTunesCloud/play_activity.sqlitedb-wal',\n\
    \    '~/Library/Finance/finance_cloud.db',\n    '~/Library/Finance/finance_cloud.db-wal',\n\
    \    '~/Library/Group Containers/group.com.docker/unleash-repo-schema-v1-Docker\
    \ Desktop.json',\n    '~/Library/HTTPStorages/com.apple.AddressBookSourceSync',\n\
    \    '~/Library/HTTPStorages/com.apple.AddressBookSourceSync/httpstorages.sqlite-shm',\n\
    \    '\t~/Library/Keychains/login.keychain-db',\n    '~/Library/Logs/zoom.us/upload_history.txt',\n\
    \    '~/Library/Preferences/com.apple.LaunchServices.QuarantineEventsV2'\n  )\n\
    \  AND NOT homepath LIKE '~/Library/%/%.sqlite'\n  AND NOT homepath LIKE '~/Library/%/%.sqlite-wal'\n\
    \  AND NOT homepath LIKE '~/Library/%/%.db'\n  AND NOT homepath LIKE '~/Library/%/%.db-wal'\n\
    \  AND NOT f.directory LIKE '/var/root/Library/Caches/%/org.sparkle-project.Sparkle/%/Sparkle.framework'\n\
    \  AND NOT f.directory LIKE '/Users/%/.docker/cli-plugins'\n  AND NOT f.directory\
    \ LIKE '/Users/%/.nix-profile/bin'\n  AND NOT f.path LIKE '/Users/%/Library/Fonts/%.ttf'\n\
    \  AND NOT f.path LIKE '/Users/%/Library/Fonts/%.otf'\nGROUP BY\n  f.path\n"
  tags: persistent, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected files in /Users/Shared
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-user-shared-entries
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find unexpected files in /Users/Shared
    --
    -- references:
    --   * https://www.elastic.co/security-labs/inital-research-of-jokerspy
    --
    -- false positives:
    --   * programs which create Shared files
    --
    -- tags: persistent state filesystem seldom
    -- platform: darwin
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.btime,
      file.mode,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data,
      RTRIM(
        COALESCE(
          REGEX_MATCH (file.directory, '(/.*?/.*?/.*?/)', 1),
          file.directory
        ),
        "/"
      ) AS top3_dir
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE '/Users/Shared/%%'
        OR file.path LIKE '/Users/Shared/.%'
        OR file.path LIKE '/Users/Shared/.%/%%'
        OR file.path LIKE '/Users/Shared/%/.%'
      )
      AND NOT (
        file.type = 'directory'
        OR file.size = 0
        OR file.path LIKE '%/../%'
        OR file.path LIKE '%/./%'
        OR file.path IN (
          '/Users/Shared/.BetaEnrollmentData.plist',
          '/Users/Shared/.betamigrated',
          '/Users/Shared/.com.intego.reporting.plist',
          '/Users/Shared/.DS_Store',
          '/Users/Shared/Plugin Loading.log',
          '/Users/Shared/.ks.intego_metrics_2.plist',
          '/Users/Shared/.localized',
          '/Users/Shared/.userfonts.cachedb',
          '/Users/Shared/CleanMyMac X/.licence',
          '/Users/Shared/LogiTuneInstallerStarted.txt',
          '/Users/Shared/.NSVolumeHeap',
          '/Users/Shared/.SeedEnrollment.plist'
        )
        OR top3_dir IN (
          '/Users/Shared/Adobe',
          '/Users/Shared/AdobeGCData',
          '/Users/Shared/AdobeGCInfo',
          '/Users/Shared/Audiority',
          '/Users/Shared/UnrealEngine',
          '/Users/Shared/Canon_Inc_IC',
          '/Users/Shared/CleanMyMac X',
          '/Users/Shared/CleanMyMac X Menu',
          '/Users/Shared/LGHUB',
          '/Users/Shared/logi',
          ' /Users/Shared/Maxon',
          '/Users/Shared/AdobeInstalledCodecsTier2',
          '/Users/Shared/LogioptionsPlus',
          '/Users/Shared/LogiOptionsPlus',
          '/Users/Shared/.logishrd',
          '/Users/Shared/logitune',
          '/Users/Shared/macenhance',
          '/Users/Shared/Parallels',
          '/Users/Shared/PPN',
          '/Users/Shared/Previously Relocated Items',
          '/Users/Shared/Red Giant',
          '/Users/Shared/Relocated Items',
          '/Users/Shared/TechSmith'
        )
        OR file.path LIKE '/Users/Shared/Epic Games/%'
        OR file.path LIKE "/Users/Shared/Previously Relocated Items %/%"
        OR (
          file.path LIKE "%.plist"
          AND magic.data = 'XML 1.0 document, ASCII text'
        )
      )
  tags: persistent, state, filesystem, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected executables in /var
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-var-executables-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Find unexpected executables in /var
    --
    -- false positives:
    --   * none known
    --
    -- tags: persistent
    -- platform: linux
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        -- This list is the result of multiple queries combined and can likely be minimized
        file.path LIKE '/var/%%'
        OR file.path LIKE '/var/tmp/%%'
        OR file.path LIKE '/var/tmp/.%/%%'
        OR file.path LIKE '/var/tmp/%/%%'
        OR file.path LIKE '/var/tmp/%/%/.%'
        OR file.path LIKE '/var/tmp/%/.%/%%'
        OR file.path LIKE '/var/spool/%%'
        OR file.path LIKE '/var/spool/.%/%%'
        OR file.path LIKE '/var/spool/%/%%'
        OR file.path LIKE '/var/spool/%/%/.%'
        OR file.path LIKE '/var/spool/%/.%/%%'
      )
      AND file.type = 'regular'
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND file.path NOT LIKE '/var/tmp/images/%'
      AND file.path NOT LIKE '/var/tmp/packages/%'
      AND (
        file.mode LIKE '%7%'
        OR file.mode LIKE '%5%'
        OR file.mode LIKE '%1%'
      )
      AND file.directory NOT IN (
        '/var/lib/colord',
        '/var/ossec/agentless',
        '/var/ossec/bin',
        '/var/ossec/wodles',
        '/var/run/booted-system',
        '/var/run/current-system'
      )
      AND file.path NOT IN (
        '/var/run/lima-boot-done',
        '/var/run/lima-ssh-ready'
      )
      AND (
        magic.data IS NULL
        OR magic.data != 'JSON data'
      )
      AND file.size > 10
  tags: persistent
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected executables in /var
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-var-executables-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find unexpected executables in /var
    --
    -- false positives:
    --   * none known
    --
    -- tags: persistent seldom
    -- platform: darwin
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data,
      signature.authority,
      signature.identifier
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE -- Optimization: don't join things until we have a whittled down list of files
      file.path IN (
        SELECT DISTINCT
          path
        FROM
          file
        WHERE
          (
            file.directory = '/var/tmp'
            OR file.directory LIKE '/var/tmp/%'
            OR file.directory LIKE '/var/tmp/%/%'
            OR file.directory LIKE '/var/tmp/%/.%'
            OR file.directory LIKE '/var/tmp/.%'
            OR file.directory LIKE '/var/tmp/.%/%'
            or file.directory LIKE '/var/tmp/.%/.%'
            OR file.directory = '/var/spool'
            OR file.directory LIKE '/var/spool/%'
            OR file.directory LIKE '/var/spool/%/%'
            OR file.directory LIKE '/var/spool/%/.%'
            OR file.directory LIKE '/var/spool/.%'
            OR file.directory LIKE '/var/spool/.%/%'
            or file.directory LIKE '/var/spool/.%/.%'
          ) -- Prevent weird recursion
          AND NOT file.directory LIKE '%/../%'
          AND NOT file.directory LIKE '%/./%' -- Exclude very temporary files
          AND NOT (strftime('%s', 'now') - ctime) < 60 -- Only executable files
          AND file.type = 'regular'
          AND (
            file.mode LIKE '%7%'
            or file.mode LIKE '%5%'
            or file.mode LIKE '%1%'
          ) -- Rosetta cache, SIP protected
          AND file.path NOT LIKE '/var/db/oah/%'
          AND file.path NOT LIKE '/var/folders/%/C/com.apple.FontRegistry/annex_aux'
          AND file.path NOT LIKE '/var/folders/%/T/go.%.%.sum'
          AND file.path NOT LIKE '/var/folders/%/T/pulumi-go.%'
          AND file.path NOT LIKE '/var/folders/%/T/sp_relauncher'
          AND file.path NOT LIKE '/var/folders/%/T/iTerm2-script%'
          AND file.path NOT LIKE '/var/tmp/epdfinfo%'
          AND file.path NOT LIKE '/var/folders/%/T/jansi-%-libjansi.jnilib'
          AND file.path NOT LIKE '/var/tmp/IN_PROGRESS_sysdiagnose_%.tmp/mddiagnose.mdsdiagnostic/diagnostic.log'
          AND file.path NOT LIKE '/var/run/current-system/etc/profiles/per-user/%'
          AND file.path NOT LIKE '/var/folders/%/T/freefn-%_emacs_%.eln'
          AND file.directory NOT IN (
            '/var/db/xcode_select_link/Makefiles/VersioningSystems/',
            '/var/db/xcode_select_link/usr/bin',
            '/var/db/xcode_select_link/usr/lib',
            '/var/db/xcode_select_link/usr/libexec',
            '/var/ossec/agentless',
            '/var/ossec/bin',
            '/var/ossec/wodles',
            '/var/run/booted-system',
            '/var/run/current-system',
            '/var/run/current-system/sw/bin',
            '/var/select',
            '/var/select/X11/bin',
            '/var/select/X11/lib',
            '/var/select/X11/lib/dri',
            '/var/select/X11/libexec',
            '/var/select/X11/lib/flat_namespace'
          )
          AND file.path NOT IN (
            '/var/log/acroUpdaterTools.log',
            '/var/vm/sleepimage'
          )
          AND file.size > 10
          AND NOT (
            file.path LIKE '/var/folders/%/T/sp_update/%'
            AND file.gid = 20
            AND file.uid = 501
          ) -- JetBrains (Delve)
          AND NOT (
            file.path LIKE '/var/folders/%/T/dlvLauncher%.sh'
            AND file.size < 1024
            AND file.mode = '0744'
          )
          AND NOT (
            file.path LIKE '/var/folders/%/T/libjansi-%.jnilib'
            AND file.size < 40000
            AND file.uid = 501
          )
          AND NOT (
            file.path LIKE '/var/tmp/_bazel_%/%/install/%'
            AND file.uid = 501
          )
      ) -- It's pretty rare, but some vendors install updates into /var. Spotify, I'm looking at you!
      AND NOT signature.authority IN (
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: GitHub (VEKTX9H2N7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Mozilla Corporation (43AQ936H96)',
        'Developer ID Application: Spotify (2FNC3A47ZF)',
        'Software Signing'
      )
      AND NOT (
        file.path LIKE '/var/db/timezone/zoneinfo/%'
        AND magic.data LIKE 'timezone%'
        AND file.size < 3000
        AND file.mode = '0755'
      ) -- Epson
      AND NOT (
        file.path LIKE '/var/tmp/InstallLog/%.plist'
        AND magic.data = 'Apple binary property list'
        AND file.size < 3000
        AND file.mode = '0777'
      )
    GROUP BY
      file.path
  tags: persistent, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected regular files in /var/run
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-var-run-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Find unexpected regular files in /var/run
    --
    -- false positives:
    --   * none known
    --
    -- references:
    --   * https://sandflysecurity.com/blog/bpfdoor-an-evasive-linux-backdoor-technical-analysis/
    --
    -- tags: persistent
    -- platform: linux
    SELECT
      file.filename,
      uid,
      gid,
      mode,
      file.ctime,
      file.atime,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      file.directory = "/var/run"
      AND file.type = "regular"
      AND file.filename NOT IN (
        'acpid.pid',
        'adduser',
        'agetty.reload',
        'alsactl.pid',
        'apcupsd.pid',
        'apport.lock',
        'atd.pid',
        'auditd.pid',
        'com.rapid7.cnchub.pid',
        'com.rapid7.component_insight_agent.pid',
        'com.rapid7.ir_agent.pid',
        'crond.pid',
        'crond.reboot',
        'cron.reboot',
        'dnf-metadata.lock',
        'docker.pid',
        'firefox-restart-required',
        'gdm3.pid',
        'gssproxy.pid',
        'haproxy.pid',
        'lightdm.pid',
        'lima-boot-done',
        'lima-ssh-ready',
        'lxcfs.pid',
        'machine-id',
        'mcelog.pid',
        'motd',
        'motd.dynamic',
        'multipathd.pid',
        'nginx.pid',
        'nvidia-powerd.pid',
        'nvidia_runtimepm_enabled',
        'nvidia_runtimepm_supported',
        'ostree-booted',
        'pulseaudio-enable-autospawn',
        'reboot-required',
        'reboot-required.pkgs',
        'rsyslogd.pid',
        'sm-notify.pid',
        'sshd.pid',
        'ublue-update.lock',
        'u-d-c-nvidia-drm-was-loaded',
        'u-d-c-nvidia-was-loaded',
        'ufw.lock',
        'unattended-upgrades.lock',
        'unattended-upgrades.pid',
        'unattended-upgrades.progress',
        'usbmuxd.pid',
        'utmp',
        'xtables.lock',
        'zed.pid',
        'zed.state',
        'zfs_fs_name',
        'zfs_unlock_complete'
      )
      AND NOT file.filename LIKE 'u-d-c-gpu-0%'
    GROUP BY
      file.path;
  tags: persistent
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected regular files in /var/run
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unexpected-var-run-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find unexpected regular files in /var/run
    --
    -- false positives:
    --   * none known
    --
    -- references:
    --   * https://sandflysecurity.com/blog/bpfdoor-an-evasive-linux-backdoor-technical-analysis/
    --
    -- tags: persistent
    -- platform: darwin
    SELECT
      file.filename,
      uid,
      gid,
      mode,
      file.ctime,
      file.atime,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      file.directory = "/var/run"
      AND file.type = "regular"
      AND file.filename NOT IN (
        '.DidRunFLO',
        '.autoBackup',
        '.fctcompsupdate',
        'VMware Fusion Services.lock',
        'FirstBootAfterUpdate',
        'FirstBootCleanupHandled',
        'appfwd.pid',
        'auditd.pid',
        'automount.initialized',
        'bootpd.pid',
        'com.apple.DumpPanic.finishedPMUFaultHandling',
        'com.apple.DumpPanic.finishedThisBoot',
        'com.apple.WindowServer.didRunThisBoot',
        'com.apple.logind.didRunThisBoot',
        'com.apple.loginwindow.didRunThisBoot',
        'com.apple.mdmclient.daemon.didRunThisBoot',
        'com.apple.mobileassetd-MobileAssetBrain',
        'com.apple.parentalcontrols.webfilterctl.mutex',
        'com.apple.softwareupdate.availableupdatesupdated',
        'diskarbitrationd.pid',
        'fctc.s',
        'hdiejectd.pid',
        'installd.commit.pid',
        'kdc.pid',
        'prl_disp_service.pid',
        'prl_naptd.pid',
        'prl_watchdog-ebdba5702a20.pid',
        'resolv.conf',
        'rtadvd.pid',
        'signpost_reporter_running',
        'socketfilterfw.launchd',
        'syslog.pid',
        'systemkeychaincheck.done',
        'utmpx',
        'wifi'
      )
      AND NOT file.filename LIKE '%.pid'
    GROUP BY
      file.path;
  tags: persistent
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Processes with executable names that feel weird
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unusual-executable-name-linux
  observer_can_run: false
  platforms: ''
  query: |
    -- Processes with executable names that feel weird
    --
    -- references:
    --   * https://www.zscaler.com/blogs/security-research/peek-apt36-s-updated-arsenal
    --
    -- tags: persistent process
    SELECT
      COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path) AS pname,
      COALESCE(
        REGEX_MATCH (p0.path, '.*/.*\.([a-z]{2,4})$', 1),
        ""
      ) AS pext,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      (
        pname LIKE "%kthread%"
        OR pname LIKE "%-help"
        OR pname LIKE "%flush%"
        OR pname LIKE "%tasks%"
        OR pname LIKE "%thread%"
        OR pname LIKE "%initd%"
        OR pname LIKE "%kdmp%"
        OR pname LIKE "%kworker%"
        OR pname LIKE "%launchd%"
        OR pname LIKE "%user_dir%"
        OR pname LIKE "%xdg%"
        OR pname LIKE "cpu%"
        OR pname LIKE "events%"
        OR pname LIKE "idle_%"
        OR pname LIKE '%xprotect%'
        OR pname LIKE "%kaudit%"
        OR pname LIKE "%nvme%"
        OR pname LIKE "%zswap%"
        OR pname LIKE "%crypt%"
        OR pname LIKE "%acpi%"
        OR pname LIKE "%kdev%"
        OR pname LIKE "%ksoft%"
        OR pname LIKE "%irq%"
        OR pname LIKE "%kswap%"
        OR pname LIKE "mm-%"
        OR pname LIKE "nm_%"
        OR pname LIKE "rcu%"
        OR REGEX_MATCH (pname, '([a-z]{16,})', 1) != ""
        OR REGEX_MATCH (pname, '([a-zA-Z0-9]{32,})', 1) != ""
        OR REGEX_MATCH (pname, '(\w{40,})', 1) != ""
        OR REGEX_MATCH (
          pname,
          '([a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+)',
          1
        ) != ""
        OR REGEX_MATCH (pname, "([a-z].*[A-Z].*\d+.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d.*[a-z].*\d.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d{5,})", 1) != ""
        OR REGEX_MATCH (pname, "^(\d\d)", 1) != ""
        OR REGEX_MATCH (pname, "^(\W)", 1) != ""
        OR (
          REGEX_MATCH (pname, "(\W)$", 1) != ""
          AND pname NOT LIKE "%)"
        )
        AND pext NOT IN ("", "gui", "cli", "us", "node", "com")
      )
      AND NOT pname LIKE '.%-wrapped'
      AND NOT pname LIKE '__debug_bin%'
      AND NOT pname LIKE '__Test%.test'
      AND pname NOT IN (
        "acpid",
        "akonadi_followupreminder_agent",
        "gmenudbusmenuproxy",
        "irqbalance",
        "kactivitymanagerd",
        "nm-applet",
        "nm-dispatcher",
        "xdg-dbus-proxy",
        "xdg-desktop-portal",
        "xdg-desktop-portal-gnome",
        "xdg-desktop-portal-gtk",
        "xdg-desktop-portal-kde",
        "xdg-document-portal",
        "xdg-permission-store",
        "xwaylandvideobridge"
      )
  tags: persistent, process
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Processes with executable names that feel weird
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unusual-executable-name-macos
  observer_can_run: false
  platforms: ''
  query: |
    -- Processes with executable names that feel weird
    --
    -- references:
    --   * https://www.zscaler.com/blogs/security-research/peek-apt36-s-updated-arsenal
    --
    -- tags: persistent process
    SELECT
      COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path) AS pname,
      COALESCE(
        REGEX_MATCH (p0.path, '.*/.*\.([a-z]{2,4})$', 1),
        ""
      ) AS pext,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      s.authority AS p0_sauth,
      s.identifier AS p0_sid,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      (
        pname LIKE "%kthread%"
        OR pname LIKE "%-help"
        OR pname LIKE "%flush%"
        OR pname LIKE "%tasks%"
        OR pname LIKE "%thread%"
        OR pname LIKE "%initd%"
        OR pname LIKE "%kdmp%"
        OR pname LIKE "%kworker%"
        OR pname LIKE "%launchd%"
        OR pname LIKE "%user_dir%"
        OR pname LIKE "%xdg%"
        OR pname LIKE "cpu%"
        OR pname LIKE "events%"
        OR pname LIKE "idle_%"
        OR pname LIKE '%xprotect%'
        OR pname LIKE "%kaudit%"
        OR pname LIKE "%nvme%"
        OR pname LIKE "%zswap%"
        OR pname LIKE "%crypt%"
        OR pname LIKE "%acpi%"
        OR pname LIKE "%kdev%"
        OR pname LIKE "%ksoft%"
        OR pname LIKE "%irq%"
        OR pname LIKE "%kswap%"
        OR pname LIKE "mm-%"
        OR pname LIKE "nm_%"
        OR pname LIKE "rcu%"
        OR REGEX_MATCH (pname, '([a-z]{16,})', 1) != ""
        OR REGEX_MATCH (pname, '([a-zA-Z0-9]{32,})', 1) != ""
        OR REGEX_MATCH (pname, '(\w{40,})', 1) != ""
        OR REGEX_MATCH (
          pname,
          '([a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+)',
          1
        ) != ""
        OR REGEX_MATCH (pname, "([a-z].*[A-Z].*\d+.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d.*[a-z].*\d.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d{5,})", 1) != ""
        OR REGEX_MATCH (pname, "^(\d\d)", 1) != ""
        OR REGEX_MATCH (pname, "^(\W)", 1) != ""
        OR (
          REGEX_MATCH (pname, "(\W)$", 1) != ""
          AND pname NOT LIKE "%)"
        )
        AND pext NOT IN ("", "gui", "cli", "us", "node", "com")
      )
      AND NOT pname IN (
        'at.obdev.littlesnitch.networkextension',
        'com.microsoft.teams2.notificationcenter',
        'cpu',
        'dynamiclinkmanager',
        'EcammLiveVideoOutAssistantXPCHelper',
        'launchd_startx',
        'ThingsWidgetExtensionMacAppStore',
        'TwitterNotificationServiceExtension'
      )
      AND NOT pname LIKE 'BetterTouch%Runner%'
      AND NOT pname LIKE '.%-wrapped'
      AND NOT pname LIKE 'cody-engine-%'
      AND NOT pname LIKE '__%go_build_%'
      AND NOT pname LIKE '__%go_test_%'
      -- example: 85C27NK92C.com.flexibits.fantastical2.mac.helper
      AND NOT pname LIKE "%.com.flexibits.fantastical2.mac.helper"
      AND NOT s.authority = "Software Signing"
  tags: persistent, process
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Processes with executable names that feel weird
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unusual-process-name-linux
  observer_can_run: false
  platforms: ''
  query: |
    -- Processes with executable names that feel weird
    --
    -- references:
    --   * https://www.zscaler.com/blogs/security-research/peek-apt36-s-updated-arsenal
    --
    -- tags: persistent process
    SELECT
      p0.name AS pname,
      COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path) AS basename,
      COALESCE(
        REGEX_MATCH (p0.name, '.*/.*\.([a-z]{2,4})$', 1),
        ""
      ) AS pext,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      (
        pname LIKE "%kthread%"
        OR pname LIKE "%-help"
        OR pname LIKE "%flush%"
        OR pname LIKE "%tasks%"
        OR pname LIKE "%thread%"
        OR pname LIKE "%initd%"
        OR pname LIKE "%kdmp%"
        OR pname LIKE "%/%"
        OR pname LIKE "%kworker%"
        OR pname LIKE "%launchd%"
        OR pname LIKE "%user_dir%"
        OR pname LIKE "%xdg%"
        OR pname LIKE "cpu%"
        OR pname LIKE "events%"
        OR pname LIKE "idle_%"
        OR pname LIKE '%xprotect%'
        OR pname LIKE "%kaudit%"
        OR pname LIKE "%nvme%"
        OR pname LIKE "%zswap%"
        OR pname LIKE "%crypt%"
        OR pname LIKE "%acpi%"
        OR pname LIKE "%kdev%"
        OR pname LIKE "%ksoft%"
        OR pname LIKE "%irq%"
        OR pname LIKE "%kswap%"
        OR pname LIKE "mm-%"
        OR pname LIKE "nm_%"
        OR pname LIKE "rcu%"
        OR REGEX_MATCH (pname, '([a-z]{18,})', 1) != ""
        OR REGEX_MATCH (pname, '([a-zA-Z0-9]{32,})', 1) != ""
        OR REGEX_MATCH (pname, '(\w{40,})', 1) != ""
        OR REGEX_MATCH (
          pname,
          '([a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+)',
          1
        ) != ""
        OR REGEX_MATCH (pname, "([a-z].*[A-Z].*\d+.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d.*[a-z].*\d.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d{5,})", 1) != ""
        OR REGEX_MATCH (pname, "^(\d\d)", 1) != ""
        OR (
          REGEX_MATCH (pname, "^(\W)", 1) != ""
          AND p0.path NOT LIKE "/nix/store/%/.%-wrapped"
        )
        OR (
          REGEX_MATCH (pname, "(\W)$", 1) != ""
          AND pname NOT LIKE "%)"
        )
        AND pext NOT IN ("", "gui", "cli", "us", "node", "com")
      )
      AND NOT p1_pid = 2
      AND NOT p0_pid = 2
      AND NOT pname LIKE '.%-wrap%'
      AND p0.path NOT LIKE "/nix/store/%"
      AND basename NOT IN (
        "acpid",
        "com.docker.backend",
        "com.docker.build",
        "com.docker.extensions",
        "dynamiclinkmanager",
        'firefox',
        "gmenudbusmenuproxy",
        "irqbalance",
        "kactivitymanagerd",
        "nm-applet",
        "perl",
        'pk-debconf-helper',
        "pt_main_thread",
        "systemd",
        "systemd-executor",
        'udevadm',
        "xdg-dbpus-proxy",
        'xdg-dbus-proxy',
        "xdg-desktop-portal",
        "xdg-desktop-portal-gnome",
        "xdg-desktop-portal-gtk",
        "xdg-desktop-portal-kde",
        "xdg-document-portal",
        "xdg-permission-store",
        "xwaylandvideobridge"
      )
      AND basename NOT LIKE '___Test%'
      AND NOT (
        basename IN ('nm-dispatcher')
        AND p1_pid = 1
      )
  tags: persistent, process
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Processes with executable names that feel weird
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unusual-process-name-macos
  observer_can_run: false
  platforms: ''
  query: |
    -- Processes with executable names that feel weird
    --
    -- references:
    --   * https://www.zscaler.com/blogs/security-research/peek-apt36-s-updated-arsenal
    --
    -- tags: persistent process
    SELECT
      p0.name AS pname,
      COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path) AS basename,
      COALESCE(
        REGEX_MATCH (p0.name, '.*/.*\.([a-z]{2,4})$', 1),
        ""
      ) AS pext,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      s.authority AS p0_sauth,
      s.identifier AS p0_sid,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      (
        pname LIKE "%kthread%"
        OR pname LIKE "%-help"
        OR pname LIKE "%flush%"
        OR pname LIKE "%tasks%"
        OR pname LIKE "%thread%"
        OR pname LIKE "%initd%"
        OR pname LIKE "%kdmp%"
        OR pname LIKE "%/%"
        OR pname LIKE "%kworker%"
        OR pname LIKE "%launchd%"
        OR pname LIKE "%user_dir%"
        OR pname LIKE "%xdg%"
        OR pname LIKE "cpu%"
        OR pname LIKE "events%"
        OR pname LIKE "idle_%"
        OR pname LIKE '%xprotect%'
        OR pname LIKE "%kaudit%"
        OR pname LIKE "%nvme%"
        OR pname LIKE "%zswap%"
        OR pname LIKE "%crypt%"
        OR pname LIKE "%acpi%"
        OR pname LIKE "%kdev%"
        OR pname LIKE "%ksoft%"
        OR pname LIKE "%irq%"
        OR pname LIKE "%kswap%"
        OR pname LIKE "mm-%"
        OR pname LIKE "nm_%"
        OR pname LIKE "rcu%"
        OR REGEX_MATCH (pname, '([a-z]{16,})', 1) != ""
        OR REGEX_MATCH (pname, '([a-zA-Z0-9]{32,})', 1) != ""
        OR REGEX_MATCH (pname, '(\w{40,})', 1) != ""
        OR REGEX_MATCH (
          pname,
          '([a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+)',
          1
        ) != ""
        OR REGEX_MATCH (pname, "([a-z].*[A-Z].*\d+.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d.*[a-z].*\d.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d{5,})", 1) != ""
        OR REGEX_MATCH (pname, "^(\d\d)", 1) != ""
        OR (
          REGEX_MATCH (pname, "^(\W)", 1) != ""
          AND p0.path NOT LIKE "/nix/store/%/.%-wrapped"
        )
        OR (
          REGEX_MATCH (pname, "(\W)$", 1) != ""
          AND pname NOT LIKE "%)"
        )
        AND pext NOT IN ("", "gui", "cli", "us", "node", "com")
      )
      AND NOT pname IN (
        'BetterTouchToolAppleScriptRunner',
        'BetterTouchToolAppleScriptRunner3',
        'BetterTouchToolShellScriptRunner',
        'EcammLiveVideoOutAssistantXPCHelper',
        'ThingsWidgetExtensionMacAppStore',
        'TwitterNotificationServiceExtension',
        'at.obdev.littlesnitch.endpointsecurity',
        'at.obdev.littlesnitch.networkextension',
        'com.microsoft.teams2.notificationcenter',
        'cpu',
        'dynamiclinkmanager',
        'launchd_startx'
      )
      -- example: 85C27NK92C.com.flexibits.fantastical2.mac.helper
      AND NOT pname LIKE "%.com.flexibits.fantastical2.mac.helper"
      AND NOT pname LIKE 'cody-engine-%'
      AND NOT pname LIKE '%-macos-arm64'
      AND NOT pname LIKE 'debug.test%'
      AND NOT pname LIKE '__%go_build%'
      AND NOT pname LIKE 'BetterTouchToolAppleScriptRunner%'
      AND NOT s.authority IN (
        "Software Signing",
        "Apple Mac OS Application Signing"
      )
  tags: persistent, process
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unusually tainted kernel - via a loaded kernel module
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - evasion - unusually-tainted-kernel-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Unusually tainted kernel - via a loaded kernel module
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1014/ (Rootkit)
    --   * https://docs.kernel.org/admin-guide/tainted-kernels.html
    --
    -- Confirmed to catch revenge-rtkit
    --
    -- false positives:
    --   * custom kernel modules
    --
    -- tags: persistent kernel state
    -- platform: linux
    --
    SELECT
      taint,
      taint & 65536 AS is_aux,
      taint & 8192 is_unsigned,
      taint & 4096 AS out_of_tree,
      taint & 512 AS kernel_warning,
      taint & 614 AS requested_by_userspace,
      taint & 8 AS force_unloaded,
      taint & 4 AS out_of_spec,
      taint & 2 AS force_loaded,
      taint & 1 AS proprietary,
      modules
    FROM
      (
        SELECT
          sc.current_value AS taint,
          GROUP_CONCAT(km.name) AS modules
        FROM
          system_controls sc,
          kernel_modules km
        WHERE
          sc.name = "kernel.tainted"
        ORDER BY
          km.name ASC
      )
      -- 4096 is a signed, out of tree, open source driver
      -- 4097 is a signed, out of tree, proprietary driver
      -- 512 is a kernel warning
    WHERE
      taint NOT IN (0, 512, 4096, 4097)
      -- Some day, folks will sign rootkits. That day isn't today.
      AND is_unsigned = 1
      AND NOT (
        (
          -- 12289 is an unsigned, out of tree, proprietary
          -- 12801 is an unsigned, out of tree, proprietary with kernel warning. not great.
          taint IN (12289, 12801)
          AND (
            modules LIKE "%,nvidia,%"
            OR modules LIKE "%,v42loopback,%"
            OR modules LIKE "%,wl,%"
          )
        )
        OR (
          -- 12352 is unsigned, out of tree, requested by user space
          -- 12289 is an unsigned, out of tree, proprietary
          taint IN (12352, 12289)
          AND modules LIKE "%,v4l2loopback,%"
        )
      )
  tags: persistent, kernel, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Catch programs that failed to run due to a launch constraint violation,
    such as a signing issue.
  discard_data: false
  interval: 900
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - exec-failed-launch-constraint-violation
  observer_can_run: false
  platforms: darwin
  query: |
    -- Catch programs that failed to run due to a launch constraint violation, such as a signing issue.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1204/
    --
    -- interval: 900
    -- platform: darwin
    -- tags: filesystem events
    SELECT
      s.identifier AS s_id,
      s.authority AS s_auth,
      -- Child
      pe.path AS p0_path,
      COALESCE(REGEX_MATCH (pe.path, '.*/(.*)', 1), pe.path) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.time AS p0_time,
      -- pe.cwd is NULL on macOS
      p.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      p1.cwd AS p1_cwd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      p1_p2.cwd AS p2_cwd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN file f ON pe.path = f.path
      LEFT JOIN signature S ON pe.path = s.path
      LEFT JOIN users u ON pe.uid = u.uid
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -900)
      AND pe.status = 1
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND p0_cmd != '/opt/homebrew/opt/tailscale/bin/tailscaled'
    GROUP BY
      pe.euid,
      pe.path,
      pe.cmdline
  tags: filesystem, events
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Pick out exotic processes based on their command-line (events-based)
  discard_data: false
  interval: 600
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - exotic-command-events-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Pick out exotic processes based on their command-line (events-based)
    --
    -- references:
    --   * https://themittenmac.com/what-does-apt-activity-look-like-on-macos/
    --
    -- false positives:
    --   * possible, but none known
    --
    -- tags: transient process events extra
    -- platform: linux
    -- interval: 600
    SELECT -- Child
      pe.path AS p0_path,
      pe.time AS p0_time,
      pe.uptime AS p0_uptime,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      AND p1.start_time <= pe.time
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.time <= pe.time
      AND pe1.cmdline != ""
      AND pe1.cwd != ""
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      AND p1_p2.start_time <= p1.start_time
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      AND pe1_p2.start_time <= pe1.time
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != ""
      AND pe1_pe2.cwd != ""
    WHERE
      pe.time > (strftime('%s', 'now') -600)
      AND pe.cmdline != ""
      AND pe.cwd != ""
      AND (
        p0_name IN (
          'bitspin',
          'bpftool',
          'heyoka',
          'nstx',
          'dnscat2',
          'tuns',
          'iodine',
          'esxcli',
          'vim-cmd',
          'minerd',
          'cpuminer-multi',
          'cpuminer',
          'httpdns',
          'rshell',
          'rsh',
          'xmrig',
          'incbit',
          'insmod',
          'kmod',
          'lushput',
          'mkfifo',
          'msfvenom',
          'nc',
          'socat'
        ) -- Chrome Stealer
        OR p0_cmd LIKE '%chrome%-load-extension%' -- Known attack scripts
        OR p0_name LIKE '%pwn%'
        OR p0_name LIKE '%attack%' -- Unusual behaviors
        OR p0_cmd LIKE '%ufw disable%'
        OR p0_cmd LIKE '%iptables stop'
        OR p0_cmd LIKE '%setenforce 0'
        OR p0_cmd LIKE '%iptables -P % ACCEPT%'
        OR p0_cmd LIKE '%iptables -F%'
        OR p0_cmd LIKE '%chattr -i%'
        OR p0_cmd LIKE '%dd if=/dev/%'
        OR p0_cmd LIKE '%cat /dev/null >%'
        OR p0_cmd LIKE '%truncate -s0 %'
        OR (
          INSTR(p0_cmd, 'history') > 0
          AND p0_cmd LIKE '%history'
          AND p0_cmd NOT LIKE 'man %'
        )
        OR p0_cmd LIKE '%touch%acmr%'
        OR p0_cmd LIKE '%touch -r%'
        OR p0_cmd LIKE '%ld.so.preload%'
        OR p0_cmd LIKE '%urllib.urlopen%'
        OR p0_cmd LIKE '%nohup%tmp%'
        OR p0_cmd LIKE '%tar % .%'
        OR p0_cmd LIKE '%tar %/.%'
        OR p0_cmd LIKE '%.config%gcloud%'
        OR p0_cmd LIKE '%.aws/%'
        OR p0_cmd LIKE '%.config/%chrome%'
        OR p0_cmd LIKE '%systemctl stop firewalld%'
        OR p0_cmd LIKE '%systemctl disable firewalld%'
        OR p0_cmd LIKE '%pkill -f%'
        OR (
          p0_cmd LIKE '%xargs kill -9%'
          AND pe.euid = 0
        )
        OR p0_cmd LIKE '%nohup /bin/bash%'
        OR p0_cmd LIKE '%echo%|%base64%-d% %|%'
        OR p0_cmd LIKE '%@reboot%crontab%'
        OR p0_cmd LIKE '%UserKnownHostsFile=/dev/null%' -- Crypto miners
        OR p0_cmd LIKE '%monero%'
        OR p0_cmd LIKE '%nanopool%'
        OR p0_cmd LIKE '%nicehash%'
        OR p0_cmd LIKE '%stratum%'
        OR p0_cmd LIKE '%/dev/%cp/%'
        OR p0_cmd LIKE '%fsockopen%'
        OR p0_cmd LIKE '%openssl%quiet%'
        OR p0_cmd LIKE '%pty.spawn%'
        OR (
          p0_cmd LIKE '%sh -i'
          AND NOT p1_name IN ('sh', 'java')
        )
        OR p0_cmd LIKE '%SOCK_STREAM%'
        OR INSTR(p0_cmd, 'Socket.') > 0
        OR (
          p0_cmd LIKE '%tail -f /dev/null%'
          AND p.cgroup_path NOT LIKE '/system.slice/docker-%'
        )
      ) -- Things that could reasonably happen at boot.
      AND NOT (
        pe.path IN ('/usr/bin/kmod', '/bin/kmod')
        AND p1_path = '/usr/lib/systemd/systemd'
        AND p1_cmd = '/sbin/init'
      )
      AND NOT (
        pe.path IN ('/usr/bin/kmod', '/bin/kmod')
        AND p1_name IN (
          'firewalld',
          'mkinitramfs',
          'systemd',
          'dockerd',
          'kube-proxy'
        )
      )
      AND NOT (
        p0_cmd LIKE '/usr/bin/modprobe %'
        AND p1_cgroup = '/system.slice/firewalld.service'
      )
      AND NOT (
        pe.path IN ('/usr/bin/kmod', '/bin/kmod')
        AND pe.uptime < 15
      )
      AND NOT (
        pe.path = '/usr/bin/mkfifo'
        AND (
          p0_cmd LIKE '%/org.gpgtools.log.%/fifo'
          OR p0_cmd LIKE 'mkfifo -- %/gitstatus.POWERLEVEL9K%.fifo'
          OR p0_cmd LIKE '%/p10k.%'
        )
      )
      AND NOT p0_cmd IN (
        'lsmod',
        'dd if=/dev/stdin conv=unblock cbs=79',
        '/usr/bin/socat STDIN UNIX-CONNECT:/run/user/1000/kwallet5.socket',
        'socat STDIN UNIX-CONNECT:/run/user/1000/kwallet5.socket'
      )
      AND NOT p0_cmd LIKE 'find . -executable -type f -name %grep -l GNU Libtool%touch -r%'
      AND NOT p0_cmd LIKE 'modinfo -k%'
      AND NOT p0_cmd LIKE 'modprobe -ab%'
      AND NOT p0_cmd LIKE 'modprobe --all%'
      AND NOT p0_cmd LIKE '%modprobe aufs'
      AND NOT p0_cmd LIKE '%touch -r /tmp/cc%.o %'
      AND NOT p0_cmd LIKE '%modprobe overlay'
      AND NOT p0_cmd LIKE '%modprobe nf_nat_netbios_ns'
      AND NOT p0_cmd LIKE '%modprobe -va%'
      AND NOT p0_cmd LIKE 'pkill -f cut -c3%'
      AND NOT p0_cmd LIKE '%/usr/bin/cmake%Socket%'
      AND NOT p0_name IN ('ar', 'cc1', 'compile', 'cmake', 'cc1plus')
      AND NOT exception_key IN (
        'bash,500,ninja,bash',
        'grep,500,fish,konsole',
        'tar,0,incusd,systemd',
        'bwrap,500,melange,dash',
        'ls,500,zsh,alacritty',
        'nc,500,fish,konsole',
        'kmod,0,incusd,systemd',
        'chrome_crashpad_handler,500,systemd,systemd',
        'bash,0,bash,containerd-shim-runc-v2'
      )
  tags: transient, process, events, extra
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Pick out exotic processes based on their command-line (events-based)
  discard_data: false
  interval: 180
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - exotic-command-events-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Pick out exotic processes based on their command-line (events-based)
    --
    -- references:
    --   * https://themittenmac.com/what-does-apt-activity-look-like-on-macos/
    --
    -- false positives:
    --   * possible, but none known
    --
    -- tags: transient process events extra
    -- platform: darwin
    -- interval: 180
    SELECT -- Child
      pe.path AS p0_path,
      pe.time AS p0_time,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      s.authority AS p0_authority,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      pe_sig1.authority AS p1_authority,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(
        p1_p2_sig.authority,
        pe1_p2_sig.authority,
        pe1_pe2_sig.authority
      ) AS p2_authority,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN signature s ON pe.path = s.path -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      LEFT JOIN signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path
      LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path
      LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path
    WHERE
      pe.time > (strftime('%s', 'now') -180)
      AND pe.status = 0
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND (
        p0_name IN (
          'bitspin',
          'bpftool',
          'csrutil',
          'heyoka',
          'nstx',
          'dnscat2',
          'tuns',
          'iodine',
          'rshell',
          'rsh',
          'incbit',
          'kmod',
          'lushput',
          'mkfifo',
          'msfvenom',
          'nc',
          'socat'
        ) -- Chrome Stealer
        OR p0_cmd LIKE '%set visible of front window to false%'
        OR p0_cmd LIKE '%chrome%-load-extension%' -- Known attack scripts
        OR p0_name LIKE '%pwn%'
        OR p0_name LIKE '%attack%' -- Unusual behaviors
        OR p0_cmd LIKE '%chattr -i%'
        OR p0_cmd LIKE '%dd if=/dev/%'
        OR p0_cmd LIKE '%cat /dev/null >%'
        OR p0_cmd LIKE '%truncate -s0 %'
        OR p0_cmd LIKE '%touch%acmr%'
        OR p0_cmd LIKE '%touch -r%'
        OR p0_cmd LIKE '%ld.so.preload%'
        OR p0_cmd LIKE 'killall%NotificationCenter'
        OR p0_cmd LIKE '%urllib.urlopen%'
        OR p0_cmd LIKE '%nohup%tmp%'
        OR p0_cmd LIKE '%killall Terminal%'
        OR (
          pe.euid = 0
          AND (
            p0_cmd LIKE '%pkill -f%'
            OR p0_cmd LIKE '%xargs kill -9%'
          )
        )
        OR p0_cmd LIKE '%rm -f /var/tmp%'
        OR p0_cmd LIKE '%rm -f /tmp%'
        OR p0_cmd LIKE '%nohup /bin/bash%'
        OR (
          INSTR(p0_cmd, 'history') > 0
          AND p0_cmd LIKE '%history'
          AND p0_cmd NOT LIKE '% history'
        )
        OR p0_cmd LIKE '%echo%|%base64 --decode %|%'
        OR p0_cmd LIKE '%echo%|%base64 -d %|%'
        OR p0_cmd LIKE '%launchctl bootout%'
        OR p0_cmd LIKE '%chflags uchg%'
        OR (
          p0_cmd LIKE '%UserKnownHostsFile=/dev/null%'
          AND NOT p1_name = 'limactl'
          AND NOT p1_cmd LIKE '%gcloud.py%'
        ) -- Random keywords
        OR p0_cmd LIKE '%ransom%' -- Reverse shells
        OR p0_cmd LIKE '%fsockopen%'
        OR p0_cmd LIKE '%openssl%quiet%'
        OR p0_cmd LIKE '%pty.spawn%'
        OR (
          p0_cmd LIKE '%sh -i'
          AND NOT p1_name IN ('sh', 'java')
          AND NOT p1_cmd LIKE "%pipenv shell"
        )
        OR p0_cmd LIKE 'socat %'
        OR p0_cmd LIKE '%SOCK_STREAM%'
        OR INSTR(p0_cmd, 'Socket.') > 0
      ) -- Things that could reasonably happen at boot.
      AND NOT (
        pe.path = '/usr/bin/mkfifo'
        AND (
          p0_cmd LIKE '%/org.gpgtools.log.%/fifo'
          OR p0_cmd LIKE '%/var/%/gitstatus.POWERLEVEL9K.%'
          OR p0_cmd LIKE '%/var/%/p10k.worker.%'
          OR p0_cmd LIKE '%/tmp/blesh/%'
        )
      )
      AND NOT (
        p0_cmd LIKE '%csrutil status'
        AND p1_name IN ('Dropbox')
      )
      AND NOT (
        p0_cmd IN (
          '/bin/launchctl bootout gui/501 /Library/LaunchAgents/com.logi.optionsplus.plist',
          '/bin/launchctl bootout system/com.docker.socket',
          '/bin/rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress',
          'git history',
          'dd if=/dev/urandom bs=15 count=1 status=none',
          'launchctl bootout gui/501/com.grammarly.ProjectLlama.UninstallAgent',
          'helm history',
          '/Library/Apple/System/Library/StagedFrameworks/Safari/SafariShared.framework/XPCServices/com.apple.Safari.History.xpc/Contents/MacOS/com.apple.Safari.History',
          'nc -h',
          'nc',
          'nc -uv 8.8.8.8 53',
          'nc localhost 8080 -vz',
          'nix profile history',
          'dd if=/dev/stdin conv=unblock cbs=79',
          'rm -f /tmp/mysql.sock',
          'sh -c launchctl bootout system "/Library/LaunchDaemons/com.ecamm.EcammAudioXPCHelper.plist"',
          '/usr/bin/csrutil report',
          '/usr/bin/csrutil status',
          '/usr/bin/pkill -F /private/var/run/lima/shared_socket_vmnet.pid',
          '/usr/bin/sudo /bin/rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress',
          '/usr/bin/xattr -d com.apple.writer_bundle_identifier /Applications/Safari.app',
          'xpcproxy com.apple.Safari.History'
        ) -- The source of these commands is still a mystery to me.
        OR pe.parent = -1
      )
      AND NOT p0_cmd LIKE 'launchctl bootout gui/501 /Users/%/Library/LaunchAgents/com.elgato.StreamDeck.plist'
      AND NOT p0_cmd LIKE '-history%'
      AND NOT p0_cmd LIKE 'dirname %history'
      AND NOT p0_cmd LIKE '/bin/rm -f /tmp/periodic.%'
      AND NOT p0_cmd LIKE '/bin/rm -f /tmp/nix-shell.%'
      AND NOT p0_cmd LIKE 'rm -f /tmp/blesh/%'
      AND NOT p0_cmd LIKE 'touch -r . /private/tmp/nix-build%'
      AND NOT p0_cmd LIKE '%GNU Libtool%touch -r%'
      AND NOT p0_cmd LIKE 'rm -f /tmp/locate%/_updatedb%'
      AND NOT p0_cmd LIKE 'rm -f /tmp/locate%/mklocate%/_mklocatedb%'
      AND NOT p0_cmd LIKE 'rm -f /tmp/insttmp_%'
      AND NOT p0_cmd LIKE '%nc localhost%'
      AND NOT p0_cmd LIKE '%nc -vz localhost%'
      AND NOT p0_cmd LIKE '/bin/cp %history%sessions/%'
      AND NOT p0_cmd LIKE '%ssh %/lima/%'
      AND NOT p0_cmd LIKE 'touch -r /tmp/KSInstallAction.%'
      AND NOT p0_cmd LIKE '%find /Applications/LogiTuneInstaller.app -type d -exec chmod 777 {}%'
      AND NOT p0_cmd LIKE '/bin/rm -f /tmp/com.adobe.%.updater/%'
      AND NOT p0_name IN ('cc1', 'compile', 'yara')
      AND NOT exception_key IN (
        'dd,500,zsh,login',
        'bash,500,idea,launchd',
        'yara,500,bash,fish',
        'go,500,fish,login',
        'ssh,500,limactl.ventura,launchd',
        'git,500,zsh,login',
        'bat,500,zsh,login',
        'git,500,zsh,goland',
        'jq,500,zsh,login',
        'sh,0,Ecamm Live,launchd',
        'cat,500,zsh,login'
      )
  tags: transient, process, events, extra
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Pick out exotic processes based on their command-line (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - exotic-commands-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Pick out exotic processes based on their command-line (state-based)
    --
    -- false positives:
    --   * possible, but none known
    --
    -- tags: transient process state
    -- platform: linux
    SELECT
      DATETIME(f.ctime, 'unixepoch') AS p0_changed,
      DATETIME(f.mtime, 'unixepoch') AS p0_modified,
      (strftime('%s', 'now') - p0.start_time) AS p0_runtime_s,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      -- Known attack scripts
      (
        p0.name IN (
          'bitspin',
          'bpftool',
          'heyoka',
          'nstx',
          'dnscat2',
          'tuns',
          'iodine',
          'esxcli',
          'vim-cmd',
          'minerd',
          'cpuminer-multi',
          'cpuminer',
          'httpdns',
          'rshell',
          'rsh',
          'xmrig',
          'incbit',
          'insmod',
          'kmod',
          'lushput',
          'mkfifo',
          'msfvenom',
          'nc',
          'socat'
        )
        OR p0.name LIKE '%pwn%'
        OR p0.name LIKE '%xig%'
        OR p0.name LIKE '%xmr%'
        OR p0.cmdline LIKE '%--pool%'
        OR p0.cmdline LIKE '%--algo%'
        OR p0.cmdline LIKE '%--wss%'
        OR p0.cmdline LIKE '%wormhole%'
        OR p0.cmdline LIKE '%bitspin%'
        OR p0.cmdline LIKE '%lushput%'
        OR p0.cmdline LIKE '%incbit%'
        OR p0.cmdline LIKE '%traitor%'
        OR p0.cmdline LIKE '%ethereum%'
        OR p0.cmdline LIKE '%msfvenom%'
        -- Unusual behaviors
        OR p0.cmdline LIKE '%ufw disable%'
        OR p0.cmdline LIKE '%dd if=/dev/%'
        OR p0.cmdline LIKE '%iptables -P % ACCEPT%'
        OR p0.cmdline LIKE '%iptables -F%'
        OR p0.cmdline LIKE '%chattr -ia%'
        OR p0.cmdline LIKE '%chflags uchg%'
        OR p0.cmdline LIKE '%bpftool%'
        OR p0.cmdline LIKE '%tar % .%'
        OR p0.cmdline LIKE '%tar %/.%'
        OR p0.cmdline LIKE '%.config%gcloud%'
        OR p0.cmdline LIKE '%.config/%chrome%'
        OR p0.cmdline LIKE '%touch%acmr%'
        OR p0.cmdline LIKE '%ld.so.preload%'
        OR p0.cmdline LIKE '%urllib.urlopen%'
        OR p0.cmdline LIKE '%nohup%tmp%'
        OR p0.cmdline LIKE '%chrome%--load-extension%'
        OR (
          p0.cmdline LIKE '%UserKnownHostsFile=/dev/null%'
          AND NOT p1.name = 'limactl'
          AND NOT p0.cmdline LIKE '%@localhost%'
          AND NOT p0.cmdline LIKE '%@localhost -A%'
        ) -- Crypto miners
        OR p0.cmdline LIKE '%hashrate%'
        OR p0.cmdline LIKE '%hashvault%'
        OR p0.cmdline LIKE '%minerd%'
        OR p0.cmdline LIKE '%nanopool%'
        OR p0.cmdline LIKE '%nicehash%'
        OR p0.cmdline LIKE '%stratum%' -- Random keywords
        OR p0.cmdline LIKE '%plant%' -- Reverse shells
        OR p0.cmdline LIKE '%/dev/%cp/%'
        OR p0.cmdline LIKE '%fsockopen%'
        OR p0.cmdline LIKE '%openssl%quiet%'
        OR p0.cmdline LIKE '%pty.spawn%'
        OR (
          p0.cmdline LIKE '%sh -i'
          AND NOT p0.path = '/usr/bin/docker'
          AND NOT p1.name IN (
            'sh',
            'java',
            'containerd-shim',
            'code',
            'emacs',
            'vim',
            'vim.nox'
          )
          AND NOT p1.cmdline LIKE '%pipenv shell'
          AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
          AND NOT p0.cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
        )
        OR p0.cmdline LIKE '%SOCK_STREAM%'
        OR INSTR(p0.cmdline, '%Socket.%') > 0 -- Keep the shell running, as in https://blog.aquasec.com/threat-alert-kinsing-malware-container-vulnerability
        OR (
          p0.cmdline LIKE '%tail -f /dev/null%'
          AND NOT p0.cmdline LIKE 'docker run%'
          AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
          AND NOT p1.pid == 0
        )
      )
      AND NOT p0.cmdline like '%socat UNIX-LISTEN:%com.discordapp%discord-ipc%'
      AND NOT p0.cmdline IN ('nc 127.0.0.1 5900')
      AND NOT p0.name IN (
        'cc1',
        'git',
        'emacs',
        'espeak',
        'compile',
        'bwrap',
        'cmake',
        'cc1plus',
        'chrome_crashpad'
      )
      AND NOT p1.name IN ('bwrap')
  tags: transient, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Pick out exotic processes based on their command-line (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - exotic-commands-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Pick out exotic processes based on their command-line (state-based)
    --
    -- false positives:
    --   * possible, but none known
    --
    -- tags: transient process state
    -- platform: darwin
    SELECT
      s.authority AS p0_auth,
      s.identifier AS p0_id,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          p.pid
        FROM
          processes p
        WHERE
          p.name IN (
            'bitspin',
            'bpftool',
            'heyoka',
            'nstx',
            'dnscat2',
            'tuns',
            'iodine',
            'esxcli',
            'vim-cmd',
            'minerd',
            'cpuminer-multi',
            'cpuminer',
            'httpdns',
            'rshell',
            'rsh',
            'xmrig',
            'incbit',
            'lushput',
            'mkfifo',
            'msfvenom',
            'nc',
            'socat'
          ) -- coin miner names
          OR REGEX_MATCH (p.name, "(pwn|xig|xmr)", 1) != "" -- malicious processes
          OR REGEX_MATCH (
            p.cmdline,
            "(bitspin|lushput|incbit|traitor|msfvenom|urllib.urlopen|nohup.*tmp|chrome.*--load-extension|tail -f /dev/null|wormhole)",
            1
          ) != "" -- suspicious things
          OR REGEX_MATCH (
            p.cmdline,
            "(UserKnownHostsFile=/dev/null|ransom|malware|fsockopen|openssl.*quiet|pty.spawn|SOCK_STREAM)",
            1
          ) != "" -- Crypto miners
          OR REGEX_MATCH (
            p.cmdline,
            "(c3pool|cryptonight|f2pool|hashrate|hashvault|minerd|monero|nanopool|nicehash|stratum|wss://| --pool| --algo)",
            1
          ) != "" -- Needs to be case sensitive
          OR (
            INSTR(p.cmdline, '%Socket.%') > 0
            AND NOT p.name IN ('cc1', 'compile', 'cmake', 'cc1plus')
          )
          OR p.cmdline LIKE '%dd if=/dev/%'
      )
      AND NOT (
        p0_cmd LIKE '%UserKnownHostsFile=/dev/null%'
        AND (
          p0_cmd LIKE "%lima/%"
          OR p0_cmd LIKE "%minikube/%"
          OR p0_cmd LIKE '%@localhost'
          OR p0_cmd LIKE '%ServerAliveInterval=0%'
          OR p1_cmd LIKE '%gcloud.py%'
        )
      )
      AND NOT (
        p0_cmd LIKE '%sh -i'
        AND p1_cmd LIKE '%pipenv shell'
      )
      AND NOT p0_cmd IN ('pkill -f Jabra Direct')
      AND NOT p0_cmd LIKE "%dd if=/dev/stdin conv=unblock cbs=79"
      AND NOT p0_cmd LIKE '%docker% run % tail -f /dev/null'
      AND NOT p1_path LIKE '/Applications/Emacs.app/Contents/MacOS/Emacs-arm64-%'
    GROUP BY
      p0.pid;
  tags: transient, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Long-running programs who were recently added to disk, based on btime/ctime
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - recently-created-executables-long-lived-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Long-running programs who were recently added to disk, based on btime/ctime
    --
    -- false-positives:
    --   * many
    --
    -- tags: transient process state
    -- platform: linux
    SELECT
      f.ctime AS p0_ctime,
      f.mtime AS p0_mtime,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.start_time AS p0_start,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.start_time AS p1_start,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.start_time AS p2_start,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.start_time > 0
      AND f.ctime > 0
      AND p0.start_time > (strftime('%s', 'now') - 43200)
      AND (p0.start_time - MAX(f.ctime, f.btime)) < 900
      AND p0.start_time >= MAX(f.ctime, f.ctime)
      AND NOT f.directory IN ('/usr/lib/firefox', '/usr/local/kolide-k2/bin') -- Typically daemons or long-running desktop apps
      -- These are binaries that are known to get updated and subsequently executed
      --
      -- What I would give for osquery to support binary signature verification on Linux
      AND NOT p0.path IN (
        '',
        '/bin/containerd',
        '/bin/containerd-shim-runc-v2',
        '/opt/google/chrome/chrome',
        '/opt/google/chrome/chrome_crashpad_handler',
        '/opt/google/chrome/nacl_helper',
        '/opt/Lens/chrome_crashpad_handler',
        '/opt/Lens/lens',
        '/opt/sublime_text/sublime_text',
        '/usr/lib64/electron/electron',
        '/usr/lib64/firefox/firefox',
        '/usr/lib64/google-cloud-sdk/platform/bundledpythonunix/bin/python3',
        '/usr/lib64/thunderbird/thunderbird',
        '/usr/lib/at-spi2-registryd',
        '/usr/lib/at-spi-bus-launcher',
        '/usr/lib/cups/notifier/dbus',
        '/usr/lib/docker/cli-plugins/docker-compose',
        '/usr/lib/electron25/electron',
        '/usr/libexec/accounts-daemon',
        '/usr/libexec/bluetooth/bluetoothd',
        '/usr/libexec/docker/docker-proxy',
        '/usr/libexec/flatpak-portal',
        '/usr/libexec/flatpak-system-helper',
        '/usr/libexec/fwupd/fwupd',
        '/usr/libexec/gnome-shell-calendar-server',
        '/usr/libexec/gstreamer-1.0/gst-plugin-scanner',
        '/usr/libexec/ibus-dconf',
        '/usr/libexec/ibus-engine-simple',
        '/usr/libexec/ibus-extension-gtk3',
        '/usr/libexec/ibus-portal',
        '/usr/libexec/ibus-x11',
        '/usr/libexec/power-profiles-daemon',
        '/usr/libexec/snapd/snapd',
        '/usr/libexec/sssd/sssd_kcm',
        '/usr/libexec/tracker-extract-3',
        '/usr/libexec/tracker-miner-fs-3',
        '/usr/lib/flatpak-session-helper',
        '/usr/lib/fwupd/fwupd',
        '/usr/lib/gdm',
        '/usr/lib/gdm-session-worker',
        '/usr/lib64/discord/Discord',
        '/usr/lib/gdm-x-session',
        '/usr/lib/gnome-shell-calendar-server',
        '/usr/lib/google-cloud-sdk/platform/bundledpythonunix/bin/python3',
        '/usr/lib/ibus/ibus-dconf',
        '/usr/lib/ibus/ibus-engine-simple',
        '/usr/lib/ibus/ibus-portal',
        '/usr/lib/libreoffice/program/oosplash',
        '/usr/lib/libreoffice/program/soffice.bin',
        '/usr/lib/opt/google/chrome/chrome',
        '/usr/lib/polkit-1/polkitd',
        '/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1',
        '/usr/lib/slack/chrome_crashpad_handler',
        '/usr/lib/slack/slack',
        '/usr/lib/snapd/snapd',
        '/usr/lib/systemd/systemd',
        '/usr/lib/systemd/systemd-homed',
        '/usr/lib/systemd/systemd-hostnamed',
        '/usr/lib/systemd/systemd-journald',
        '/usr/lib/systemd/systemd-logind',
        '/usr/lib/systemd/systemd-machined',
        '/usr/lib/systemd/systemd-oomd',
        '/usr/lib/systemd/systemd-resolved',
        '/usr/lib/systemd/systemd-timesyncd',
        '/usr/lib/systemd/systemd-userdbd',
        '/usr/lib/systemd/systemd-userwork',
        '/usr/lib/tracker-extract-3',
        '/usr/lib/upowerd',
        '/usr/lib/x86_64-linux-gnu/obs-plugins/obs-browser-page',
        '/usr/lib/xdg-desktop-portal-gtk',
        '/usr/lib/xf86-video-intel-backlight-helper',
        '/usr/local/bin/kind',
        '/usr/sbin/dnsmasq',
        '/usr/share/code/chrome_crashpad_handler',
        '/usr/share/code/code',
        '/usr/share/spotify-client/spotify',
        '/usr/share/teams/team'
      )
      AND NOT p0.path LIKE '/home/%/bin/%'
      AND NOT p0.path LIKE '/home/%/git/%'
      AND NOT p0.path LIKE '/home/%/.local/share/JetBrains/Toolbox/apps/%'
      AND NOT p0.path LIKE '/home/%/.local/share/nvim/mason/packages/%'
      AND NOT p0.path LIKE '/home/%/.cache/JetBrains/%/GoLand/___%'
      AND NOT p0.path LIKE '/home/%/.local/share/Steam/ubuntu%'
      AND NOT p0.path LIKE '/home/%/.rustup/toolchains/%/libexec/%'
      AND NOT p0.path LIKE '/home/%/jbr/lib/jcef_helper'
      AND NOT p0.path LIKE '/home/%/jbr/bin/java'
      AND NOT p0.path LIKE '/home/%/node_modules/.bin/%'
      AND NOT p0.path LIKE '/home/%/Projects/%'
      AND NOT p0.path LIKE '/home/%/terraform-provider-%'
      AND NOT p0.path LIKE '/home/%/%.test'
      AND NOT p0.path LIKE '/nix/store/%/bin/%'
      AND NOT p0.path LIKE '/nix/store/%/libexec/%'
      AND NOT p0.path LIKE '/opt/%'
      AND NOT p0.path LIKE '/tmp/go-build%'
      AND NOT p0.path LIKE '/tmp/terraform_%/terraform'
      AND NOT p0.path LIKE '/tmp/tmp0.%/%/bin/%'
      AND NOT p0.path LIKE '/usr/local/bin/%'
      AND NOT p0.path LIKE '/usr/local/Cellar/%'
      AND NOT p0.path LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
      AND NOT p0.path LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/launcher'
      AND NOT p0.path LIKE '/var/kolide-k2/%/osqueryd'
      AND NOT p0.path LIKE '/var/kolide-k2/%/launcher'
      AND NOT p0.path LIKE '%/.vscode/extensions/%'
      AND NOT p0.path LIKE '/var/home/linuxbrew/.linuxbrew/Cellar/%'
      AND NOT p0.path LIKE '%/.local/share/spotify-launcher/install/usr/%'
      AND NOT (
        p0.name IN ('osqtool-x86_64', 'osqtool-arm64')
        AND p0.cmdline LIKE './%'
      )
      AND NOT p1.path IN ('/usr/bin/gnome-shell') -- Filter out developers working on their own code
      AND NOT p1.name = 'makepkg'
      AND NOT p2.path = '/usr/bin/yay'
      AND NOT p2.cmdline LIKE '/usr/bin/yay %'
      AND NOT (
        f.directory IN ('/usr/bin', '/usr/sbin')
        AND f.filename NOT LIKE '.%'
      )
      AND NOT (
        p0.path LIKE '/home/%'
        AND p0.uid > 499
        AND f.ctime = f.mtime
        AND f.uid = p0.uid
        AND p0.cmdline LIKE './%'
        AND p0.path NOT LIKE '%/.%'
        AND p0.path NOT LIKE '%cache%'
      )
      AND NOT (
        p0.path LIKE '/tmp/%/osqtool-%'
        AND p0.uid > 499
        AND f.ctime = f.mtime
        AND f.uid = p0.uid
        AND p0.cmdline LIKE './%'
      )
      AND NOT (
        p0.path LIKE '/home/%/.magefile/%'
        AND p0.uid > 499
        AND f.ctime = f.mtime
        AND f.uid = p0.uid
      )
    GROUP BY
      p0.pid
  tags: transient, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Long-running programs who were recently added to disk, based on btime/ctime
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - recently-created-executables-long-lived-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Long-running programs who were recently added to disk, based on btime/ctime
    --
    -- false-positives:
    --   * many
    --
    -- tags: transient process state
    -- platform: darwin
    SELECT
      f.ctime,
      f.btime,
      f.mtime,
      p0.start_time,
      s.authority AS s_auth,
      s.identifier AS s_id,
      REPLACE(f.directory, u.directory, '~') AS dir,
      COALESCE(
        REGEX_MATCH (
          REPLACE(f.directory, u.directory, '~'),
          '(~/.*?/.*?/.*?/)',
          1
        ),
        REPLACE(f.directory, u.directory, '~')
      ) AS top3_dir,
      REPLACE(f.path, u.directory, '~') AS homepath,
      -- Child
      p0.pid AS p0_pid,
      p0.start_time AS p0_start,
      p0.path AS p0_path,
      s.authority AS p0_sauth,
      s.identifier AS p0_sid,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.start_time AS p1_start,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN users u ON f.uid = u.uid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > 0
          AND start_time > (strftime('%s', 'now') - 43200)
          AND pid > 0
          AND path != ""
          AND NOT path LIKE '/Applications/%'
          AND NOT path LIKE '/Library/Apple/%'
          AND NOT path LIKE '/nix/store/%'
          AND NOT path LIKE '/opt/homebrew/%'
          AND NOT path LIKE '%/bin/cargo'
          AND NOT path LIKE '/System/%'
          AND NOT path LIKE '/usr/local/kolide-k2/bin/%'
          AND NOT path LIKE '%/cloud_sql_proxy'
      )
      AND (p0.start_time - MAX(f.ctime, f.btime)) < 600
      AND f.ctime > 0
      AND NOT (
        p0.euid > 499
        AND (
          top3_dir IN (
            '~/Library/Application Support/BraveSoftware/',
            '~/Library/Application Support/com.elgato.StreamDeck/',
            '~/Library/Application Support/duckly/',
            '/Library/Application Support/EcammLive',
            '~/homebrew/Library/Homebrew/',
            '~/Library/Application Support/Figma/',
            '~/Library/Application Support/Foxit Software/',
            '~/Library/Application Support/JetBrains/',
            '~/Library/Application Support/OpenLens',
            '~/.local/share/nvim/',
            '~/Library/Application Support/sourcegraph-sp/',
            '~/Library/Application Support/Steam/',
            '~/Library/Application Support/WebEx Folder/',
            '~/Library/Application Support/Zed/',
            '~/Library/Application Support/Zwift/',
            '~/Library/Application Support/Zwift',
            '~/Library/Caches/com.mimestream.Mimestream/',
            '~/Library/Caches/company.thebrowser.Browser/',
            '~/Library/Caches/com.sempliva.Tiles/',
            '~/Library/Caches/JetBrains/',
            '~/Library/Caches/org.gpgtools.updater/',
            '~/Library/Caches/snyk/',
            '/Library/Developer/Xcode/',
            '~/.local/share/bob/',
            '~/projects/go/src/',
            '~/.terraform.d/plugin-cache/registry.terraform.io/',
            '/usr/local/kolide-k2/Kolide.app/Contents/MacOS',
            '~/.vscode/extensions/ms-vscode.cpptools-1.15.4-darwin-arm64/'
          )
          OR dir IN (
            '~/bin',
            '~/gohome/bin',
            '~/code/bin',
            '~/go/bin',
            '~/melange',
            '~/repos/bincapz/out',
            '~/Library/Application Support/cloud-code/installer/google-cloud-sdk/bin',
            '/usr/local/kolide-k2/Kolide.app/Contents/MacOS',
            '~/Library/Application Support/dev.warp.Warp-Stable',
            '~/Library/Application Support/snyk-ls',
            '~/Library/Application Support/zoom.us/Plugins/aomhost.app/Contents/MacOS',
            '~/.local/bin',
            '~/.local/share/gh/extensions/gh-sbom',
            '~/.magefile',
            '~/projects/go/bin',
            '/usr/local/kolide-k2/Kolide.app/Contents/MacOS'
          )
          OR dir LIKE '~/%/node_modules/%bin'
          OR dir LIKE '~/%.vscode/extensions/%'
          OR dir LIKE '~/.vscode-insiders/extensions/%'
          OR dir LIKE '~/.rustup/toolchains/%'
          OR dir LIKE '~/%/go/bin'
          OR dir LIKE '~/Downloads/%.app/Contents/MacOS'
          OR dir LIKE '~/dev/%'
          OR f.path LIKE '%go-build%'
          OR homepath LIKE '~/%/src/%.test'
          OR homepath LIKE '~/%/pkg/%.test'
          OR homepath LIKE '~/%/gopls'
          OR homepath LIKE '~/go/%/bin'
          OR homepath LIKE '~/Parallels/%/WinAppHelper'
          OR f.path LIKE '/private/tmp/%/Creative Cloud Installer.app/Contents/MacOS/Install'
          OR f.path LIKE '/private/tmp/go-%'
          OR f.path LIKE '/private/tmp/nix-build-%'
          OR f.path LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'
          OR f.path LIKE '/private/var/folders/%/bin/%'
          OR f.path LIKE '/private/var/folders/%/d/Wrapper/%.app/%'
          OR f.path LIKE '/private/var/folders/%/GoLand/%'
          OR f.path LIKE '/private/var/folders/%/T/download/ARMDCHammer'
          OR f.path LIKE '/private/var/folders/%/T/pulumi-go.%'
        )
      )
      AND NOT s.authority IN (
        'Apple Mac OS Application Signing',
        'Apple iPhone OS Application Signing',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Azul Systems, Inc. (TDTHCUPYFR)',
        'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',
        'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4)',
        'Developer ID Application: Brother Industries, LTD. (5HCL85FLGW)',
        'Developer ID Application: Bryan Jones (49EYHPJ4Q3)',
        'Developer ID Application: Canon Inc. (XE2XNRRXZ5)',
        'Developer ID Application: Cisco (DE8Y96K9QP)',
        'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Denver Technologies, Inc (2BBY89MBSN)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: Eclipse Foundation, Inc. (JCDTMS22B4)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: Emmanouil Konstantinidis (3YP8SXP3BF)',
        'Developer ID Application: EnterpriseDB Corporation (26QKX55P9K)',
        'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'Developer ID Application: GPGTools GmbH (PKV8ZPD836)',
        'Developer ID Application: Galvanix (5BRAQAFB8B)',
        'Developer ID Application: Garmin International (72ES32VZUA)',
        'Developer ID Application: General Arcade (Pte. Ltd.) (S8JLSG5ES7)',
        'Developer ID Application: GitHub (VEKTX9H2N7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: Kandji, Inc. (P3FGV63VK7)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Kolide, Inc (X98UFR7HA3)',
        'Developer ID Application: Fumihiko Takayama (G43BCU2T37)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Wesley FURLONG (P4A6FU9KZ3)',
        'Developer ID Application: Michael Jones (YD6LEYT6WZ)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Mojang AB (HR992ZEAE6)',
        'Developer ID Application: OPENVPN TECHNOLOGIES, INC. (ACV7L3WCD8)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: Parallels International GmbH (4C6364ACXT)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: The Browser Company of New York Inc. (S6N382Y83G)',
        'Developer ID Application: RescueTime, Inc (FSY4RB8H39)',
        'Developer ID Application: Wizards of OBS LLC (2MMRE5MTB8)',
        'Developer ID Application: SUSE LLC (2Q6FHJR3H3)',
        'Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',
        'Developer ID Application: SteelSeries (6WGL6CHFH2)',
        'Developer ID Application: Hashicorp, Inc. (D38WU7D763)',
        'Developer ID Application: Sublime HQ Pty Ltd (Z6D26JE4Y4)',
        'Developer ID Application: Tailscale Inc. (W5364U7YZB)',
        'Developer ID Application: Yubico Limited (LQA3CS5MM7)',
        'Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3)',
        'Developer ID Application: Zwift, Inc (C2GM8Y9VFM)',
        'Software Signing'
      )
      AND NOT (
        s.identifier = "com.apple.print.PrinterProxy"
        AND p0.path LIKE "/Users/%/Library/Printers/%/Contents/MacOS/PrinterProxy"
        AND p0.uid > 499
      )
      AND NOT (
        homepath LIKE '~/%'
        AND p0.uid > 499
        AND f.ctime = f.mtime
        AND f.uid = p0.uid
        AND p0.cmdline LIKE './%'
        AND p0.path NOT LIKE '%Library%'
        AND p0.path NOT LIKE '%/.%'
        AND p0.path NOT LIKE '%Cache%'
      )
      AND NOT homepath LIKE '~/%/terraform-provider-%'
      AND NOT homepath LIKE '~/src/%'
      AND NOT homepath LIKE '~/github/%'
      AND NOT homepath LIKE '~/go/src/%'
      -- Arc
      AND NOT (
        p0.path LIKE '/Users/%/Library/Caches/%/org.sparkle-project.Sparkle/Launcher/%'
        AND s.identifier = 'org.sparkle-project.Sparkle.Updater'
        AND s.authority != ''
        AND p0.uid > 499
      )
      AND NOT (
        p0.path = '/Library/PrivilegedHelperTools/com.macpaw.CleanMyMac4.Agent'
        AND s_auth = 'Developer ID Application: MacPaw Inc. (S8EX82NJP6)'
      )
    GROUP BY
      p0.pid
  tags: transient, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Programs running as root with a relative path (event-based)
  discard_data: false
  interval: 180
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - relative-exec-low-uid-events
  observer_can_run: false
  platforms: posix
  query: |
    -- Programs running as root with a relative path (event-based)
    --
    -- references:
    --   * https://www.microsoft.com/en-us/security/blog/2022/12/21/microsoft-research-uncovers-new-zerobot-capabilities/
    --
    -- platform: posix
    -- interval: 180
    -- tags: process events
    SELECT -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.time AS p0_time,
      pe.time AS p0_time,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -180)
      AND pe.cmdline != ''
      AND pe.euid < 500
      AND pe.cmdline LIKE './%'
      AND p0_cmd NOT IN (
        './conftest',
        './configure',
        './ksinstall --install=Keystone.tbz',
        './podinfo --port=9898 --port-metrics=9797 --grpc-port=9999 --grpc-service-name=podinfo --level=info --random-delay=false --random-error=false'
      )
      AND p0_cmd NOT LIKE './tools/bpf/resolve_btfids/resolve_btfids -b vmlinux /var/lib/dkms/%'
      AND p0_cmd NOT LIKE './tools/objtool/objtool%--hacks%'
      AND p0_cmd NOT LIKE './out/osqtool-% %'
      AND p0_path NOT LIKE '/private/tmp/PKInstallSandbox.%/Scripts/com.microsoft.OneDrive.%/OneDrivePkgTelemetry'
      AND NOT p0_cgroup LIKE '/system.slice/docker-%'
  tags: process, events
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Programs running as root with a relative path
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - relative-exec-low-uid
  observer_can_run: false
  platforms: posix
  query: |
    -- Programs running as root with a relative path
    --
    -- references:
    --   * https://www.microsoft.com/en-us/security/blog/2022/12/21/microsoft-research-uncovers-new-zerobot-capabilities/
    --
    -- tags: transient process state
    -- platform: posix
    SELECT -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.start_time AS p0_start,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.start_time AS p1_start,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          euid < 500
          AND cmdline LIKE './%'
          AND NOT cmdline LIKE './out/osqtool-% %'
          AND NOT cmdline LIKE './osqueryi%'
          AND NOT cmdline LIKE './OneDrivePkgTelemetry%'
          AND NOT cgroup_path LIKE '/system.slice/docker-%'
      )
    GROUP BY
      p0.pid
  tags: transient, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Uncover reverse-shell processes
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - reverse-shell-socket
  observer_can_run: false
  platforms: posix
  query: |
    -- Uncover reverse-shell processes
    --
    -- refs:
    --   * https://www.invicti.com/blog/web-security/understanding-reverse-shells/
    --   * https://attack.mitre.org/techniques/T1059/ (Command & Scripting Interpreter)
    --
    -- false-positives:
    --   * none known
    --
    -- tags: transient process state often
    -- platform: posix
    SELECT DISTINCT
      (p.pid),
      p.parent,
      p.name,
      p.path,
      p.cmdline,
      p.cwd,
      p.root,
      p.uid,
      p.gid,
      p.start_time,
      pos.remote_address,
      pos.remote_port,
      pos.local_address,
      pos.local_port,
      pp.cmdline,
      pp.path
    FROM
      process_open_files pof
      JOIN process_open_sockets pos USING (pid)
      LEFT JOIN processes p ON pof.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT OUTER JOIN process_open_files ON p.pid = process_open_files.pid
    WHERE
      p.name IN ('sh', 'bash', 'perl', 'python')
      AND pof.pid IS NULL
      AND pos.remote_port > 0
      AND NOT (
        p.path = '/usr/bin/bash'
        AND pp.cmdline LIKE 'pacman -S%'
      )
  tags: transient, process, state, often
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Suspicious URL requests by built-in fetching tools (event-based)
  discard_data: false
  interval: 120
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - sketchy-fetcher-events
  observer_can_run: false
  platforms: posix
  query: "-- Suspicious URL requests by built-in fetching tools (event-based)\n--\n\
    -- refs:\n--   * https://attack.mitre.org/techniques/T1105/ (Ingress Tool Transfer)\n\
    --   * https://attack.mitre.org/techniques/T1571/ (Non-Standard Port)\n--\n--\
    \ interval: 120\n-- tags: transient process events\n-- platform: posix\nSELECT\n\
    \  -- Child\n  pe.path AS p0_path,\n  REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,\n\
    \  TRIM(pe.cmdline) AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.pid AS p0_pid,\n  pe.time\
    \ AS p0_time,\n  p.cgroup_path AS p0_cgroup,\n  -- Parent\n  pe.parent AS p1_pid,\n\
    \  p1.cgroup_path AS p1_cgroup,\n  TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS\
    \ p1_cmd,\n  COALESCE(p1.path, pe1.path) AS p1_path,\n  COALESCE(p_hash1.sha256,\
    \ pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)',\
    \ 1) AS p1_name,\n  -- Grandparent\n  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n\
    \  COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,\n  TRIM(\n  \
    \  COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n  ) AS p2_cmd,\n\
    \  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,\n  COALESCE(\n\
    \    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n  ) AS p2_hash,\n\
    \  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n    '.*/(.*)',\n\
    \    1\n  ) AS p2_name,\n  -- Extra fields\n  REGEX_MATCH (pe.cmdline, '(\\w+:\\\
    /\\/.*)\\b', 1) AS url,\n  REGEX_MATCH (pe.cmdline, '[ /](\\d+\\.\\d+\\.\\d+\\\
    .\\d+)[:/]', 1) AS ip,\n  REGEX_MATCH (pe.cmdline, ':(\\d+)', 1) AS port,\n  REGEX_MATCH\
    \ (pe.cmdline, '//([\\w\\-\\.]+)[:/]', 1) AS addr,\n  REGEX_MATCH (pe.cmdline,\
    \ '//[\\w\\-\\.]+\\.(\\w+)[:/]', 1) AS tld\nFROM\n  process_events pe,\n  uptime\n\
    \  LEFT JOIN processes p ON pe.pid = p.pid\n  -- Parents (via two paths)\n  LEFT\
    \ JOIN processes p1 ON pe.parent = p1.pid\n  LEFT JOIN hash p_hash1 ON p1.path\
    \ = p_hash1.path\n  LEFT JOIN process_events pe1 ON pe.parent = pe1.pid\n  AND\
    \ pe1.cmdline != ''\n  LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path\n \
    \ -- Grandparents (via 3 paths)\n  LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid\
    \ -- Current grandparent via parent processes\n  LEFT JOIN processes pe1_p2 ON\
    \ pe1.parent = pe1_p2.pid -- Current grandparent via parent events\n  LEFT JOIN\
    \ process_events pe1_pe2 ON pe1.parent = pe1_p2.pid\n  AND pe1_pe2.cmdline !=\
    \ '' -- Past grandparent via parent events\n  LEFT JOIN hash p1_p2_hash ON p1_p2.path\
    \ = p1_p2_hash.path\n  LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path\n\
    \  LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path\n  -- Extra\
    \ fields\nWHERE\n  pe.time > (strftime('%s', 'now') -120)\n  AND pe.cmdline !=\
    \ ''\n  -- NOTE: Sync remaining portion with sketchy-fetchers\n  AND (\n    INSTR(pe.cmdline,\
    \ 'wget ') > 0\n    OR INSTR(pe.cmdline, 'curl ') > 0\n  )\n  -- Sketchy fetcher\
    \ events always seem to contain a switch\n  AND pe.cmdline LIKE '%-%'\n  AND pe.cmdline\
    \ LIKE '%/%'\n  AND (\n    -- If it's an IP or port, it's suspicious\n    ip NOT\
    \ IN ('', '127.0.0.1', '0.0.0.0', '::1')\n    OR port != ''\n    OR tld NOT IN\
    \ (\n      '',\n      'app',\n      'ca',\n      'cloud',\n      'com',\n    \
    \  'de',\n      'dev',\n      'edu',\n      'fun',\n      'gov',\n      'io',\n\
    \      'md',\n      'mil',\n      'net',\n      'org',\n      'se',\n      'sh',\n\
    \      'so',\n      'uk',\n      'us'\n    )\n    -- Or if it matches weird keywords\
    \ we've seen\n    OR p.cmdline LIKE '%chmod%'\n    OR pe.cmdline LIKE '%.onion%'\n\
    \    OR pe.cmdline LIKE '%tor2web%'\n    OR pe.cmdline LIKE '%aliyun%'\n    OR\
    \ pe.cmdline LIKE '%pastebin%'\n    OR pe.cmdline LIKE '%curl.*\u2014write-out%'\n\
    \    OR pe.cmdline LIKE '%curl %--user-agent%'\n    OR pe.cmdline LIKE '%curl\
    \ -k%'\n    OR pe.cmdline LIKE '%curl -sL %'\n    OR pe.cmdline LIKE '%curl%-o-%'\n\
    \    OR pe.cmdline LIKE '%curl%--connect-timeout%'\n    OR pe.cmdline LIKE '%curl%--output\
    \ /dev/null%'\n    OR pe.cmdline LIKE '%curl%--O /dev/null%'\n    OR pe.cmdline\
    \ LIKE '%curl%--insecure%'\n    OR pe.cmdline LIKE '%wget %--user-agent%'\n  \
    \  OR pe.cmdline LIKE '%wget %--no-check-certificate%'\n    OR pe.cmdline LIKE\
    \ '%wget -nc%'\n    OR pe.cmdline LIKE '%wget -q%'\n    OR pe.cmdline LIKE '%wget\
    \ -t%'\n    -- Or anything launched by a system user\n    OR (\n      pe.cmdline\
    \ LIKE '%wget -%'\n      AND pe.euid < 500\n      AND p.cgroup_path NOT LIKE '/system.slice/docker-%'\n\
    \    )\n    OR (\n      pe.cmdline LIKE '%curl %'\n      AND pe.euid < 500\n \
    \     AND pe.cmdline NOT LIKE \"%./configure %--with-curl%\"\n      AND p.cgroup_path\
    \ NOT LIKE '/system.slice/docker-%'\n    )\n  )\n  -- Exceptions for all calls\n\
    \  AND NOT (\n    pe.euid > 500\n    AND (\n      pe.cmdline LIKE '%--dump-header%'\n\
    \      OR pe.cmdline LIKE '%127.0.0.1:%'\n      OR pe.cmdline LIKE '% localhost:%'\n\
    \      OR pe.cmdline LIKE '%/192.168.%:%'\n      OR pe.cmdline LIKE '%application/json%'\n\
    \      OR pe.cmdline LIKE '%/chainctl_%'\n      OR pe.cmdline LIKE '%ctlog%'\n\
    \      OR pe.cmdline LIKE '%curl -X %'\n      OR pe.cmdline LIKE '%Authorization:\
    \ Bearer%'\n      OR pe.cmdline LIKE 'git %'\n      OR pe.cmdline LIKE '%go mod\
    \ %'\n      OR pe.cmdline LIKE '%grpcurl%'\n      OR pe.cmdline LIKE '%Homebrew%'\n\
    \      OR pe.cmdline LIKE '%https://api.github.com/%'\n      OR pe.cmdline LIKE\
    \ '%If-None-Match%'\n      OR pe.cmdline LIKE \"%libcurl%\"\n      OR pe.cmdline\
    \ LIKE '%LICENSES/vendor/%'\n      OR pe.cmdline LIKE '%localhost:%'\n      OR\
    \ pe.cmdline LIKE '%/openid/v1/jwks%'\n      OR pe.cmdline LIKE '%--progress-bar%'\n\
    \      OR pe.cmdline LIKE '%.well-known/openid-configuration%'\n      OR pe.cmdline\
    \ LIKE 'wget --no-check-certificate https://github.com/%'\n      OR pe.cmdline\
    \ LIKE 'curl -sL wttr.in%'\n      OR p1_cmd LIKE '%brew.rb%'\n      OR p1_cmd\
    \ LIKE '%brew.sh%'\n    )\n  )\n  AND NOT (\n    pe.euid > 500\n    AND pe.cmdline\
    \ LIKE '%/api'\n    AND pe.cmdline NOT LIKE '%-o%'\n    AND pe.cmdline NOT LIKE\
    \ '%-O%'\n  )\n  -- These are typically curl -k calls\n  -- We need the addr \"\
    IS NOT NULL\" to avoid filtering out\n  -- NULL entries\n  AND NOT (\n    addr\
    \ IS NOT NULL\n    AND (\n      addr IN (\n        'releases.hashicorp.com',\n\
    \        'github.com',\n        'cdn.zoom.us',\n        'dl.enforce.dev'\n   \
    \   )\n      -- Ignore local addresses (Docker development)\n      OR addr NOT\
    \ LIKE '%.%'\n      OR ip LIKE '172.2%'\n      OR ip LIKE '192.168.%'\n      OR\
    \ ip LIKE '127.%'\n      OR ip LIKE '10.%'\n    )\n  )\n  AND NOT p1_cmd LIKE\
    \ '/usr/bin/bash /usr/bin/makepkg %'\n"
  tags: transient, process, events
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Suspicious URL requests by built-in fetching tools (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - sketchy-fetcher
  observer_can_run: false
  platforms: posix
  query: |
    -- Suspicious URL requests by built-in fetching tools (state-based)
    --
    -- refs:
    --   * https://attack.mitre.org/techniques/T1105/ (Ingress Tool Transfer)
    --   * https://attack.mitre.org/techniques/T1571/ (Non-Standard Port)
    --
    -- tags: transient process state
    -- platform: posix
    SELECT
      REGEX_MATCH (p0.cmdline, '(\w+:\/\/.*)\b', 1) AS url,
      REGEX_MATCH (p0.cmdline, '//(\d+\.\d+\.\d+\.\d+)[:/]', 1) AS ip,
      REGEX_MATCH (p0.cmdline, ':(\d+)', 1) AS port,
      REGEX_MATCH (p0.cmdline, '//([\w\-\.]+)[:/]', 1) AS addr,
      REGEX_MATCH (p0.cmdline, '//[\w\-\.]+\.(\w+)[:/]', 1) AS tld,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      -- NOTE: Sync remaining portion with sketchy-fetcher-events
      (
        INSTR(p0.cmdline, 'wget ') > 0
        OR INSTR(p0.cmdline, 'curl ') > 0
      )
      -- Sketchy fetcher events always seem to contain a switch
      AND p0.cmdline LIKE '%-%'
      AND p0.cmdline LIKE '%/%'
      AND (
        ip NOT IN ('', '127.0.0.1', '::1')
        OR port != ''
        OR tld NOT IN (
          '',
          'app',
          'ca',
          'cloud',
          'com',
          'de',
          'dev',
          'edu',
          'fun',
          'gov',
          'io',
          'md',
          'mil',
          'net',
          'org',
          'se',
          'sh',
          'so',
          'uk'
        )
        OR p0.cmdline LIKE '%chmod%'
        OR p0.cmdline LIKE '%.onion%'
        OR p0.cmdline LIKE '%tor2web%'
        OR p0.cmdline LIKE '%aliyun%'
        OR p0.cmdline LIKE '%pastebin%'
        OR p0.cmdline LIKE '%curl %--user-agent%'
        OR p0.cmdline LIKE '%curl -k%'
        OR p0.cmdline LIKE '%curl -sL %'
        OR p0.cmdline LIKE '%curl%-o-%'
        OR p0.cmdline LIKE '%curl%--insecure%'
        OR p0.cmdline LIKE '%wget %--user-agent%'
        OR p0.cmdline LIKE '%wget %--no-check-certificate%'
        OR p0.cmdline LIKE '%curl%--connect-timeout%'
        OR p0.cmdline LIKE '%wget -nc%'
        OR p0.cmdline LIKE '%wget -t%'
        OR p0.cmdline LIKE '%wget -q%'
        OR (
          p0.cmdline LIKE '%wget %'
          AND p0.euid < 500
          -- TODO: Update this query to understand containers
          AND p1.path NOT IN (
            "/usr/bin/bwrap",
            "/bin/busybox",
            "/usr/bin/melange"
          )
        )
        OR (
          p0.cmdline LIKE '%curl %'
          AND p0.euid < 500
          AND p0.cmdline NOT LIKE "%./configure %--with-curl%"
        )
      )
      -- Exceptions for all calls
      AND p1.name NOT IN ('makepkg') -- Exceptions for non-privileged calls
      AND NOT (
        p0.euid > 500
        AND (
          p0.cmdline LIKE '%--dump-header%'
          OR p0.cmdline LIKE '%/api/v%'
          OR p0.cmdline LIKE '%curl -X %'
          OR p0.cmdline LIKE '%go mod %'
          OR p0.cmdline LIKE '%application/json%'
          OR p0.cmdline LIKE '%grpcurl%'
          OR p0.cmdline LIKE '%Homebrew%'
          OR p0.cmdline LIKE '%Nixpkgs/%'
          OR p0.cmdline LIKE '%If-None-Match%'
          OR p0.cmdline LIKE '%ctlog%'
          OR p0.cmdline LIKE '%.well-known/openid-configuration%'
          OR p0.cmdline LIKE '%/openid/v1/jwks%'
          OR p0.cmdline LIKE '%--progress-bar%'
          OR p1.cmdline LIKE '%brew.rb%'
          OR p1.cmdline LIKE '%brew.sh%'
          OR p1.cmdline LIKE '/nix/store/%-builder.sh'
          OR p0.cmdline LIKE 'git %'
          OR p0.cmdline LIKE '%LICENSES/vendor/%'
          OR p0.cmdline LIKE 'curl -sL wttr.in%'
          OR p0.cmdline LIKE '%localhost:%'
          OR p0.cmdline LIKE '%127.0.0.1:%'
          OR p0.name IN ('apko')
        )
      )
      -- These are typically curl -k calls
      -- We need the addr "IS NOT NULL" to avoid filtering out
      -- NULL entries
      AND NOT (
        addr IS NOT NULL
        AND (
          addr IN (
            'releases.hashicorp.com',
            'github.com',
            'dl.enforce.dev'
          )
          -- Ignore local addresses (Docker development)
          OR addr NOT LIKE '%.%'
          OR ip LIKE '172.21.%'
          OR ip LIKE '192.168.%'
        )
      )
      -- Qualys Cloud Agent
      AND NOT (
        addr = "169.254.169.254"
        AND p2.path = "/usr/local/qualys/cloud-agent/bin/qualys-scan-util"
      )
      -- Elastic Agent
      AND NOT p0.path LIKE '/Library/Elastic/Agent/%'
      AND NOt p0.cmdline LIKE '%/osqueryd %'
  tags: transient, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unusually small programs (events-based)
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - tiny-executable-events
  observer_can_run: false
  platforms: ''
  query: |
    -- Unusually small programs (events-based)
    --
    -- references:
    --   * https://cybersecurity.att.com/blogs/labs-research/shikitega-new-stealthy-malware-targeting-linux
    --
    -- interval: 300
    -- tags: transient process events
    SELECT
      p.pid,
      p.path,
      p.cmdline,
      file.size,
      p.time,
      file.type,
      p.mode,
      p.cwd,
      p.euid,
      p.parent,
      p.syscall,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.euid AS parent_euid,
      hash.sha256 AS child_sha256,
      phash.sha256 AS parent_sha256,
      magic.data AS magic
    FROM
      process_events p
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash phash ON pp.path = phash.path
      LEFT JOIN magic ON p.path = magic.path
    WHERE
      p.time > (strftime('%s', 'now') -300)
      AND file.size > 0
      AND file.size < 10000
      AND file.type = 'regular'
      AND p.cwd != ""
      AND p.cwd IS NOT NULL
      AND p.path NOT LIKE '%.sh'
      AND p.path NOT LIKE '%.py'
      AND p.path NOT LIKE '%.rb'
      AND p.path NOT IN (
        '/sbin/ldconfig',
        '/usr/sbin/ldconfig',
        '/usr/bin/c_rehash',
        '/usr/sbin/update-ca-certificates'
      )
      AND NOT (
        p.path LIKE '/Users/%'
        AND magic.data LIKE 'POSIX shell script%'
      )
      AND p.path NOT LIKE '/private/var/folders/%/T/iTerm2-scrip%sh'
      AND p.path NOT LIKE '/home/%/.local/share/Steam/%'
      AND p.path NOT LIKE '%/openoffice%/program/pagein'
      -- Removes a false-positive we've seen on Linux, generated through 'runc init'
      AND NOT (
        p.path = "/"
        AND file.size < 8192
      )
  tags: transient, process, events
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unusually small programs (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - tiny-executable
  observer_can_run: false
  platforms: ''
  query: |
    -- Unusually small programs (state-based)
    --
    -- references:
    --   * https://cybersecurity.att.com/blogs/labs-research/shikitega-new-stealthy-malware-targeting-linux
    --
    -- tags: transient process state
    SELECT
      p.pid,
      p.path,
      p.cmdline,
      file.size,
      p.start_time,
      file.mode,
      file.type,
      p.cwd,
      p.euid,
      p.parent,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.euid AS parent_euid,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON pp.path = hash.path
    WHERE
      file.size > 0
      AND file.size < 10000
      AND NOT file.path LIKE '/Users/%/.zsh/completion'
      AND NOT file.path LIKE '/home/%/.zsh/completion'
      AND NOT file.path LIKE '/home/%/.local/share/Steam/ubuntu%'
      AND NOT file.path LIKE '/home/%/.local/share/Steam/steamapps/%'
      AND NOT file.path IN ('/', '/usr/bin/ruby')
  tags: transient, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Things that call chmod to set executable permissions
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-chmod-exec-event-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Things that call chmod to set executable permissions
    --
    -- references:
    --   * https://www.microsoft.com/en-us/security/blog/2022/05/19/rise-in-xorddos-a-deeper-look-at-the-stealthy-ddos-malware-targeting-linux-devices/
    --
    -- false positives:
    --   * loads of them
    --
    -- tags: transient process events
    -- platform: linux
    -- interval: 300
    SELECT
      IFNULL(
        REGEX_MATCH (TRIM(pe.cmdline), '.* (/.*)', 1),
        CONCAT (
          pe.cwd,
          '/',
          REGEX_MATCH (TRIM(pe.cmdline), '.* (.*)', 1)
        )
      ) AS f_path,
      f.mode AS f_mode,
      f.type AS f_type,
      hash.sha256 AS f_hash,
      magic.data AS f_magic,
      -- Child
      pe.path AS p0_path,
      COALESCE(REGEX_MATCH (pe.path, '.*/(.*)', 1), pe.path) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Wow, you can do that?
      LEFT JOIN file f ON IFNULL(
        REGEX_MATCH (TRIM(pe.cmdline), '.* (/.*)', 1),
        CONCAT (
          pe.cwd,
          '/',
          REGEX_MATCH (TRIM(pe.cmdline), '.* (.*)', 1)
        )
      ) = f.path
      LEFT JOIN hash ON f.path = hash.path
      LEFT JOIN magic ON f.path = magic.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.pid IN (
        SELECT DISTINCT
          pid
        FROM
          process_events
        WHERE
          time > (strftime('%s', 'now') -300)
          AND syscall = "execve"
          AND (
            cmdline LIKE '%chmod% 7%'
            OR cmdline LIKE '%chmod% +rwx%'
            OR cmdline LIKE '%chmod% +x%'
            OR cmdline LIKE '%chmod% u+x%'
            OR cmdline LIKE '%chmod% a+x%'
          )
          AND cmdline NOT LIKE 'chmod 777 /app/%'
          AND cmdline NOT LIKE 'chmod 700 /tmp/apt-key-gpghome.%'
          AND cmdline NOT LIKE 'chmod 700 /home/%/snap/%/%/.config'
          AND cmdline NOT LIKE 'chmod +x /home/%/bin/%'
      )
      AND pe.time > (strftime('%s', 'now') -300)
      AND pe.syscall = "execve"
      AND f.type != 'directory'
      AND p1_cgroup NOT LIKE '/system.slice/docker-%'
      AND p1_cgroup NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
      AND p2_cgroup NOT LIKE '/system.slice/docker-%'
      AND p2_cgroup NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
    GROUP BY
      p0_pid
  tags: transient, process, events
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Things that call chmod to set executable permissions
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-chmod-exec-event-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Things that call chmod to set executable permissions
    --
    -- references:
    --   * https://www.microsoft.com/en-us/security/blog/2022/05/19/rise-in-xorddos-a-deeper-look-at-the-stealthy-ddos-malware-targeting-linux-devices/
    --
    -- false positives:
    --   * loads of them
    --
    -- tags: transient process events
    -- platform: darwin
    -- interval: 300
    SELECT
      IFNULL(
        REGEX_MATCH (TRIM(pe.cmdline), '.* (/.*)', 1),
        CONCAT (
          pe.cwd,
          '/',
          REGEX_MATCH (TRIM(pe.cmdline), '.* (.*)', 1)
        )
      ) AS f_path,
      f.mode AS f_mode,
      f.type AS f_type,
      hash.sha256 AS f_hash,
      magic.data AS f_magic,
      -- Child
      pe.path AS p0_path,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Wow, you can do that?
      LEFT JOIN file f ON IFNULL(
        REGEX_MATCH (TRIM(pe.cmdline), '.* (/.*)', 1),
        CONCAT (
          pe.cwd,
          '/',
          REGEX_MATCH (TRIM(pe.cmdline), '.* (.*)', 1)
        )
      ) = f.path
      LEFT JOIN hash ON f.path = hash.path
      LEFT JOIN magic ON f.path = magic.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.pid IN (
        SELECT DISTINCT
          pid
        FROM
          process_events
        WHERE
          time > (strftime('%s', 'now') -300)
          AND status = 0
          AND parent > 0
          AND (
            cmdline LIKE '%chmod% 7%'
            OR cmdline LIKE '%chmod% +rwx%'
            OR cmdline LIKE '%chmod% +x%'
            OR cmdline LIKE '%chmod% u+x%'
            OR cmdline LIKE '%chmod% a+x%'
          )
          AND cmdline != 'chmod 0777 /Users/Shared/logitune'
      )
      AND pe.time > (strftime('%s', 'now') -300)
      AND pe.syscall = "execve"
      AND f.type != 'directory'
    GROUP BY
      p0_pid
  tags: transient, process, events
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Applications setting environment variables to bypass security protections
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-env-values-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Applications setting environment variables to bypass security protections
    --
    -- Inpsired by BPFdoor and other intrusions
    -- https://www.sandflysecurity.com/blog/compromised-linux-cheat-sheet/
    --
    -- WARNING: This query is known to require a higher than average wall time.
    --
    -- tags: transient state
    -- interval: 300
    -- platform: linux
    SELECT
      pe.key,
      pe.value,
      LENGTH(pe.value) AS value_len,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      -- Querying processes first and filtering by time gives a massive 20X speed improvement
      -- over querying process_envs first and JOIN'ing against processes
      processes p0
      JOIN process_envs pe ON p0.pid = pe.pid
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE -- This time should match the interval
      p0.start_time > (strftime('%s', 'now') - 300)
      AND (
        pe.key = 'HISTFILE'
        AND NOT pe.value LIKE '/home/%/.%_history'
        AND NOT pe.value LIKE '~/.%_history'
        AND NOT pe.value LIKE '%/.histfile'
      )
      OR (
        pe.key = 'LD_PRELOAD'
        AND NOT pe.value = ''
        AND NOT p0.path LIKE '%/firefox'
        AND NOT pe.value IN (
          'libfakeroot.so',
          '/usr/local/lib/libmimalloc.so',
          '/opt/splunkforwarder/lib/libdlwrapper.so',
          '/usr/lib/libjemalloc.so'
        )
        AND NOT pe.value LIKE ':/home/%/.local/share/Steam'
        AND NOT pe.value LIKE ':/home/%/.var/app/com.valvesoftware.Steam/%'
        AND NOT pe.value LIKE ':/home/%/.local/share/Steam/ubuntu%/gameoverlayrenderer.so:/home/%/.local/share/Steam/ubuntu%/gameoverlayrenderer.so'
        AND NOT pe.value LIKE ':/snap/%'
        AND NOT pe.value LIKE '/app/bin/%'
        AND NOT pe.value LIKE 'libmozsandbox.so%'
        AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
      )
      -- setuid
      OR (
        LENGTH(pe.value) > 1024
        AND pe.key != 'LS_COLORS'
        AND f.mode IS NOT NULL
        AND f.mode NOT LIKE '0%'
      )
  tags: transient, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Applications setting environment variables to bypass security protections
  discard_data: false
  interval: 60
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-env-values-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Applications setting environment variables to bypass security protections
    --
    -- Inpsired by BPFdoor and other intrusions
    -- https://www.sandflysecurity.com/blog/compromised-linux-cheat-sheet/
    --
    -- WARNING: This query is known to require a higher than average wall time.
    --
    -- interval: 60
    -- platform: darwin
    SELECT
      key,
      value,
      p.pid,
      p.path,
      p.cwd,
      p.cmdline,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd
      -- Querying processes first and filtering by time gives a massive 20X speed improvement
      -- over querying process_envs first and JOIN'ing against processes
    FROM
      processes p
      LEFT JOIN process_envs pe ON p.pid = pe.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
    WHERE -- This time should match the interval
      p.start_time > (strftime('%s', 'now') - 60)
      AND (
        key = 'HISTFILE'
        AND NOT VALUE LIKE '/Users/%/.%_history'
      )
      OR (
        key = 'LD_PRELOAD'
        AND NOT p.path LIKE '%/firefox'
        AND NOT pe.value = 'libfakeroot.so'
        AND NOT pe.value LIKE 'libmozsandbox.so%'
        AND NOT pe.value LIKE ':/snap/%' -- Yes, on macOS (emote)
      )
      OR (
        key = 'DYLD_INSERT_LIBRARIES' -- actively exploited on programs which disable library security
        AND NOT pe.value = '/System/Library/PrivateFrameworks/PreviewsInjection.framework/PreviewsInjection'
        AND NOT pe.value LIKE '/opt/homebrew/Cellar/r/4.%/lib/R/lib/libR.dylib'
        AND NOT pe.value LIKE '%/libsamply_mac_preload.dylib'
        AND NOT pe.value LIKE '%/Steam/Steam.AppBundle/Steam/Contents/MacOS/steamloader.dylib:%/Steam/Steam.AppBundle/Steam/Contents/MacOS/gameoverlayrenderer.dylib'
        AND NOT pe.value LIKE '%/libtrace.dylib'
      )
      OR (
        key = 'DYLD_FRAMEWORK_PATH' -- sort of obsolete, but may affect SIP abusers
        AND NOT pe.value LIKE '%/IDLE.app/%'
        AND NOT pe.value = '/System/Library/Frameworks'
      )
  tags: ''
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Catch applications running from unusual directories, such as /tmp (event-based)
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-execdir-events-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Catch applications running from unusual directories, such as /tmp (event-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1074/
    --
    -- false positives:
    --   * programs running in alternative namespaces (Docker)
    --
    -- interval: 300
    -- platform: linux
    -- tags: process events
    SELECT -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p1.euid, pe1.euid) AS p1_euid,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = pe.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.pid IN (
        SELECT
          pid
        FROM
          process_events
        WHERE
          time > (strftime('%s', 'now') -300)
          AND (
            INSTR(path, "/bin") != 1
            AND INSTR(path, "/sbin/") != 1
            AND INSTR(path, "/usr/bin/") != 1
            AND INSTR(path, "/usr/lib/") != 1
            AND INSTR(path, "/usr/lib64/") != 1
            AND INSTR(path, "/usr/libexec") != 1
            AND INSTR(path, "/usr/sbin/") != 1
            AND INSTR(path, "/home/") != 1
            AND INSTR(path, "/nix/") != 1
            AND INSTR(path, "/opt/") != 1
            AND INSTR(path, "/snap/") != 1
            AND INSTR(path, "/var/kolide-k2/") != 1
            AND INSTR(path, "/var/lib/snapd/") != 1
            AND INSTR(path, "/usr/share/spotify") != 1
            AND INSTR(path, "/usr/share/code/") != 1
            AND INSTR(path, "/usr/local/") != 1
            AND INSTR(path, "/tmp/go-build") != 1
            AND INSTR(path, "/app/") != 1
            AND INSTR(path, "/ko-app") != 1
            AND INSTR(path, "/usr/share/teams/") != 1
            AND INSTR(path, "/.terraform/") > 0
          )
          AND syscall = "execve" -- REGEX_MATCH performed terribly. INSTR and LIKE are very very close.
        GROUP BY
          path
      )
      AND pe.time > (strftime('%s', 'now') -300)
      AND pe.syscall = "execve"
      AND p.cgroup_path NOT LIKE '/system.slice/docker-%'
      AND p.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
      AND p1.cgroup_path NOT LIKE '/system.slice/docker-%'
      AND p1.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
    GROUP BY
      pe.pid
  tags: process, events
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Catch applications running from unusual directories, such as /tmp
  discard_data: false
  interval: 240
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-execdir-events-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Catch applications running from unusual directories, such as /tmp
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1074/
    --
    -- false positives:
    --   * software installers and updaters
    --   * developers running programs out of /tmp
    --
    -- interval: 240
    -- platform: darwin
    -- tags: filesystem events extra
    SELECT
      COALESCE(
        REGEX_MATCH (REPLACE(pe.path, u.directory, '~'), '(.*)/', 1),
        pe.path
      ) AS dir,
      COALESCE(
        REGEX_MATCH (
          REPLACE(pe.path, u.directory, '~'),
          '(~*/.*?)/',
          1
        ),
        REPLACE(pe.path, u.directory, '~'),
        '(.*)/',
        1
      ) AS top1_dir,
      COALESCE(
        REGEX_MATCH (
          REPLACE(pe.path, u.directory, '~'),
          '(~*/.*?/.*?/.*?)/',
          1
        ),
        REPLACE(pe.path, u.directory, '~'),
        '(.*)/',
        1
      ) AS top3_dir,
      s.identifier AS s_id,
      s.authority AS s_auth,
      -- Child
      pe.path AS p0_path,
      COALESCE(REGEX_MATCH (pe.path, '.*/(.*)', 1), pe.path) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.time AS p0_time,
      -- pe.cwd is NULL on macOS
      p.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      p1.cwd AS p1_cwd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      p1_p2.cwd AS p2_cwd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN file f ON pe.path = f.path
      LEFT JOIN signature S ON pe.path = s.path
      LEFT JOIN users u ON pe.uid = u.uid
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -240)
      AND pe.status = 0
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND top1_dir NOT IN (
        '~/Applications',
        '/Applications',
        '~/Applications (Parallels)',
        '~/bin',
        '~/.cargo',
        '~/melange',
        '~/chainctl',
        '~/chainguard',
        '~/anaconda3',
        '~/dev',
        '~/code',
        '~/Code',
        '~/.vscode-insiders',
        '~/.config',
        '~/.gimme',
        '~/git',
        '~/github',
        '~/go',
        '~/google-cloud-sdk',
        '~/.gradle',
        '~/homebrew',
        '~/.kuberlr',
        --  '~/Library',
        '~/.local',
        '/nix',
        '~/Parallels',
        '~/proj',
        '~/projects',
        '~/Projects',
        '~/workspace',
        '~/.provisio',
        '~/.pulumi',
        '~/.pyenv',
        '~/.rustup',
        '~/src',
        '~/.steampipe',
        '/System',
        '~/.tflint.d',
        '~/.vscode',
        '~/.vs-kubernetes'
      )
      AND top3_dir NOT IN (
        '~/.docker/cli-plugins',
        '~/.docker/cli-plugins/docker-sbom',
        '/Library/Apple/System',
        '/Library/Application Support/AdGuard Software',
        '/Library/Application Support/Adobe',
        '/Library/Application Support/Blackmagic Design',
        '~/Library/Application Support/Box',
        '~/Library/Application Support/BraveSoftware',
        '/Library/Application Support/Canon_Inc_IC',
        '~/Library/Application Support/CleanMyMac X',
        '~/Library/Application Support/Code',
        '/Library/Application Support/com.canonical.multipass',
        '~/Library/Application Support/com.elgato.StreamDeck',
        '~/Library/Application Support/com.grammarly.ProjectLlama',
        '/Library/Application Support/EcammLive',
        '/Library/Application Support/Fortinet',
        '~/Library/Application Support/Foxit Software',
        '/Library/Application Support/GPGTools',
        '~/Library/Application Support/InstantView',
        '~/Library/Application Support/JetBrains',
        '~/Library/Application Support/LogMeInInc',
        '~/Library/Application Support/minecraft',
        '~/Library/Application Support/OpenLens',
        '/Library/Application Support/org.pqrs',
        '~/Library/Application Support/Steam',
        '~/Library/Application Support/zoom.us',
        '~/Library/Caches/com.knollsoft.Rectangle',
        '~/Library/Caches/com.mimestream.Mimestream',
        '~/Library/Caches/Cypress',
        '~/Library/Caches/dagger',
        '~/Library/Caches/JetBrains',
        '~/Library/Caches/snyk',
        '/Library/Developer/CommandLineTools',
        '~/Library/Developer/Xcode',
        '/Library/Elastic/Agent',
        '/Library/Frameworks/Python.framework',
        '/Library/Google/GoogleSoftwareUpdate',
        '~/Library/Google/GoogleSoftwareUpdate',
        '/Library/Java/JavaVirtualMachines',
        '/Library/Plug-Ins/FxPlug',
        '/Library/Printers/Brother',
        '/Library/Printers/Canon',
        '/Library/Screen Savers/XScreenSaverUpdater.app',
        '~/Library/Services/UE4EditorServices.app',
        '/opt/Elastic/Endpoint',
        '/opt/homebrew/Caskroom',
        '/opt/homebrew/Cellar',
        '/opt/homebrew/Library',
        '/opt/rapid7/ir_agent',
        '/private/tmp/golangci-lint',
        '/private/var/kolide-k2',
        '~/syft/.tool/binny',
        '/usr/libexec/AssetCache',
        '/usr/libexec/rosetta',
        '/usr/local/Cellar',
        '/usr/local/crc',
        '/usr/local/kolide-k2',
        '/Volumes/Google Chrome/Google Chrome.app',
        '/Volumes/Slack/Slack.app',
        '~/.wdm/drivers/chromedriver'
      )
      AND dir NOT IN (
        '/bin',
        '~/bin',
        '~/.cache/gitstatus',
        '~/code/bin',
        '~/.docker/cli-plugins',
        '~/Downloads/google-cloud-sdk/bin',
        '~/Downloads/protoc/bin',
        '~/go/bin',
        '~/Library/Application Support/Alfred/Assistant',
        '~/Library/Application Support/cloud-code/installer/google-cloud-sdk/bin',
        '~/Library/Application Support/dev.warp.Warp-Stable',
        '/Library/Application Support/Fortinet/FortiClient/bin',
        '/Library/Application Support/Kandji/Kandji Menu/Kandji Menu.app/Contents/MacOS',
        '/Library/Application Support/Logitech.localized/LogiOptionsPlus/logioptionsplus_agent.app/Contents/MacOS',
        '/Library/Application Support/Logitech.localized/Logitech Options.localized/LogiMgrUpdater.app/Contents/Resources',
        '~/Library/Application Support/minecraft/launcher/launcher.bundle/Contents/Frameworks/launcher-Helper (GPU).app/Contents/MacOS',
        '~/Library/Application Support/snyk-ls',
        '/Library/Application Support/X-Rite/Frameworks/XRiteDevice.framework/Versions/B/Resources/XRD Software Update.app/Contents/MacOS',
        '/Library/Audio/Plug-Ins/HAL/ACE.driver/Contents/Resources',
        '/Library/Audio/Plug-Ins/HAL/ACE.driver/Contents/Resources/aceagent.app/Contents/MacOS',
        '/Library/Audio/Plug-Ins/HAL/SolsticeDesktopSpeakers.driver/Contents/XPCServices/RelayXpc.xpc/Contents/MacOS',
        '/Library/DropboxHelperTools/Dropbox_u501',
        '/Library/Filesystems/kbfuse.fs/Contents/Resources',
        '/Library/Filesystems/macfuse.fs/Contents/Resources',
        '/Library/Frameworks/Python.framework/Versions/3.10/bin',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers.app/Contents/MacOS',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateAgent.app/Contents/MacOS',
        '/Library/Image Capture/Devices/EPSON Scanner.app/Contents/MacOS',
        '/Library/Kandji/Kandji Agent.app/Contents/MacOS',
        '/Library/Kandji/Kandji Agent.app/Contents/MacOS/',
        '/Library/Printers/Brother/Filter/rastertobrother2130.bundle/Contents/MacOS',
        '/Library/Printers/Brother/Filter/rastertobrother2300.bundle/Contents/MacOS',
        '/Library/Printers/Brother/Utilities/Server/LOGINserver.app/Contents/MacOS',
        '/Library/Printers/Brother/Utilities/Server/NETserver.app/Contents/MacOS',
        '/Library/Printers/Brother/Utilities/Server/USBAppControl.app/Contents/MacOS',
        '/Library/Printers/Brother/Utilities/Server/WorkflowAppControl.app/Contents/MacOS',
        '/Library/Printers/DYMO/Utilities',
        '/Library/Printers/EPSON/InkjetPrinter2/Filter/commandtoescp.app/Contents/MacOS',
        '/Library/PrivilegedHelperTools',
        '/Library/TeX/texbin',
        '~/.local/bin',
        '~/.magefile',
        '~/melange',
        '/node_modules/.bin',
        '/opt/custom-cli-tools',
        '/opt/homebrew/bin',
        '/opt/osquery/lib/osquery.app/Contents/MacOS',
        '/opt/usr/bin',
        '/opt/X11/bin',
        '/opt/X11/libexec',
        '~/projects/go/bin',
        '/run/current-system/sw/bin',
        '/sbin',
        '/tmp/bin',
        '/usr/bin',
        '/usr/lib',
        '/usr/lib/bluetooth',
        '/usr/lib/cups/notifier',
        '/usr/libexec',
        '/usr/libexec/ApplicationFirewall',
        '/usr/libexec/AssetCache',
        '/usr/libexec/cups/backend',
        '/usr/libexec/firmwarecheckers',
        '/usr/libexec/firmwarecheckers/eficheck',
        '/usr/libexec/rosetta',
        '/usr/lib/fwupd',
        '/usr/lib/ibus',
        '/usr/lib/system',
        '/usr/local/aws-cli',
        '/usr/local/bin',
        '/usr/local/MacGPG2/bin',
        '/usr/sbin',
        '/Volumes/Grammarly/Grammarly Installer.app/Contents/MacOS'
      ) -- Locally built executables
      AND NOT (
        s.identifier = 'a.out'
        AND (
          dir LIKE '~/%'
          OR dir LIKE '/Users/%'
        )
        AND p1_name IN ('fish', 'sh', 'bash', 'zsh', 'terraform', 'code')
      )
      AND NOT (
        s.authority = ''
        AND dir LIKE '~/%'
        AND p1_name IN ('fish', 'sh', 'bash', 'zsh')
        AND p.cmdline LIKE './%'
      ) -- Spotify
      AND pe.path NOT LIKE '/private/var/folders/%/T/sp_relauncher' -- Sparkle updater
      AND pe.path NOT LIKE '/private/tmp%/cloud_sql_proxy'
      AND pe.path NOT LIKE '/Users/%/Library/Caches/%/org.sparkle-project.Sparkle/Launcher/%/Updater.app/Contents/MacOS/Updater'
      AND dir NOT LIKE '/Applications/%'
      AND dir NOT LIKE '~/%/bin'
      AND dir NOT LIKE '~/Downloads/%.app/Contents/MacOS'
      AND dir NOT LIKE '~/Documents/%/build/%'
      AND dir NOT LIKE '~/Documents/%/target/%'
      AND dir NOT LIKE '~/%/google-cloud-sdk/bin/%'
      AND dir NOT LIKE '~/Library/Caches/ms-playwright/%'
      AND dir NOT LIKE '~/Library/Printers/%/Contents/MacOS'
      AND dir NOT LIKE '/Library/SystemExtensions/%-%/%.systemextension/Contents/MacOS'
      AND dir NOT LIKE '~/.local/%/packages/%'
      AND dir NOT LIKE '~/%/node_modules/%'
      AND dir NOT LIKE '/opt/%/bin'
      AND dir NOT LIKE '/private/tmp/%.app/Contents/MacOS'
      AND dir NOT LIKE '/private/tmp/go-build%/exe'
      AND dir NOT LIKE '%/go/bin'
      AND dir NOT LIKE '/private/tmp/KSInstallAction.%/Install Google Software Update.app/Contents/Helpers'
      AND dir NOT LIKE '/private/tmp/nix-build-%'
      AND dir NOT LIKE '/private/var/folders/%/T/cargo-install%'
      AND dir NOT LIKE '/private/tmp/PKInstallSandbox.%/Scripts/com.microsoft.OneDrive.%'
      AND dir NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%.xpc/Contents/MacOS'
      AND dir NOT LIKE '/private/var/folders/%/bin'
      AND dir NOT LIKE '/private/var/folders/%/Contents/%'
      AND dir NOT LIKE '/private/var/folders/%/d/Wrapper/%.app%'
      AND dir NOT LIKE '/private/var/folders/%/go-build%'
      AND dir NOT LIKE '/private/var/folders/%/GoLand'
      AND dir NOT LIKE '/private/var/kolide-k2/k2device.kolide.com/updates/osqueryd/%'
      AND dir NOT LIKE '~/%repo%' -- When running code as root
      AND dir NOT LIKE '~/%sigstore%'
      AND dir NOT LIKE '%/.terraform/providers/%'
      AND dir NOT LIKE '~/Library/Arduino%/packages/%'
      AND dir NOT LIKE '/Volumes/com.getdropbox.dropbox-%' -- These signers can run from wherever the hell they want.
      AND s.identifier != 'org.sparkle-project.Sparkle.Autoupdate'
      AND s.authority NOT IN (
        'Apple iPhone OS Application Signing',
        'Apple Mac OS Application Signing',
        'Developer ID Application: Azul Systems, Inc. (TDTHCUPYFR)',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Rogue Amoeba Software, LLC (7266XEXAPM)',
        'Developer ID Application: Brother Industries, LTD. (5HCL85FLGW)',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59)',
        'Developer ID Application: Cisco (DE8Y96K9QP)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',
        'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',
        'Developer ID Application: Canon Inc. (XE2XNRRXZ5)',
        'Developer ID Application: SILICON MOTION, INC. (JAGYSS7E9A)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: Silicon Laboratories Inc (52444FG85C)',
        'Developer ID Application: Epic Games International, S.a.r.l. (96DBZ92D3Y)',
        'Developer ID Application: Figma, Inc. (T8RA8NE3B7)',
        'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK)',
        'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Hashicorp, Inc. (D38WU7D763)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: LG Electronics (5SKT5H4CPQ)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: MacPaw Inc. (S8EX82NJP6)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Mojang AB (HR992ZEAE6)',
        'Developer ID Application: Ned Deily (DJ3H93M7VJ)',
        'Developer ID Application: Node.js Foundation (HX7739G8FX)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        'Developer ID Application: reMarkable AS (4FFUD2H2F6)',
        'Developer ID Application: Snyk Limited (97QYW7LHSF)',
        'Developer ID Application: Sublime HQ Pty Ltd (Z6D26JE4Y4)',
        'Developer ID Application: TablePlus Inc (3X57WP8E8V)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Developer ID Application: Valve Corporation (MXGJJ98X76)',
        'Developer ID Application: Wireshark Foundation, Inc. (7Z6EMTD2C6)',
        'Software Signing'
      ) -- Don't spam alerts with repeated invocations of the same command-line
    GROUP BY
      p.cmdline,
      p.cwd,
      p.euid;
  tags: filesystem, events, extra
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Programs running out of unexpected directories, such as /tmp (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-execdir-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Programs running out of unexpected directories, such as /tmp (state-based)
    --
    -- references:
    --   * https://blog.talosintelligence.com/2022/10/alchimist-offensive-framework.html
    --
    -- tags: transient process state
    -- platform: linux
    SELECT
      -- Child
      p0.pid AS p0_pid,
      p0.cgroup_path AS p0_cgroup,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT DISTINCT
          pid
        FROM
          processes
        WHERE
          pid > 1
          AND path != ""
          AND INSTR(path, "/bin") != 1
          AND INSTR(path, "/sbin/") != 1
          AND INSTR(path, "/usr/bin/") != 1
          AND INSTR(path, "/usr/lib/") != 1
          AND INSTR(path, "/usr/lib64/") != 1
          AND INSTR(path, "/usr/libexec") != 1
          AND INSTR(path, "/usr/sbin/") != 1
          AND INSTR(path, "/usr/x86_64-pc-linux-gnu/bin") != 1
          AND INSTR(path, "/home/") != 1
          AND INSTR(path, "/nix/") != 1
          AND INSTR(path, "/opt/") != 1
          AND INSTR(path, "/snap/") != 1
          AND INSTR(path, "/var/lib/snapd/") != 1
          AND INSTR(path, "/var/lib/flatpak") != 1
          AND INSTR(path, "/var/opt/") != 1
          AND INSTR(path, "/var/usrlocal/bin/") != 1
          AND INSTR(path, "/usr/local/kolide-k2/bin/") != 1
          AND INSTR(path, "/var/kolide-k2/") != 1
          AND INSTR(path, "/usr/share/spotify") != 1
          AND INSTR(path, "/usr/share/code/") != 1
          AND INSTR(path, "/var/home/") != 1
          AND INSTR(path, "/usr/local/") != 1
          AND INSTR(path, "/tmp/go-build") != 1
          AND INSTR(path, "/app/") != 1
          AND INSTR(path, "/ko-app") != 1
          AND INSTR(path, "/usr/share/teams/") != 1
          AND path NOT LIKE "%/.terraform%"
          AND path != '/bpfilter_umh'
          AND NOT path LIKE '/tmp/%/osqtool'
          AND NOT path LIKE '/tmp/GoLand/___go_build_%_go'
          AND NOT cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
          AND NOT cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/libpod-%'
          AND NOT cgroup_path LIKE '/system.slice/docker-%' -- Interactive terminal
          AND NOT (
            cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/app-gnome-Alacritty-%.scope'
            AND path LIKE '/tmp/%'
          )
          AND NOT (
            euid > 500
            AND (
              path LIKE '/tmp/terraform_%/terraform'
              OR path LIKE '/tmp/%/output/%'
              OR path LIKE '/tmp/%/_output/%'
              OR path LIKE '/tmp/%/bin/%'
              OR path LIKE '%/.terraform/providers/%'
              OR path LIKE '/tmp/.mount_%'
            )
          )
        GROUP BY
          path
      )
    GROUP BY
      p0.pid
  tags: transient, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find programs running from strange directories on macOS
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-execdir-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find programs running from strange directories on macOS
    --
    -- false positives:
    --   - Vendors who are doing weird things that are not in the signature list
    --
    -- See "execdir-events" for the version that is more likely to catch things
    --
    -- platform: darwin
    -- tags: transient seldom process filesystem state
    SELECT DISTINCT
      COALESCE(REGEX_MATCH (p0.path, '(.*)/', 1), p0.path) AS dir,
      REPLACE(f.directory, u.directory, '~') AS homedir,
      COALESCE(
        REGEX_MATCH (
          REPLACE(f.directory, u.directory, '~'),
          '(~/.*?/.*?/.*?/)',
          1
        ),
        REPLACE(f.directory, u.directory, '~')
      ) AS top3_homedir,
      REGEX_MATCH (
        REPLACE(f.directory, u.directory, '~'),
        '(~/.*?/)',
        1
      ) AS top_homedir,
      s.authority AS p0_auth,
      s.identifier AS p0_id,
      -- Child
      p0.pid AS p0_pid,
      p0.start_time AS p0_start,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.start_time AS p1_start,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN users u ON p0.uid = u.uid
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          pid > 0
          AND REGEX_MATCH (
            path,
            "^(/System|/usr/libexec/|/usr/sbin/|/usr/bin/|/usr/lib/|/bin/|/Applications|/Library/Apple/|/sbin/|/usr/local/kolide-k2)",
            1
          ) IS NULL
        GROUP BY
          path
      )
      AND NOT dir IN (
        '/Library/Application Support/Logitech.localized/Logitech Options.localized/LogiMgrUpdater.app/Contents/Resources',
        '/Library/DropboxHelperTools/Dropbox_u501',
        '/Library/Filesystems/kbfuse.fs/Contents/Resources',
        '/Library/Frameworks/Python.framework/Versions/3.10/bin',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers.app/Contents/MacOS',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateAgent.app/Contents/MacOS',
        '/Library/Printers/DYMO/Utilities',
        '/Library/Kandji/Kandji Agent.app/Contents/MacOS/',
        '/Library/Application Support/Kandji/Kandji Menu/Kandji Menu.app/Contents/MacOS',
        '/Library/PrivilegedHelperTools',
        '/Library/TeX/texbin',
        '/usr/local/aws-cli',
        '/nix/store',
        '/nix/var/nix/profiles/default/bin',
        '/opt/homebrew/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/bin/gke-gcloud-auth-plugin',
        '/opt/usr/bin',
        '/opt/X11/bin',
        '/opt/X11/libexec',
        '/run/current-system/sw/bin'
      )
      AND NOT homedir IN (
        '~/bin',
        '~/.cache/gitstatus',
        '~/.gvm/binscripts',
        '~/.local/share/gh/extensions/gh-sbom',
        '~/.magefile'
      )
      AND NOT homedir LIKE '~/%/bin'
      AND NOT homedir LIKE '~/Downloads/%.app/Contents/MacOS'
      AND NOT top_homedir IN (
        '~/Applications/',
        '~/Applications (Parallels)/',
        '~/bin/',
        '~/.cargo/',
        '~/code/',
        '~/Code/',
        '~/.config/',
        '~/dev/',
        '~/git/',
        '~/go/',
        '~/google-cloud-sdk/',
        '~/homebrew/',
        '~/.kuberlr/',
        '~/Parallels/',
        '~/proj/',
        '~/projects/',
        '~/.provisio/',
        '~/.pulumi/',
        '~/.pyenv/',
        '~/.rbenv/',
        '~/repos/',
        '~/.rustup/',
        '~/sigstore/',
        '~/src/',
        '~/.steampipe/',
        '~/.supermaven/',
        '~/.tflint.d/',
        '~/.Trash/',
        '~/.vscode/',
        '~/.vs-kubernetes/',
        '~/workspace/'
      )
      AND NOT top3_homedir IN (
        '/Library/Application Support/EcammLive',
        '/Library/Developer/Xcode/',
        '/opt/rapid7/ir_agent',
        '~/.local/share/bob/',
        '~/.local/share/nvim/',
        '~/.terraform.d/plugin-cache/registry.terraform.io/',
        '~/Library/Arduino15/packages/',
        '~/Library/Caches/Cypress/',
        '~/Library/Caches/JetBrains/',
        '~/Library/Caches/com.grammarly.ProjectLlama/',
        '~/Library/Caches/com.mimestream.Mimestream/',
        '~/Library/Caches/com.sempliva.Tiles/',
        '~/Library/Caches/org.gpgtools.updater/',
        '~/Library/Caches/snyk/',
        '~/Library/Services/UE4EditorServices.app/',
        '~/anaconda3/Anaconda-Navigator.app/Contents/'
      )
      AND dir NOT LIKE '/Applications/%'
      AND dir NOT LIKE '/private/tmp/%.app/Contents/MacOS'
      AND dir NOT LIKE '/private/tmp/go-build%/exe'
      AND dir NOT LIKE '/private/tmp/KSInstallAction.%/Install Google Software Update.app/Contents/Helpers'
      AND dir NOT LIKE '/private/tmp/nix-build-%'
      AND dir NOT LIKE '/private/tmp/PKInstallSandbox.%/Scripts/com.microsoft.OneDrive.%'
      AND dir NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%.xpc/Contents/MacOS'
      AND dir NOT LIKE '/private/var/folders/%/bin'
      AND dir NOT LIKE '/private/var/folders/%/Contents/%'
      AND dir NOT LIKE '/private/var/folders/%/d/Wrapper/%.app'
      AND dir NOT LIKE '/private/var/folders/%/go-build%'
      AND dir NOT LIKE '/private/var/folders/%/GoLand'
      AND dir NOT LIKE '%/.terraform/providers/%'
      AND dir NOT LIKE '/Volumes/com.getdropbox.dropbox-%'
      AND homedir NOT LIKE '~/%/google-cloud-sdk/bin/%'
      AND homedir NOT LIKE '~/Library/Caches/ms-playwright/%'
      AND homedir NOT LIKE '~/%/node_modules/%'
      AND homedir NOT LIKE '~/.local/%/packages/%'
      AND homedir NOT LIKE '~/Library/Printers/%/Contents/MacOS'
      AND homedir NOT LIKE '~/Library/Caches/%/org.sparkle-project.Sparkle/Launcher/%/Updater.app/Contents/MacOS'
      AND homedir NOT LIKE '~/Library/Application Support/%'
      AND s.authority NOT IN (
        'Apple iPhone OS Application Signing',
        'Apple Mac OS Application Signing',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Cisco (DE8Y96K9QP)',
        'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: EnterpriseDB Corporation (26QKX55P9K)',
        'Developer ID Application: Epic Games International, S.a.r.l. (96DBZ92D3Y)',
        'Developer ID Application: Figma, Inc. (T8RA8NE3B7)',
        'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Hashicorp, Inc. (D38WU7D763)',
        'Developer ID Application: Hercules Labs Inc. (B8PC799ZGU)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Node.js Foundation (HX7739G8FX)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Sublime HQ Pty Ltd (Z6D26JE4Y4)',
        'Developer ID Application: TablePlus Inc (3X57WP8E8V)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Developer ID Application: Valve Corporation (MXGJJ98X76)',
        'Developer ID Application: Wireshark Foundation, Inc. (7Z6EMTD2C6)',
        'Software Signing'
      ) -- Locally built executables
      AND NOT (
        s.identifier = "a.out"
        AND homedir LIKE '~/%'
        AND p1.name LIKE '%sh'
        AND p2.name = 'login'
        AND p0.path NOT LIKE '%/Cache%'
        AND p0.path NOT LIKE '%/Library/%'
        AND p0.path NOT LIKE '%/.%'
      )
  tags: transient, seldom, process, filesystem, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find processes running that are tied to binaries with unsual permissions.
    Namely, 0777.
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-executable-permissions
  observer_can_run: false
  platforms: posix
  query: |
    -- Find processes running that are tied to binaries with unsual permissions. Namely, 0777.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1222/
    --
    -- false positives:
    --   * poorly written software
    --
    -- platform: posix
    -- tags: persistent filesystem state
    SELECT
      f.mode,
      f.uid,
      f.gid,
      f.ctime,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      f.mode NOT IN (
        '0500',
        '0551',
        '0544',
        '0555',
        '0711',
        '0750',
        '0755',
        '0775',
        '0744',
        '6755',
        '0700',
        '2755',
        '4511',
        '4555',
        '4755'
      )
      -- Vendors who are very relaxed about permissions
      AND NOT (
        f.path IN (
          '/Applications/Camera Settings.app/Contents/MacOS/LogitechCamera',
          '/Applications/motionVFX/Plugins/mUtility.app/Contents/PlugIns/mUtility XPC Service.pluginkit/Contents/MacOS/mUtility XPC Service',
          '/Library/Application Support/Logitech/com.logitech.vc.LogiVCCoreService/LogiVCCoreService.app/Contents/MacOS/LogiVCCoreService'
        )
        AND f.mode = '0777'
        AND f.uid > 500
      )
      AND NOT (
        f.path LIKE '/Users/%/.local/bin/%'
        AND f.mode = '0777'
        AND f.uid > 500
      )
      AND NOT (
        f.path LIKE '/Users/%/Library/Application Support/Code/User/globalStorage/grafana.vscode-jsonnet/bin/jsonnet-language-server'
        AND f.mode = '0777'
        AND f.uid > 500
      )
      AND NOT (
        f.path LIKE '/Users/%/.vscode/extensions/sumneko.lua-%-darwin-arm64/server/bin/lua-language-server'
        AND f.mode = '0777'
        AND f.uid > 500
      )
      AND NOT (
        f.path LIKE '/Users/%/Library/Application Support/Zwift/ZwiftAppMetal'
        AND f.mode = '0777'
        AND f.uid > 500
      )
      AND NOT (
        f.path = '/usr/bin/sudo'
        AND f.mode = '4111'
        AND f.uid = 0
      )
      AND NOT (
        f.path LIKE '/home/%/.local/share/JetBrains/Toolbox/bin/jetbrains-toolbox'
        AND f.mode = '0744'
      )
      AND NOT (
        f.path LIKE '/Users/%/Applications (Parallels)/%.app/Contents/MacOS/WinAppHelper'
        AND f.mode = '0777'
      )
      AND NOT (
        f.path LIKE '/opt/homebrew/Cellar/socket_vmnet/%/bin/socket_vmnet'
        AND f.mode = '1555'
      )
      AND NOT (
        f.path LIKE '/opt/homebrew/Cellar/dnsmasq/%/sbin/dnsmasq'
        AND f.mode = '1555'
      )
      AND NOT (
        f.path LIKE '/Users/%/Library/Application Support/com.raycast.macos/NodeJS/runtime/%/bin/node'
        AND f.mode = '0754'
      )
      AND NOT (
        f.path LIKE '%/Elastic/Agent/data/elastic-agent%/elastic-agent'
        AND f.mode = '0770'
      )
      AND NOT (
        f.path = '/Library/Bitdefender/AVP/product/bin/EndpointSecurityforMac.app/Contents/MacOS/EndpointSecurityforMac'
        AND f.mode = '0655'
      )
      AND NOT (
        p0.name = 'ShortcutDroplet'
        AND f.mode = '0751'
      )
  tags: persistent, filesystem, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Suspicious parenting of fetch tools (event-based)
  discard_data: false
  interval: 450
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-fetcher-parent-events
  observer_can_run: false
  platforms: posix
  query: |
    -- Suspicious parenting of fetch tools (event-based)
    --
    -- refs:
    --   * https://attack.mitre.org/techniques/T1105/ (Ingress Tool Transfer)
    --
    -- tags: transient process state often
    -- platform: posix
    -- interval: 450
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.time AS p0_time,
      pe.euid AS p0_euid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      -- NOTE: The remainder of this query is synced with unexpected-fetcher-parents
      pe.cmdline != ''
      AND pe.time > (strftime('%s', 'now') -450)
      AND p0_name IN ('curl', 'wget', 'ftp', 'tftp')
      AND NOT exception_key IN (
        'curl,0,nm-dispatcher,',
        'curl,500,bash,bash',
        'curl,0,nm-dispatcher,nm-dispatcher',
        'curl,500,bash,nix-daemon',
        'curl,500,bash,ShellLauncher',
        'curl,500,bash,zsh',
        'curl,500,env,env',
        'curl,500,fish,gnome-terminal-',
        'curl,500,bash,yay',
        'curl,500,ruby,zsh',
        'curl,500,ShellLauncher,',
        'curl,500,ShellLauncher,login',
        'curl,500,zsh,login',
        'curl,500,zsh,sh',
        'wget,500,env,env'
      )
      AND NOT (
        pe.euid > 500
        AND p1_name IN ('sh', 'fish', 'zsh', 'bash', 'dash')
        AND p2_name IN (
          'alacritty',
          'gnome-terminal-',
          'kitty',
          'login',
          'roxterm',
          'stable',
          'tmux',
          'tmux:server',
          'wezterm-gui',
          'zsh'
        )
      )
      AND NOT p1_name IN ('yay', 'nvim')
      AND NOT (
        pe.euid > 500
        AND p0_cmd IN ('curl --fail https://ipinfo.io/timezone')
      )
      AND NOT (
        pe.euid > 500
        AND p1_name = 'env'
        AND p1_cmd LIKE '/usr/bin/env -i % HOMEBREW_BREW_FILE=%'
      )
      AND NOT (
        pe.euid > 500
        AND p1_name = 'ruby'
        AND p1_cmd LIKE '%/Homebrew/brew.rb%'
      )
      AND NOT (
        pe.euid > 500
        AND p1_name = 'env'
        AND p1_cmd LIKE '/usr/bin/env bash ./hack/%.sh'
      )
      AND NOT p0_cmd LIKE 'wget --no-check-certificate https://github.com/istio/istio/%'
      AND NOT p0_cmd LIKE '%curl -L https://artifacts.elastic.co/%'
      AND NOT p.cgroup_path LIKE '/system.slice/docker-%'
    GROUP BY
      pe.pid
  tags: transient, process, state, often
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Suspicious parenting of fetch tools (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-fetcher-parents
  observer_can_run: false
  platforms: posix
  query: |
    -- Suspicious parenting of fetch tools (state-based)
    --
    -- refs:
    --   * https://attack.mitre.org/techniques/T1105/ (Ingress Tool Transfer)
    --
    -- tags: transient process state often
    -- platform: posix
    SELECT
      p.pid,
      p.path,
      p.name AS child_name,
      p.cmdline AS cmd,
      p.cwd,
      p.euid,
      p.parent,
      p.cgroup_path,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd,
      pp.euid AS parent_euid,
      gp.name AS gparent_name,
      gp.cmdline AS gparent_cmd,
      pp.pid AS gparent_pid,
      hash.sha256 AS parent_sha256,
      CONCAT (
        p.name,
        ',',
        MIN(p.euid, 500),
        ',',
        pp.name,
        ',',
        gp.name
      ) AS exception_key
    FROM
      processes p
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN processes gp ON pp.parent = gp.pid
      LEFT JOIN hash ON pp.path = hash.path
    WHERE -- NOTE: The remainder of this query is synced with unexpected-fetcher-parent-events
      child_name IN ('curl', 'wget', 'ftp', 'tftp') -- And not a regular local user
      AND NOT exception_key IN (
        'curl,0,09-timezone,nm-dispatcher',
        'curl,0,build.sh,buildkit-runc',
        'curl,0,eos-rankmirrors,eos-rankmirrors',
        'curl,0,nm-dispatcher,',
        'curl,0,nm-dispatcher,nm-dispatcher',
        'curl,0,sh,qualys-cloud-ag',
        'curl,0,sh,qualys-scan-uti',
        'curl,300,bash,nix',
        'curl,301,bash,nix',
        'curl,302,bash,nix',
        'curl,303,bash,nix',
        'curl,500,colima,zsh',
        'curl,305,bash,nix',
        'curl,307,bash,nix',
        'curl,500,make,bash',
        'curl,500,nwg-panel,systemd',
        'curl,500,bash,bash',
        'curl,500,bash,fakeroot',
        'curl,500,bash,fish',
        'curl,500,bash,nix-daemon',
        'curl,500,zsh,Hyper',
        'curl,500,bash,ShellLauncher',
        'curl,500,bash,zsh',
        'curl,500,bash,bash',
        'curl,500,env,env',
        'curl,500,zsh,Emacs-arm64-11',
        'curl,500,eos-connection-,eos-update-noti',
        'curl,500,fish,gnome-terminal-',
        'curl,500,launchd,kernel_task',
        'curl,500,makepkg,yay',
        'curl,500,node-cve-count.,bash',
        'curl,500,nvim,nvim',
        'curl,500,ruby,zsh',
        'curl,500,endpoint-instal,bash',
        'curl,500,ShellLauncher,',
        'curl,500,ShellLauncher,login',
        'curl,500,Slack,launchd',
        'curl,500,Stats,bash',
        'curl,500,zsh,login',
        'curl,500,zsh,sh',
        'wget,500,env,env',
        'wget,500,sh,bwrap',
        'wget,500,zsh,bash'
      )
      AND NOT (
        p.euid > 500
        AND parent_name IN ('sh', 'fish', 'zsh', 'bash', 'dash')
        AND gparent_name IN (
          'alacritty',
          'gnome-terminal-',
          'kitty',
          'login',
          'roxterm',
          'tmux',
          'stable',
          'old',
          'tmux:server',
          'wezterm-gui',
          'zsh'
        )
      )
      AND NOT p.cmdline IN (
        'curl -s -6 https://api.serhiy.io/v1/stats/ip',
        'curl -s -4 https://api.serhiy.io/v1/stats/ip',
        'curl https://wttr.in/?format=1 -s'
      )
      AND NOT parent_name IN ('yay')
      AND NOT p.cmdline LIKE 'curl -s https://support-sp.apple.com/sp/product%'
      AND NOT (
        p.euid > 500
        AND parent_name = 'env'
        AND parent_cmd LIKE '/usr/bin/env -i % HOMEBREW_BREW_FILE=%'
      )
      AND NOT (
        p.euid > 500
        AND parent_name = 'ruby'
        AND parent_cmd LIKE '%/Library/Homebrew/brew.rb%'
      )
      AND NOT (
        p.euid > 500
        AND parent_name = 'env'
        AND parent_cmd LIKE '/usr/bin/env bash ./hack/%.sh'
      )
      AND NOT (
        p.euid > 500
        AND parent_name = 'bash'
        AND parent_cmd LIKE 'bash ./hack/%.sh'
      )
      AND NOT (
        p.euid > 500
        AND parent_name = 'bash'
        AND parent_cmd LIKE 'bash %/bin/go-build %'
      )
      AND NOT (
        p.euid > 500
        AND parent_name = 'ruby'
        AND p.cmdline LIKE '/usr/bin/curl --disable --cookie /dev/null --globoff --show-error --user-agent Homebrew/%'
      )
      AND NOT p.cgroup_path LIKE '/system.slice/docker-%'
    GROUP BY
      p.pid
  tags: transient, process, state, often
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Detect commands used to bless a file as executable
  discard_data: false
  interval: 600
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-file-made-executable
  observer_can_run: false
  platforms: posix
  query: |
    -- Detect commands used to bless a file as executable
    --
    -- false positives:
    --   * none observed, but they are expected
    --
    -- interval: 600
    -- platform: posix
    -- tags: process events
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.euid AS p0_euid,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Extra fields
      REGEX_MATCH (TRIM(pe.cmdline), ".* (.*?)$", 1) AS target_path
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -600)
      AND pe.cmdline != ''
      AND pe.path IN ('/bin/chmod', '/usr/bin/chmod')
      AND (
        p0_cmd LIKE '%chmod 7%'
        OR p0_cmd LIKE '%chmod 5%'
        OR p0_cmd LIKE '%chmod 1%'
        OR p0_cmd LIKE '%chmod +%x'
      )
      AND p0_cmd NOT LIKE 'chmod 700 /tmp/apt-key-gpghome.%'
      AND p0_cmd NOT LIKE 'chmod 700 /home/%/snap/%/.config'
      AND p0_cmd NOT LIKE 'chmod 755 /home/%/.gradle/wrapper/dists/gradle-%-bin/%bin/gradle'
      AND p0_cmd NOT IN ('chmod 755 /usr/local/share/ca-certificates')
      AND NOT p0_cgroup LIKE '/system.slice/docker-%'
    GROUP BY
      pe.pid
  tags: process, events
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Gatekeeper exceptions are exceptions for downloaded binaries
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-gatekeeper-approvals-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Gatekeeper exceptions are exceptions for downloaded binaries
    --
    -- references:
    --   * https://posts.specterops.io/hunting-for-bad-apples-part-2-6f2d01b1f7d3
    --
    -- false positives:
    --   * developers downloading binaries from Github
    --
    -- platform: darwin
    -- tags: persistent filesystem state gatekeeper
    SELECT
      gap.ctime,
      gap.mtime,
      gap.path,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      signature.identifier,
      signature.authority
    FROM
      gatekeeper_approved_apps AS gap
      LEFT JOIN file ON gap.path = file.path
      LEFT JOIN hash ON gap.path = hash.path
      LEFT JOIN signature ON gap.path = signature.path
    WHERE
      gap.path NOT LIKE '/Users/%/bin/%'
      AND gap.path NOT LIKE '/Users/%/%-darwin-a%64'
      AND gap.path NOT LIKE '/Users/%/%_darwin_a%64%'
      AND gap.path NOT LIKE '/Users/%/Downloads/cosign'
      AND gap.path NOT LIKE '/Users/%/Downloads/missp'
      AND gap.path NOT LIKE '/Users/%/bom'
      AND gap.path NOT LIKE '/Users/%/configure'
      AND gap.path NOT LIKE '/Users/%/cosign-%'
      AND gap.path NOT LIKE '/Users/%/crane'
      AND gap.path NOT LIKE '/Users/%/rekor-cli'
      AND gap.path NOT LIKE '/Users/%/trivy'
      AND gap.path NOT LIKE '/usr/local/bin/%'
      AND gap.path NOT LIKE '/Users/%/Downloads/openresty%/bundle/install'
      AND gap.path NOT LIKE '/Users/%/Downloads/U_STIGViewer%/STIGViewer'
      AND signature.authority != 'Developer ID Application: Jamie Zawinski (4627ATJELP)'
    GROUP BY
      gap.requirement
  tags: persistent, filesystem, state, gatekeeper
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Detect weird mounts, like mounting the EFI partition
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-mounts
  observer_can_run: false
  platforms: darwin
  query: |
    -- Detect weird mounts, like mounting the EFI partition
    --
    -- references:
    --   * https://www.welivesecurity.com/2022/07/19/i-see-what-you-did-there-look-cloudmensis-macos-spyware/
    --
    -- platform: darwin
    -- tags: transient filesystem state
    SELECT
      *
    FROM
      mounts
    WHERE
      device = '/dev/disk0s1'
      AND type = 'msdos';
  tags: transient, filesystem, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Detect unusual calls to osascript
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-osascript-calls
  observer_can_run: false
  platforms: darwin
  query: |
    -- Detect unusual calls to osascript
    --
    -- This query does some gymnastics, as the information on the parent process may be
    -- found in the 'process' (currently running) or 'process_events' table (recently started).
    --
    -- In the case of a long-running process that was recently terminated, parent information
    -- may not be in either.
    --
    -- false positives:
    --   * none observed, but they are expected
    --
    -- interval: 300
    -- platform: darwin
    -- tags: process events
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      s.authority AS p0_authority,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      pe_sig1.authority AS p1_authority,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(
        p1_p2_sig.authority,
        pe1_p2_sig.authority,
        pe1_pe2_sig.authority
      ) AS p2_authority
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN signature s ON pe.path = s.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      LEFT JOIN signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path
      LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path
      LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path
    WHERE
      pe.path IN ('/usr/bin/osascript', '/usr/bin/osacompile')
      AND pe.time > (strftime('%s', 'now') -300)
      AND pe.cmdline != ''
      -- Only include successful executions: On macOS, process_events includes unsuccessful path lookups!
      AND pe.status = 0
      AND NOT (
        pe.euid > 500
        AND (
          p0_cmd IN (
            'osascript -e user locale of (get system info)',
            'osascript -e tell application "Finder" to reveal application file id "com.garmin.renu.client"',
            'osascript ./ExpressLoginItem.scpt',
            'osascript -e get POSIX path of (path to application id "com.garmin.LifetimeMapUpdate")',
            'osascript -e get POSIX path of (path to application id "com.garmin.expressfit")',
            'osascript -e get POSIX path of (path to application id "com.garmin.antagent")'
          )
          OR p0_cmd LIKE '%"CFBundleName" of property list file (app_path & ":Contents:Info.plist")'
          OR p0_cmd LIKE 'osascript -e set zoomStatus to "closed"%'
          OR p0_cmd LIKE 'osascript -l JavaScript%com.elgato.StreamDeck%'
          OR p0_cmd LIKE 'osascript -e%tell application "System Preferences"%reveal anchor "shortcutsTab"%"com.apple.preference.keyboard"'
          OR p0_cmd LIKE 'osascript -e tell application "zoom.us"%'
          OR p0_cmd LIKE 'osascript -l JavaScript /tmp/PKInstallSandbox.%/Scripts/org.gpgtools.gpgmailloader.pkg.%/mailbundle-enabled.jxa -- GPGMailLoader.mailbundle'
          OR p0_cmd LIKE 'osascript openChrome.applescript http://127.0.0.1:%'
          OR p0_cmd LIKE 'osascript openChrome.applescript http%://localhost%'
          OR p0_cmd LIKE '/usr/bin/osascript /Applications/Amazon Photos.app/Contents/Resources/quit_and_restart_app.scpt /Applications/Amazon Photos.app com.amazon.clouddrive.mac%'
          OR p0_cmd LIKE '/usr/bin/osascript /Users/%/Library/Caches/com.runningwithcrayons.Alfred/Workflow Scripts/%'
          OR p0_cmd LIKE '/usr/bin/osascript /Users/%/osx-trash/trashfile.AppleScript %'
          OR p0_cmd LIKE '/usr/bin/osascript %com.docker.docker%'
          OR p0_cmd LIKE '%osacompile -o /Users/%/Applications/Home Manager Trampolines/%'
          OR p1_cmd LIKE '%aws %sso%'
          OR p1_cmd LIKE '%gcloud% auth %login%'
          OR p1_cmd LIKE '%gcloud% init'
          OR p1_cmd LIKE '%auth login'
          OR p1_cmd LIKE '% /opt/homebrew/bin/jupyter%notebook'
          OR p1_cmd LIKE '/bin/sh %/opt/homebrew/bin/git-gui%'
          OR p1_cmd LIKE '%tell application "System Events" to sleep%'
          OR p1_authority = 'Developer ID Application: Docker Inc (9BNSXJN65R)'
          OR p1_name IN ('yubikey-agent')
          OR (
            p1_authority = 'Developer ID Application: VNG ONLINE CO.,LTD (CVB6BX97VM)'
            AND p0_cmd = 'osascript -ss'
          )
          OR (
            p1_authority = 'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)'
            AND p0_cmd = 'osascript'
          )
        )
      )
      -- The following apply to all uids
      AND NOT p0_cmd IN (
        'osascript -e do shell script "/bin/rm -Rf /opt/vagrant /usr/local/bin/vagrant" with administrator privileges',
        'osascript -e user locale of (get system info)',
        '/usr/bin/osascript -e do shell script "/bin/rm -Rf /opt/vagrant /usr/local/bin/vagrant" with administrator privileges'
      )
    GROUP BY
      pe.pid
  tags: process, events
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected use of raw sockets in executables, sometimes used for
    C&C communications
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-packet-sniffer
  observer_can_run: false
  platforms: posix
  query: |
    -- Find unexpected use of raw sockets in executables, sometimes used for C&C communications
    --
    -- false positives:
    --   * operating-system network managers
    --
    -- tags: transient process state
    -- platform: posix
    SELECT
      pop.*,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_sockets pop
      LEFT JOIN processes p0 ON pop.pid = p0.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      pop.family = 17 -- PF_PACKET
      AND p0.name NOT IN (
        'wpa_supplicant',
        'systemd-network',
        'NetworkManager',
        'dhclient',
        'packetbeat',
        'dhcpcd',
        'tcpdump'
      )
  tags: transient, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Programs running as root from unusual signers on macOS
  discard_data: false
  interval: 900
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-root-signer-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Programs running as root from unusual signers on macOS
    --
    -- platform: darwin
    -- interval: 900
    -- tags: transient seldom process state
    -- Canonical example of including process parents from process_events
    SELECT
      f.directory AS dir,
      REGEX_MATCH (p.path, '(/.*?/.*?)/', 1) AS top_dir,
      -- Child
      pe.path AS p0_path,
      pe.time AS p0_time,
      pe.euid AS p0_euid,
      s.authority AS p0_sauth,
      s.identifier AS p0_sid,
      hash.sha256 AS p0_hash,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      -- pe.cwd is NULL on macOS
      p.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.start_time, pe1.time) AS p1_start,
      COALESCE(p1.path, pe1.path) AS p1_path,
      p1.cwd AS p1_cwd,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      p1_p2.cwd AS p2_cwd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN file f ON pe.path = f.path
      LEFT JOIN users u ON pe.uid = u.uid
      LEFT JOIN signature s ON pe.path = s.path
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN hash ON pe.path = hash.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      p0_euid = 0
      AND pe.time > (strftime('%s', 'now') -900)
      -- query optimization: Exclude SIP protected directories
      AND top_dir NOT IN (
        '/Library/Apple',
        '/System/Library',
        '/usr/bin',
        '/usr/libexec',
        '/usr/sbin'
      )
      AND s.authority NOT IN (
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Apple Inc. - XQuartz (NA574AWV7E)',
        'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: Ecamm Network, LLC (5EJH68M642)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK)',
        'Developer ID Application: Foxit Corporation (8GN47HTP75)',
        'Developer ID Application: Fumihiko Takayama (G43BCU2T37)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Kandji, Inc. (P3FGV63VK7)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Kolide, Inc (X98UFR7HA3)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Mersive Technologies (63B5A5WDNG)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: Parallels International GmbH (4C6364ACXT)',
        'Developer ID Application: Private Internet Access, Inc. (5357M5NW9W)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Rogue Amoeba Software, Inc. (7266XEXAPM)',
        'Developer ID Application: Rogue Amoeba Software, LLC (7266XEXAPM)',
        'Developer ID Application: Ryan Hanson (XSYZ3E4B7D)',
        'Developer ID Application: Sanford, L.P. (N3S6676K3E)',
        'Developer ID Application: Tailscale Inc. (W5364U7YZB)',
        'Software Signing'
      )
      AND NOT (
        s.authority = ""
        AND pe.path LIKE "/nix/store/%-nix-%/bin/nix"
        AND p1.path = "/sbin/launchd"
      )
      AND NOT (
        s.authority = ""
        AND (
          pe.path LIKE "/nix/store/%-nix-%/bin/nix-%"
          OR pe.path LIKE "/private/var/folders/%/T/tmp.%/nix-installer"
        )
        AND p1_path = "/usr/bin/sudo"
      )
      AND NOT (
        s.authority = ""
        AND pe.path LIKE "/opt/%/bin/socket_vmnet"
        AND p1_path IN ("/usr/bin/sudo", "/sbin/launchd")
      )
      AND NOT (
        s.authority = ""
        AND pe.path LIKE "/opt/homebrew/Cellar/mariadb/%/bin/mariadbd"
        AND p0_cmd LIKE "/opt/homebrew/opt/mariadb/bin/mariadbd %"
      )
      AND NOT (
        s.authority = ""
        AND pe.path LIKE "/opt/homebrew/Cellar/tailscale/%/bin/tailscaled"
        AND p0_cmd LIKE "/opt/homebrew/Cellar/tailscale/%/bin/tailscaled %"
      )
      AND NOT (
        s.authority = "Developer ID Application: Node.js Foundation (HX7739G8FX)"
        AND p0_name = "node"
        AND p1_name IN ("vim", "nvim")
      )
      AND NOT pe.path LIKE '/usr/local/Cellar/htop/%/bin/htop'
  tags: transient, seldom, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find programs that use the Security Framework on macOS - popular among
    malware authors
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-security-framework-program-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find programs that use the Security Framework on macOS - popular among malware authors
    --
    -- platform: darwin
    -- tags: persistent state process seldom
    SELECT
      s.authority,
      s.identifier,
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        p0.name,
        ',',
        s.identifier,
        ',',
        s.authority
      ) AS exception_key,
      pmm.path AS lib_path,
      -- Child
      p0.pid AS p0_pid,
      p0.start_time AS p0_start,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.start_time AS p1_start,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.start_time AS p2_start,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN process_memory_map pmm ON p0.pid = pmm.pid
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      -- Focus on longer-running programs
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time < (strftime('%s', 'now') - 7200)
          AND parent != 0
          -- Assume STP
          AND NOT path LIKE '/System/%'
          AND NOT path LIKE '/usr/libexec/%'
          AND NOT path LIKE '/usr/sbin/%'
          -- Other oddball binary paths
          AND NOT path LIKE '/opt/homebrew/Cellar/%'
          AND NOT path LIKE '/usr/local/Cellar/%/bin/%'
          AND NOT path LIKE '/Users/%/go/src/%/%.test'
          AND NOT (
            path LIKE '/Users/%/homebrew/Cellar/%'
            AND name IN ('limactl', 'Python', 'bash')
          )
          AND NOT (
            path LIKE '/Users/%/Library/Application Support/com.elgato.StreamDeck/Plugins/com.elgato.cpu.sdPlugin/cpu'
            AND name = 'cpu'
          )
          AND NOT path IN ('/opt/socket_vmnet/bin/socket_vmnet')
      )
      AND pmm.path LIKE '%Security.framework%'
      AND exception_key NOT IN (
        '0,ir_agent,bootstrap,Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        '0,ir_agent,ir_agent,Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        '0,nix,nix,',
        '0,osqueryd,io.osquery.agent,Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        '0,osqueryd,osqueryd,Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        '0,rapid7_endpoint_broker,rapid7_endpoint_broker,Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        '0,velociraptor,a.out,',
        '500,AeroSpace,bobko.aerospace,aerospace-codesign-certificate',
        '500,Android File Transfer Agent,com.google.android.mtpagent,Developer ID Application: Google, Inc. (EQHXZ8M8AV)',
        '500,AppleMusic,AppleMusic,Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        '500,bash,bash,',
        '500,bash,com.apple.bash,Software Signing',
        '500,Bazecor Helper,,',
        '500,Bitwarden,com.bitwarden.desktop,Apple Mac OS Application Signing',
        '500,Bitwarden Helper,com.bitwarden.desktop.helper,Apple Mac OS Application Signing',
        '500,Bitwarden Helper (GPU),com.bitwarden.desktop.helper.GPU,Apple Mac OS Application Signing',
        '500,Bitwarden Helper (Renderer),com.bitwarden.desktop.helper.Renderer,Apple Mac OS Application Signing',
        '500,BloomRPC Helper,,',
        '500,bufls,a.out,',
        '500,.cargo-wrapped,.cargo-wrapped,',
        '500,chainctl,a.out,',
        '500,Chromium,Chromium,',
        '500,clangd,,',
        '500,clangd,clangd,',
        '500,cloud-sql-proxy,a.out,',
        '500,cloud_sql_proxy,a.out,',
        '500,cloud-sql-proxy.darwin.arm64,a.out,',
        '500,copilot-agent-macos-arm64,copilot-agent-macos-arm64-5555494405ae226b796431f588804b65cad1040e,',
        '500,CopyClip,com.fiplab.clipboard,Apple Mac OS Application Signing',
        '500,cosign,a.out,',
        '500,cpu,cpu-555549441132dc6b7af538428ce3359ae94eab37,',
        '500,crane,a.out,',
        '500,debug.test,a.out,',
        '500,dfu-discovery,a.out,',
        '500,dive,a.out,',
        '500,Divvy,com.mizage.Divvy,Apple Mac OS Application Signing',
        '500,dlv,a.out,',
        '500,docker,a.out,',
        '500,Duckly,Electron,',
        '500,Duckly Helper,Electron Helper,',
        '500,Duckly Helper (Renderer),Electron Helper (Renderer),',
        '500,Emacs-arm64-11,Emacs-arm64-11,Developer ID Application: Galvanix (5BRAQAFB8B)',
        '500,epdfinfo,epdfinfo,',
        '500,esbuild,,',
        '500,esbuild,a.out,',
        '500,Evernote,com.evernote.Evernote,Apple Mac OS Application Signing',
        '500,Evernote Helper,com.evernote.Evernote.helper,Apple Mac OS Application Signing',
        '500,Evernote Helper (GPU),com.evernote.Evernote.helper.GPU,Apple Mac OS Application Signing',
        '500,Evernote Helper (Renderer),com.evernote.Evernote.helper.Renderer,Apple Mac OS Application Signing',
        '500,fake,a.out,',
        '500,Final Cut Pro,com.apple.FinalCut,Apple Mac OS Application Signing',
        '500,git,git,',
        '500,gitsign,a.out,',
        '500,gitsign-credential-cache,a.out,',
        '500,GitterHelperApp,com.troupe.gitter.mac.GitterHelperApp,Developer ID Application: Troupe Technology Limited (A86QBWJ43W)',
        '500,gke-gcloud-auth-plugin,a.out,',
        '500,go,a.out,',
        '500,GoLinks Extension,com.golinks.golinks-app.safari-app-extension,Apple Mac OS Application Signing',
        '500,gopls,a.out,',
        '500,gopls,gopls,',
        '500,gpg-agent,gpg-agent,',
        '500,Grammarly for Safari,com.grammarly.safari.extension,Apple Mac OS Application Signing',
        '500,Grammarly Safari Extension,com.grammarly.safari.extension.ext2,Apple Mac OS Application Signing',
        '500,hugo,a.out,',
        '500,InternalFiltersXPC,com.apple.InternalFiltersXPC,Apple Mac OS Application Signing',
        '500,ipcserver,com.valvesoftware.steam,Developer ID Application: Valve Corporation (MXGJJ98X76)',
        '500,ipcserver.old,,',
        '500,J8RPQ294UB.com.skitch.SkitchHelper,J8RPQ294UB.com.skitch.SkitchHelper,Apple Mac OS Application Signing',
        '500,J8RPQ294UB.com.skitch.SkitchHelper,J8RPQ294UB.com.skitch.SkitchHelper,Developer ID Application: Skitch Inc (J8RPQ294UB)',
        '500,k9s,a.out,',
        '500,keyboxd,keyboxd,',
        '500,ko,,',
        '500,ko,a.out,',
        '500,kubectl,a.out,',
        '500,lua-language-server,lua-language-server,',
        '500,Magnet,com.crowdcafe.windowmagnet,Apple Mac OS Application Signing',
        '500,mattermost,a.out,',
        '500,Mattermost Helper (GPU),Mattermost.Desktop.helper.GPU,Apple Mac OS Application Signing',
        '500,Mattermost Helper,Mattermost.Desktop.helper,Apple Mac OS Application Signing',
        '500,Mattermost Helper (Renderer),Mattermost.Desktop.helper.Renderer,Apple Mac OS Application Signing',
        '500,Mattermost,Mattermost.Desktop,Apple Mac OS Application Signing',
        '500,melange,a.out,',
        '500,melange-run,a.out,',
        '500,monday.com,com.monday.desktop,Apple Mac OS Application Signing',
        '500,monday.com Helper,com.monday.desktop.helper,Apple Mac OS Application Signing',
        '500,monday.com Helper (GPU),com.monday.desktop.helper.GPU,Apple Mac OS Application Signing',
        '500,monday.com Helper (Renderer),com.monday.desktop.helper.Renderer,Apple Mac OS Application Signing',
        '500,monorail,,',
        '500,monorail,a.out,',
        '500,nvim,,',
        '500,nvim,nvim,',
        '500,OOPProResRawService,com.apple.videoapps.OOPProResRawService,Apple Mac OS Application Signing',
        '500,osqueryd,osqueryd,Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        '500,plugin-darwin-arm64,a.out,',
        '500,PrinterProxy,com.apple.print.PrinterProxy,',
        '500,python,,',
        '500,registry,a.out,',
        '500,registry-redirect,a.out,',
        '500,ruff,,',
        '500,Runner.Listener,apphost-55554944a938bab90f04347d83659c53dd1197d6,',
        '500,rust-analyzer,rust_analyzer-d11ae4e1bae4360d,',
        '500,scdaemon,scdaemon,',
        '500,sdaudioswitch,,',
        '500,sdaudioswitch,sdaudioswitch,',
        '500,sdmicmute,,',
        '500,sdmicmute,sdmicmute,',
        '500,sdzoomplugin,,',
        '500,serial-discovery,a.out,',
        '500,Slack,com.tinyspeck.slackmacgap,Apple Mac OS Application Signing',
        '500,Slack Helper,com.tinyspeck.slackmacgap.helper,Apple Mac OS Application Signing',
        '500,Slack Helper (GPU),com.tinyspeck.slackmacgap.helper,Apple Mac OS Application Signing',
        '500,Slack Helper (Plugin),com.tinyspeck.slackmacgap.helper,Apple Mac OS Application Signing',
        '500,Slack Helper (Renderer),com.tinyspeck.slackmacgap.helper,Apple Mac OS Application Signing',
        '500,snyk-ls_darwin_arm64,a.out,',
        '500,Speedtest,com.ookla.speedtest-macos,Apple Mac OS Application Signing',
        '500,ssh,ssh,',
        '500,Steam Helper,com.valvesoftware.steam.helper,Developer ID Application: Valve Corporation (MXGJJ98X76)',
        '500,steam_osx,com.valvesoftware.steam,Developer ID Application: Valve Corporation (MXGJJ98X76)',
        '500,stern,a.out,',
        '500,syncthing,syncthing,',
        '500,Telegram,ru.keepcoder.Telegram,Apple Mac OS Application Signing',
        '500,testing,com.yourcompany.testing,', -- Xcode iPhone emulator
        '500,tflint,a.out,',
        '500,tflint-ruleset-aws,a.out,',
        '500,tflint-ruleset-google,a.out,',
        '500,timestamp-server,a.out,',
        '500,Divvy,com.mizage.direct.Divvy,Developer ID Application: Mizage, LLC',
        '500,Todoist,com.todoist.mac.Todoist,Apple Mac OS Application Signing',
        '500,Todoist Helper,com.todoist.mac.Todoist.helper,Apple Mac OS Application Signing',
        '500,Todoist Helper (GPU),com.todoist.mac.Todoist.helper.GPU,Apple Mac OS Application Signing',
        '500,Todoist Helper (Renderer),com.todoist.mac.Todoist.helper.Renderer,Apple Mac OS Application Signing',
        '500,TwitchStudioStreamDeck,TwitchStudioStreamDeck,Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        '500,LogicProThumbnailExtension,com.apple.logic10.LogicProThumbnailExtension,Apple Mac OS Application Signing',
        '500,vim,,',
        '500,vim,vim,',
        '500,WinAppHelper,,',
        '500,WinAppHelper,WinAppHelper,'
      )
      AND NOT (
        exception_key LIKE '500,%,a.out,'
        AND p0.path LIKE '/private/var/folders%/T/go-build%/exe/%'
      )
      AND NOT (
        exception_key LIKE '500,tflint%,a.out,'
        AND p0.path LIKE '/Users/%/.tflint.d/%'
      )
      AND NOT (
        exception_key LIKE '500,python3.%,%,'
        AND (
          p0.path LIKE '/opt/%/bin/python%'
          OR p0.path LIKE '/nix/store/%/bin/python%'
        )
      )
      AND NOT (
        exception_Key LIKE '500,%,a.out,'
        AND p0.path LIKE '/Users/%/go/bin/%'
      )
      AND NOT exception_key LIKE '500,terraform-provider-cosign_%,,'
      AND NOT exception_key LIKE '500,cody-engine-%-macos-arm64,%,'
      AND NOT exception_key LIKE '500,rust-analyzer-aarch64-apple-darwin,rust_analyzer-%,'
      AND NOT exception_key LIKE '500,___%,a.out,'
      AND NOT exception_key LIKE '500,zellij,zellij%,'
      AND NOT exception_key LIKE '500,ruff,ruff%,'
      AND NOT exception_key LIKE '500,copilot-agent-macos-%,copilot-agent-macos-%,'
      AND NOT exception_key LIKE '500,samply,samply-%,'
      AND NOT exception_key LIKE '500,gopls_%,a.out,'
      AND NOT exception_key LIKE '500,terraform-provider-%,,'
      AND NOT exception_key LIKE '500,terraform-provider-%,a.out,'
      AND NOT exception_key LIKE '500,Runner.%,apphost-%,'
      AND NOT exception_key LIKE '500,kubectl.%,a.out,'
      AND NOT exception_key LIKE '500,marksman-macos,marksman-%,'
      AND NOT exception_key LIKE '500,rustlings,rustlings-%,'
      AND NOT exception_key LIKE '500,rust-analyzer,rust_analyzer-%,'
      AND NOT exception_key LIKE '500,nvim,bob-%'
      AND NOT exception_key LIKE '500,nvim,%.out,'
      AND NOT exception_key LIKE '500,rzls,apphost-%,'
      AND NOT exception_key LIKE '500,sg-nvim-agent,sg_nvim_agent-%,'
      AND NOT exception_key LIKE '500,taplo-full-darwin-%,taplo-%,'
    GROUP BY
      p0.pid
  tags: persistent, state, process, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected setuid binaries on disk
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-setuid-binaries
  observer_can_run: false
  platforms: posix
  query: |
    -- Find unexpected setuid binaries on disk
    --
    -- false positives:
    --   * new software
    --
    -- tags: persistent seldom
    -- platform: posix
    SELECT
      GROUP_CONCAT(path) AS paths,
      gid,
      uid,
      mode,
      type,
      size,
      data,
      sha256
    FROM
      (
        SELECT
          file.path,
          file.gid,
          file.uid,
          file.inode,
          file.mode,
          file.type,
          file.size,
          magic.data,
          hash.sha256
        FROM
          file
          LEFT JOIN hash ON file.path = hash.path
          LEFT JOIN magic ON file.path = magic.path
        WHERE
          file.directory IN (
            '/bin',
            '/opt/google-cloud-sdk/bin',
            '/opt/homebrew/bin',
            '/opt/homebrew/sbin',
            '/sbin',
            '/etc',
            '/tmp',
            '/var/lib',
            '/usr/libexec',
            '/usr/bin',
            '/usr/lib',
            '/usr/lib64',
            '/usr/libexec',
            '/usr/lib/jvm/default/bin',
            '/usr/local/bin',
            '/usr/local/lib',
            '/usr/local/lib64',
            '/usr/local/libexec',
            '/usr/local/sbin',
            '/usr/sbin',
            '/var/tmp'
          )
          AND type = 'regular'
          AND mode NOT LIKE '0%'
          AND mode NOT LIKE '1%'
          AND mode NOT LIKE '2%'
          AND NOT (
            mode LIKE '4%11'
            AND uid = 0
            AND gid = 0
            AND file.path IN (
              '/bin/cdda2wav',
              '/bin/cdrecord',
              '/bin/icedax',
              '/bin/mount.nfs',
              '/bin/mount.nfs4',
              '/bin/readcd',
              '/bin/readom',
              '/bin/rscsi',
              '/bin/staprun',
              '/bin/sudo',
              '/bin/sudoedit',
              '/bin/umount.nfs',
              '/bin/umount.nfs4',
              '/bin/wodim',
              '/sbin/cdda2wav',
              '/sbin/cdrecord',
              '/sbin/icedax',
              '/sbin/mount.nfs',
              '/sbin/mount.nfs4',
              '/sbin/readcd',
              '/sbin/readom',
              '/sbin/rscsi',
              '/sbin/umount.nfs',
              '/sbin/umount.nfs4',
              '/sbin/userhelper',
              '/sbin/wodim',
              '/usr/bin/cdda2wav',
              '/usr/bin/cdrecord',
              '/usr/bin/icedax',
              '/usr/bin/mount.nfs',
              '/usr/bin/mount.nfs4',
              '/usr/bin/readcd',
              '/usr/bin/readom',
              '/usr/bin/rscsi',
              '/usr/bin/staprun',
              '/usr/bin/sudo',
              '/usr/bin/sudoedit',
              '/usr/bin/umount.nfs',
              '/usr/bin/umount.nfs4',
              '/usr/bin/wodim',
              '/usr/libexec/security_authtrampoline',
              '/usr/sbin/cdda2wav',
              '/usr/sbin/cdrecord',
              '/usr/sbin/icedax',
              '/usr/sbin/mount.nfs',
              '/usr/sbin/mount.nfs4',
              '/usr/sbin/readcd',
              '/usr/sbin/readom',
              '/usr/sbin/rscsi',
              '/usr/bin/chsh',
              '/usr/bin/chfn',
              '/bin/chsh',
              '/bin/chfn',
              '/usr/sbin/umount.nfs',
              '/usr/sbin/umount.nfs4',
              '/usr/sbin/userhelper',
              '/usr/sbin/wodim'
            )
          )
          AND NOT (
            mode LIKE '4%55'
            AND uid = 0
            AND gid = 0
            AND file.path IN (
              '/bin/at',
              '/bin/atq',
              '/bin/atrm',
              '/bin/chage',
              '/bin/chfn',
              '/bin/chsh',
              '/bin/crontab',
              '/bin/doas',
              '/bin/expiry',
              '/bin/firejail',
              '/bin/fusermount',
              '/bin/fusermount3',
              '/bin/fusermount-glusterfs',
              '/bin/gpasswd',
              '/bin/keybase-redirector',
              '/bin/ksu',
              '/bin/mount',
              '/bin/mullvad-exclude',
              '/bin/ndisc6',
              '/bin/newgidmap',
              '/bin/newgrp',
              '/bin/newuidmap',
              '/bin/nvidia-modprobe',
              '/bin/passwd',
              '/bin/pkexec',
              '/bin/ps',
              '/bin/rdisc6',
              '/bin/rltraceroute6',
              '/bin/schroot',
              '/bin/sg',
              '/bin/su',
              '/bin/sudo',
              '/bin/sudoedit',
              '/bin/suexec',
              '/bin/ubuntu-core-launcher',
              '/bin/umount',
              '/bin/vmware-user',
              '/bin/vmware-user-suid-wrapper',
              '/sbin/chage',
              '/sbin/chfn',
              '/sbin/chsh',
              '/sbin/crontab',
              '/sbin/doas',
              '/sbin/expiry',
              '/sbin/firejail',
              '/sbin/fusermount',
              '/sbin/fusermount3',
              '/sbin/gpasswd',
              '/sbin/grub2-set-bootflag',
              '/sbin/ksu',
              '/sbin/mount',
              '/sbin/mount.nfs',
              '/sbin/mount.nfs4',
              '/sbin/mullvad-exclude',
              '/sbin/ndisc6',
              '/sbin/newgrp',
              '/sbin/nvidia-modprobe',
              '/sbin/pam_timestamp_check',
              '/sbin/passwd',
              '/sbin/pkexec',
              '/sbin/rdisc6',
              '/sbin/rltraceroute6',
              '/sbin/sg',
              '/sbin/su',
              '/sbin/sudo',
              '/sbin/sudoedit',
              '/sbin/suexec',
              '/sbin/umount',
              '/sbin/umount.nfs',
              '/sbin/umount.nfs4',
              '/sbin/unix_chkpwd',
              '/sbin/usernetctl',
              '/usr/bin/at',
              '/usr/bin/atq',
              '/usr/bin/atrm',
              '/usr/bin/batch',
              '/usr/bin/chage',
              '/usr/bin/chfn',
              '/usr/bin/chsh',
              '/usr/bin/crontab',
              '/usr/bin/doas',
              '/usr/bin/expiry',
              '/usr/bin/firejail',
              '/usr/bin/fusermount',
              '/usr/bin/fusermount3',
              '/usr/bin/fusermount-glusterfs',
              '/usr/bin/gpasswd',
              '/usr/bin/keybase-redirector',
              '/usr/bin/ksu',
              '/usr/bin/login',
              '/usr/bin/mount',
              '/usr/bin/mullvad-exclude',
              '/usr/bin/ndisc6',
              '/usr/bin/newgidmap',
              '/usr/bin/newgrp',
              '/usr/bin/newuidmap',
              '/usr/bin/nvidia-modprobe',
              '/usr/bin/passwd',
              '/usr/bin/pkexec',
              '/usr/bin/quota',
              '/usr/bin/rdisc6',
              '/usr/bin/rltraceroute6',
              '/usr/bin/schroot',
              '/usr/bin/sg',
              '/usr/bin/su',
              '/usr/bin/sudo',
              '/usr/bin/sudoedit',
              '/usr/bin/suexec',
              '/usr/bin/top',
              '/usr/bin/ubuntu-core-launcher',
              '/usr/bin/umount',
              '/usr/bin/vmware-user',
              '/usr/bin/vmware-user-suid-wrapper',
              '/usr/lib64/mail-dotlock',
              '/usr/lib64/xf86-video-intel-backlight-helper',
              '/usr/lib64/Xorg.wrap',
              '/usr/libexec/authopen',
              '/usr/libexec/libgtop_server2',
              '/usr/libexec/polkit-agent-helper-1',
              '/usr/libexec/qemu-bridge-helper',
              '/usr/libexec/spice-client-glib-usb-acl-helper',
              '/usr/libexec/Xorg.wrap',
              '/usr/lib/mail-dotlock',
              '/usr/lib/xf86-video-intel-backlight-helper',
              '/usr/lib/Xorg.wrap',
              '/usr/local/bin/doas',
              '/usr/sbin/chage',
              '/usr/sbin/chfn',
              '/usr/sbin/chsh',
              '/usr/sbin/crontab',
              '/usr/sbin/doas',
              '/usr/sbin/expiry',
              '/usr/sbin/firejail',
              '/usr/sbin/fusermount',
              '/usr/sbin/fusermount3',
              '/usr/sbin/gpasswd',
              '/usr/sbin/grub2-set-bootflag',
              '/usr/sbin/ksu',
              '/usr/sbin/mount',
              '/usr/sbin/mount.nfs',
              '/usr/sbin/mount.nfs4',
              '/usr/sbin/mullvad-exclude',
              '/usr/sbin/ndisc6',
              '/usr/sbin/newgrp',
              '/usr/sbin/nvidia-modprobe',
              '/usr/sbin/pam_timestamp_check',
              '/usr/sbin/passwd',
              '/usr/sbin/pkexec',
              '/usr/sbin/rdisc6',
              '/usr/sbin/rltraceroute6',
              '/usr/sbin/sg',
              '/usr/sbin/su',
              '/usr/sbin/sudo',
              '/usr/sbin/sudoedit',
              '/usr/sbin/suexec',
              '/usr/sbin/traceroute',
              '/usr/sbin/traceroute6',
              '/usr/sbin/umount',
              '/usr/sbin/umount.nfs',
              '/usr/sbin/umount.nfs4',
              '/usr/sbin/unix_chkpwd',
              '/usr/sbin/usernetctl'
            )
          )
          AND NOT (
            mode = '4754'
            AND uid = 0
            AND gid = 30
            AND file.path IN ('/usr/sbin/pppd', '/sbin/pppd')
          )
          AND NOT (
            mode = '6755'
            AND uid = 0
            AND gid = 0
            AND file.path IN (
              '/bin/mount.cifs',
              '/bin/mount.smb3',
              '/bin/unix_chkpwd',
              '/sbin/mount.cifs',
              '/sbin/mount.smb3',
              '/sbin/unix_chkpwd',
              '/usr/bin/mount.cifs',
              '/usr/bin/mount.smb3',
              '/usr/bin/unix_chkpwd',
              '/usr/lib/xtest',
              '/usr/lib64/xtest',
              '/usr/sbin/mount.cifs',
              '/usr/sbin/mount.smb3',
              '/usr/sbin/unix_chkpwd'
            )
          )
          AND NOT (
            mode = '4110'
            AND uid = 0
            AND gid = 156
            AND file.path IN ('/bin/staprun', '/usr/bin/staprun')
          )
      )
    GROUP BY
      inode
  tags: persistent, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected calls to sysctl (event-based)
  discard_data: false
  interval: 600
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-sysutils-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Unexpected calls to sysctl (event-based)
    --
    -- refs:
    --   * https://attack.mitre.org/techniques/T1497/001/ (Virtualization/Sandbox Evasion: System Checks)
    --
    -- platform: linux
    -- interval: 600
    SELECT -- Child
      pe.path AS p0_path,
      pe.time AS p0_time,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -600)
      AND pe.cmdline != ''
      AND (
        pe.path IN (
          '/usr/bin/sysctl',
          '/sbin/sysctl',
          '/usr/sbin/sysctl',
          '/usr/bin/chattr',
          '/sbin/chattr',
          '/usr/sbin/chattr',
          '/usr/bin/setenforce',
          '/sbin/setenforce',
          '/usr/sbin/setenforce',
          '/usr/bin/sqlite3'
        ) -- Used by LaZagne, through the Platform library
        OR (
          pe.path IN ('/ur/bin/uname', '/bin/uname')
          AND pe.cmdline LIKE '%uname -p'
        )
      )
      AND p.parent > 0
    GROUP BY
      pe.pid
  tags: ''
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected calls to macOS system utilities (event-based)
  discard_data: false
  interval: 900
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-sysutils-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Unexpected calls to macOS system utilities (event-based)
    --
    -- refs:
    --   * https://attack.mitre.org/techniques/T1497/001/ (Virtualization/Sandbox Evasion: System Checks)
    --   * https://www.sentinelone.com/blog/atomic-stealer-threat-actor-spawns-second-variant-of-macos-malware-sold-on-telegram/
    --
    -- platform: darwin
    -- interval: 900
    SELECT
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key,
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      s.authority AS p0_authority,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      pe_sig1.authority AS p1_authority,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(
        p1_p2_sig.authority,
        pe1_p2_sig.authority,
        pe1_pe2_sig.authority
      ) AS p2_authority
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN signature s ON pe.path = s.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      LEFT JOIN signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path
      LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path
      LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path
    WHERE
      pe.time > (strftime('%s', 'now') -900)
      AND pe.status = 0
      AND pe.parent > 0
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND pe.status == 0
      AND pe.path IN (
        '/usr/bin/csrutil',
        '/usr/bin/ditto',
        '/usr/bin/dscl',
        '/usr/bin/funzip',
        '/usr/bin/openssl',
        '/usr/bin/security',
        '/usr/bin/sqlite3',
        '/usr/sbin/spctl',
        '/usr/bin/sw_vers',
        '/usr/bin/unzip',
        '/usr/bin/uuidgen',
        '/usr/bin/whoami',
        '/usr/libexec/security_authtrampoline',
        '/usr/sbin/ioreg',
        '/usr/sbin/sysctl',
        '/usr/sbin/system_profiler'
      )
      AND p.parent > 0
      AND NOT p0_cmd IN (
        'sysctl -i sysctl.proc_translated',
        'sysctl -n hw.optional.arm64',
        'sw_vers -productName',
        'unzip -h',
        'sysctl -n sysctl.proc_translated',
        '/usr/sbin/system_profiler SPUSBDataType',
        'system_profiler SPUSBDataType',
        '/usr/sbin/sysctl kern.hv_support',
        '/usr/sbin/sysctl -n hw.cputype',
        '/usr/sbin/sysctl sysctl.proc_translated'
      )
      AND NOT exception_key IN (
        'ditto,500,ruby,zsh',
        'ioreg,500,bash,Alfred Preferences',
        'ioreg,500,com.docker.backend,launchd',
        'system_profiler,0,launcher,launchd',
        'system_profiler,500,bash,launchd',
        'system_profiler,500,bash,logioptionsplus_agent',
        'system_profiler,500,Google Drive,launchd',
        'system_profiler,500,steam_osx,launchd',
        'system_profiler,500,Ultimate,launchd',
        'unzip,500,tmux,launchd'
      )
      AND NOT exception_key LIKE 'unzip,500,login,iTermServer-%'
      AND NOT p0_cmd LIKE '/usr/libexec/security_authtrampoline /Library/Application Support/Adobe/Adobe Desktop Common/ElevationManager/Adobe Installer auth%'
      AND NOT p0_cmd LIKE '%sqlite3%vulnerability.db%'
      AND NOT p1_path IN (
        '/Applications/LogiTune.app/Contents/MacOS/LogiTune',
        '/Applications/Alfred 5.app/Contents/Preferences/Alfred Preferences.app/Contents/MacOS/Alfred Preferences'
      )
    GROUP BY
      pe.pid
  tags: ''
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Detect unusual calls to xattr, used to remove filesystem attributes
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - unexpected-xattr-calls-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Detect unusual calls to xattr, used to remove filesystem attributes
    --
    -- false positives:
    --   * none observed, but they are expected
    --
    -- interval: 300
    -- platform: darwin
    -- tags: process events
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      s.authority AS p0_authority,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      pe_sig1.authority AS p1_authority,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(
        p1_p2_sig.authority,
        pe1_p2_sig.authority,
        pe1_pe2_sig.authority
      ) AS p2_authority,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN signature s ON pe.path = s.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      LEFT JOIN signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path
      LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path
      LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path
    WHERE
      pe.time > (strftime('%s', 'now') -300)
      AND pe.status = 0
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND pe.status == 0
      AND pe.path = '/usr/bin/xattr'
      AND p0_cmd NOT LIKE '%xattr -d -r com.apple.quarantine /Applications/%.app'
      AND p0_cmd NOT LIKE '%xattr -r -d com.apple.quarantine /Applications/%.app'
      AND p0_cmd NOT LIKE '%xattr -d com.apple.quarantine /Applications/%.app'
      AND p0_cmd NOT LIKE '%xattr -d com.apple.quarantine /Applications/%.app/%.xpc'
      AND p0_cmd NOT LIKE '%xattr -d com.apple.FinderInfo /Applications/Parallels Desktop.app'
      AND NOT (
        pe.euid > 500
        AND p0_cmd LIKE '%xattr -l %'
      )
      AND NOT (
        pe.euid > 500
        AND p0_cmd LIKE '%xattr -p com.apple.quarantine %'
      )
      AND NOT (
        pe.euid > 500
        AND p0_cmd LIKE '%xattr -p com.apple.rootless /Users/%/Library/Containers/%'
      )
      AND NOT (
        pe.euid > 500
        AND p0_cmd LIKE '%xattr -p com.apple.metadata:kMDItemAlternateNames %'
      )
      AND NOT (
        pe.euid > 500
        AND p0_cmd LIKE '/usr/bin/xattr -w com.apple.metadata:kMDItemAlternateNames %'
      )
      AND NOT (
        pe.euid > 500
        AND p0_cmd LIKE 'xattr -r -d com.apple.quarantine /Users/%/.provisio/bin/%.app'
      )
      AND NOT (
        pe.euid > 500
        AND p0_cmd = '/usr/bin/xattr -h'
        AND p1_cmd LIKE '%brew%'
      )
      AND p0_cmd NOT LIKE '/usr/bin/xattr -w com.apple.quarantine 0002;%'
      AND p0_cmd NOT LIKE '/usr/bin/xattr -w com.apple.quarantine 0181;%'
      AND p0_cmd NOT LIKE '/usr/bin/xattr -w com.apple.quarantine 0381;%'
    GROUP BY
      pe.pid
  tags: process, events
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Returns a list of malware matches from macOS XProtect
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - xprotect-reports
  observer_can_run: false
  platforms: darwin
  query: |
    -- Returns a list of malware matches from macOS XProtect
    --
    -- tags: persistent often malware xprotect
    -- platform: darwin
    SELECT
      *
    FROM
      xprotect_reports;
  tags: persistent, often, malware, xprotect
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Currently running CryptoCoin miner
  discard_data: false
  interval: 7200
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - yara-unexpected-miner-process
  observer_can_run: false
  platforms: posix
  query: |
    -- Currently running CryptoCoin miner
    --
    -- reference:
    --   * https://github.com/Neo23x0/signature-base/blob/master/yara/pua_cryptocoin_miner.yar
    --
    -- tags: persistent
    -- interval: 7200
    -- platform: posix
    SELECT
      yara.*,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN yara ON p0.path = yara.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > (strftime('%s', 'now') - 7200)
          AND path != ""
        GROUP BY
          path
      )
      AND yara.sigrule = '
        rule miner {
        strings:
            $tcp = "stratum+tcp://" ascii
            $tls = "stratum+tls://" ascii
            $ssl = "stratum+ssl://" ascii
            $stratum = "stratum://" ascii
            $normalhash = "\"normalHashing\": true,"
        condition:
            filesize < 10MB and 1 of them
    }'
      AND yara.count > 0
  tags: persistent
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Currently running UPX executable
  discard_data: false
  interval: 7199
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - execution - yara-unexpected-upx-process
  observer_can_run: false
  platforms: posix
  query: |
    -- Currently running UPX executable
    --
    -- tags: persistent
    -- interval: 7199
    -- platform: posix
    SELECT
      yara.*,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN yara ON p0.path = yara.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > (strftime('%s', 'now') - 7200)
          AND path != ""
        GROUP BY
          path
      )
      AND yara.sigrule = '
        rule upx {
        strings:
            $upx_sig = "UPX!"

        condition:
            $upx_sig in (0..1024)
        }'
      AND yara.count > 0
  tags: persistent
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Programs which are reading an unusually large amount of data
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - exfil - high_disk_bytes_read
  observer_can_run: false
  platforms: ''
  query: |
    -- Programs which are reading an unusually large amount of data
    --
    -- Can be used to detect exfiltration
    --
    -- false positives:
    --   * Virtual Machine managers
    --   * Backup software
    --   * Build tools
    --
    -- references:
    --   * https://attack.mitre.org/tactics/TA0010/ (Exfiltration)
    --
    -- tags: transient process
    SELECT
      -- WARNING: Writes to tmpfs are not reflected against this counter
      p0.disk_bytes_read AS bytes_read,
      (strftime('%s', 'now') - p0.start_time) AS age,
      p0.disk_bytes_read / (strftime('%s', 'now') - p0.start_time) AS bytes_read_rate,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cgroup_path AS p0_cgroup,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      -- On my Linux machine, tarring up a home directory clocks in at 2,800,000 - 4,986,722
      bytes_read_rate > 2500000
      AND age > 180
      AND p0.path NOT LIKE '/Applications/%.app/Contents/%'
      AND p0.path NOT LIKE '/System/Library/%'
      AND p0.path NOT LIKE '/System/Applications/%'
      AND p0.path NOT LIKE '/Library/Apple/System/Library/%'
      AND p0.path NOT LIKE '/home/%/.local/share/Steam/steamapps/%'
      AND p0.name NOT IN (
        'BDLDaemon',
        'Disk Inventory X',
        'GoogleSoftwareUpdateAgent',
        'LogiFacecamService',
        'Safari',
        'UpdateBrainService',
        'ZwiftAppMetal',
        'ZwiftAppSilicon',
        'apko',
        'baloo_file',
        'baloo_file_extr',
        'bash',
        'bincapz',
        'bwrap',
        'cargo',
        'chrome',
        'clamscan',
        'code',
        'com.apple.MobileSoftwareUpdate.UpdateBrainService',
        'com.apple.NRD.UpdateBrainService',
        'cpptools',
        'dnf',
        'docker',
        'elastic-endpoin',
        'elastic-endpoint',
        'electron',
        'emacs',
        'steam_osx',
        'factorio',
        'firefox',
        'fish',
        'fleet_backend',
        'fsdaemon',
        'fsnotifier',
        'gnome-software',
        'go',
        'golangci-lint',
        'gopls',
        'grype',
        'hugo',
        'java',
        'kandji-library-manager',
        'kandji-parameter-agent',
        'kube-apiserver',
        'kube-controller',
        'kube-scheduler',
        'kue',
        'launcher',
        'mediawriter',
        'melange',
        'nautilus',
        'nessusd',
        'nix',
        'nix-daemon',
        'nvim',
        'ollama',
        'ollama-runer',
        'osqueryd',
        'osqueryi',
        'plasmashell',
        'qemu-system-aarch64',
        'qemu-system-x86',
        'qemu-system-x86-64',
        'rpi-imager',
        'rpm-ostree',
        'rsync',
        'sh',
        'simdiskimaged',
        'slack',
        'snapd',
        'spotify',
        'steam',
        'systemd',
        'terraform',
        'terraform-ls',
        'terraform-provider-apko',
        'thunderbird',
        'tilt',
        'unattended-upgr',
        'update_dyld_sim_shared_cache',
        'vim',
        'wineserver',
        'wolfictl',
        'yay',
        'ykman-gui',
        'yum',
        'zsh'
      )
      AND NOT p0.path IN (
        '/System/Volumes/Preboot/Cryptexes/App/System/Applications/Safari.app/Contents/XPCServices/com.apple.Safari.BrowserDataImportingService.xpc/Contents/MacOS/com.apple.Safari.BrowserDataImportingService',
        '/System/Volumes/Preboot/Cryptexes/Incoming/OS/System/Library/Frameworks/WebKit.framework/Versions/A/XPCServices/com.apple.WebKit.WebContent.xpc/Contents/MacOS/com.apple.WebKit.WebContent',
        '/app/libexec/mediawriter/helper',
        '/usr/bin/apt',
        '/usr/bin/darktable',
        '/usr/bin/dockerd',
        '/usr/bin/gnome-shell',
        '/Library/Application Support/Adobe/Adobe Desktop Common/HDBox/Setup',
        '/usr/bin/gnome-software',
        '/usr/bin/rsync',
        '/usr/bin/teskdisk',
        '/usr/bin/udevadm',
        '/usr/bin/update-notifier',
        '/usr/lib/systemd/systemd',
        '/usr/lib64/electron/electron',
        '/usr/libexec/PerfPowerServices',
        '/usr/libexec/aned',
        '/usr/libexec/biomesyncd',
        '/usr/libexec/coreduetd',
        '/usr/libexec/diskimagesiod',
        '/usr/libexec/diskmanagementd',
        '/usr/libexec/flatpak-system-helper',
        '/usr/libexec/logd',
        '/usr/libexec/logd_helper',
        '/usr/libexec/packagekitd',
        '/Library/Elastic/Endpoint/elastic-endpoint',
        '/usr/libexec/PerfPowerServices',
        '/usr/libexec/signpost_reporter',
        '/usr/libexec/snapd/snapd',
        '/usr/libexec/syspolicyd',
        '/usr/libexec/tracker-extract-3',
        '/usr/libexec/tracker-miner-fs-3',
        '/usr/sbin/spindump',
        '/usr/sbin/systemstats'
      )
      AND NOT p0.path LIKE '/Library/SystemExtensions/%/io.kandji.KandjiAgent.ESF-Extension.systemextension/Contents/MacOS/io.kandji.KandjiAgent.ESF-Extension'
      AND NOT (
        p0.name = 'bindfs'
        AND p0.cmdline LIKE 'bindfs%-o fsname=%'
      )
      AND NOT (
        p0.name = 'jetbrains-toolb'
        AND p0.path LIKE '/tmp/.mount_jet%/jetbrains-toolbox'
      )
      AND NOT (
        p0.name LIKE 'gopls_%'
        AND p0.path LIKE '%gopls/gopls%'
      )
      AND NOT p0.path LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%com.apple.MobileSoftwareUpdate.UpdateBrainService.%.xpc/Contents/MacOS/com.apple.MobileSoftwareUpdate.UpdateBrainService'
      AND NOT (
        p0.name = 'FindMy'
        AND p0.path = '/System/Applications/FindMy.app/Contents/MacOS/FindMy'
      )
      AND NOT (
        p0.name = 'go'
        AND p0.cmdline LIKE 'go run %'
      )
      AND NOT (
        p0.name = 'kernel_task'
        AND p0.path = ''
        AND p0.parent IN (0, 1)
        AND p0.on_disk = -1
      )
      AND NOT (
        p0.name = 'node'
        AND p0.cwd LIKE '%/console-ui/app'
      )
      AND NOT (
        p0.name = 'ruby'
        AND p0.cmdline LIKE '%brew.rb upgrade'
      )
      AND NOT (
        p0.name = 'terraform-ls'
        AND p0.cmdline LIKE 'terraform-ls serve%'
      )
      AND NOT (
        p0.name = ""
        AND p1.name = "nvim"
      )
      AND NOT p0.path LIKE "%/terraform-provider-%"
      AND NOT p0_cmd LIKE '%/gcloud.py components update'
      AND NOT (
        p0.path LIKE '/home/%/Apps/PhpStorm%/jbr/bin/java'
      )
      AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
    GROUP BY
      p0.pid
  tags: transient, process
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Currently running program with Linux red flags
  discard_data: false
  interval: 7200
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - exfil - yara-exec-connect-process-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Currently running program with Linux red flags
    --
    -- reference:
    --   * bpfdoor (old)
    --
    -- tags: persistent
    -- interval: 7200
    -- platform: linux
    SELECT
      yara.strings,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN yara ON p0.path = yara.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > (strftime('%s', 'now') - 7200)
          AND path != ""
        GROUP BY
          path
      )
      AND yara.sigrule = '
        rule syscalls {
        strings:
            $inet_ntoa = "inet_ntoa"
            $listen = "listen"
            $connect = "connect"
            $execve = "execve"
        condition:
            filesize < 10MB and $execve in (0..8192) and 2 of them
    }'
      AND yara.count > 0
      AND yara.path NOT IN (
        '/usr/sbin/auditd',
        '/usr/lib/git-core/git-remote-https',
        '/usr/bin/sudo',
        '/usr/bin/dbus-broker-launch',
        '/usr/sbin/mcelog'
      )
  tags: persistent
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Rust Program that uses both HTTP and Exec
  discard_data: false
  interval: 7200
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - exfil - yara-unexpected-rust-http-exec-process
  observer_can_run: false
  platforms: posix
  query: |
    -- Rust Program that uses both HTTP and Exec
    -- tags: persistent
    -- interval: 7200
    -- platform: posix
    SELECT
      yara.*,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN yara ON p0.path = yara.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > (strftime('%s', 'now') - 7200)
          AND path != ""
        GROUP BY
          path
      )
      AND yara.sigrule = '
        rule http_exec {
        strings:
            $http_proxy = "HTTP_PROXY" ascii
            $process_unix = "process_unix.rs" ascii
        condition:
            all of them
    }'
      AND yara.count > 0
      AND p0.name NOT IN (
        'atuin',
        'Cody',
        'deno',
        'DevPod',
        'fig-darwin-universal',
        'figma_agent',
        'nvim',
        'old',
        'OrbStack Helper',
        'sg-nvim-agent',
        'stable',
        'wezterm-gui',
        'zed'
      )
      AND p0.name NOT LIKE 'cody-engine-%'
      AND p0.path NOT LIKE '/Users/%/.cargo/bin/%'
      AND p0.path NOT IN (
        '/Applications/safeqclient.app/Contents/MacOS/safeqclient',
        '/Applications/Zed.app/Contents/MacOS/Zed',
        '/Library/safeqclientcore/bin/safeqclientcore'
      )
  tags: persistent
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Files where the timestamp falls along 12-hour boundaries - probably
    caused by 'touch <date>0000'
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - impact - evenly-timestomped
  observer_can_run: false
  platforms: linux
  query: |
    -- Files where the timestamp falls along 12-hour boundaries - probably caused by 'touch <date>0000'
    --
    -- false positives:
    --   * 1 in 43200 chance per binary
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/006/ (Indicator Removal on Host: Timestomp)
    --
    -- tags: persistent seldom filesystem
    -- platform: linux
    SELECT
      file.path,
      DATETIME(file.mtime, 'unixepoch', 'localtime') AS mod_time,
      DATETIME(file.atime, 'unixepoch', 'localtime') AS access_time,
      file.inode,
      file.type,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE "/bin/%%"
        OR file.path LIKE "/etc/%%"
        OR file.path LIKE "/sbin/%%"
        OR file.path LIKE "/lib/%%"
        OR file.path LIKE "/usr/%%"
      )
      -- This timestamp is in UTC
      AND file.mtime > (strftime('%s', 'now') - (86400 * 720))
      AND file.mtime % 3600 = 0
      AND file.type = 'regular'
      -- Narrow down to specific offsets in the users local timezone (there should be a better way!)
      AND (
        mod_time LIKE "% 12:00:00"
        OR mod_time LIKE "% 00:00:00"
      )
      -- false positives
      AND filename NOT IN (
        'master.passwd',
        'COPYING',
        'debian_version',
        'NEWS',
        '_libinput',
        'printcap',
        'strace-log-merge',
        'installer-info.json'
      )
      AND file.path NOT LIKE '%/lynis%'
      AND file.path NOT LIKE '%/yelp-xsl%'
      AND file.path NOT LIKE '/etc/cups/%'
      AND file.path NOT LIKE '/usr/share/libinput/%.quirks'
      AND file.path NOT LIKE '/usr/lib64/electron/locales/%.pak'
  tags: persistent, seldom, filesystem
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected /etc/hosts entries
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - impact - unexpected-etc-hosts
  observer_can_run: false
  platforms: ''
  query: |
    -- Unexpected /etc/hosts entries
    --
    -- false positives:
    --   * developers adding entries for their own use
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1565/001/ (Data Manipulation: Stored Data Manipulation)
    --
    -- tags: persistent seldom filesystem net
    SELECT
      *
    FROM
      etc_hosts
    WHERE
      hostnames NOT IN (
        'localhost',
        'localhost ip6-localhost ip6-loopback',
        'localhost localhost.localdomain localhost4 localhost4.localdomain4',
        'ip6-allnodes',
        'ip6-allrouters',
        'kubernetes'
      )
      AND address NOT IN (
        '::1',
        'ff02::1',
        'ff02::2',
        '255.255.255.255',
        'fe00::0',
        'ff00::0'
      )
      AND address NOT LIKE '127.%'
      AND address NOT LIKE '172.%'
      AND address NOT LIKE '192.168.%'
      AND address NOT LIKE '10.%'
      AND hostnames NOT LIKE 'localhost.%'
      AND hostnames NOT LIKE '%k8s%'
      AND hostnames NOT LIKE '%.svc'
      AND hostnames NOT LIKE '%.%-%.%.dev'
      AND hostnames NOT LIKE '%local%'
      AND hostnames NOT LIKE '%.wtf'
      AND hostnames NOT LIKE '%.test'
      AND hostnames NOT LIKE '%.internal'
      AND hostnames NOT LIKE '%.local'
      AND hostnames NOT LIKE "%.cloud"
      AND hostnames NOT LIKE 'ip6-%'
      AND hostnames NOT LIKE "%.example.com"
  tags: persistent, seldom, filesystem, net
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Look for sketchy download files based on keywords
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - initial_access - sketchy-download-name
  observer_can_run: false
  platforms: darwin
  query: |
    -- Look for sketchy download files based on keywords
    --
    -- references:
    --   - https://www.sentinelone.com/blog/macos-metastealer-new-family-of-obfuscated-go-infostealers-spread-in-targeted-attacks/
    --
    -- tags: persistent filesystem
    -- platform: darwin
    SELECT
      file.filename,
      REGEX_MATCH (file.filename, '.*\.(.*?)$', 1) AS extension,
      magic.data,
      hash.sha256,
      ea.value AS download_url,
      signature.authority AS s_auth,
      signature.identifier AS s_id
    FROM
      file
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN extended_attributes ea ON file.path = ea.path
      AND ea.key = "where_from"
      LEFT JOIN signature ON file.path = signature.path
    WHERE
      file.path LIKE "/Users/%/Downloads/%"
      -- Frequently targetted extension for InfoStealer attacks
      AND extension IN ('dmg', 'exe', 'rar', 'pkg')
      AND (
        file.filename LIKE "%Adobe Photoshop%"
        OR file.filename LIKE "%.app%"
        OR file.filename LIKE "%Advertising%"
        OR file.filename LIKE "%agreement%"
        OR file.filename LIKE "%animated%"
        OR file.filename LIKE "%Brief%"
        OR file.filename LIKE "%confidentiality%"
        OR file.filename LIKE "%conract%"
        OR file.filename LIKE "%contract%"
        OR file.filename LIKE "%cover%"
        OR file.filename LIKE "%crack%"
        OR file.filename LIKE "%description%"
        OR file.filename LIKE "%Flash%"
        OR file.filename LIKE "%resume%"
        OR file.filename LIKE "cv%"
        OR file.filename LIKE "%cv"
        OR file.filename LIKE "%curriculum%"
        OR file.filename LIKE "%freyavr%"
        OR file.filename LIKE "%game%"
        OR file.filename LIKE "%immediate%"
        OR file.filename LIKE "%logos%"
        OR file.filename LIKE "%official%"
        OR file.filename LIKE "%pdf%"
        OR file.filename LIKE "%Player%"
        OR file.filename LIKE "%poster%"
        OR file.filename LIKE "%presentation%"
        OR file.filename LIKE "%receipt%"
        OR file.filename LIKE "%reference%"
        OR file.filename LIKE "%terms%"
        OR file.filename LIKE "%secret%"
        OR file.filename LIKE "%confidential%"
        OR file.filename LIKE "%trading%"
        OR file.filename LIKE "%Update%"
        OR file.filename LIKE "%weed%"
      )
      -- False positives
      AND NOT (
        file.filename LIKE "LogiPresentation%.dmg"
        OR file.filename = "googlesoftwareupdate.dmg"
        OR file.filename LIKE "pdftk_server-%-win-setup.exe"
        OR file.filename LIKE "PioneerDriveUpdaterBDR%.dmg"
        OR file.filename LIKE "%MacVim%.dmg"
        OR file.filename LIKE 'CalDigit_%_PD_Firmware_Updater_v%_Mac.dmg'
        OR file.filename LIKE 'TS%-Thunderbolt-Firmware-Updater-Uninstaller.dmg'
        OR file.filename LIKE 'PA Lottery Player Location Check%.dmg'
      )
  tags: persistent, filesystem
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Look for sketchy mounted disk images, inspired by Shlayer
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - initial_access - sketchy-mounted-diskimage
  observer_can_run: false
  platforms: darwin
  query: |
    -- Look for sketchy mounted disk images, inspired by Shlayer
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1566/001/ (Phishing: Spearphishing Attachment)
    --   * https://attack.mitre.org/techniques/T1204/002/ (User Execution: Malicious File)
    --   * https://www.crowdstrike.com/blog/how-crowdstrike-uncovered-a-new-macos-browser-hijacking-campaign/
    --
    -- tags: transient volume filesystem
    -- platform: darwin
    SELECT
      RTRIM(file.path, '/') AS f,
      file.bsd_flags AS f_flags,
      file.gid AS f_gid,
      file.mode AS f_mode,
      file.size AS f_size,
      file.type AS f_type,
      REGEX_MATCH (file.filename, '.*\.(.*?)$', 1) AS f_ext,
      file.uid AS f_uid,
      hash.sha256 AS f_sha256,
      magic.data AS f_data,
      mdfind.path AS probable_source,
      mdhash.sha256 AS probable_source_sha256,
      ea.value AS probable_url,
      REGEX_MATCH (file.path, '/Volumes/(.*?)/', 1) AS vol_name,
      signature.authority AS s_auth,
      signature.identifier AS s_id
    FROM
      file
      LEFT JOIN mdfind ON mdfind.query = "kMDItemFSName == '*" || REGEX_MATCH (file.path, '/Volumes/(\w+)', 1) || "*.dmg'"
      LEFT JOIN extended_attributes ea ON mdfind.path = ea.path
      AND ea.key = 'where_from'
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN hash mdhash ON mdfind.path = mdhash.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE
      file.path IN (
        SELECT DISTINCT
          file.path
        FROM
          block_devices
          JOIN mounts ON mounts.device = block_devices.name
          JOIN file ON file.directory = mounts.path
          OR file.directory LIKE mounts.path || "/%.app/Contents/MacOS/"
          OR file.directory LIKE mounts.path || "/%.app/Contents/Resources/"
          OR file.directory LIKE mounts.path || "/%/%.app/Contents/MacOS/"
          OR file.directory LIKE mounts.path || "/%/%.app/Contents/Library/LaunchServices"
          OR file.directory LIKE mounts.path || "/%/%.app/Contents/Resources/"
        WHERE
          model = 'Disk Image'
          AND parent != ""
          AND mounts.path LIKE "/Volumes/%"
          -- osquery will traverse symlinks, this prevents following symlinks to /Applications (poorly)
          AND file.path NOT LIKE "/Volumes/%/Applications/%"
          AND file.path NOT LIKE "/Volumes/%/ /%"
          AND NOT (
            file.type != "regular"
            AND file.directory LIKE '%/Contents/Resources/'
          )
      )
      AND (
        --   Rule 0. App binaries that are hidden, like WnBJLaF/1302.app/Contents/MacOS/1302 (1302.app)
        (
          file.directory LIKE '/Volumes/%/Contents/MacOS'
          AND file.bsd_flags = "HIDDEN"
        ) --   Rule 1. App binaries that are a thin shell script wrapper for another resource (Player_009.app, 1302.app)
        OR (
          file.directory LIKE '/Volumes/%/Contents/MacOS'
          AND file.mode LIKE "%7%"
          AND file.type != 'directory'
          AND magic.data LIKE '%script%'
          AND signature.identifier != 'net.snowflake.snowsql'
          AND signature.authority NOT IN (
            'Developer ID Application: Allen Bai (97DN42T837)',
            'Developer ID Application: BlueStack Systems, Inc. (QX5T8D6EDU)',
            'Developer ID Application: Galvanix (5BRAQAFB8B)'
          )
        ) -- Rule 2. App binaries that have mixed-caps names such as LYwjtu0sc3XqkNVbQe_gM4YiRpmgUpRIew or yWnBJLaF (AdobeFlashPlayer_567.app)
        OR (
          file.mode LIKE "%7%"
          AND file.type != 'directory'
          AND REGEX_MATCH (file.filename, '([a-z]+[A-Z][A-Z]+[a-z]+)', 1) != ""
          AND magic.data LIKE "%executable%"
          -- Some people do weird things!
          AND signature.authority NOT IN (
            'Software Signing',
            'Developer ID Application: Atlassian Pty Ltd (UPXU4CQZ5P)',
            'Developer ID Application: MacroMates Ltd. (45TL96F76G)',
            'Developer ID Application: Logitech Inc. (QED4VVPZWA)'
          )
        ) -- Rule 3. App binaries with a numerical name, such as 2829030009 (Player_009.app)
        OR (
          file.mode LIKE "%7%"
          AND file.type != 'directory'
          AND REGEX_MATCH (file.filename, '^(\d)+$', 1) != ""
        ) --   4. App resources that are Mach-O binaries, such as 2829030009, or enc (Player_009.app, AdobeFlashPlayer_567.app)
        OR (
          file.directory LIKE '/Volumes/%/Resources'
          AND magic.data LIKE '%executable%'
          AND f_ext NOT IN ('py', 'sh', 'metallib')
        ) --   5. Volumes with a name containing suspicious names: Player, Flash, Update
        OR (
          (
            vol_name LIKE "Install%"
            -- The rest are synced with sketchy-download-names
            OR vol_name LIKE "%.app%"
            OR vol_name LIKE "%AnyDesk%"
            OR vol_name LIKE "%Advertising%"
            OR vol_name LIKE "%agreement%"
            OR vol_name LIKE "%animated%"
            OR vol_name LIKE "%Brief%"
            OR vol_name LIKE "%confidentiality%"
            OR vol_name LIKE "%conract%"
            OR vol_name LIKE "%contract%"
            OR vol_name LIKE "%cover%"
            OR vol_name LIKE "%crack%"
            OR vol_name LIKE "%description%"
            OR vol_name LIKE "%Flash%"
            OR vol_name LIKE "%resume%"
            OR vol_name LIKE "cv%"
            OR vol_name LIKE "%cv"
            OR vol_name LIKE "%curriculum%"
            OR vol_name LIKE "%freyavr%"
            OR vol_name LIKE "%game%"
            OR vol_name LIKE "%immediate%"
            OR vol_name LIKE "%logos%"
            OR vol_name LIKE "%official%"
            OR vol_name LIKE "%pdf%"
            OR vol_name LIKE "%Player%"
            OR vol_name LIKE "%poster%"
            OR vol_name LIKE "%presentation%"
            OR vol_name LIKE "%receipt%"
            OR vol_name LIKE "%secret%"
            OR vol_name LIKE "%confidential%"
            OR vol_name LIKE "%reference%"
            OR vol_name LIKE "%terms%"
            OR vol_name LIKE "%trading%"
            OR vol_name LIKE "%Update%"
            OR vol_name LIKE "%weed%"
          )
          AND file.directory LIKE "/Volumes/%/Contents/MacOS"
          AND signature.authority NOT IN (
            "Developer ID Application: Bookry Ltd (4259LE8SU5)",
            "Developer ID Application: Justin Clift (C34AV33YLK)",
            "Developer ID Application: Logitech Inc. (QED4VVPZWA)",
            "Developer ID Application: Oracle America, Inc. (VB5E2TV963)",
            "Developer ID Application: Orbital Labs, LLC (U.S.) (HUAQ24HBR6)",
            "Developer ID Application: VideoLAN (75GAHG3SZQ)"
          )
        ) --   6. Volumes containing a hidden top-level folder or binary, such as yWnBJLaF (1302.app)
        OR (
          file.bsd_flags = "HIDDEN"
          AND (
            file.mode LIKE "%7%"
            OR file.mode LIKE "%5%"
            OR file.mode LIKE "%1%"
          )
          AND file.filename NOT IN (
            '.Trashes',
            '.background',
            '.VolumeIcon.icns',
            '.TemporaryItems'
          )
          -- Brother Printer Utilities
          AND f != '/Volumes/brotherwdswML_nonPanel/MacResources'
          AND file.filename NOT LIKE '%.previous'
          AND file.filename NOT LIKE '%.interrupted'
          AND signature.authority != 'Developer ID Application: Google LLC (EQHXZ8M8AV)'
          AND file.filename NOT LIKE '%.backup'
        ) --   7. Volumes containing a top-level symlink to something other than /Applications, such as yWnBJLaF (1302.app)
        OR (
          file.symlink = 1
          AND magic.data NOT IN (
            '/Library/Application Support/Apple/Safari/SafariForWebKitDevelopment',
            'symbolic link to .',
            'symbolic link to /Applications',
            'symbolic link to /Applications/',
            'symbolic link to ../Resources/public',
            'symbolic link to steam_osx'
          )
          -- emacs
          AND magic.data NOT LIKE 'symbolic link to bin-x86%'
          AND magic.data NOT LIKE 'symbolic link to /Users/%/My Drive'
          -- Docker
          AND magic.data NOT LIKE 'cannot open%'
        )
      )
    GROUP BY
      file.path;
  tags: transient, volume, filesystem
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Surface ISO/DMG disk images that have suspicious names
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - initial_access - unexpected-diskimage-name-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Surface ISO/DMG disk images that have suspicious names
    --
    -- references:
    --   * https://objective-see.org/blog/blog_0x4E.html
    --
    -- false positives:
    --   * unknown
    --
    -- platform: darwin
    -- tags: persistent filesystem spotlight
    SELECT
      file.path,
      file.size,
      datetime(file.btime, 'unixepoch') AS file_created,
      magic.data,
      hash.sha256,
      signature.identifier,
      signature.authority,
      ea.value AS url,
      REGEX_MATCH (ea.value, '/[\w_-]+\.([\w\._-]+)[:/]', 1) AS domain,
      REGEX_MATCH (ea.value, '/([\w_-]+\.[\w\._-]+)[:/]', 1) AS host
    FROM
      mdfind
      LEFT JOIN file ON mdfind.path = file.path
      LEFT JOIN hash ON mdfind.path = hash.path
      LEFT JOIN extended_attributes ea ON mdfind.path = ea.path
      LEFT JOIN magic ON mdfind.path = magic.path
      LEFT JOIN signature ON mdfind.path = signature.path
    WHERE
      (
        mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.iso'"
        OR mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.dmg'"
        OR mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.pkg'"
      )
      AND ea.key = 'where_from'
      AND file.btime > (strftime('%s', 'now') -86400)
      AND (
        file.filename LIKE 'Installer.%'
        OR file.filename LIKE '%Player.%'
        OR file.filename LIKE '% AIR %'
        OR file.filename LIKE '%Flash%'
        OR file.filename LIKE '%Resume%'
      )
    GROUP BY
      ea.value
  tags: persistent, filesystem, spotlight
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Surface ISO/DMG disk images that were downloaded from unexpected places
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - initial_access - unexpected-diskimage-source-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Surface ISO/DMG disk images that were downloaded from unexpected places
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1566/001/ (Phishing: Spearphishing Attachment)
    --   * https://attack.mitre.org/techniques/T1204/002/ (User Execution: Malicious File)
    --   * https://unit42.paloaltonetworks.com/chromeloader-malware/
    --
    -- false positives:
    --   * disk images downloaded from a location not in the exception list
    --
    -- platform: darwin
    -- tags: persistent filesystem spotlight often
    SELECT
      file.path,
      file.size,
      datetime(file.btime, 'unixepoch') AS file_created,
      magic.data,
      hash.sha256,
      signature.identifier,
      signature.authority,
      ea.value AS url,
      REGEX_MATCH (ea.value, '/[\w_-]+\.([\w\._-]+)[:/]', 1) AS domain,
      REGEX_MATCH (ea.value, '/([\w_-]+\.[\w\._-]+)[:/]', 1) AS host
    FROM
      mdfind
      LEFT JOIN file ON mdfind.path = file.path
      LEFT JOIN hash ON mdfind.path = hash.path
      LEFT JOIN extended_attributes ea ON mdfind.path = ea.path
      LEFT JOIN magic ON mdfind.path = magic.path
      LEFT JOIN signature ON mdfind.path = signature.path
    WHERE
      (
        mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.iso'"
        OR mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.dmg'"
        OR mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.pkg'"
      )
      AND ea.key = 'where_from'
      AND file.btime > (strftime('%s', 'now') -86400)
      AND domain NOT IN (
        'adobe.com',
        'akmedia.digidesign.com',
        'alfredapp.com',
        'amazon.com',
        'android.com',
        'apple.com',
        'arc.net',
        'asana.com',
        'balena.io',
        'balsamiq.com',
        'bblmw.com',
        'bluestacks.com',
        'box.com',
        'brave.com',
        'canon.co.uk',
        'cdn.mozilla.net',
        'charlesproxy.com',
        'cloudfront.net',
        'cron.com',
        'csclub.uwaterloo.ca',
        'c-wss.com',
        'descript.com',
        'digidesign.com',
        'discordapp.net',
        'discord.com',
        'dl.sourceforge.net',
        'docker.com',
        'dogado.de',
        'download.prss.microsoft.com',
        'duckduckgo.com',
        'eclipse.org',
        'emeet.com',
        'epson.com',
        'fcix.net',
        'gaomon.net',
        'getutm.app',
        'gimp.org',
        'github.io',
        'githubusercontent.com',
        'google.ca',
        'grammarly.com',
        'integodownload.com',
        'irccloud.com',
        'jetbrains.com',
        'live.com',
        'kagi.com',
        'libreoffice.org',
        'logitech.com',
        'loom.com',
        'macbartender.com',
        'microsoft.com',
        'minecraft.net',
        'mirrorservice.org',
        'mojang.com',
        'mozilla.org',
        'mutedeck.com',
        'mysql.com',
        'notion.so',
        'notion-static.com',
        'ocf.berkeley.edu',
        'oobesaas.adobe.com',
        'openra.net',
        'oracle.com',
        'osuosl.org',
        'perforce.com',
        'pqrs.org',
        'prusa3d.com',
        'remarkable.com',
        'rewind.ai',
        's3.amazonaws.com',
        'securew2.com',
        'signal.org',
        'skype.com',
        'slack.com',
        'slack-edge.com',
        'stclairsoft.com',
        'steampowered.com',
        'synaptics.com',
        'tableplus.com',
        'teams.cdn.office.net',
        'techsmith.com',
        'ubuntu.com',
        'umd.edu',
        'usa.canon.com',
        'uubyte.com',
        'vc.logitech.com',
        'vimcal.com',
        'virtualbox.org',
        'vmware.com',
        'warp.dev',
        'webex.com',
        'whatsapp.com',
        'xtom.com',
        'yubico.com',
        'zoo.dev',
        'zoomgov.com',
        'zoom.us',
        'zsa.io'
      )
      -- NOTE: Do not put all of storage.googleapis.com or similarly generic hosts here
      AND host NOT IN (
        'adoptium.net',
        'arc.net',
        'asana.com',
        'balsamiq.com',
        'bearly.ai',
        'brave.com',
        'calibre-ebook.com',
        'cron.com',
        'discord.com',
        'dl.discordapp.net',
        'dl.google.com',
        'duckduckgo.com',
        'dygma.com',
        'emacsformacosx.com',
        'epson.com',
        'figma.com',
        'flipperzero.one',
        'getkap.co',
        'github.com',
        'go.dev',
        'kittycad.io',
        'krisp.ai',
        'evernote.com',
        'mail.google.com',
        'manual.canon',
        'mimestream.com',
        'mnvoip.mm.fcix.net',
        'mutedeck.com',
        'obdev.at',
        'awscli.amazonaws.com',
        'obsidian.md',
        'universal-blue.discourse.group',
        'obsproject.com',
        'opalcamera.com',
        'posit.co',
        'presenting.app',
        'proton.me',
        'rancherdesktop.io',
        'rectangleapp.com',
        'stclairsoft.s3.amazonaws.com',
        'store.steampowered.com',
        'tableplus.com',
        'textexpander.com',
        'ubuntu.com',
        'warp-releases.storage.googleapis.com',
        'wavebox.io',
        'www.google.com',
        'www.messenger.com',
        'zed.dev',
        'zoom.us'
      )
      -- Yes, these are meant to be fairly broad.
      AND host NOT LIKE 'download%'
      AND host NOT LIKE 'cdn%'
      AND host NOT LIKE '%.cdn.%.com'
      AND host NOT LIKE '%.edu'
      AND host NOT LIKE 'github-production-release-asset-%.s3.amazonaws.com'
      AND host NOT LIKE '%.org'
      AND host NOT LIKE 'dl.%'
      AND host NOT LIKE 'dl-%'
      AND host NOT LIKE 'mirror%'
      AND host NOT LIKE 'driver.%'
      AND host NOT LIKE 'support%'
      AND host NOT LIKE 's3.%.amazonaws.com'
      AND host NOT LIKe '%.s3.%.amazonaws.com'
      AND host NOT LIKE 'software%'
      AND host NOT LIKE 'www.google.%'
      AND host NOT LIKE '%release%.storage.googleapis.com'
      AND NOT (
        host LIKE '%.fbcdn.net'
        AND (
          file.filename LIKE 'Messenger.%.dmg'
          OR file.filename LIKE '%WhatsApp.dmg'
        )
      )
      AND ea.value NOT LIKE 'https://storage.googleapis.com/copilot-mac-releases/%'
    GROUP BY
      ea.value
  tags: persistent, filesystem, spotlight, often
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected process that spawns shell processes (event-based)
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - initial_access - unexpected-shell-parent-events
  observer_can_run: false
  platforms: posix
  query: |
    -- Unexpected process that spawns shell processes (event-based)
    --
    -- false positives:
    --   * IDE's
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1059/ (Command and Scripting Interpreter)
    --   * https://attack.mitre.org/techniques/T1204/002/ (User Execution: Malicious File)
    --
    -- tags: process events
    -- interval: 300
    -- platform: posix
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p1.euid, pe1.euid) AS p1_euid,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -300)
      AND pe.cmdline != ''
      AND pe.parent > 0
      AND p0_name IN ('sh', 'fish', 'zsh', 'bash', 'dash')
      AND NOT (
        p1_name IN (
          'abrt-handle-eve',
          'alacritty',
          'at-spi-bus-launcher',
          'bash',
          'build-script-build',
          'chainctl',
          'chezmoi',
          'clang-11',
          'code',
          'Code Helper (Renderer)',
          'Code - Insiders Helper (Renderer)',
          'collect2',
          'com.docker.backend',
          'conmon',
          'containerd-shim',
          'containerd-shim-runc-v2',
          'cpptools',
          'dash',
          'dbus-run-session',
          'demoit',
          'direnv',
          'doas',
          'docker-credential-desktop',
          'docker-credential-gcr',
          'Docker Desktop',
          'dpkg',
          'Emacs-arm64-11',
          'env',
          'erl_child_setup',
          'find',
          'FinderSyncExtension',
          'fish',
          'gatherheaderdoc',
          'gdm3',
          'gdm-session-worker',
          'gdm-wayland-session',
          'gdm-x-session',
          'git',
          'gke-gcloud-auth-plugin',
          'gnome-session-binary',
          'gnome-shell',
          'gnome-terminal-server',
          'go',
          'goland',
          'gopls',
          'helm',
          'yacls',
          'HP Diagnose & Fix',
          'i3bar',
          'i3blocks',
          'idea',
          'java',
          'jetbrains-toolbox',
          'kitty',
          'ko',
          'konsole',
          'kubectl',
          'lightdm',
          'local-path-provisioner',
          'login',
          'MacVim',
          'make',
          'mc',
          'monorail',
          'my_print_defaults',
          'ninja',
          'nix',
          'nix-build',
          'nix-daemon',
          'nm-dispatcher',
          'node',
          'nu',
          'nvim',
          'obs',
          'package_script_service',
          'pacman',
          'perl',
          'PK-Backend',
          'provisio',
          'pulumi',
          -- 'python' - do not include this, or you won't detect supply-chain attacks.
          'ression-arm64',
          'roxterm',
          'sddm-helper',
          'sdk',
          'sdzoomplugin',
          'sh',
          'ShellLauncher',
          'skhd',
          'snyk',
          'snyk-macos',
          'sshd',
          'stable',
          'Stream Deck',
          'su',
          'sudo',
          'swift',
          'systemd',
          'systemd-sleep',
          'terminator',
          'terraform',
          'terraform-ls',
          'test2json',
          'tmux',
          'tmux:server',
          'update-notifier',
          'vi',
          'vim',
          'Vim',
          'vim.nox',
          'watch',
          'wezterm-gui',
          'xargs',
          'xcrun',
          'xfce4-terminal',
          'xinit',
          'Xorg',
          'lazygit',
          'xterm',
          'yay',
          'yum',
          'zed',
          'zellij',
          'zsh'
        )
        OR p1_name LIKE 'terraform-provider-%'
        OR p1_name LIKE 'iTermServer-%'
        -- Do not add shells to this list if you want your query to detect
        -- bad programs that were started from a shell.
        OR p2_name IN ('env', 'git')
        -- Homebrew, except we don't want to allow all of ruby
        OR p0_cmd IN (
          '/bin/bash /usr/bin/xdg-settings set default-url-scheme-handler slack Slack.desktop',
          '/bin/bash /usr/local/bin/mount-product-files',
          '/bin/sh -c black .',
          "/bin/sh -c defaults delete 'com.cisco.webexmeetingsapp'",
          '/bin/sh -c ioreg -rd1 -c IOPlatformExpertDevice',
          '/bin/sh -c lsb_release -a --short',
          '/bin/sh -c ps ax -ww -o pid,ppid,uid,gid,args',
          '/bin/sh -c scutil --get ComputerName',
          '/bin/sh -c sysctl hw.model kern.osrelease',
          '/bin/sh -c uname -m 2>/dev/null',
          '/bin/sh /usr/bin/lsb_release -a',
          '/bin/sh /usr/bin/lsb_release -a --short',
          '/bin/zsh -c ls',
          'sh -c /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -sdk /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk -find python3 2> /dev/null',
          'sh -c /bin/stty size 2>/dev/null',
          'sh -c cat /proc/sys/kernel/pid_max',
          "sh -c osascript -e 'user locale of (get system info)'",
          "sh -c pacmd list-sinks |grep 'name:\|module:'",
          'sh -c pactl --version',
          'sh -c python3.7 --version 2>&1',
          'sh -c /usr/bin/xcrun clang 2>&1',
          'sh -c xcode-select --print-path >/dev/null 2>&1 && xcrun --sdk macosx --show-sdk-path 2>/dev/null',
          '/usr/bin/python3 /usr/bin/terminator'
        )
        OR (
          p1_name = 'WhatsApp'
          -- WhatsApp grabs the serial number from people's machines :(
          AND p0_cmd = '/bin/sh -c ioreg -c IOPlatformExpertDevice -d 2'
        )
        OR (
          p1_name LIKE 'emacs-%'
          AND p1_path LIKE '%/bin/emacs%'
        )
        OR p1_cmd IN (
          '/usr/bin/python3 /usr/share/apport/apport-gtk',
          'php ./autodocs update images'
        )
        OR (
          p1_cmd LIKE '%Python% /opt/homebrew/bin/jupyter%'
          AND p0_cmd = '/bin/sh -c osascript'
        )
        OR (
          p1_name = 'osqueryd'
          AND p0_cmd LIKE '/bin/sh /etc/NetworkManager/dispatcher.d/%'
        )
        OR (
          p1_name = 'ssh'
          AND p0_cmd LIKE '%gcloud.py compute start-iap-tunnel%'
        )
        OR exception_key IN (
          'bash,0,auditd,launchd',
          'bash,0,etcd,containerd-shim-runc-v2',
          'bash,0,kube-apiserver,containerd-shim-runc-v2',
          'bash,0,mutter-x11-frames,gnome-shell',
          'bash,0,perl5.30,system_installd',
          'bash,0,pia-daemon,launchd',
          'bash,0,udevadm,udevadm',
          'bash,500,accounts-daemon,systemd',
          'bash,500,busybox,bwrap',
          'bash,500,com.docker.dev-envs,com.docker.backend',
          'bash,500,docker-builder,bash',
          'bash,500,Foxit PDF Reader,launchd',
          'bash,500,gnome-session-binary,systemd',
          'bash,500,gpg-agent,launchd',
          'bash,500,Hyprland,gdm-wayland-session',
          'bash,500,incusd,incusd',
          'bash,500,lazygit,nvim',
          'bash,500,.man-wrapped,zsh',
          'bash,500,plasmashell,systemd',
          'bash,500,Private Internet Access,launchd',
          'bash,500,ruby,zsh',
          'bash,500,script,bash',
          'bash,500,steam,bash',
          'bash,500,xdg-desktop-portal,systemd',
          'bash,500,xdg-permission-store,systemd',
          'dash,0,anacron,systemd',
          'dash,0,dpkg,apt',
          'bash,500,bwrap,bwrap',
          'dash,0,dpkg,python3.10',
          'dash,0,kindnetd,containerd-shim-runc-v2',
          'dash,0,kube-proxy,containerd-shim-runc-v2',
          'dash,0,run-parts,dash',
          'dash,0,snapd,systemd',
          'dash,500,gdm-wayland-session,gdm-session-worker',
          'dash,500,python3.12,firefox-bin',
          'sh,0,auditd,launchd',
          'sh,0,Ecamm Live,launchd',
          'sh,0,expect,kandji-daemon',
          'sh,500,cloud_sql_proxy,zsh',
          'sh,500,docs,zsh',
          'sh,500,Google Drive,launchd',
          'sh,500,LogiTune,launchd',
          'sh,500,Meeting Center,launchd',
          'sh,500,snyk-macos,snyk',
          'sh,500,splunkd,splunkd',
          'sh,500,ssh,Code Helper (Plugin)',
          'sh,500,ssh,mosh-client',
          'sh,500,updater,Foxit PDF Reader',
          'sh,500,viddy,zsh',
          'sh,500,yabai,launchd',
          'zsh,500,Hyper,launchd',
          'zsh,500,old,launchd',
          'zsh,500,old,old',
          'zsh,500,OpenLens,launchd',
          'zsh,500,pycharm,launchd',
          'zsh,500,python3.10,gnome-shell',
          'zsh,500,rubymine,launchd',
          'zsh,500,stable,launchd'
        )
        OR p0_cmd LIKE '%/bash -e%/bin/as -arch%'
        OR p0_cmd LIKE '/bin/sh -c /Applications/%'
        OR p0_cmd LIKE '%/usr/bin/python3 /usr/bin/terminator%'
        OR p0_cmd LIKE '/bin/bash %/opt/homebrew/%'
        OR p0_cmd LIKE '/bin/bash /usr/bin/xdg-settings check %'
        OR p0_cmd LIKE '/bin/bash /usr/local/Homebrew/%'
        OR p0_cmd LIKE '/bin/sh %/bin/xvim block %'
        OR p0_cmd LIKE '/bin/sh %/bin/gcloud%config config-helper%'
        OR p0_cmd LIKE '/bin/sh %/google-cloud-sdk/bin/gcloud config get project'
        OR p0_cmd LIKE '/bin/sh -c pkg-config %'
        OR p0_cmd LIKE '/bin/sh %/docker-credential-gcloud get'
        OR p0_cmd LIKE '/bin/bash %git credential-osxkeychain get'
        OR p0_cmd LIKE '/bin/sh /usr/bin/xdg-open %'
        OR p0_cmd LIKE '/bin/sh /usr/bin/xdg-settings check %'
        OR p0_cmd LIKE '/bin/sh /usr/bin/xdg-settings get %'
        OR p0_cmd LIKE '/bin/sh /usr/bin/xdg-settings set %'
        OR p0_cmd LIKE '/bin/bash /Users/%/homebrew/Library/Homebrew/shims/shared/curl %'
        OR p0_cmd LIKE '%gcloud config config-helper --format=json'
        OR p0_cmd LIKE '%gcloud config get-value%'
        OR p0_cmd LIKE '%sh -c ntia-checker %'
        OR p0_cmd LIKE '%/google-chrome% --flag-switches-begin % --product-version'
        OR p1_cmd LIKE '%/bin/pipenv shell'
        OR p1_cmd LIKE '/System/Library/Frameworks/Ruby.framework/Versions/2.6/usr/bin/ruby -W1 --disable=gems,rubyopt -- /Users/%/homebrew/Library/Homebrew/build.rb%'
        OR p1_cmd LIKE 'gcloud% auth%login%'
        OR p1_cmd LIKE '/%google-cloud-sdk/lib/gcloud.py%'
        OR p1_cmd LIKE '%/usr/bin/terminator%'
        OR (
          exception_key IN ('sh,500,ruby,zsh', 'bash,500,ruby,zsh')
          AND p1_cmd LIKE '%brew.rb'
        )
        OR (
          exception_key = 'sh,500,ruby,ruby'
          AND p1_cmd LIKE '%homebrew%'
        )
        OR p1_cmd LIKE '%Python /opt/homebrew/bin/aws configure sso'
        OR p2_cmd LIKE '/bin/bash /usr/local/bin/brew%'
        OR p2_cmd LIKE '/usr/bin/python3 -m py_compile %'
      )
      AND NOT p0_cgroup LIKE '/system.slice/docker-%'
      AND NOT p1_cgroup LIKE '/system.slice/docker-%'
      AND NOT p2_cgroup LIKE '/system.slice/docker-%'
    GROUP BY
      pe.pid
  tags: process, events
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected process that spawns shell processes (event based)
  discard_data: false
  interval: 60
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - initial_access - unexpected-shell-parents
  observer_can_run: false
  platforms: posix
  query: |
    -- Unexpected process that spawns shell processes (event based)
    --
    -- false positives:
    --   * IDE's
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1059/ (Command and Scripting Interpreter)
    --   * https://attack.mitre.org/techniques/T1204/002/ (User Execution: Malicious File)
    --
    -- tags: process events
    -- interval: 60
    -- platform: posix
    SELECT
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.name IN ('sh', 'fish', 'zsh', 'bash', 'dash')
      -- Ignore partial table joins
      AND p1_path != ''
      -- Editors & terminals mostly.
      -- I know it's tempting to list "electron" here but please find a more specific exclusion.
      AND p1.name NOT IN (
        'abrt-action-per',
        'abrt-handle-eve',
        'AGSService',
        'alacritty',
        'Alfred',
        'anacron',
        'arduino-cli',
        'auditd',
        'bash',
        'buildkit-runc',
        'build-script-build',
        'chezmoi',
        'clang-11',
        'code',
        'Code Helper (Renderer)',
        'Code - Insiders Helper',
        'Code - Insiders Helper (Renderer)',
        'collect2',
        'configure',
        'conmon',
        'containerd-shim',
        'Core Sync',
        'Cursor',
        'Cursor Helper',
        'dash',
        'demoit',
        'direnv',
        'dnf',
        'dnf-automatic',
        'doas',
        'Docker Desktop',
        'dumb-init',
        'elastic-security',
        'erl_child_setup',
        'find',
        'FinderSyncExtension',
        'fish',
        'flock',
        'gdm-wayland-ses',
        'gephi',
        'git',
        'GitKraken Helper (Renderer)',
        'git-remote-http',
        'git-remote-https',
        'gnome-session-b',
        'gnome-shell',
        'go',
        'goland',
        'GoogleSoftwareUpdateAgent',
        'GoogleUpdater',
        'helm',
        'Hyper',
        'i3bar',
        'i3blocks',
        'idea',
        'incusd',
        'inittool2',
        'java',
        'jetbrains_client',
        'kitty',
        'ko',
        'konsole',
        'kubectl',
        'kue',
        'ld',
        'lightdm',
        'linux-sandbox',
        'LogiMgrDaemon',
        'LogiTune',
        'logrotate',
        'MacVim',
        'make',
        'Microsoft.VisualStudio.Reliability.Monitor',
        'monorail',
        'newgrp',
        'ninja',
        'nix',
        'nix-build',
        'nix-daemon',
        'node',
        'nu',
        'nvim',
        'OpenLens',
        'package_script_service',
        'pacman',
        'perl',
        'pia-daemon',
        'PK-Backend',
        'provisio',
        'ptyxis-agent',
        'pycharm',
        'qcalc',
        'Rancher Desktop',
        'roxterm',
        'rpmbuild',
        'Runner.Listener',
        'Runner.Worker',
        'screen',
        'sdk',
        'sdzoomplugin',
        'sh',
        'skhd',
        'ssh',
        'sshd',
        'steam_osx',
        'swift',
        'systemd',
        'terminator',
        'terraform',
        'terraform-provi',
        'test2json',
        'timeout',
        'tmux',
        'tmux:server',
        'udev-worker',
        'unattended-upgr',
        'update-notifier',
        'vi',
        'vim',
        'vim-nox11',
        'VisualStudio',
        'watch',
        'wezterm-gui',
        'xargs',
        'xcrun',
        'xfce4-session',
        'xfce4-terminal',
        'yum',
        'zellij',
        'zsh'
      )
      AND p1_path NOT IN (
        '/Applications/Docker.app/Contents/MacOS/Docker',
        '/Applications/Docker.app/Contents/MacOS/install',
        '/Applications/Hyper.app/Contents/MacOS/Hyper',
        '/usr/bin/make',
        '/Applications/Visual Studio Code.app/Contents/MacOS/Electron',
        '/Applications/Docker.app/Contents/Resources/bin/com.docker.cli',
        '/Applications/Docker.app/Contents/Resources/bin/docker-credential-desktop',
        '/Applications/IntelliJ IDEA.app/Contents/MacOS/idea',
        '/Applications/Alfred 5.app/Contents/Preferences/Alfred Preferences.app/Contents/MacOS/Alfred Preferences',
        '/Applications/Parallels Desktop.app/Contents/MacOS/Parallels Service',
        '/Applications/Parallels Desktop.app/Contents/MacOS/prl_update_helper',
        '/Applications/RStudio.app/Contents/Resources/app/bin/rsession-arm64',
        '/Applications/Amazon Photos.app/Contents/MacOS/Amazon Photos',
        '/bin/dash',
        '/usr/bin/networksetup',
        '/bin/sh',
        '/usr/local/qualys/cloud-agent/bin/qualys-cloud-agent',
        '/Library/Application Support/Logitech.localized/LogiOptionsPlus/logioptionsplus_agent.app/Contents/MacOS/logioptionsplus_agent',
        '/Library/Developer/CommandLineTools/usr/bin/git',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateDaemon',
        '/Library/Kandji/Kandji Agent.app/Contents/MacOS/kandji-library-manager',
        '/opt/X11/libexec/launchd_startx',
        '/Applications/DDPM/DDPM.app/Contents/MacOS/DDPM',
        '/sbin/launchd',
        '/System/Library/Frameworks/Security.framework/authtrampoline',
        '/usr/bin/alacritty',
        '/usr/bin/apt',
        '/usr/sbin/networksetup',
        '/usr/bin/apt-get',
        '/usr/bin/bash',
        '/usr/bin/bwrap',
        '/usr/bin/crond',
        '/usr/bin/dash',
        '/usr/bin/dirname',
        '/usr/bin/login',
        '/usr/bin/man',
        '/usr/bin/su',
        '/usr/bin/sudo',
        '/usr/bin/sysdiagnose',
        '/usr/bin/xargs',
        '/usr/bin/zsh',
        '/usr/libexec/gdm-x-session',
        '/usr/libexec/gnome-terminal-server',
        '/usr/libexec/periodic-wrapper',
        '/usr/lib/xorg/Xorg'
      )
      AND NOT p0.cmdline IN (
        -- npm run server
        'sh -c -- exec-bin node_modules/.bin/hugo/hugo server',
        'sh -c /usr/bin/defaults write us.zoom.xos NSQuitAlwaysKeepsWindows -bool false',
        '/bin/sh -c ioreg -rd1 -c IOPlatformExpertDevice',
        '/bin/sh -c system_profiler SPDisplaysDataType | grep "Chipset Model"',
        '/usr/bin/python3 /usr/bin/terminator',
        '/bin/sh -c sysctl hw.model kern.osrelease',
        '/bin/sh /etc/security/audit_warn soft /var/audit',
        'sh -c hugo-installer --version otherDependencies.hugo --extended --destination node_modules/.bin/hugo',
        '/bin/bash -c ioreg -l -w 0 | grep SecureInput',
        "sh -c acpi -b | grep -v 'unavailable'",
        'sh -c xcode-select --print-path >/dev/null 2>&1 && xcrun --sdk macosx --show-sdk-path 2>/dev/null',
        -- Brother printer
        'sh -c ps -xcocommand,pid | grep "LOGINserver"'
      )
      AND NOT (
        p1.name = 'sshd'
        AND p0.cmdline LIKE '%askpass%'
      )
      AND NOT (
        p1.name = 'steam'
        AND p0.cmdline LIKE 'sh -c %steamwebhelper.sh%'
      )
      AND NOT (
        p1.name = 'bash'
        AND p0.cmdline LIKE 'sh -s _hostname %'
      )
      AND NOT (
        p1.cmdline LIKE 'perl%/help2man%'
        AND p0.cmdline LIKE 'sh -c man/%'
      )
      AND NOT p0.cmdline LIKE '/bin/sh %/bin/docker-credential-gcloud get'
      AND NOT p1_path LIKE '/private/var/folders/%/T/go-build%.test'
      AND NOT p1_path LIKE '/Users/%/.vscode/extensions/stateful.runme-%/bin/runme'
      AND NOT p1_path LIKE '/private/tmp/PKInstallSandbox.%/tmp/Python/Python3.framework/Versions/%/Resources/Python.app/Contents/MacOS/Python'
      AND NOT p0.cmdline LIKE '%/Library/Apple/System/Library/InstallerSandboxes%'
      AND NOT p0.cmdline LIKE '%gcloud config config-helper%'
      AND NOT p0.cmdline LIKE '%hugo/hugo server%'
      AND NOT p1.cmdline LIKE '%/bin/pytest %'
      AND NOT p0.cmdline LIKE '%/bin/codeclimate %'
      AND NOT p0.cmdline LIKE '%/ChromeRecovery --browser-version=%'
      AND NOT p1.cmdline LIKE '/Applications/Warp.app/%'
      AND NOT p1.cmdline IN ('npm run start', 'npm install')
      AND NOT p1.cmdline LIKE '%brew.rb%'
      AND NOT p1.cmdline LIKE '%/Homebrew/build.rb%'
      AND NOT p1.cmdline LIKE '%Code Helper%'
      AND NOT p1.cmdline LIKE '%Code - Insiders Helper%'
      AND NOT p1.cmdline LIKE '%gcloud.py config config-helper%'
      AND NOT p1.cmdline LIKE '/usr/lib/electron19/electron /usr/lib/code/out/bootstrap-fork --type=ptyHost --logsPath /home/%/.config/Code - OSS/logs/%'
      AND NOT p1.name LIKE '%term%'
      AND NOT p1.name LIKE '%Term%'
      AND NOT p1.name LIKE 'Emacs%'
      AND NOT p1.name LIKE 'terraform-prov%'
      AND NOT p1.path LIKE '/Users/%/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateAgent.app/Contents/MacOS/GoogleSoftwareUpdateAgent'
      -- Oh, NixOS.
      AND NOT p1.name LIKE '%/bin/bash'
      AND NOT p1.name LIKE '%/bin/direnv'
      AND NOT p1_path LIKE '/nix/store/%sh'
      AND NOT p1_path LIKE '/opt/homebrew/%'
      AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
      AND NOT p0.cgroup_path LIKE '/system.slice/system.slice:docker:%'
  tags: process, events
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Scan removable volumes for sketchy files
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - initial_access - unexpected-volume-contents
  observer_can_run: false
  platforms: darwin
  query: |
    -- Scan removable volumes for sketchy files
    --
    -- false positives:
    --   * Installer packages with hidden files
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1566/001/ (Phishing: Spearphishing Attachment)
    --   * https://attack.mitre.org/techniques/T1204/002/ (User Execution: Malicious File)
    --   * https://www.crowdstrike.com/blog/how-crowdstrike-uncovered-a-new-macos-browser-hijacking-campaign/
    --
    -- tags: transient volume filesystem seldom
    -- platform: darwin
    SELECT
      RTRIM(file.path, '/') AS trimpath,
      uid,
      filename,
      gid,
      mode,
      REGEX_MATCH (file.path, '(.*)/', 1) AS dirname,
      REGEX_MATCH (RTRIM(file.path, '/'), '.*/(.*?)$', 1) AS basename,
      REGEX_MATCH (RTRIM(file.path, '/'), '.*\.(.*?)$', 1) AS extension,
      mtime,
      ctime,
      symlink,
      type,
      size,
      hash.sha256,
      magic.data,
      signature.identifier,
      signature.authority
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE
      (
        file.path LIKE '/Volumes/%/%'
        OR file.path LIKE '/Volumes/%/.%'
      )
      AND file.path NOT LIKE '/Volumes/Macintosh HD%'
      AND file.path NOT LIKE '/Volumes/%/.com.apple.timemachine%'
      AND (
        extension IN (
          'command',
          'lnk',
          'gcode',
          'mpkg',
          'pkg',
          'scpt',
          'dmg',
          'iso',
          'gz',
          'sh',
          'sql'
        )
        OR file.symlink != 0
        OR basename LIKE '.%'
        OR basename LIKE '%.sql%'
        OR basename LIKE '%Chrome%'
        OR basename LIKE '%Extension%'
        OR basename LIKE '%enforce%'
        OR basename LIKE '%hidden%'
        OR basename LIKE '%Installer%'
        OR basename LIKE '%mono%'
        OR basename LIKE '%secret%'
        OR basename LIKE '%sql%'
        OR basename LIKE '%guard%'
        OR basename LIKE 'cg%'
      ) -- exceptions go here
      AND basename NOT IN (
        '.',
        '..',
        '.CFUserTextEncoding',
        '.DS_Store',
        '.TemporaryItems',
        '.Trashes',
        '.VolumeIcon.icns',
        '._.TemporaryItems',
        '._.Trashes',
        '._.apdisk',
        '._AUTORUN.INF',
        '._Id.txt',
        '.actrc',
        '.angular-config.json',
        '.apdisk',
        '.background',
        '.background.png',
        '.background.tiff',
        '.bash_history',
        '.bashrc',
        '.dbshell',
        '.disk_label',
        '.disk_label_2x',
        '.file',
        '.file-revisions-by-id',
        '.flyrc',
        '.gitconfig',
        '.iotest',
        '.keystone_install',
        '.lesshst',
        '.metadata_never_index_unless_rootfs',
        '.mysql_history',
        '.pdfbox.cache',
        '.shortcut-targets-by-id',
        '.vol',
        '.zsh_history',
        'KBFS_NOT_RUNNING',
        'LogiPresentation Installer.app',
        'Seagate Dashboard Installer.exe',
        'UFRII_LT_LIPS_LX_Installer.pkg',
        'pve-installer.squashfs'
      )
      AND authority NOT IN (
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: BlueStack Systems, Inc. (QX5T8D6EDU)',
        'Developer ID Application: Canon Inc. (XE2XNRRXZ5)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)'
      ) -- Unsigned programs here
      AND trimpath NOT IN (
        '/Volumes/Google Chrome/.keystone_install',
        '/Volumes/Google Chrome Canary/.keystone_install',
        '/Volumes/macFUSE/Install macFUSE.pkg',
        '/Volumes/macFUSE/.engine_install',
        '/Volumes/Garmin Express/Install Garmin Express.pkg',
        '/Volumes/PMHOME_3601DL/PMH_INST.pkg',
        '/Volumes/Jabra Direct Setup/JabraDirectSetup.pkg'
      )
      AND trimpath NOT LIKE '/Volumes/JDK %/JDK %.pkg'
      AND trimpath NOT LIKE '/Volumes/Splunk %/Install Splunk'
      AND trimpath NOT LIKE '/Volumes/Google Earth Pro%/Install Google Earth Pro%.pkg'
      AND trimpath NOT LIKE '/Volumes/mysql-shell-%/mysql-shell-%.pkg'
      AND trimpath NOT LIKE '/Volumes/Blackmagic DaVinci Resolve/Install Resolve %.pkg'
      AND magic.data NOT LIKE 'ASCII text%'
      AND NOT (
        magic.data = 'AppleDouble encoded Macintosh file'
        AND basename LIKE '._%'
      )
  tags: transient, volume, filesystem, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Surface webmail downloads of an unexpected sort
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - initial_access - unexpected-webmail-downloads
  observer_can_run: false
  platforms: darwin
  query: |
    -- Surface webmail downloads of an unexpected sort
    --
    -- false positives:
    --   * Files without an extension or extensions not explicitly added to the allow list
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1566/001/ (Phishing: Spearphishing Attachment)
    --
    -- platform: darwin
    -- tags: persistent filesystem spotlight
    SELECT
      file.path,
      file.size,
      datetime(file.btime, 'unixepoch') AS file_created,
      magic.data,
      hash.sha256,
      s.authority,
      s.identifier,
      LOWER(
        REGEX_MATCH (RTRIM(file.path, '/'), '.*\.(.*?)$', 1)
      ) AS extension
    FROM
      mdfind
      LEFT JOIN file ON mdfind.path = file.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN signature s ON file.path = s.path
    WHERE
      mdfind.query = 'kMDItemWhereFroms == ''*https://mail.google.com/*'''
      AND file.btime > (strftime('%s', 'now') -86400)
      -- Extensions that would not normally raise suspicion if sent by e-mail (excludes dmg, iso, lnk, exe)
      AND extension NOT IN (
        'ai',
        'cer',
        'csv',
        'doc',
        'Dockerfile',
        'docx',
        'dwg',
        'eml',
        'eps',
        'gif',
        'heic',
        'htm',
        'html',
        'icloud',
        'jfif',
        'jpeg',
        'jpg',
        'json',
        'key',
        'mov',
        'mp3',
        'mp4',
        'mpeg',
        'mpg',
        'numbers',
        'ods',
        'odt',
        'pages',
        'pdf',
        'pem',
        'pgp',
        'png',
        'potx',
        'ppt',
        'pptx',
        'pub',
        'rtf',
        'svg',
        'tif',
        'tiff',
        'txt',
        'wav',
        'webp',
        'xls',
        'xlsm',
        'xlsx',
        'xml',
        'yml',
        'yaml',
        'zip'
      )
  tags: persistent, filesystem, spotlight
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: 'tags: volume filesystem seldom'
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - initial_access - yara-recently-downloaded-miner
  observer_can_run: false
  platforms: ''
  query: |
    -- tags: volume filesystem seldom
    SELECT
      file.path,
      file.size,
      file.btime,
      file.ctime,
      file.mtime,
      magic.data,
      hash.sha256
    FROM
      file
      JOIN yara ON file.path = yara.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      file.path IN (
        SELECT
          path
        FROM
          file
        WHERE
          (
            file.path LIKE '/home/%/Downloads/%'
            OR file.path LIKE '/home/%/Downloads/%/%'
            OR file.path LIKE '/Users/%/Downloads/%'
            OR file.path LIKE '/Users/%/Downloads/%/%'
            OR file.path LIKE '/tmp/%'
            OR file.path LIKE '/var/tmp/%'
          )
          AND file.type = "regular"
          AND file.size > 2000
          AND file.size < 400000
          AND (
            file.btime > (strftime('%s', 'now') -43200)
            OR file.ctime > (strftime('%s', 'now') -43200)
            OR file.mtime > (strftime('%s', 'now') -43200)
          )
      )
      AND yara.sigrule = '
        rule miner {
        strings:
            $tcp = "stratum+tcp://" ascii
            $tls = "stratum+tls://" ascii
            $ssl = "stratum+ssl://" ascii
            $stratum = "stratum://" ascii
            $normalhash = "\"normalHashing\": true,"
        condition:
            filesize < 10MB and 1 of them
    }'
      AND yara.count > 0
  tags: volume, filesystem, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Flag packed binaries that have recently been downloaded
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - initial_access - yara-recently-downloaded-packed
  observer_can_run: false
  platforms: ''
  query: "-- Flag packed binaries that have recently been downloaded\n--\n-- tags:\
    \ volume filesystem persistent seldom\nSELECT\n  file.path,\n  file.size,\n  file.btime,\n\
    \  file.ctime,\n  file.mtime,\n  magic.data,\n  hash.sha256,\n  yara.*\nFROM\n\
    \  file\n  JOIN yara ON file.path = yara.path\n  LEFT JOIN magic ON file.path\
    \ = magic.path\n  LEFT JOIN hash ON file.path = hash.path\nWHERE\n  file.path\
    \ IN (\n    SELECT\n      path\n    FROM\n      file\n    WHERE\n      (\n   \
    \     file.path LIKE '/home/%/Downloads/%'\n        OR file.path LIKE '/home/%/Downloads/%/%'\n\
    \        OR file.path LIKE '/Users/%/Downloads/%'\n        OR file.path LIKE '/Users/%/Downloads/%/%'\n\
    \        OR file.path LIKE '/tmp/%'\n        OR file.path LIKE '/var/tmp/%'\n\
    \      )\n      AND file.type = \"regular\"\n      AND file.size > 2000\n    \
    \  AND file.size < 400000\n      AND (\n        file.btime > (strftime('%s', 'now')\
    \ -43200)\n        OR file.ctime > (strftime('%s', 'now') -43200)\n        OR\
    \ file.mtime > (strftime('%s', 'now') -43200)\n      )\n  )\n  AND yara.sigrule\
    \ = '\nrule cxFreeze_Python_executable : high {\n  meta:\n    hash_2023_MacStealer_weed\
    \ = \"6a4f8b65a568a779801b72bce215036bea298e2c08ec54906bb3ebbe5c16c712\"\n  strings:\n\
    \    $cxfreeze = \"cx_Freeze\"\n  condition:\n    filesize < 10485760 and $cxfreeze\n\
    }\nimport \"math\"\n\nrule obfuscated_elf : high {\n  meta:\n    description =\
    \ \"Obfuscated ELF binary (missing content)\"\n    hash_2023_APT31_1d60 = \"1d60edb577641ce47dc2a8299f8b7f878e37120b192655aaf80d1cde5ee482d2\"\
    \n    hash_2023_UPX_0c25 = \"0c25a05bdddc144fbf1ffa29372481b50ec6464592fdfb7dec95d9e1c6101d0d\"\
    \n    hash_2023_Earthwrom_1ae6 = \"1ae62dbec330695d2eddc7cb9a65d47bad5f45af95e6c8a803f0780e0749a3ad\"\
    \n  strings:\n    $dlsym = \"dlsym\" fullword\n    $gcc = \"gcc\" fullword\n \
    \   $libstdc = \"libstdc\" fullword\n    $glibc = \"glibc\" fullword\n    $setsid\
    \ = \"setsid\" fullword\n    $gmon = \"__gmon_start__\"\n    $glibc2 = \"@GLIBC\"\
    \n    $cxa = \"__cxa_finalize\"\n    $dereg = \"__deregister_frame_info\"\n  \
    \  $symtab = \".symtab\" fullword\n    $__libc_start_main = \"__libc_start_main\"\
    \n  condition:\n    uint32(0) == 1179403647 and none of them\n}\n\nrule high_entropy_header\
    \ : high {\n  meta:\n    description = \"Obfuscated ELF binary (high entropy content)\"\
    \n    hash_2023_UPX_0c25 = \"0c25a05bdddc144fbf1ffa29372481b50ec6464592fdfb7dec95d9e1c6101d0d\"\
    \n    hash_2023_UPX_5a59 = \"5a5960ccd31bba5d47d46599e4f10e455b74f45dad6bc291ae448cef8d1b0a59\"\
    \n    hash_2023_FontOnLake_38B09D690FAFE81E964CBD45EC7CF20DCB296B4D_elf = \"f155fafa36d1094433045633741df98bbbc1153997b3577c3fa337cc525713c0\"\
    \n  strings:\n    $not_pyinst = \"pyi-bootloader-ignore-signals\"\n    $not_go\
    \ = \"syscall_linux.go\"\n    $not_go2 = \"vdso_linux.go\"\n  condition:\n   \
    \ uint32(0) == 1179403647 and math.entropy(1200, 4096) > 7 and none of ($not*)\n\
    }\nimport \"math\"\n\nprivate rule smallBinary {\n\tcondition:\n\t\t// matches\
    \ ELF or machO binary\n\t\tfilesize < 64MB and (uint32(0) == 1179403647 or uint32(0)\
    \ == 4277009102 or uint32(0) == 3472551422 or uint32(0) == 4277009103 or uint32(0)\
    \ == 3489328638 or uint32(0) == 3405691582 or uint32(0) == 3199925962)\n}\n\n\
    rule high_entropy_7_5 : medium {\n    meta:\n        description = \"higher entropy\
    \ binary (>7.5)\"\n    condition:\n\t\tsmallBinary and math.entropy(1,filesize)\
    \ >= 7.5\n}\n\nrule high_entropy_7_9 : high {\n    meta:\n        description\
    \ = \"high entropy binary (>7.9)\"\n\tstrings:\n\t\t// prevent bazel false positive\n\
    \t\t$bin_java = \"bin/java\"\n    condition:\n\t\tsmallBinary and math.entropy(1,filesize)\
    \ >= 7.9 and not $bin_java\n}\nrule kiteshield : high {\n  meta:\n    author =\
    \ \"Alex.Turing, Wang Hao\"\n    date = \"2024-05-28\"\n    description = \"Rule\
    \ to identify files packed by Kiteshield\"\n    hash_amdc6766_1 = \"2c80808b38140f857dc8b2b106764dd8\"\
    \n    hash_amdc6766_2 = \"909c015d5602513a770508fa0b87bc6f\"\n    hash_amdc6766_3\
    \ = \"5ea33d0655cb5797183746c6a46df2e9\"\n    hash_gafgyt = \"4afedf6fbf4ba95bbecc865d45479eaf\"\
    \n    hash_winnti = \"f5623e4753f4742d388276eaee72dea6\"\n    reference = \"https://blog.xlab.qianxin.com/kiteshield_packer_is_being_abused_by_linux_cyber_threat_actors\"\
    \n    tool = \"Kiteshield\"\n    tool_repository = \"https://github.com/GunshipPenguin/kiteshield\"\
    \n\n  strings:\n    $loader_jmp = {31 D2 31 C0 31 C9 31 F6 31 FF 31 ED 45 31 C0\
    \ 45 31 C9 45 31 D2 45 31 DB 45 31 E4 45 31 ED 45 31 F6 45 31 FF 5B FF E3}\n \
    \   // \"/proc/%d/status\"\n    $loader_s1 = {ac f4 f7 e9 e4 a7 ac ee a4 ff f9\
    \ ef fb e5 e2}\n    // \"TracerPid:\"\n    $loader_s2 = {d7 f6 e4 e5 e2 fa d9\
    \ e3 ef b6}\n    // \"/proc/%d/stat\"\n    $loader_s3 = {ac f4 f7 e9 e4 a7 ac\
    \ ee a4 ff f9 ef fb}\n    // \"LD_PRELOAD\"\n    $loader_s4 = {cf c0 da d6 d5\
    \ cd c5 c5 ca c8}\n    // \"LD_AUDIT\"\n    $loader_s5 = {cf c0 da c7 d2 cc c0\
    \ de}\n    // \"LD_DEBUG\"\n    $loader_s6 = {cf c0 da c2 c2 ca dc cd}\n    //\
    \ \"0123456789abcdef\"\n    $loader_s7 = {b3 b5 b7 b5 b3 bd bf bd b3 b5 ec ec\
    \ ec f4 f4 f4}\n\n  condition:\n    $loader_jmp and all of ($loader_s*) and\n\
    \    // ELF Magic at offset 0\n    uint32(0) == 0x464c457f and\n    // ET_EXEC\
    \ at offset 16\n    uint16(16) == 0x0002 and\n    (\n        // x86_64 at offset\
    \ 18\n        uint16(18) == 0x003e or\n        // aarch64 at offset 18\n     \
    \   uint16(18) == 0x00b7\n    )\n}\n\nrule shc : high {\n  meta:\n    description\
    \ = \"Binary generated with SHC (Shell Script Compiler)\"\n    ref = \"https://github.com/neurobin/shc\"\
    \n    hash_2023_Linux_Malware_Samples_1328 = \"1328f1c2c9fe178f13277c18847dd9adb9474f389985e17126fcb895aac035f2\"\
    \n    hash_2023_Linux_Malware_Samples_77b8 = \"77b881109c2141aef8a86263de75e041794556489055c1488f1d36feb7d70dd3\"\
    \n    hash_2023_Linux_Malware_Samples_edbe = \"edbee3b92100cc9a6a8a3c1a5fc00212627560c5e36d29569d497613ea3e3c16\"\
    \n  strings:\n    $ref = \"argv[0] nor $_\"\n  condition:\n    $ref\n}\n\nrule\
    \ upx : high {\n  meta:\n    description = \"Binary is packed with UPX\"\n   \
    \ hash_2023_UPX_0c25 = \"0c25a05bdddc144fbf1ffa29372481b50ec6464592fdfb7dec95d9e1c6101d0d\"\
    \n    hash_2023_UPX_5a59 = \"5a5960ccd31bba5d47d46599e4f10e455b74f45dad6bc291ae448cef8d1b0a59\"\
    \n    hash_2023_FontOnLake_38B09D690FAFE81E964CBD45EC7CF20DCB296B4D_elf = \"f155fafa36d1094433045633741df98bbbc1153997b3577c3fa337cc525713c0\"\
    \n  strings:\n    $u_upx_sig = \"UPX!\"\n    $u_packed = \"executable packer\"\
    \n    $u_is_packed = \"This file is packed\"\n    $not_upx = \"UPX_DEBUG_DOCTEST_DISABLE\"\
    \n  condition:\n    any of ($u*) in (0..1024) and none of ($not*)\n}\n\nrule upx_elf\
    \ : high {\n  meta:\n    description = \"Linux ELF binary packed with UPX\"\n\
    \    hash_2023_UPX_0c25 = \"0c25a05bdddc144fbf1ffa29372481b50ec6464592fdfb7dec95d9e1c6101d0d\"\
    \n    hash_2023_UPX_5a59 = \"5a5960ccd31bba5d47d46599e4f10e455b74f45dad6bc291ae448cef8d1b0a59\"\
    \n    hash_2023_FontOnLake_1F52DB8E3FC3040C017928F5FFD99D9FA4757BF8_elf = \"efbd281cebd62c70e6f5f1910051584da244e56e2a3228673e216f83bdddf0aa\"\
    \n  strings:\n    $proc_self = \"/proc/self/exe\"\n    $prot_exec = \"PROT_EXEC|PROT_WRITE\
    \ failed\"\n  condition:\n    uint32(0) == 1179403647 and $prot_exec and $proc_self\n\
    }\n\nrule upx_elf_tampered : critical {\n  meta:\n    description = \"Linux ELF\
    \ binary packed with modified UPX\"\n    hash_2023_Unix_Trojan_DarkNexus_2527\
    \ = \"2527fc4d6491bd8fc9a79344790466eaedcce8795efe540ac323ea93e59c5ab5\"\n   \
    \ hash_2023_Unix_Trojan_DarkNexus_2e1d = \"2e1d9acd6ab43d63f3eab9fc995080fc67a0a5bbdc66be3aff53ed3745c9e811\"\
    \n    hash_2023_Unix_Trojan_DarkNexus_3a55 = \"3a55dcda90c72acecb548f4318d41708bb73c4c3fb099ff65c988948dc8b216f\"\
    \n  strings:\n    $prot_exec = \"PROT_EXEC|PROT_WRITE failed\"\n    $upx = \"\
    UPX!\"\n  condition:\n    uint32(0) == 1179403647 and $prot_exec and not $upx\n\
    }\n  '\n  AND yara.count > 0\n"
  tags: volume, filesystem, persistent, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: 'tags: volume filesystem seldom'
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - initial_access - yara-recently-downloaded-ransom
  observer_can_run: false
  platforms: ''
  query: |
    -- tags: volume filesystem seldom
    SELECT
      file.path,
      file.size,
      file.btime,
      file.ctime,
      file.mtime,
      magic.data,
      hash.sha256,
      yara.*
    FROM
      file
      JOIN yara ON file.path = yara.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      file.path IN (
        SELECT
          path
        FROM
          file
        WHERE
          (
            file.path LIKE '/home/%/Downloads/%'
            OR file.path LIKE '/home/%/Downloads/%/%'
            OR file.path LIKE '/Users/%/Downloads/%'
            OR file.path LIKE '/Users/%/Downloads/%/%'
            OR file.path LIKE '/tmp/%'
            OR file.path LIKE '/var/tmp/%'
          )
          AND file.type = "regular"
          AND file.size > 2000
          AND file.size < 400000
          AND (
            file.btime > (strftime('%s', 'now') -43200)
            OR file.ctime > (strftime('%s', 'now') -43200)
            OR file.mtime > (strftime('%s', 'now') -43200)
          )
      )
      AND yara.sigrule = '
        rule ransomware {
        strings:
            $unfortunately = "unfortunately" ascii
            $crypted = "crypted" ascii
            $leaked = "leaked" ascii
            $recover = "recover your" ascii
            $leaks = "of leaks" ascii
            $decrypt = "will decrypt" ascii

            $onion = ".onion/" ascii
            $tor = "TOR Browser" ascii

            $esxcli = "esxcli" ascii
        condition:
            filesize < 10MB and 3 of them
    }'
      AND yara.count > 0
      AND file.path NOT LIKE "%.csv"
      AND file.path NOT LIKE "%.txt"
      AND file.path NOT LIKE "%.md"
      AND file.path NOT LIKE "%.xls"
  tags: volume, filesystem, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: 'tags: volume filesystem seldom extra'
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - initial_access - yara-recently-downloaded-stealer
  observer_can_run: false
  platforms: ''
  query: "-- tags: volume filesystem seldom extra\nSELECT\n  file.path,\n  file.size,\n\
    \  file.btime,\n  file.ctime,\n  file.mtime,\n  magic.data,\n  hash.sha256,\n\
    \  yara.*\nFROM\n  file\n  JOIN yara ON file.path = yara.path\n  LEFT JOIN magic\
    \ ON file.path = magic.path\n  LEFT JOIN hash ON file.path = hash.path\nWHERE\
    \ -- Only scan recent downloads\n  file.path IN (\n    SELECT\n      path\n  \
    \  FROM\n      file\n    WHERE\n      (\n        file.path LIKE '/home/%/Downloads/%'\n\
    \        OR file.path LIKE '/home/%/Downloads/%/%'\n        OR file.path LIKE\
    \ '/Users/%/Downloads/%'\n        OR file.path LIKE '/Users/%/Downloads/%/%'\n\
    \        OR file.path LIKE '/tmp/%'\n        OR file.path LIKE '/var/tmp/%'\n\
    \      )\n      AND file.type = \"regular\"\n      AND file.size > 2000\n    \
    \  AND file.size < 400000\n      AND (\n        file.btime > (strftime('%s', 'now')\
    \ -43200)\n        OR file.ctime > (strftime('%s', 'now') -43200)\n        OR\
    \ file.mtime > (strftime('%s', 'now') -43200)\n      )\n  )\n  AND yara.sigrule\
    \ = '\nrule multiple_browser_credentials : suspicious {\n  strings:\n    $c_library_keychains\
    \ = \"/Library/Keychains\"\n    $c_cookies_sqlite = \"cookies.sqlite\"\n    $c_moz_cookies\
    \ = \"moz_cookies\"\n    $c_opera_gx = \"OperaGX\"\n    $c_keychain_db = \"login.keychain-db\"\
    \n    $c_dscl_local = \"dscl /Local/Default\"\n    $c_osascript = \"osascript\"\
    \n    $c_find_generic_password = \"find-generic-password\"\n    $not_security\
    \ = \"PROGRAM:security\"\n    $not_verbose = \"system_verbose\"\n    $not_kandji\
    \ = \"com.kandji.profile.mdmprofile\"\n    $not_xul = \"XUL_APP_FILE\"\n  condition:\n\
    \    3 of ($c_*) and none of ($not_*)\n}\n\nrule multiple_browser_credentials_2\
    \ {\n  strings:\n    $a_google_chrome = \"Google/Chrome\"\n    $a_app_support\
    \ = \"Application Support\"\n    $a_app_support_slash = \"Application\\\\ Support\"\
    \n    $a_cookies_sqlite = \"cookies.sqlite\"\n    $a_cookies = \"Cookies\"\n \
    \   $a_places_sqlite = \"places.sqlite\"\n    $a_moz_cookies = \"moz_cookies\"\
    \n    $a_firefox_profiles = \"Firefox/Profiles\"\n    $a_opera_gx = \"OperaGX\"\
    \n    $a_form_history = \"formhistory.sqlite\"\n    $a_chrome_local_state = \"\
    Chrome/Local State\"\n    $a_brave_software = \"BraveSoftware\"\n    $a_opera\
    \ = \"Opera Software\"\n    $not_osquery = \"OSQUERY_WORKER\"\n    $not_private\
    \ = \"/System/Library/PrivateFrameworks/\"\n  condition:\n    3 of ($a_*) and\
    \ none of ($not_*)\n}\n\n\nrule multiple_browser_refs : notable {\n  strings:\n\
    \t$d_config = \".config\" fullword\n\t$d_app_support = \"Application Support\"\
    \ fullword\n\n\t$h_http = \"http\" fullword\n\t$h_POST = \"POST\" fullword\n\n\
    \t$z_zip = \"zip\" fullword\n\t$z_ZIP = \"ZIP\" fullword\n\t$z_ditto = \"ditto\"\
    \ fullword\n\t$z_tar = \"tar\" fullword\n\n\t$b_Yandex = \"Yandex\"\n\t$b_Brave\
    \ = \"Brave\"\n\t$b_Firefox = \"Firefox\"\n\t$b_Safari = \"Safari\"\n\t$b_Chrome\
    \ = \"Chrome\"\n  condition:\n    any of ($d*) and any of ($h*) and any of ($z*)\
    \ and 2 of ($b*)\n}\n'\n  AND yara.count > 0\n  AND file.path NOT LIKE \"%.csv\"\
    \n  AND file.filename != 'RIT_Wireless.dmg'\n"
  tags: volume, filesystem, seldom, extra
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find launchd entries which purport to be by Apple, but point to binaries
    that are not signed by Apple.
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - fake-apple-launchd
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find launchd entries which purport to be by Apple, but point to binaries that are not signed by Apple.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/004/ (Create or Modify System Process: Launch Daemon)
    --   * https://posts.specterops.io/hunting-for-bad-apples-part-1-22ef2b44c0aa
    --
    -- false positives:
    --   * none have been observed
    --
    -- platform: darwin
    -- tags: persistent launchd state
    SELECT
      *
    FROM
      launchd
      LEFT JOIN file ON launchd.path = file.path
      LEFT JOIN signature ON launchd.program_arguments = signature.path
    WHERE
      launchd.name LIKE 'com.apple.%'
      -- Optimization, assumes SIP
      AND file.directory NOT IN (
        '/System/Library/LaunchAgents',
        '/System/Library/LaunchDaemons',
        '/Library/Apple/System/Library/LaunchDaemons',
        '/Library/Apple/System/Library/LaunchAgents'
      )
      AND launchd.run_at_load = 1
      AND signature.authority != 'Software Signing'
  tags: persistent, launchd, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected programs listening from /tmp or other weird directories
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - listening-from-unusual-location
  observer_can_run: false
  platforms: ''
  query: |
    -- Unexpected programs listening from /tmp or other weird directories
    --
    --
    -- tags: persistent state net often
    -- Canonical example of information to include for processes
    SELECT
      lp.address,
      lp.port,
      lp.protocol,
      REPLACE(f.directory, u.directory, '~') AS homepath,
      REPLACE(p0.cwd, u.directory, '~') AS homecwd,
      CONCAT (
        MIN(lp.port, 32768),
        ',',
        lp.protocol,
        ',',
        MIN(p0.uid, 500),
        ',',
        p0.name
      ) AS exception_key,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      listening_ports lp
      JOIN processes p0 ON lp.pid = p0.pid
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN users u ON f.uid = u.uid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      lp.port != 0
      AND (
        p0.path LIKE "/private/tmp%"
        OR p0.path LIKE "/private/var/tmp%"
        OR p0.path LIKE "/var/tmp%"
        OR p0.path LIKE "/tmp%"
        OR p0.path LIKE "/dev%"
        OR p0.path LIKE "/Users/Shared%"
        OR p0.path LIKE "%/.%"
        OR p0.cwd LIKE "/private/tmp%"
        OR p0.cwd LIKE "/private/var/tmp%"
        OR p0.cwd LIKE "/var/tmp%"
        OR p0.cwd LIKE "/tmp%"
        OR p0.cwd LIKE "/dev%"
        OR p0.cwd LIKE "%/.%"
        OR p0.cwd LIKE "/Users/Shared%"
      )
      AND NOT (
        p0.name IN (
          'caddy',
          'controller',
          'docker-proxy',
          'hugo',
          'gopls',
          'limactl',
          'nuclei',
          'qemu-system-aarch64',
          'qemu-system-x86',
          'crane',
          'kubectl',
          'nginx-ingress-c',
          'node',
          'rootlessport',
          'webhook'
        )
        AND lp.port > 1024
        and lp.protocol = 6
      )
      AND NOT (
        p0.name = "ssh"
        AND homecwd LIKE '/tmp/%'
        AND lp.address IN ("127.0.0.1", "::1")
      )
      -- Overly broad, but prevents a lot of false positives
      AND NOT homepath LIKE "~/.%"
      AND NOT homecwd LIKE "~/.%"
      AND NOT homecwd LIKE '/Users/%/.gradle/daemon/%'
      AND NOT f.directory IN (
        '/Applications/Keybase.app/Contents/SharedSupport/bin',
        '/opt/docker-desktop/bin'
      )
      AND NOT exception_key IN (
        '16620,6,500,psi-bastion',
        '32768,6,500,java',
        '24024,17,500,MTGA',
        '1,1,500,ping'
      )
      AND NOT p0.path LIKE '/nix/store/%'
      AND NOt p0.path LIKE '/Users/Shared/Epic Games/%'
      AND NOT (
        exception_key = '32768,17,500,qemu-system-x86'
        AND homecwd LIKE '/tmp/wolfi-%'
      )
  tags: persistent, state, net, often
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find programs where fd0 (stdin), fd1 (stdout), or fd2 (stderr) are
    connected to a socket
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - low-fd-socket
  observer_can_run: false
  platforms: posix
  query: |
    -- Find programs where fd0 (stdin), fd1 (stdout), or fd2 (stderr) are connected to a socket
    --
    -- false positives:
    --   * none known
    --
    -- references:
    --   * https://www.deepinstinct.com/blog/bpfdoor-malware-evolves-stealthy-sniffing-backdoor-ups-its-game
    --
    -- tags: process state
    -- platform: posix
    SELECT
      pos.protocol,
      pos.pid,
      pos.remote_address,
      pos.local_address,
      pos.local_port,
      pos.remote_port,
      pos.state,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_sockets pos
      JOIN processes p0 ON pos.pid = p0.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      pos.fd < 3
      AND pos.family != 1
      AND p0.path NOT IN (
        '/Applications/NetSpot.app/Contents/MacOS/NetSpot',
        '/usr/bin/skopeo',
        '/usr/libexec/bootpd',
        '/usr/libexec/pcp/bin/pmcd',
        '/usr/local/bin/velociraptor'
      )
  tags: process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Slow query to find root programs with an open socket and few shared
    libraries
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - minimal-socket-client-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Slow query to find root programs with an open socket and few shared libraries
    --
    -- false positives:
    --   * some minimalist daemons
    --
    -- references:
    --   * https://www.deepinstinct.com/blog/bpfdoor-malware-evolves-stealthy-sniffing-backdoor-ups-its-game
    --
    -- tags: persistent process state seldom
    -- platform: linux
    SELECT
      pos.protocol,
      pos.pid,
      pos.remote_address,
      pos.local_address,
      pos.local_port,
      pos.remote_port,
      pos.state,
      GROUP_CONCAT(DISTINCT pmm.path) AS libs,
      COUNT(DISTINCT pmm.path) AS lib_count,
      -- Child
      p0.path AS proc_path,
      p0.name AS proc_name,
      p0.start_time AS proc_start,
      p0.cmdline AS proc_cmd,
      p0.cwd AS porc_cwd,
      p0.cgroup_path AS proc_cgroup,
      p0.euid AS proc_euid,
      p0_hash.sha256 AS sha256
    FROM
      processes p0
      JOIN process_open_sockets pos ON p0.pid = pos.pid
      JOIN process_memory_map pmm ON p0.pid = pmm.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
    WHERE
      p0.path != '' -- optimization: focus on longer running processes
      AND p0.start_time < (strftime('%s', 'now') - 900)
      AND p0.path NOT IN (
        '/usr/bin/containerd',
        '/usr/bin/fusermount3',
        '/usr/sbin/acpid',
        '/usr/bin/dash',
        '/opt/bitnami/redis/bin/redis-server',
        '/usr/bin/kas',
        '/usr/local/bin/gitary',
        '/usr/bin/docker',
        '/usr/sbin/mcelog',
        '/usr/libexec/docker/docker-proxy',
        '/usr/bin/docker-proxy',
        '/usr/bin/cat',
        '/usr/lib/electron/chrome-sandbox',
        '/usr/bin/i3blocks'
      )
      AND p0.name NOT IN (
        'chrome_crashpad',
        'dhcpcd',
        'kas',
        'gitaly',
        'redis-server',
        'stern',
        'Brackets-node'
      ) -- optimization: minimalistic daemons typically only run 1 pid per path
      AND p0.path NOT LIKE '/home/%/go/bin/%'
      AND pos.family != 1
      AND pos.pid > 0
      AND pos.state != 'LISTEN'
      AND pmm.path LIKE "%.so.%"
      AND NOT (
        pos.local_address = "127.0.0.1"
        AND pos.remote_address = "127.0.0.1"
      )
    GROUP BY
      pos.pid -- libc.so, ld-linux
    HAVING
      lib_count IN (1, 2)
  tags: persistent, process, state, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Slow query to find root programs with an open socket and few shared
    libraries
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - minimal-socket-client-macos
  observer_can_run: false
  platforms: macos
  query: |
    -- Slow query to find root programs with an open socket and few shared libraries
    --
    -- false positives:
    --   * some minimalist daemons
    --
    -- references:
    --   * https://www.deepinstinct.com/blog/bpfdoor-malware-evolves-stealthy-sniffing-backdoor-ups-its-game
    --
    -- tags: persistent process state seldom extra
    -- platform: macos
    SELECT
      p.uid,
      p.euid,
      pos.protocol,
      pos.pid,
      pos.remote_address,
      pos.local_address,
      pos.local_port,
      pos.remote_port,
      p.name,
      p.start_time,
      p.parent,
      p.cgroup_path,
      p.path,
      pos.state,
      GROUP_CONCAT(DISTINCT pmm.path) AS libs,
      COUNT(DISTINCT pmm.path) AS lib_count,
      -- Normally we would use signatures for exceptions, but it was triggering
      -- an unusual performance issue in osquery.
      CONCAT (MIN(p.euid, 500), ',', p.name, ',', p.path) AS exception_key
    FROM
      processes p
      -- For some reason, joining this table increases the runtime by 30X
      -- LEFT JOIN signature s ON p.path = s.path
      JOIN process_memory_map pmm ON p.pid = pmm.pid
      JOIN process_open_sockets pos ON p.pid = pos.pid
    WHERE
      p.pid IN (
        SELECT
          processes.pid
        FROM
          processes
          JOIN process_open_sockets ON processes.pid = process_open_sockets.pid
          AND family != 1
        WHERE
          processes.path NOT LIKE '/System/%'
          -- TODO: consider whitelisting /Applications/%.app/Contents/MacOS/%
          AND processes.path NOT LIKE '/Library/Apple/%'
          AND processes.path NOT LIKE '/usr/libexec/%'
          AND processes.path NOT LIKE '/usr/sbin/%'
          AND processes.path NOT LIKE '/sbin/%'
          AND processes.path NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'
          AND processes.path NOT LIKE '/usr/bin/%'
          AND processes.path NOT LIKE '/nix/store/%/bin/nix'
          AND processes.path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
          AND processes.path NOT LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/Kolide.app/Contents/MacOS/launcher'
          AND processes.start_time < (strftime('%s', 'now') -600)
        GROUP BY
          processes.path
      )
      AND pmm.path LIKE "%.dylib"
      AND exception_key NOT IN (
        '500,Bitwarden,/Applications/Bitwarden.app/Contents/MacOS/Bitwarden',
        '500,Clipy,/Applications/Clipy.app/Contents/MacOS/Clipy',
        '500,Evernote,/Applications/Evernote.app/Contents/MacOS/Evernote',
        '500,Final Cut Pro,/Applications/Final Cut Pro.app/Contents/MacOS/Final Cut Pro',
        '500,J8RPQ294UB.com.skitch.SkitchHelper,/Applications/Skitch.app/Contents/Library/LoginItems/J8RPQ294UB.com.skitch.SkitchHelper.app/Contents/MacOS/J8RPQ294UB.com.skitch.SkitchHelper',
        '500,Lightshot Screenshot,/Applications/Lightshot Screenshot.app/Contents/MacOS/Lightshot Screenshot',
        '500,Macdown,/Applications/MacDown.app/Contents/MacOS/MacDown',
        '500,Revolt Helper (GPU),/Applications/Revolt.app/Contents/Frameworks/Revolt Helper (GPU).app/Contents/MacOS/Revolt Helper (GPU)',
        '500,Revolt Helper,/Applications/Revolt.app/Contents/Frameworks/Revolt Helper.app/Contents/MacOS/Revolt Helper',
        '500,Revolt,/Applications/Revolt.app/Contents/MacOS/Revolt',
        '500,Skitch,/Applications/Skitch.app/Contents/MacOS/Skitch',
        '500,Slack Helper (GPU),/Applications/Slack.app/Contents/Frameworks/Slack Helper (GPU).app/Contents/MacOS/Slack Helper (GPU)',
        '500,Slack Helper (Renderer),/Applications/Slack.app/Contents/Frameworks/Slack Helper (Renderer).app/Contents/MacOS/Slack Helper (Renderer)',
        '500,Slack,/Applications/Slack.app/Contents/MacOS/Slack',
        '500,Snagit 2020,/Applications/Snagit 2020.app/Contents/MacOS/Snagit 2020',
        '500,SnagitHelper2020,/Applications/Snagit 2020.app/Contents/Library/LoginItems/SnagitHelper2020.app/Contents/MacOS/SnagitHelper2020',
        '500,Speedtest,/Applications/Speedtest.app/Contents/MacOS/Speedtest',
        '500,Todoist,/Applications/Todoist.app/Contents/MacOS/Todoist',
        '500,WhatsApp Helper (GPU),/Applications/WhatsApp.app/Contents/Frameworks/WhatsApp Helper (GPU).app/Contents/MacOS/WhatsApp Helper (GPU)',
        '500,monday.com,/Applications/monday.com.app/Contents/MacOS/monday.com'
      )
      AND exception_key NOT LIKE '500,MacVim,/%/MacVim.app/Contents/MacOS/MacVim'
      AND exception_key NOT LIKE '500,PrinterProxy,/Users/%/Library/Printers/Brother %.app/Contents/MacOS/PrinterProxy'
      AND exception_key NOT LIKE '500,Steam Helper,/Users/%/Library/Application Support/Steam/Steam.AppBundle/Steam/Contents/MacOS/Frameworks/Steam Helper.app/Contents/MacOS/Steam Helper'
      AND exception_key NOT LIKE '500,Skitch,/private/var/folders/%/d/Skitch.app/Contents/MacOS/Skitch'
    GROUP BY
      pos.pid
    HAVING
      lib_count IN (1, 2)
      AND libs NOT LIKE '/Applications/%/Contents/Frameworks/Electron Framework.framework/Versions/A/Libraries/libffmpeg.dylib,/usr/lib/libobjc-trampolines.dylib'
      AND libs NOT LIKE '/usr/lib/libobjc-trampolines.dylib,/Applications/%.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Libraries/libffmpeg.dylib'
  tags: persistent, process, state, seldom, extra
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Funky systemd units, may be evidence of persistence
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - suspicious-systemd-unit
  observer_can_run: false
  platforms: linux
  query: "-- Funky systemd units, may be evidence of persistence\n--\n-- references:\n\
    --   * https://attack.mitre.org/techniques/T1543/002/ (Create or Modify System\
    \ Process: Systemd Service)\n--   * https://www.cadosecurity.com/blog/spinning-yarn-a-new-linux-malware-campaign-targets-docker-apache-hadoop-redis-and-confluence\n\
    --   * https://sandflysecurity.com/blog/log4j-kinsing-linux-malware-in-the-wild/\n\
    --\n-- false positives:\n--   * home-made systemd files\n--\n-- tags: persistent\
    \ filesystem systemd\n-- platform: linux\nSELECT\n  file.path,\n  file.size,\n\
    \  file.btime,\n  file.ctime,\n  file.mtime,\n  hash.sha256,\n  yara.*\nFROM file\n\
    \  JOIN yara ON file.path = yara.path\n  JOIN hash ON file.path = hash.path\n\
    WHERE\n  file.path IN (\n    SELECT DISTINCT(fragment_path) FROM systemd_units\n\
    \    WHERE fragment_path LIKE \"%.service\"\n    AND NOT fragment_path LIKE \"\
    /run/systemd/generator.late/%\"\n  )\n  AND yara.sigrule = '\nrule systemd_execstart_danger_path_val\
    \ : high {\n  meta:\n    ref = \"https://sandflysecurity.com/blog/log4j-kinsing-linux-malware-in-the-wild/\"\
    \n    description = \"Starts from a dangerous-looking path\"\n  strings:\n   \
    \ $awkward = /ExecStart=\\/(boot|var|tmp|dev|root)\\/[\\.\\w\\-\\/]{0,32}/\n \
    \ condition:\n    filesize < 102400 and $awkward\n}\n\nrule systemd_execstart_elsewhere\
    \ : medium {\n  meta:\n    description = \"Starts from an unusual path\"\n   \
    \ ref = \"https://sandflysecurity.com/blog/log4j-kinsing-linux-malware-in-the-wild/\"\
    \n    hash_2023_Downloads_kinsing = \"05d02411668f4ebd576a24ac61cc84e617bdb66aa819581daa670c65f1a876f0\"\
    \n    hash_2023_articles_https_pberba_github_io_security_2022_02_07_linux_threat_hunting_for_persistence_systemd_generators\
    \ = \"8c227f67a16162ffd5b453a478ced2950eba4cbe3b004c5cc935fb9551dc2289\"\n   \
    \ hash_2024_2024_Spinning_YARN_yarn_fragments = \"723326f8551f2a92ccceeec93859f58df380a3212e7510bc64181f2a0743231c\"\
    \n  strings:\n    $execstart = /ExecStart=\\/[\\w\\/]{1,128}/\n    $not_bin =\
    \ \"ExecStart=/bin/\"\n    $not_bin_true = \"ExecStart=/bin/true\"\n    $not_etc_rcd\
    \ = \"ExecStart=/etc/rc.d/rc.local\"\n    $not_etc_rc_local = \"ExecStart=/etc/rc.local\"\
    \n    $not_init_d = \"ExecStart=/etc/init.d/\"\n    $not_lib = \"ExecStart=/lib/\"\
    \n    $not_motd = \"ExecStart=/etc/update-motd.d/\"\n    $not_opt = \"ExecStart=/opt/\"\
    \n    $not_sbin = \"ExecStart=/sbin/\"\n    $not_usr_bin = \"ExecStart=/usr/bin/\"\
    \n    $not_usr_libexec = \"ExecStart=/usr/libexec/\"\n    $not_usr_lib = \"ExecStart=/usr/lib/\"\
    \n    $not_usr_local = \"ExecStart=/usr/local/\"\n    $not_usr_sbin = \"ExecStart=/usr/sbin/\"\
    \n    $not_usr_share = \"ExecStart=/usr/share/\"\n  condition:\n    filesize <\
    \ 102400 and $execstart and none of ($not_*)\n}\n\nrule systemd_execstop_elsewhere\
    \ : medium {\n  meta:\n    ref = \"https://www.trendmicro.com/en_us/research/23/c/iron-tiger-sysupdate-adds-linux-targeting.html\"\
    \n\tdescription = \"Runs program from unexpected directory at stop\"\n  strings:\n\
    \    $execstop = /ExecStop=\\/[\\w\\.\\_\\-]{2,64}/\n    $not_lib = \"ExecStop=/lib/\"\
    \n    $not_opt = \"ExecStart=/opt/\"\n    $not_sbin = \"ExecStop=/sbin/\"\n  \
    \  $not_usr_libexec = \"ExecStop=/usr/libexec/\"\n    $not_usr_lib = \"ExecStop=/usr/lib/\"\
    \n    $not_usr_local = \"ExecStop=/usr/local/\"\n    $not_usr_sbin = \"ExecStop=/usr/sbin/\"\
    \n    $not_usr_share = \"ExecStop=/usr/share/\"\n  condition:\n    filesize <\
    \ 384 and $execstop and none of ($not*)\n}\n\nrule systemd_small_no_blank_lines\
    \ : high {\n  meta:\n    ref = \"https://sandflysecurity.com/blog/log4j-kinsing-linux-malware-in-the-wild/\"\
    \n    hash_2023_Downloads_kinsing = \"05d02411668f4ebd576a24ac61cc84e617bdb66aa819581daa670c65f1a876f0\"\
    \n  strings:\n    $execstart = \"ExecStart\"\n    $blank = \"\\n\\n\"\n    $not_dbus\
    \ = \"Type=dbus\"\n    $not_after = /After=\\w/\n    $not_before = /Before=\\\
    w{1,128}/\n    $not_notify = \"Type=notify\"\n  condition:\n    filesize < 512\
    \ and $execstart and not $blank and none of ($not*)\n}\n\nrule systemd_small_multiuser_no_comments_or_documentation\
    \ : high {\n  meta:\n    ref = \"https://sandflysecurity.com/blog/log4j-kinsing-linux-malware-in-the-wild/\"\
    \n\tdescription = \"systemd unit is undocumented\"\n  strings:\n    $execstart\
    \ = \"ExecStart=\"\n    $multiuser = \"multi-user.target\"\n    $not_comment =\
    \ \"# \"\n    $not_documentation = \"Documentation=\"\n    $not_requires_socket\
    \ = /Requires=.{0,64}socket/\n    $not_condition_path = \"Condition\"\n    $not_after\
    \ = \"After=\"\n    $not_systemd = \"ExecStart=systemd-\"\n    $not_output = \"\
    StandardOutput=\"\n    $not_part_of = \"PartOf=\"\n    $not_dbus = \"Type=dbus\"\
    \n    $not_oneshot = \"Type=oneshot\"\n    $not_lima = \"Description=lima-guestagent\"\
    \n  condition:\n    filesize < 384 and $execstart and $multiuser and none of ($not_*)\n\
    }\nrule systemd_small_no_output : high {\n  meta:\n\tdescription = \"Discards\
    \ all logging output\"\n  strings:\n    $output_null = \"StandardOutput=null\"\
    \n    $error_null = \"StandardError=null\"\n    $not_input_null = \"StandardInput=null\"\
    \n    $not_syslog = \"syslog\"\n    $not_before = \"Before=\"\n    $not_display\
    \ = \"WantedBy=display-manager.service\"\n  condition:\n    filesize < 384 and\
    \ ($output_null and $error_null) and none of ($not*)\n}\n\nrule systemd_small_multiuser_not_in_dependency_tree\
    \ : high {\n  meta:\n    description = \"Relies on nothing, nothing relies on\
    \ it\"\n    hash_2023_Downloads_kinsing = \"05d02411668f4ebd576a24ac61cc84e617bdb66aa819581daa670c65f1a876f0\"\
    \n  strings:\n    $execstart = \"ExecStart=\"\n    $multiuser = \"multi-user.target\"\
    \n    $not_after = /After=\\w/\n    $not_before = /Before=\\w{1,128}/\n    $not_requires\
    \ = /Requires=\\w/\n    $not_condition = \"Condition\"\n    $not_oneshot = \"\
    Type=oneshot\"\n    $not_default = \"DefaultDependencies=no\"\n    $not_env =\
    \ \"EnvironmentFile=\"\n    $not_bus = \"BusName=\"\n    $not_idle = \"Type=idle\"\
    \n    $not_systemd = \"ExecStart=systemd-\"\n    $not_lima = \"Description=lima-guestagent\"\
    \n  condition:\n    filesize < 384 and $execstart and $multiuser and none of ($not_*)\n\
    }\n\nrule sytemd_small_type_forking_not_in_dep_tree : high {\n  meta:\n    hash_2023_Txt_Malware_Sustes_0e77\
    \ = \"0e77291955664d2c25d5bfe617cec12a388e5389f82dee5ae4fd5c5d1f1bdefe\"\n   \
    \ hash_2023_Unix_Malware_Kaiji_3e68 = \"3e68118ad46b9eb64063b259fca5f6682c5c2cb18fd9a4e7d97969226b2e6fb4\"\
    \n    hash_2023_Unix_Malware_Kaiji_f4a6 = \"f4a64ab3ffc0b4a94fd07a55565f24915b7a1aaec58454df5e47d8f8a2eec22a\"\
    \n  strings:\n    $forking = \"Type=forking\"\n    $not_after = /After=\\w/\n\
    \    $not_before = /Before=\\w{1,128}/\n    $not_condition = \"ConditionPath\"\
    \n    $not_oneshot = \"Type=oneshot\"\n    $not_default_deps = \"DefaultDependencies=no\"\
    \n    $not_env = \"EnvironmentFile=\"\n    $not_bus = \"BusName=\"\n    $not_idle\
    \ = \"Type=idle\"\n    $not_systemd = \"ExecStart=systemd-\"\n    $not_default_target\
    \ = \"WantedBy=default.target\"\n  condition:\n    filesize < 384 and $forking\
    \ and none of ($not_*)\n}\n\nrule systemd_small_restart_always : medium {\n  meta:\n\
    \    description = \"service restarts no matter how many times it crashes\"\n\
    \    hash_2023_Downloads_kinsing = \"05d02411668f4ebd576a24ac61cc84e617bdb66aa819581daa670c65f1a876f0\"\
    \n  strings:\n    $restart = \"Restart=always\"\n    $not_syslog = \"SyslogLevel=\"\
    \n    $not_gpl = \"GPL-2.0-only\"\n    $not_after = /After=\\w/\n    $not_before\
    \ = /Before=\\w{1,128}/\n    $not_notify = \"Type=notify\"\n  condition:\n   \
    \ filesize < 384 and $restart and none of ($not*)\n}\n\nrule systemd_small_short_description\
    \ {\n  meta:\n    description = \"Short or no description\"\n  strings:\n    $execstart\
    \ = \"ExecStart=\"\n    $short_desc = /Description=\\n/\n  condition:\n    filesize\
    \ < 384 and all of them\n}\n\nrule systemd_nice_execstart_restart_no_comment {\n\
    \  meta:\n    description = \"Sets nice value and restarts always without comments,\
    \ possible miner\"\n  strings:\n    $has_execstart = \"ExecStart=\"\n    $has_restart\
    \ = \"Restart=always\"\n    $has_nice = \"Nice=\"\n    $not_comment = \"#\"\n\
    \  condition:\n    filesize < 4096 and all of ($has*) and none of ($not*)\n}\n\
    \nrule usr_bin_execstop_shell : medium {\n  meta:\n    ref = \"https://www.trendmicro.com/en_us/research/23/c/iron-tiger-sysupdate-adds-linux-targeting.html\"\
    \n\tdescription = \"Runs shell script at stop\"\n  strings:\n    $execstop = /ExecStop=\\\
    /bin\\/sh .{0,64}/\n    $not_podman_logging = \"/usr/bin/podman $LOGGING\"\n \
    \ condition:\n    filesize < 4096 and $execstop and none of ($not*)\n}\n\nrule\
    \ systemd_hidden_execstart : critical {\n  meta:\n  \tdescription = \"ExecStart\
    \ references hidden file\"\n  strings:\n    $path_top_bin = /ExecStart=\\/\\.[\\\
    w\\/]+/\n    $path_sub_bin = /ExecStart=\\/\\w[\\w\\/]*\\/\\.\\w+/\n    $path_arg_sub\
    \ = /ExecStart=.* \\/\\w[\\w\\/]*\\/\\.\\w+/\n    $path_arg_top = /ExecStart=.*\
    \ \\/\\.[\\w\\/]+/\n    $not_autorelabel = \"/.autorelabel\"\n    $not_exists\
    \ = \"ConditionPathExists\"\n    $not_ksysguard = \"/.ksysguard/ksgrd_network_helper\"\
    \n  condition:\n  \tany of ($path*) and none of ($not*)\n}\n\nrule systemd_hidden_execstop\
    \ : critical {\n  meta:\n  \tdescription = \"ExecStop references hidden file\"\
    \n  strings:\n    $path_top_bin = /ExecStart=\\/\\.[\\w\\/]+/\n    $path_sub_bin\
    \ = /ExecStart=\\/\\w[\\w\\/]*\\/\\.\\w+/\n    $path_arg_sub = /ExecStart=.* \\\
    /\\w[\\w\\/]*\\/\\.\\w+/\n    $path_arg_top = /ExecStart=.* \\/\\.[\\w\\/]+/\n\
    \n    $not_autorelabel = \"/.autorelabel\"\n    $not_exists = \"ConditionPathExists\"\
    \n  condition:\n  \tany of ($path*) and none of ($not*)\n}\n\nrule systemd_hidden_working_directory\
    \ : critical {\n  meta:\n  \tdescription = \"WorkingDirectory is a hidden\"\n\
    \  strings:\n    $ref = /WorkingDirectory=.*\\/\\..*/\n  condition:\n\tany of\
    \ them\n}\n'\n\nAND yara.count > 0\n"
  tags: persistent, filesystem, systemd
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Look for sketchy udev entries, inspired by sedexp
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - suspicious-udev-runner-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Look for sketchy udev entries, inspired by sedexp
    --
    -- references:
    --  * https://www.aon.com/en/insights/cyber-labs/unveiling-sedexp
    --  * https://ch4ik0.github.io/en/posts/leveraging-Linux-udev-for-persistence/
    --
    -- tags: volume filesystem
    -- platform: linux
    SELECT
      file.path,
      file.size,
      file.btime,
      file.ctime,
      file.mtime,
      hash.sha256,
      yara.*
    FROM
      file
      JOIN yara ON file.path = yara.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      file.path IN (
        SELECT
          file.path
        FROM
          file
        WHERE
          file.path LIKE '/etc/udev/rules.d/%'
          OR file.path LIKE '/usr/lib/udev/rules.d/%'
          OR file.path LIKE '/lib/udev/rules.d/%'
          OR file.path LIKE '/usr/local/lib/udev/rules.d/%'
        GROUP BY
          file.inode
      )
      AND yara.sigrule = '
    rule udev_memory_device_runner : critical {
        meta:
            description = "runs program once built-in memory device is created"
        strings:
            $action_add = "ACTION==\"add\""
            $major = "ENV{MAJOR}==\"1\""
            $run = "RUN+="
        condition:
            all of them
    }

    rule udev_at_runner : critical {
        meta:
            description = "runs program via at"
            reference = "https://ch4ik0.github.io/en/posts/leveraging-Linux-udev-for-persistence/"
        strings:
            $add = "ACTION==\"add\""
            $run_at = "RUN+=\"/usr/bin/at "
            $run_at2 = "RUN+=\"at "
        condition:
            $add and any of ($run*)
    }

    rule udev_unusual_small_runner : high {
        meta:
            description = "small udev entry that runs program based on unusual parameters"
        strings:
            $action_run = "RUN+="
            $not_attrs = "ATTRS{"
            $not_kernel = "KERNEL=="
            $not_block = "SUBSYSTEM==\"block\""
            $not_bridge = "RUN+=\"bridge-network-interface\""
        condition:
            filesize < 96 and all of ($action*) and none of ($not*)
    }

    rule udev_major_runner : high {
        meta:
            description = "runs program once major device number is created, may have false-positives"
        strings:
            $action_add = "ACTION==\"add\""
            $major = "ENV{MAJOR}=="
            $run = "RUN+="
        condition:
            all of them
    }'
      AND yara.count > 0
  tags: volume, filesystem
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected systemd units, may be evidence of persistence
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-active-systemd-units
  observer_can_run: false
  platforms: linux
  query: "-- Unexpected systemd units, may be evidence of persistence\n--\n-- references:\n\
    --   * https://attack.mitre.org/techniques/T1543/002/ (Create or Modify System\
    \ Process: Systemd Service)\n--\n-- false positives:\n--   * System updates\n\
    --\n-- tags: persistent seldom filesystem systemd\n-- platform: linux\nSELECT\
    \ --  description AS 'desc',\n  fragment_path,\n  MAX(user, 'root') AS effective_user,\n\
    \  following,\n  hash.sha256,\n  file.ctime,\n  file.size,\n  CONCAT (id, ',',\
    \ description, ',', user) AS exception_key\nFROM\n  systemd_units\n  LEFT JOIN\
    \ hash ON systemd_units.fragment_path = hash.path\n  LEFT JOIN file ON systemd_units.fragment_path\
    \ = file.path\nWHERE\n  active_state != 'inactive'\n  AND sub_state != 'plugged'\n\
    \  AND sub_state != 'mounted'\n  AND file.filename != ''\n  -- Don't care about\
    \ logical groupings.\n  AND NOT file.filename LIKE '%.target'\n  AND NOT fragment_path\
    \ = '/usr/lib/systemd/system/systemd-fsck@.service'\n  -- All of these are known\
    \ good exceptions in known good paths\n  AND NOT (\n    (\n      -- Only allow\
    \ fragment paths in known good directories\n      fragment_path LIKE '/lib/systemd/system/%'\n\
    \      OR fragment_path LIKE '/usr/lib/systemd/system/%'\n      OR fragment_path\
    \ LIKE '/etc/systemd/system/%'\n      OR fragment_path LIKE '/run/systemd/generator/%'\n\
    \      OR fragment_path LIKE '/run/systemd/generator.late/%.service'\n      OR\
    \ fragment_path LIKE '/run/systemd/transient/%'\n    )\n    AND (\n      exception_key\
    \ IN (\n        'abrtd.service,ABRT Automated Bug Reporting Tool,',\n        'abrtd.service,ABRT\
    \ Daemon,',\n        'abrt-journal-core.service,ABRT coredumpctl message creator,',\n\
    \        'abrt-journal-core.service,Creates ABRT problems from coredumpctl messages,',\n\
    \        'abrt-oops.service,ABRT kernel log watcher,',\n        'abrt-xorg.service,ABRT\
    \ Xorg log watcher,',\n        'accounts-daemon.service,Accounts Service,',\n\
    \        'acpid.path,ACPI Events Check,',\n        'acpid.service,ACPI Daemon,',\n\
    \        'acpid.service,ACPI event daemon,',\n        'acpid.socket,ACPID Listen\
    \ Socket,',\n        'akmods.service,Builds and install new kmods from akmod packages,',\n\
    \        'alsa-restore.service,Save/Restore Sound Card State,',\n        'alsa-state.service,Manage\
    \ Sound Card State (restore and store),',\n        'alsa-store.service,Store Sound\
    \ Card State,',\n        'anacron.service,Run anacron jobs,',\n        'anacron.timer,Trigger\
    \ anacron every hour,',\n        'apache2.service,The Apache HTTP Server,',\n\
    \        'apcupsd.service,APC UPS Power Control Daemon for Linux,',\n        'apparmor.service,Load\
    \ AppArmor profiles,',\n        'apport-autoreport.path,Process error reports\
    \ when automatic reporting is enabled (file watch),',\n        'apport-autoreport.service,Process\
    \ error reports when automatic reporting is enabled,',\n        'apport-autoreport.timer,Process\
    \ error reports when automatic reporting is enabled (timer based),',\n       \
    \ 'apport.service,automatic crash report generation,',\n        'apport.service,LSB:\
    \ automatic crash report generation,',\n        'apt-daily.service,Daily apt download\
    \ activities,',\n        'apt-daily.timer,Daily apt download activities,',\n \
    \       'apt-daily-upgrade.timer,Daily apt upgrade and clean activities,',\n \
    \       'archlinux-keyring-wkd-sync.service,Refresh existing keys of archlinux-keyring,',\n\
    \        'archlinux-keyring-wkd-sync.timer,Refresh existing PGP keys of archlinux-keyring\
    \ regularly,',\n        'atd.service,Deferred execution scheduler,',\n       \
    \ 'auditd.service,Security Auditing Service,',\n        'auditd.service,Security\
    \ Audit Logging Service,',\n        'audit.service,Kernel Auditing,',\n      \
    \  'augenrules.service,auditd rules generation,',\n        'avahi-daemon.service,Avahi\
    \ mDNS/DNS-SD Stack,',\n        'avahi-daemon.socket,Avahi mDNS/DNS-SD Stack Activation\
    \ Socket,',\n        'backup-rpmdb.timer,Backup of RPM database,',\n        'backup-sysconfig.timer,Backup\
    \ of /etc/sysconfig,',\n        'binfmt-support.service,Enable support for additional\
    \ executable binary formats,',\n        'blk-availability.service,Availability\
    \ of block devices,',\n        'bluetooth.service,Bluetooth service,',\n     \
    \   'bolt.service,Thunderbolt system service,',\n        'bootupd.socket,bootupd.socket,',\n\
    \        'brew-update.service,Auto update brew for mutable brew installs,1000',\n\
    \        'brew-update.timer,Timer for brew update for mutable brew,',\n      \
    \  'brew-upgrade.timer,Timer for brew upgrade for on image brew,',\n        'ca-certificates.path,Watch\
    \ for changes in CA certificates,',\n        'check-battery.timer,Check if mainboard\
    \ battery is Ok,',\n        'chronyd.service,NTP client/server,',\n        'chrony.service,chrony,\
    \ an NTP client/server',\n        'cloud-config.service,Apply the settings specified\
    \ in cloud-config,',\n        'cloud-final.service,Execute cloud user/final scripts,',\n\
    \        'cloud-init-hotplugd.socket,cloud-init hotplug hook socket,',\n     \
    \   'cloud-init-local.service,Initial cloud-init job (pre-networking),',\n   \
    \     'cloud-init.service,Initial cloud-init job (metadata service crawler),',\n\
    \        'colord.service,Manage, Install and Generate Color Profiles,colord',\n\
    \        'com.system76.PowerDaemon.service,System76 Power Daemon,',\n        'com.system76.Scheduler.service,Automatically\
    \ configure CPU scheduler for responsiveness on AC,',\n        'console-setup.service,Set\
    \ console font and keymap,',\n        'containerd.service,containerd container\
    \ runtime,',\n        'cpufrequtils.service,LSB: set CPUFreq kernel parameters,',\n\
    \        'crond.service,Command Scheduler,',\n        'cronie.service,Periodic\
    \ Command Scheduler,',\n        'cron.service,Regular background program processing\
    \ daemon,',\n        'cups-browsed.service,Make remote CUPS printers available\
    \ locally,',\n        'cups-browsed.service,Make remote CUPS printers available\
    \ locally,cups-browsed',\n        'cups.path,CUPS Scheduler,',\n        'cups.service,CUPS\
    \ Scheduler,',\n        'cups.socket,CUPS Scheduler,',\n        'dbus-:1.2-org.pop_os.transition_system@0.service,dbus-:1.2-org.pop_os.transition_system@0.service,0',\n\
    \        'dbus-broker.service,D-Bus System Message Bus,',\n        'dbus.service,D-Bus\
    \ System Message Bus,',\n        'dbus.socket,D-Bus System Message Bus Socket,',\n\
    \        'detect-part-label-duplicates.service,Detect if the system suffers from\
    \ bsc#1089761,',\n        'dhcpcd.service,DHCP Client,',\n        'displaylink.service,DisplayLink\
    \ Manager Service,',\n        'display-manager.service,Display Manager,',\n  \
    \      'display-manager.service,X11 Server,',\n        'dkms.service,Builds and\
    \ install new kernel modules through DKMS,',\n        'dm-event.socket,Device-mapper\
    \ event daemon FIFOs,',\n        'dnf-automatic-install.service,dnf automatic\
    \ install updates,',\n        'dnf-automatic-install.timer,dnf-automatic-install\
    \ timer,',\n        'dnf-makecache.service,dnf makecache,',\n        'dnf-makecache.timer,dnf\
    \ makecache --timer,',\n        'docker.service,Docker Application Container Engine,',\n\
    \        'docker.socket,Docker Socket for the API,',\n        'dpkg-db-backup.timer,Daily\
    \ dpkg database backup timer,',\n        'dracut-shutdown.service,Restore /run/initramfs\
    \ on shutdown,',\n        'e2scrub_all.timer,Periodic ext4 Online Metadata Check\
    \ for All Filesystems,',\n        'elastic-agent.service,Elastic Agent is a unified\
    \ agent to observe, monitor and protect your system.,',\n        'ElasticEndpoint.service,ElasticEndpoint,',\n\
    \        'finalrd.service,Create final runtime dir for shutdown pivot root,',\n\
    \        'firewalld.service,firewalld - dynamic firewall daemon,',\n        'firewall.service,Firewall,',\n\
    \        'flatpak-system-helper.service,flatpak system helper,',\n        'fprintd.service,Fingerprint\
    \ Authentication Daemon,',\n        'fstrim.service,Discard unused blocks on filesystems\
    \ from /etc/fstab,',\n        'fstrim.timer,Discard unused blocks once a week,',\n\
    \        'fstrim.timer,Discard unused filesystem blocks once a week,',\n     \
    \   'fwupd-refresh.service,Refresh fwupd metadata and update motd,fwupd-refresh',\n\
    \        'fwupd-refresh.timer,Refresh fwupd metadata regularly,',\n        'fwupd.service,Firmware\
    \ update daemon,',\n        'gdm.service,GNOME Display Manager,',\n        'geoclue.service,Location\
    \ Lookup Service,geoclue',\n        'gitsign.service,Keyless Git signing with\
    \ Sigstore!,',\n        'gnome-remote-desktop.service,GNOME Remote Desktop,gnome-remote-desktop',\n\
    \        'gssproxy.service,GSSAPI Proxy Daemon,',\n        'haproxy.service,HAProxy\
    \ Load Balancer,',\n        'haveged.service,Entropy Daemon based on the HAVEGE\
    \ algorithm,',\n        'ifupdown-pre.service,Helper to synchronize boot up for\
    \ ifupdown,',\n        'iio-sensor-proxy.service,IIO Sensor Proxy service,',\n\
    \        'import-state.service,Import network configuration from initramfs,',\n\
    \        'incus-lxcfs.service,Incus - LXCFS daemon,',\n        'incus.service,Incus\
    \ - Daemon,',\n        'incus.service,Incus - Main daemon,',\n        'incus.socket,Incus\
    \ - Daemon (unix socket),',\n        'incus-startup.service,Incus - Startup check,',\n\
    \        'incus-user.socket,Incus - Daemon (user unix socket),',\n        'ir_agent.service,Rapid7\
    \ Insight Agent,root',\n        'irqbalance.service,irqbalance daemon,',\n   \
    \     'iscsid.socket,Open-iSCSI iscsid Socket,',\n        'iscsiuio.socket,Open-iSCSI\
    \ iscsiuio Socket,',\n        'issue-generator.path,Watch for changes in issue\
    \ snippets,',\n        'iwd.service,Wireless service,',\n        'jeos-firstboot.service,SUSE\
    \ JeOS First Boot Wizard,',\n        'jeos-firstboot-snapshot.service,SUSE JeOS\
    \ First Boot Wizard - create system snapshot,',\n        'kbdsettings.service,Apply\
    \ settings from /etc/sysconfig/keyboard,',\n        'kde-sysmonitor-workaround.service,Workaround\
    \ KDE System Monitor not having the correct caps,',\n        'kdump.service,Crash\
    \ recovery kernel arming,',\n        'kerneloops.service,Tool to automatically\
    \ collect and submit kernel crash signatures,kernoops',\n        'keyboard-setup.service,Set\
    \ the console keyboard layout,',\n        'klog.service,Early Kernel Boot Messages,',\n\
    \        'kmod-static-nodes.service,Create List of Static Device Nodes,',\n  \
    \      'kmod-static-nodes.service,Create list of static device nodes for the current\
    \ kernel,',\n        'kolide-launcher.service,Kolide launcher,',\n        'launcher.kolide-k2.service,The\
    \ Kolide Launcher,',\n        'launcher,/usr/local/kolide-k2/bin/launcher,0,system.slice,launcher.kolide-k2.service,0755',\n\
    \        'ldconfig.service,Rebuild Dynamic Linker Cache,',\n        'libvirtd-admin.socket,Libvirt\
    \ admin socket,',\n        'libvirtd-ro.socket,Libvirt local read-only socket,',\n\
    \        'libvirtd.service,Virtualization daemon,',\n        'libvirtd.socket,Libvirt\
    \ local socket,',\n        'libvirt-workaround.service,Workaround to relabel libvirt\
    \ files and directories,',\n        'lightdm.service,Light Display Manager,',\n\
    \        'lima-guestagent.service,lima-guestagent,',\n        'livesys-late.service,SYSV:\
    \ Late init script for live image.,',\n        'livesys.service,LSB: Init script\
    \ for live image.,',\n        'lm_sensors.service,Hardware Monitoring Sensors,',\n\
    \        'lm-sensors.service,Initialize hardware monitoring sensors,',\n     \
    \   'lm_sensors.service,Initialize hardware monitoring sensors,',\n        'loadcpufreq.service,LSB:\
    \ Load kernel modules needed to enable cpufreq scaling,',\n        'logrotate-checkconf.service,Logrotate\
    \ configuration check,',\n        'logrotate.service,Rotate log files,',\n   \
    \     'logrotate.timer,Daily rotation of log files,',\n        'logrotate.timer,logrotate.timer,',\n\
    \        'low-memory-monitor.service,Low Memory Monitor,',\n        'lvm2-lvmpolld.socket,LVM2\
    \ poll daemon socket,',\n        'lvm2-monitor.service,Monitoring of LVM2 mirrors,\
    \ snapshots etc. using dmeventd or progress polling,',\n        'lxcfs.service,FUSE\
    \ filesystem for LXC,',\n        'lxc-monitord.service,LXC Container Monitoring\
    \ Daemon,',\n        'lxc-net.service,LXC network bridge setup,',\n        'lxc.service,LXC\
    \ Container Initialization and Autoboot Code,',\n        'lxd-installer.socket,Helper\
    \ to install lxd snap on demand,',\n        'machine.slice,Virtual Machine and\
    \ Container Slice,',\n        'man-db.service,Daily man-db regeneration,root',\n\
    \        'man-db.timer,Daily man-db regeneration,',\n        'mcelog.service,Machine\
    \ Check Exception Logging Daemon,',\n        'mlocate-updatedb.timer,Updates mlocate\
    \ database every day,',\n        'ModemManager.service,Modem Manager,root',\n\
    \        'modprobe@efi_pstore.service,Load Kernel Module efi_pstore,',\n     \
    \   'modprobe@pstore_blk.service,Load Kernel Module pstore_blk,',\n        'modprobe@pstore_zone.service,Load\
    \ Kernel Module pstore_zone,',\n        'modprobe@ramoops.service,Load Kernel\
    \ Module ramoops,',\n        'monitorix.service,Monitorix,',\n        'motd-news.timer,Message\
    \ of the Day,',\n        'mount-pstore.service,mount-pstore.service,',\n     \
    \   'multipathd.service,Device-Mapper Multipath Device Controller,',\n       \
    \ 'multipathd.socket,multipathd control socket,',\n        'nessusd.service,The\
    \ Nessus Vulnerability Scanner,',\n        'netcf-transaction.service,Rollback\
    \ uncommitted netcf network config change transactions,',\n        'networkd-dispatcher.service,Dispatcher\
    \ daemon for systemd-networkd,',\n        'networking.service,Raise network interfaces,',\n\
    \        'network-local-commands.service,Extra networking commands.,',\n     \
    \   'NetworkManager-dispatcher.service,Network Manager Script Dispatcher Service,',\n\
    \        'NetworkManager.service,Network Manager,',\n        'NetworkManager-wait-online.service,Network\
    \ Manager Wait Online,',\n        'network-setup.service,Networking Setup,',\n\
    \        'nginx.service,A high performance web server and a reverse proxy server,',\n\
    \        'nginx.service,Nginx Web Server,nginx',\n        'nis-domainname.service,Read\
    \ and set NIS domainname from /etc/sysconfig/network,',\n        'nix-daemon.service,Nix\
    \ Daemon,',\n        'nix-daemon.socket,Nix Daemon Socket,',\n        'nix-gc.timer,nix-gc.timer,',\n\
    \        'nscd.service,Name Service Cache Daemon,nscd',\n        'nscd.service,Name\
    \ Service Cache Daemon (nsncd),nscd',\n        'nvidia-fallback.service,Fallback\
    \ to nouveau as nvidia did not load,',\n        'nvidia-persistenced.service,NVIDIA\
    \ Persistence Daemon,',\n        'nvidia-powerd.service,nvidia-powerd service,',\n\
    \        'nvidia-suspend.service,NVIDIA system suspend actions,',\n        'openvpn.service,OpenVPN\
    \ service,',\n        'orbit,/opt/orbit/bin/orbit/linux/stable/orbit,0',\n   \
    \     'orbit.service,Orbit osquery,',\n        'ostree-finalize-staged-hold.service,Hold\
    \ /boot Open for OSTree Finalize Staged Deployment,',\n        'ostree-finalize-staged.path,OSTree\
    \ Monitor Staged Deployment,',\n        'ostree-finalize-staged.service,OSTree\
    \ Finalize Staged Deployment,',\n        'ostree-remount.service,OSTree Remount\
    \ OS/ Bind Mounts,',\n        'packagekit.service,PackageKit Daemon,root',\n \
    \       'passim.service,Local Caching Server,passim',\n        'pcscd.service,PC/SC\
    \ Smart Card Daemon,',\n        'pcscd.socket,PC/SC Smart Card Daemon Activation\
    \ Socket,',\n        'phpsessionclean.timer,Clean PHP session files every 30 mins,',\n\
    \        'plocate-updatedb.service,Update the plocate database,',\n        'plocate-updatedb.timer,Update\
    \ the plocate database daily,',\n        'plymouth-quit.service,Terminate Plymouth\
    \ Boot Screen,',\n        'plymouth-quit-wait.service,Hold until boot process\
    \ finishes up,',\n        'plymouth-read-write.service,Tell Plymouth To Write\
    \ Out Runtime Data,',\n        'plymouth-start.service,Show Plymouth Boot Screen,',\n\
    \        'pmcd.service,Performance Metrics Collector Daemon,',\n        'podman.socket,Podman\
    \ API Socket,',\n        'polkit.service,Authorization Manager,',\n        'polkit.service,Authorization\
    \ Manager,polkitd',\n        'postfix@-.service,Postfix Mail Transport Agent (instance\
    \ -),',\n        'power-profiles-daemon.service,Power Profiles daemon,',\n   \
    \     'proc-sys-fs-binfmt_misc.automount,Arbitrary Executable File Formats File\
    \ System Automount Point,',\n        'pulseaudio-enable-autospawn.service,LSB:\
    \ Enable pulseaudio autospawn,',\n        'pwrstatd.service,The monitor UPS software.,',\n\
    \        'qemu-kvm.service,QEMU KVM preparation - module, ksm, hugepages,',\n\
    \        'qualys-cloud-agent.service,Qualys cloud agent daemon,',\n        'raid-check.timer,Weekly\
    \ RAID setup health check,',\n        'realmd.service,Realm and Domain Configuration,',\n\
    \        'reflector.service,Refresh Pacman mirrorlist with Reflector.,',\n   \
    \     'reflector.timer,Refresh Pacman mirrorlist weekly with Reflector.,',\n \
    \       'reload-systemd-vconsole-setup.service,Reset console on configuration\
    \ changes,',\n        'resolvconf-pull-resolved.path,resolvconf-pull-resolved.path,',\n\
    \        'resolvconf.service,Nameserver information manager,',\n        'resolvconf.service,resolvconf\
    \ update,',\n        'rngd.service,Hardware RNG Entropy Gatherer Daemon,',\n \
    \       'rpcbind.service,RPC Bind,',\n        'rpcbind.socket,RPCbind Server Activation\
    \ Socket,',\n        'rpc-statd-notify.service,Notify NFS peers of a restart,',\n\
    \        'rpm-ostree-countme.service,Weekly rpm-ostree Count Me reporting,rpm-ostree',\n\
    \        'rpm-ostree-countme.timer,Weekly rpm-ostree Count Me timer,',\n     \
    \   'rpm-ostreed-automatic.service,rpm-ostree Automatic Update,',\n        'rpm-ostreed-automatic.timer,rpm-ostree\
    \ Automatic Update Trigger,',\n        'rpm-ostreed.service,rpm-ostree System\
    \ Management Daemon,rpm-ostree',\n        'rsyslog.service,System Logging Service,',\n\
    \        'rtkit-daemon.service,RealtimeKit Scheduling Policy Service,',\n    \
    \    'schroot.service,Recover schroot sessions,',\n        'sddm.service,Simple\
    \ Desktop Display Manager,',\n        'serial-getty@hvc0.service,Serial Getty\
    \ on hvc0,',\n        'serial-getty@ttyAMA0.service,Serial Getty on ttyAMA0,',\n\
    \        'serial-getty@ttyS0.service,Serial Getty on ttyS0,',\n        'setroubleshootd.service,SETroubleshoot\
    \ daemon for processing new SELinux denial logs,setroubleshoot',\n        'setvtrgb.service,Set\
    \ console scheme,',\n        'shadow.service,Verify integrity of password and\
    \ group files,',\n        'shadow.timer,Daily verification of password and group\
    \ files,',\n        '-.slice,Root Slice,',\n        'smartd.service,Self Monitoring\
    \ and Reporting Technology (SMART) Daemon,',\n        'snap.canonical-livepatch.canonical-livepatchd.service,Service\
    \ for snap application canonical-livepatch.canonical-livepatchd,',\n        'snapd.apparmor.service,Load\
    \ AppArmor profiles managed internally by snapd,',\n        'snapd.seeded.service,Wait\
    \ until snapd is fully seeded,',\n        'snapd.service,Snap Daemon,',\n    \
    \    'snapd.socket,Socket activation for snappy daemon,',\n        'snap.lxd.daemon.unix.socket,Socket\
    \ unix for snap application lxd.daemon,',\n        'snap.lxd.user-daemon.unix.socket,Socket\
    \ unix for snap application lxd.user-daemon,',\n        'snap.yubioath-desktop.pcscd.service,Service\
    \ for snap application yubioath-desktop.pcscd,',\n        'sshd.service,OpenSSH\
    \ Daemon,',\n        'sshd.service,OpenSSH server daemon,',\n        'sshd.service,SSH\
    \ Daemon,',\n        'ssh.service,OpenBSD Secure Shell server,',\n        'ssh.socket,OpenBSD\
    \ Secure Shell server socket,',\n        'sssd-kcm.service,SSSD Kerberos Cache\
    \ Manager,',\n        'sssd-kcm.socket,SSSD Kerberos Cache Manager responder socket,',\n\
    \        'supergfxd.service,SUPERGFX,',\n        'swapfile.swap,/swapfile,',\n\
    \        'swap.img.swap,/swap.img,',\n        'switcheroo-control.service,Switcheroo\
    \ Control Proxy service,',\n        'swtpm-workaround.service,Workaround swtpm\
    \ not having the correct label,',\n        'syslog.socket,Syslog Socket,',\n \
    \       'sysstat-collect.timer,Run system activity accounting tool every 10 minutes,',\n\
    \        'sysstat.service,Resets System Activity Logs,root',\n        'sysstat-summary.timer,Generate\
    \ summary of yesterday''s process accounting,',\n        'systemd-ask-password-console.path,Dispatch\
    \ Password Requests to Console Directory Watch,',\n        'systemd-ask-password-plymouth.path,Forward\
    \ Password Requests to Plymouth Directory Watch,',\n        'systemd-ask-password-wall.path,Forward\
    \ Password Requests to Wall Directory Watch,',\n        'systemd-binfmt.service,Set\
    \ Up Additional Binary Formats,',\n        'systemd-boot-random-seed.service,Update\
    \ Boot Loader Random Seed,',\n        'systemd-boot-update.service,Automatic Boot\
    \ Loader Update,',\n        'systemd-coredump.socket,Process Core Dump Socket,',\n\
    \        'systemd-fsckd.socket,fsck to fsckd communication Socket,',\n       \
    \ 'systemd-fsck-root.service,File System Check on Root Device,',\n        'systemd-growfs@-.service,Grow\
    \ File System on /,',\n        'systemd-homed-activate.service,Home Area Activation,',\n\
    \        'systemd-homed.service,Home Area Manager,',\n        'systemd-hostnamed.service,Hostname\
    \ Service,',\n        'systemd-hwdb-update.service,Rebuild Hardware Database,',\n\
    \        'systemd-initctl.socket,initctl Compatibility Named Pipe,',\n       \
    \ 'systemd-journal-catalog-update.service,Rebuild Journal Catalog,',\n       \
    \ 'systemd-journald-audit.socket,Journal Audit Socket,',\n        'systemd-journald-dev-log.socket,Journal\
    \ Socket (/dev/log),',\n        'systemd-journald.service,Journal Service,',\n\
    \        'systemd-journald.socket,Journal Socket,',\n        'systemd-journal-flush.service,Flush\
    \ Journal to Persistent Storage,',\n        'systemd-localed.service,Locale Service,',\n\
    \        'systemd-logind.service,User Login Management,',\n        'systemd-machined.service,Virtual\
    \ Machine and Container Registration Service,',\n        'systemd-machine-id-commit.service,Commit\
    \ a transient machine-id on disk,',\n        'systemd-modules-load.service,Load\
    \ Kernel Modules,',\n        'systemd-networkd.service,Network Configuration,systemd-network',\n\
    \        'systemd-networkd.socket,Network Service Netlink Socket,',\n        'systemd-networkd-wait-online.service,Wait\
    \ for Network to be Configured,',\n        'systemd-network-generator.service,Generate\
    \ network units from Kernel command line,',\n        'systemd-oomd.service,Userspace\
    \ Out-Of-Memory (OOM) Killer,systemd-oom',\n        'systemd-oomd.socket,Userspace\
    \ Out-Of-Memory (OOM) Killer Socket,',\n        'systemd-pcrmachine.service,TPM2\
    \ PCR Machine ID Measurement,',\n        'systemd-pcrphase.service,TPM2 PCR Barrier\
    \ (User),',\n        'systemd-pcrphase-sysinit.service,TPM2 PCR Barrier (Initialization),',\n\
    \        'systemd-pstore.service,Platform Persistent Storage Archival,',\n   \
    \     'systemd-random-seed.service,Load/Save OS Random Seed,',\n        'systemd-random-seed.service,Load/Save\
    \ Random Seed,',\n        'systemd-remount-fs.service,Remount Root and Kernel\
    \ File Systems,',\n        'systemd-resolved.service,Network Name Resolution,systemd-resolve',\n\
    \        'systemd-rfkill.socket,Load/Save RF Kill Switch Status /dev/rfkill Watch,',\n\
    \        'systemd-suspend.service,System Suspend,',\n        'systemd-sysctl.service,Apply\
    \ Kernel Variables,',\n        'systemd-sysext.socket,System Extension Image Management\
    \ (Varlink),',\n        'systemd-sysusers.service,Create System Users,',\n   \
    \     'systemd-timedated.service,Time & Date Service,',\n        'systemd-timesyncd.service,Network\
    \ Time Synchronization,systemd-timesync',\n        'systemd-tmpfiles-clean.timer,Daily\
    \ Cleanup of Temporary Directories,',\n        'systemd-tmpfiles-setup-dev-early.service,Create\
    \ Static Device Nodes in /dev gracefully,',\n        'systemd-tmpfiles-setup-dev.service,Create\
    \ Static Device Nodes in /dev,',\n        'systemd-tmpfiles-setup.service,Create\
    \ System Files and Directories,',\n        'systemd-tmpfiles-setup.service,Create\
    \ Volatile Files and Directories,',\n        'systemd-udevd-control.socket,udev\
    \ Control Socket,',\n        'systemd-udevd-kernel.socket,udev Kernel Socket,',\n\
    \        'systemd-udevd.service,Rule-based Manager for Device Events and Files,',\n\
    \        'systemd-udev-settle.service,Wait for udev To Complete Device Initialization,',\n\
    \        'systemd-udev-trigger.service,Coldplug All udev Devices,',\n        'systemd-update-done.service,Update\
    \ is Completed,',\n        'systemd-update-utmp.service,Record System Boot/Shutdown\
    \ in UTMP,',\n        'systemd-update-utmp.service,Update UTMP about System Boot/Shutdown,',\n\
    \        'systemd-userdbd.service,User Database Manager,',\n        'systemd-userdbd.socket,User\
    \ Database Manager Socket,',\n        'systemd-user-sessions.service,Permit User\
    \ Sessions,',\n        'systemd-vconsole-setup.service,Setup Virtual Console,',\n\
    \        'systemd-vconsole-setup.service,Virtual Console Setup,',\n        'system.slice,System\
    \ Slice,',\n        'tailscaled.service,Tailscale node agent,',\n        'thermald.service,Thermal\
    \ Daemon Service,',\n        'tlp.service,TLP system startup/shutdown,',\n   \
    \     'touchegg.service,Touch\xE9gg Daemon,',\n        'ua-timer.timer,Ubuntu\
    \ Advantage Timer for running repeated jobs,',\n        'ua-timer.timer,Ubuntu\
    \ Pro Timer for running repeated jobs,',\n        'ublue-system-setup.service,Configure\
    \ system,',\n        'ublue-update.service,Universal Blue Update Oneshot Service,',\n\
    \        'ublue-update.timer,Auto Update System Timer For Universal Blue,',\n\
    \        'ubuntu-fan.service,Ubuntu FAN network setup,',\n        'udisks2.service,Disk\
    \ Manager,',\n        'ufw.service,Uncomplicated firewall,',\n        'unattended-upgrades.service,Unattended\
    \ Upgrades Shutdown,',\n        'unbound-anchor.timer,daily update of the root\
    \ trust anchor for DNSSEC,',\n        'updatedb.timer,Daily locate database update,',\n\
    \        'update-notifier-download.timer,Download data for packages that failed\
    \ at package install time,',\n        'update-notifier-motd.timer,Check to see\
    \ whether there is a new version of Ubuntu available,',\n        'upower.service,Daemon\
    \ for power management,',\n        'uresourced.service,User resource assignment\
    \ daemon,',\n        'usbmuxd.service,Socket daemon for the usbmux protocol used\
    \ by Apple devices,',\n        'user.slice,User and Session Slice,',\n       \
    \ 'uuidd.service,Daemon for generating UUIDs,uuidd',\n        'uuidd.socket,UUID\
    \ daemon activation socket,',\n        'v4l2-relayd.service,v4l2-relay daemon\
    \ service,',\n        'vboxautostart-service.service,vboxautostart-service.service,',\n\
    \        'vboxballoonctrl-service.service,vboxballoonctrl-service.service,',\n\
    \        'vboxdrv.service,VirtualBox Linux kernel module,',\n        'vboxweb-service.service,vboxweb-service.service,',\n\
    \        'velociraptor_client.service,Velociraptor linux client,',\n        'velociraptor_server.service,Velociraptor\
    \ server,velociraptor',\n        'virtinterfaced-admin.socket,libvirt interface\
    \ daemon admin socket,',\n        'virtinterfaced-ro.socket,libvirt interface\
    \ daemon read-only socket,',\n        'virtinterfaced.socket,libvirt interface\
    \ daemon socket,',\n        'virtinterfaced.socket,Libvirt interface local socket,',\n\
    \        'virtlockd-admin.socket,libvirt locking daemon admin socket,',\n    \
    \    'virtlockd.socket,libvirt locking daemon socket,',\n        'virtlockd.socket,Virtual\
    \ machine lock manager socket,',\n        'virtlogd-admin.socket,libvirt logging\
    \ daemon admin socket,',\n        'virtlogd-admin.socket,Virtual machine log manager\
    \ socket,',\n        'virtlogd.service,Virtual machine log manager,',\n      \
    \  'virtlogd.socket,libvirt logging daemon socket,',\n        'virtlogd.socket,Virtual\
    \ machine log manager socket,',\n        'virtlxcd-admin.socket,libvirt LXC daemon\
    \ admin socket,',\n        'virtlxcd-ro.socket,libvirt LXC daemon read-only socket,',\n\
    \        'virtlxcd.socket,libvirt LXC daemon socket,',\n        'virtnetworkd-admin.socket,libvirt\
    \ network daemon admin socket,',\n        'virtnetworkd-ro.socket,libvirt network\
    \ daemon read-only socket,',\n        'virtnetworkd.socket,libvirt network daemon\
    \ socket,',\n        'virtnetworkd.socket,Libvirt network local socket,',\n  \
    \      'virtnodedevd-admin.socket,libvirt nodedev daemon admin socket,',\n   \
    \     'virtnodedevd-ro.socket,libvirt nodedev daemon read-only socket,',\n   \
    \     'virtnodedevd.socket,libvirt nodedev daemon socket,',\n        'virtnodedevd.socket,Libvirt\
    \ nodedev local socket,',\n        'virtnwfilterd-admin.socket,libvirt nwfilter\
    \ daemon admin socket,',\n        'virtnwfilterd-ro.socket,libvirt nwfilter daemon\
    \ read-only socket,',\n        'virtnwfilterd.socket,libvirt nwfilter daemon socket,',\n\
    \        'virtnwfilterd.socket,Libvirt nwfilter local socket,',\n        'virtproxyd-admin.socket,libvirt\
    \ proxy daemon admin socket,',\n        'virtproxyd-ro.socket,libvirt proxy daemon\
    \ read-only socket,',\n        'virtproxyd.socket,libvirt proxy daemon socket,',\n\
    \        'virtproxyd.socket,Libvirt proxy local socket,',\n        'virtqemud-admin.socket,Libvirt\
    \ qemu admin socket,',\n        'virtqemud-admin.socket,libvirt QEMU daemon admin\
    \ socket,',\n        'virtqemud-ro.socket,libvirt QEMU daemon read-only socket,',\n\
    \        'virtqemud-ro.socket,Libvirt qemu local read-only socket,',\n       \
    \ 'virtqemud.service,Virtualization qemu daemon,',\n        'virtqemud.socket,libvirt\
    \ QEMU daemon socket,',\n        'virtqemud.socket,Libvirt qemu local socket,',\n\
    \        'virtsecretd-admin.socket,libvirt secret daemon admin socket,',\n   \
    \     'virtsecretd-ro.socket,libvirt secret daemon read-only socket,',\n     \
    \   'virtsecretd.socket,libvirt secret daemon socket,',\n        'virtsecretd.socket,Libvirt\
    \ secret local socket,',\n        'virtstoraged-admin.socket,libvirt storage daemon\
    \ admin socket,',\n        'virtstoraged-ro.socket,libvirt storage daemon read-only\
    \ socket,',\n        'virtstoraged.socket,libvirt storage daemon socket,',\n \
    \       'virtstoraged.socket,Libvirt storage local socket,',\n        'virtvboxd-admin.socket,libvirt\
    \ VirtualBox daemon admin socket,',\n        'virtvboxd-ro.socket,libvirt VirtualBox\
    \ daemon read-only socket,',\n        'virtvboxd.socket,libvirt VirtualBox daemon\
    \ socket,',\n        'whoopsie.path,Start whoopsie on modification of the /var/crash\
    \ directory,',\n        'wickedd-auto4.service,wicked AutoIPv4 supplicant service,',\n\
    \        'wickedd-dhcp4.service,wicked DHCPv4 supplicant service,',\n        'wickedd-dhcp6.service,wicked\
    \ DHCPv6 supplicant service,',\n        'wickedd-nanny.service,wicked network\
    \ nanny service,',\n        'wickedd.service,wicked network management service\
    \ daemon,',\n        'wicked.service,wicked managed network interfaces,',\n  \
    \      'wpa_supplicant.service,WPA supplicant,',\n        'zfs-import-cache.service,Import\
    \ ZFS pools by cache file,',\n        'zfs-load-key-rpool.service,Load ZFS key\
    \ for rpool,',\n        'zfs-load-module.service,Install ZFS kernel module,',\n\
    \        'zfs-mount.service,Mount ZFS filesystems,',\n        'zfs-scrub.service,ZFS\
    \ pools scrubbing,',\n        'zfs-scrub.timer,zfs-scrub.timer,',\n        'zfs-share.service,ZFS\
    \ file system shares,',\n        'zfs-snapshot-daily.service,ZFS auto-snapshotting\
    \ every day,',\n        'zfs-snapshot-frequent.service,ZFS auto-snapshotting every\
    \ 15 mins,',\n        'zfs-snapshot-hourly.service,ZFS auto-snapshotting every\
    \ hour,',\n        'zfs-volume-wait.service,Wait for ZFS Volume (zvol) links in\
    \ /dev,',\n        'zfs-zed.service,ZFS Event Daemon (zed),',\n        'znapzend.service,ZnapZend\
    \ - ZFS Backup System,root',\n        'zpool-trim.service,ZFS pools trim,',\n\
    \        'zpool-trim.timer,zpool-trim.timer,'\n      )\n      OR exception_key\
    \ LIKE 'boot-sysctl.service,Apply Kernel Variables for % from /boot,'\n      OR\
    \ exception_key LIKE 'dbus-:1.%-org.freedesktop.problems@%.service,dbus-:%.%-org.freedesktop.problems@%.service,0'\n\
    \      OR exception_key LIKE 'drkonqi-coredump-processor@%.service,Pass systemd-coredump\
    \ journal entries to relevant user for potential DrKonqi handling,'\n      OR\
    \ exception_key LIKE 'machine-qemu%.scope,Virtual Machine qemu%,'\n      OR exception_key\
    \ LIKE 'run-media-%.mount,run-media-%.mount,'\n      OR exception_key LIKE 'systemd-cryptsetup@%.service,Cryptography\
    \ Setup for %,'\n      OR exception_key LIKE 'zfs-snapshot-%.service,zfs-snapshot-%.service,'\n\
    \      OR exception_key LIKE 'zfs-snapshot-%.timer,zfs-snapshot-%.timer,'\n  \
    \    OR id LIKE ''\n      OR id LIKE 'dev-disk-by%.swap'\n      OR id LIKE 'dev-mapper-%.swap'\n\
    \      OR id LIKE 'dev-zram%.swap'\n      OR id LIKE 'docker-%.scope'\n      OR\
    \ id LIKE 'getty@tty%.service'\n      OR id LIKE 'home-manager-%.service'\n  \
    \    OR id LIKE 'lvm2-pvscan@%.service'\n      OR id LIKE 'session-%.scope'\n\
    \      OR id LIKE 'system-systemd%cryptsetup.slice'\n      OR id LIKE 'systemd-backlight@%.service'\n\
    \      OR id LIKE 'systemd-cryptsetup@luks%.service'\n      OR id LIKE 'systemd-cryptsetup@nvme%.service'\n\
    \      OR id LIKE 'systemd-fsck@dev-disk-by%service'\n      OR id LIKE 'systemd-zram-setup@zram%.service'\n\
    \      OR id LIKE 'user-runtime-dir@%.service'\n      OR id LIKE 'user@%.service'\n\
    \      OR id LIKE 'akmods@%64.service'\n    )\n  )\n"
  tags: persistent, seldom, filesystem, systemd
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Highlight chrome extensions with wide-ranging permissions that are
    not part of your whitelist
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-chrome-extensions
  observer_can_run: false
  platforms: ''
  query: "-- Highlight chrome extensions with wide-ranging permissions that are not\
    \ part of your whitelist\n--\n-- references:\n--   * https://attack.mitre.org/techniques/T1176/\
    \ (Browser Extensions)\n--\n-- false positives:\n--   * Almost unlimited: any\
    \ extension that isn't on your whitelist\n--\n-- tags: persistent seldom browser\n\
    SELECT\n  name,\n  profile,\n  chrome_extensions.description AS 'descr',\n  persistent\
    \ AS persists,\n  CONCAT (\n    \"https://chromewebstore.google.com/detail/extension/\"\
    ,\n    identifier\n  ) AS ext_url,\n  author,\n  chrome_extensions.path,\n  referenced\
    \ AS in_config,\n  file.ctime,\n  file.btime,\n  file.mtime,\n  from_webstore\
    \ AS in_store,\n  TRIM(CAST(permissions AS text)) AS perms,\n  state AS 'enabled',\n\
    \  CONCAT (\n    from_webstore,\n    ',',\n    author,\n    ',',\n    name,\n\
    \    ',',\n    identifier\n  ) AS exception_key,\n  hash.sha256\nFROM\n  users\n\
    \  CROSS JOIN chrome_extensions USING (uid)\n  LEFT JOIN file ON chrome_extensions.path\
    \ = file.path\n  LEFT JOIN hash ON chrome_extensions.path = hash.path\nWHERE\n\
    \  state = 1\n  AND (\n    (\n      from_webstore != 'true'\n      AND (\n   \
    \     perms LIKE \"%nativeMessaging%\"\n        OR perms LIKE '%bookmarks%'\n\
    \        OR perms LIKE \"%pageCapture%\"\n        OR perms LIKE \"%session%\"\
    \ -- Sigstore\n        OR perms LIKE \"%http%\"\n        OR perms LIKE \"%webRequest%\"\
    \n      )\n    )\n    OR (\n      perms LIKE '%://*/%'\n      OR perms LIKE '%<all_urls>%'\n\
    \      OR perms LIKE '%clipboardRead%'\n      OR perms LIKE '%cookies%'\n    \
    \  OR perms LIKE '%coinbase%'\n      OR perms LIKE '%blockchain%'\n      OR perms\
    \ LIKE '%debugger%'\n      OR perms LIKE '%declarativeNetRequestFeedback%'\n \
    \     OR perms LIKE '%desktopCapture%'\n      OR perms LIKE '%github.com%'\n \
    \     OR perms LIKE '%google.com%'\n      OR perms LIKE \"%history%\"\n      OR\
    \ perms LIKE \"%nativeMessaging%\"\n      OR perms LIKE \"%proxy%\"\n      OR\
    \ perms LIKE \"%webAuthenticationProxy%\"\n      OR perms LIKE \"%management%\"\
    \n    )\n  )\n  AND NOT exception_key IN (\n    'false,,Grammarly: AI Writing\
    \ and Grammar Checker App,cnlefmmeadmemmdciolhbnfeacpdfbkd',\n    'false,privacybadger-owner@eff.org,Privacy\
    \ Badger,mkejgcgkdlddbggjhhflekkondicpnop',\n    'true,,Acorns Earn,facncfnojagdpibmijfjdmhkklabakgd',\n\
    \    'true,Adaware,Safe Torrent Scanner,aegnopegbbhjeeiganiajffnalhlkkjb',\n \
    \   'true,Adblock for Chrome Team,Adblock for Chrome\u2122,onomjaelhagjjojbkcafidnepbfkpnee',\n\
    \    'true,,Adblock for Youtube\u2122,cmedhionkhpnakcndndgjdbohmhepckk',\n   \
    \ 'true,Adblock, Inc.,AdBlock \u2014 best ad blocker,gighmmpiobklfepjocnamgkkbiglidom',\n\
    \    'true,,Add to Amazon Wish List,ciagpekplgpbepdgggflgmahnjgiaced',\n    'true,,Add\
    \ to Babylist Button,jcmljanephecacpljcpiogonhhadfpda',\n    'true,Adguard Software\
    \ Ltd,AdGuard AdBlocker,bgnkhhnnamicmpeenaelnjfhikgbkllg',\n    'true,,Adobe Acrobat:\
    \ PDF edit, convert, sign tools,efaidnbmnnnibpcajpcglclefindmkaj',\n    'true,AgileBits,1Password\
    \ extension (desktop app required),aomjjhallfgjeglblehebfpbcfeobpgk',\n    'true,AgileBits,1Password\
    \ Nightly \u2013 Password Manager,gejiddohjgogedgjnonbofjigllpkmbf',\n    'true,AgileBits,1Password\
    \ \u2013 Password Manager,aeblfdkhhhdcdjpifhhbdiojplfjncoa',\n    'true,AgileBits,1Password\
    \ \\xE2\\x80\\x93 Password Manager,aeblfdkhhhdcdjpifhhbdiojplfjncoa',\n    'true,Alexander\
    \ Shutau,Dark Reader,eimadpbcbfnmbkopoojfekhnkhdbieeh',\n    'true,All uBlock\
    \ contributors,uBlock - free ad blocker,epcnnfbjfcgphgdmggkamkmgojdagdnn',\n \
    \   'true,,Application Launcher For Drive (by Google),lmjegmlicamnimmfhcmpkclmigmmcbeh',\n\
    \    'true,,Apps Launcher for Chrome,hdmhnhkegdfpajaeijlfopfoallfdiak',\n    'true,,Awesome\
    \ ChatGPT Screenshot & Screen Recorder,nlipoenfbbikpbjkfpfillcgkoblgpmj',\n  \
    \  'true,,Awesome Screen Recorder & Screenshot,nlipoenfbbikpbjkfpfillcgkoblgpmj',\n\
    \    'true,,axe DevTools - Web Accessibility Testing,lhdoppojpmngadmnindnejefpokejbdd',\n\
    \    'true,,Bardeen - automate manual work,ihhkmalpkhkoedlmcnilbbhhbhnicjga',\n\
    \    'true,,Bardeen - automate workflows with one click,ihhkmalpkhkoedlmcnilbbhhbhnicjga',\n\
    \    'true,Benjamin Hollis,JSONView,gmegofmjomhknnokphhckolhcffdaihd',\n    'true,BetaFish,AdBlock\
    \ \u2014 best ad blocker,gighmmpiobklfepjocnamgkkbiglidom',\n    'true,,Bionic\
    \ Reading,kdfkejelgkdjgfoolngegkhkiecmlflj',\n    'true,Bitwarden Inc.,Bitwarden\
    \ - Free Password Manager,nngceckbapebfimnlniiiahkandclblb',\n    'true,Bitwarden\
    \ Inc.,Bitwarden Password Manager,nngceckbapebfimnlniiiahkandclblb',\n    'true,,BlockSite:\
    \ Block Websites & Stay Focused,eiimnmioipafcokbfikbljfdeojpcgbh',\n    'true,,Boomerang\
    \ for Gmail,mdanidgdpmkimeiiojknlnekblgmpdll',\n    'true,,Browsec VPN - Free\
    \ VPN for Chrome,omghfjlpggmjjaagoclmmobgdodcjboh',\n    'true,,BrowserStack Local,mfiddfehmfdojjfdpfngagldgaaafcfo',\n\
    \    'true,CAD Team,Cookie AutoDelete,fhcgjolkccmbidfldomjliifgaodjagh',\n   \
    \ 'true,,Canvas Blocker - Fingerprint Protect,nomnklagbgmgghhjidfhnoelnjfndfpd',\n\
    \    'true,,Capital One Shopping: Add to Chrome for Free,nenlahapcbofgnanklpelkaejcehkggg',\n\
    \    'true,,Capital One Shopping: Save Now,nenlahapcbofgnanklpelkaejcehkggg',\n\
    \    'true,,Caret,fljalecfjciodhpcledpamjachpmelml',\n    'true,,Chrome Capture\
    \ - Gif & Screenshot tool,ggaabchcecdbomdcnbahdfddfikjmphe',\n    'true,chromeos-recovery-tool-admin@google.com,Chromebook\
    \ Recovery Utility,jndclpdbaamdhonoechobihbbiimdgai',\n    'true,,Chrome RDP for\
    \ Google Cloud Platform,mpbbnannobiobpnfblimoapbephgifkm',\n    'true,,Chrome\
    \ Remote Desktop,inomeogfingihgjfjlpeplalcfajhgai',\n    'true,,Chrome Web Store\
    \ Payments,nmmhkkegccagdldgiimedpiccmgmieda',\n    'true,,Cisco Umbrella Chromebook\
    \ client (Ext),jcdhmojfecjfmbdpchihbeilohgnbdci',\n    'true,,Cisco Webex Extension,jlhmfgmfgeifomenelglieieghnjghma',\n\
    \    'true,,Clear Cache,cppjkneekbjaeellbfkmgnhonkkjfpdn',\n    'true,,Clear cookies\
    \ for one site,kajgpmmnnohnlajonknigghinhjmmehc',\n    'true,,ClickUp: Tasks,\
    \ Screenshots, Email, Time,pliibjocnfmkagafnbkfcimonlnlpghj',\n    'true,,Clipboard\
    \ History,cioiijhfebhhkmnijjjgbhkjjdlphjid',\n    'true,,Clockify Time Tracker,pmjeegjhjdlccodhacdgbgfagbpmccpe',\n\
    \    'true,Clockwise Inc.,Clockwise: AI Calendar & Scheduling Assistant,hjcneejoopafkkibfbcaeoldpjjiamog',\n\
    \    'true,Clockwise Inc.,Clockwise: Team Time & Calendar Management,hjcneejoopafkkibfbcaeoldpjjiamog',\n\
    \    'true,,Cloud9,nbdmccoknlfggadpfkmcpnamfnbkmkcp',\n    'true,,Cloud Vision,nblmokgbialjjgfhfofbgfcghhbkejac',\n\
    \    'true,,coLaboratory Notebook,pianggobfjcgeihlmfhfgkfalopndooo',\n    'true,,ColorPick\
    \ Eyedropper,ohcpnigalekghcmgcdcenkpelffpdolg',\n    'true,,ColorZilla,bhlhnicpbhignbdhedgjhgdocnmhomnp',\n\
    \    'true,compose.ai,Compose AI: AI-powered Writing Tool,ddlbpiadoechcolndfeaonajmngmhblj',\n\
    \    'true,Contacts+,Contacts+ for Gmail,cnaibnehbbinoohhjafknihmlopdhhip',\n\
    \    'true,CookieBlock Team,CookieBlock,fbhiolckidkciamgcobkokpelckgnnol',\n \
    \   'true,,Cookie Tab Viewer,fdlghnedhhdgjjfgdpgpaaiddipafhgk',\n    'true,,Copper\
    \ CRM for Gmail,hpfmedbkgaakgagknibnonpkimkibkla',\n    'true,,Copper CRM for\
    \ Gmail\u2122,hpfmedbkgaakgagknibnonpkimkibkla',\n    'true,,Copy Me That,lgjinjcobiflbbnhenlfkcjpeeacklfl',\n\
    \    'true,,Coupert - Automatic Coupon Finder & Cashback,mfidniedemcgceagapgdekdbmanojomk',\n\
    \    'true,,crouton integration,gcpneefbbnfalgjniomfjknbcgkbijom',\n    'true,Crowdcast,\
    \ Inc.,Crowdcast Screensharing,kgmadhplahebfoiijgloflhakfjlkbpb',\n    'true,,Crunchbase\
    \ - B2B Company & Contact Info,mdfjplgeknamfodpoghbmhhlcjoacnbp',\n    'true,,CSS\
    \ Scan,gieabiemggnpnminflinemaickipbebg',\n    \"true,Daniel Kladnik @ kiboke\
    \ studio,I don't care about cookies,fihnjjcciajhdojfnbdddfaoknhalnja\",\n    'true,,Datanyze\
    \ Chrome Extension,mlholfadgbpidekmhdibonbjhdmpmafd',\n    'true,,DealFinder by\
    \ VoucherCodes,jhgicjdnnonfaedodemjjinbgcoeiajo',\n    'true,,DEPRECATED Secure\
    \ Shell App,pnhechapfaindjhompbnflcldabbghjo',\n    'true,,[DEPRECATED] Tag Assistant\
    \ Legacy,kejbdjndbnbjgmefkgdddjlbokphdefk',\n    'true,,Disconnect,jeoacafpbcihiomhlakheieifhpjdfeo',\n\
    \    'true,,Distill Web Monitor,inlikjemeeknofckkjolnjbpehgadgge',\n    'true,,Drift\
    \ Login Extension,gpkmgamohlkjijibojblielfahgpgcne',\n    'true,,DuckDuckGo Privacy\
    \ Essentials,bkdgflcldnnnapblkhphbgpggdiikppg',\n    'true,,Dux-Soup for LinkedIn\
    \ Automation,ppdakpfeaodfophjplfdedpcodkdkbal',\n    'true,,EditThisCookie,fngmhnnpilhplaeedifhccceomclgfbg',\n\
    \    'true,,Emoji Keyboard - Emojis For Chrome,fbcgkphadgmbalmlklhbdagcicajenei',\n\
    \    'true,,Endpoint Verification,callobklhcbilhphinckomhgkigmfocg',\n    'true,,Eno\xAE\
    \ from Capital One\xAE,clmkdohmabikagpnhjmgacbclihgmdje',\n    'true,,Espruino\
    \ Web IDE,bleoifhkdalbjfbobjackfdifdneehpo',\n    'true,,Event Merge for Google\
    \ Calendar\u2122,idehaflielbgpaokehlhidbjlehlfcep',\n    'true,Evernote,Evernote\
    \ Web Clipper,pioclpoplcdbaefihamjohnefbikjilc',\n    'true,ExpressVPN,ExpressVPN:\
    \ VPN proxy for a better internet,fgddmllnllkalaagkghckoinaemmogpe',\n    'true,,Extensity,jjmflmamggggndanpgfnpelongoepncg',\n\
    \    'true,eyeo GmbH,Adblock Plus - free ad blocker,cfhdojbkjhnklbpkdaibdccddilifddb',\n\
    \    'true,,Facebook Pixel Helper,fdgfkebogiimcoedlicjlajpkdmockpc',\n    'true,,Fake\
    \ Filler,bnjjngeaknajbdcgpfkgnonkmififhfo',\n    'true,,Fakespot Fake Amazon Reviews\
    \ and eBay Sellers,nakplnnackehceedgkgkokbgbmfghain',\n    'true,Federico Brigante,GitHub\
    \ Issue Link Status,nbiddhncecgemgccalnoanpnenalmkic',\n    'true,,feedly,hipbfijinpcgfogaopmgehiegacbhmob',\n\
    \    'true,,FoxyProxy Basic,dookpfaalaaappcdneeahomimbllocnb',\n    'true,Fran\xE7\
    ois Duprat,Mobile simulator - responsive testing tool,ckejmhbmlajgoklhgbapkiccekfoccmk',\n\
    \    'true,,Free Maps Ruler,ejpahoknghmacibohhgleeacndkglgmo',\n    \"true,Gareth\
    \ Stephenson,My O'Reilly Downloader,deebiaolijlopiocielojiipnpnaldlk\",\n    'true,Ghostery,Ghostery\
    \ \u2013 Privacy Ad Blocker,mlomiejdfkolichcflejclcbmpeaniij',\n    'true,Ghostery,Ghostery\
    \ Tracker & Ad Blocker - Privacy AdBlock,mlomiejdfkolichcflejclcbmpeaniij',\n\
    \    'true,Ghostery,Ghostery Tracker Ad Blocker - Privacy AdBlock,mlomiejdfkolichcflejclcbmpeaniij',\n\
    \    'true,,GHunt Companion,dpdcofblfbmmnikcbmmiakkclocadjab',\n    'true,,Github\
    \ Absolute Dates,iepecohjelcmdnahbddleblfphbaheno',\n    'true,,GitHub Red Alert,kmiekjkmkbhbnlempjkaombjjcfhdnfe',\n\
    \    'true,,Gmail\u2122 Email Templates by cloudHQ,llccdnmbipddnkhmldacpcjjcnljpoij',\n\
    \    'true,,Go Links,gojgbkejhelijlkgpmlbbkklljgmfljj',\n    'true,,GoLinks,mdkgfdijbhbcbajcdlebbodoppgnmhab',\n\
    \    'true,,Google Analytics Parameter Stripper,jbgedkkfkohoehhkknnmlodlobbhafge',\n\
    \    'true,,Google Docs Offline,ghbmnnjooekpmoecnnnilnnbdlolhkhi',\n    'true,,Google\
    \ Drive,apdfllckaahabafndbhieahigkjlhalf',\n    'true,,Google Hangouts,nckgahadagoaajjgafhacjanaoiihapd',\n\
    \    'true,,Google Keep Chrome Extension,lpcaedmchfhocbbapmcbpinfpgnhiddi',\n\
    \    'true,,Google Keep - Notes and Lists,hmjkmjkepdijhoojdojkdfohbdgmmhki',\n\
    \    'true,,Google Mail Checker,mihcahmgecmbnbcchbopgniflfhgnkff',\n    'true,,Google\
    \ Optimize,bhdplaindhdkiflmbfbciehdccfhegci',\n    'true,,Google Play Books,mmimngoggfoobjdlefbcabngfnmieonb',\n\
    \    'true,,Google Play Movies & TV,gdijeikdkaembjbdobgfkoidjkpbmlkd',\n    'true,Gordon\
    \ Pedsersen,MarkDownload - Markdown Web Clipper,pcmpcfapbekmbjjkdalcgopdkipoggdi',\n\
    \    'true,,GoToMeeting for Google Calendar,gaonpiemcjiihedemhopdoefaohcjoch',\n\
    \    'true,,GoToTraining Screensharing,copcmbdalilphnaiajfmonkegedhkndd',\n  \
    \  'true,,Grammarly: AI Writing and Grammar Checker App,kbfnbcaeplbcioakkpcpgfkobkghlhen',\n\
    \    'true,,Grammarly: Grammar Checker and AI Writing App,kbfnbcaeplbcioakkpcpgfkobkghlhen',\n\
    \    'true,,Grammarly: Grammar Checker and Writing App,kbfnbcaeplbcioakkpcpgfkobkghlhen',\n\
    \    'true,,Gravit Designer,pdagghjnpkeagmlbilmjmclfhjeaapaa',\n    'true,,Greenhouse\
    \ Recruiting Chrome extension,naooopefdfeangnkgmjpklgblnfmbaea',\n    'true,,GSConnect,jfnifeihccihocjbfcfhicmmgpjicaec',\n\
    \    'true,Guilherme Nascimento,Prevent Duplicate Tabs,eednccpckdkpojaiemedoejdngappaag',\n\
    \    'true,,Hippo Video: Video and Screen Recorder,cijidiollmnkegoghpfobabpecdkeiah',\n\
    \    'true,homerchen19,File Icons for GitHub and GitLab,ficfmibkjjnpogdcfhfokmihanoldbfe',\n\
    \    'true,,Honey: Automatic Coupons & Cash Back,bmnlcjabgnpnenekpadlanbbkooimhnj',\n\
    \    'true,,Honey: Automatic Coupons & Rewards,bmnlcjabgnpnenekpadlanbbkooimhnj',\n\
    \    'true,,HTTPS Everywhere,gcbommkclmclpchllfjekcdonpmejbdp',\n    'true,https://metamask.io,MetaMask,nkbihfbeogaeaoehlefnkodbefgpgknn',\n\
    \    'true,,HubSpot Sales,oiiaigjnkhngdbnoookogelabohpglmd',\n    'true,,Hundred\
    \ Handshakes,cmlngncglcblbobiehdpjcgbpoemidho',\n    'true,,IBA Opt-out (by Google),gbiekjoijknlhijdjbaadobpkdhmoebb',\n\
    \    'true,,iCloud Bookmarks,fkepacicchenbjecpbpbclokcabebhah',\n    'true,,iCloud\
    \ Passwords,pejdijmoenmkgeppbflobdenhhabjlaj',\n    'true,,Instapaper,ldjkgaaoikpmhmkelcgkgacicjfbofhh',\n\
    \    'true,James Anderson,LeechBlock NG,blaaajhemilngeeffpbfkdjjoefldkok',\n \
    \   'true,,Jamstash,jccdpflnecheidefpofmlblgebobbloc',\n    'true,,Jitsi Meetings,kglhbbefdnlheedjiejgomgmfplipfeb',\n\
    \    'true,,JSON Formatter,bcjindcccaagfpapjjmafapmmgkkhgoa',\n    'true,,JSON\
    \ Viewer Pro,eifflpmocdbdmepbjaopkkhbfmdgijcc',\n    'true,,Kagi Search,cdglnehniifkbagbbombnjghhcihifij',\n\
    \    'true,,Kagi Search for Chrome,cdglnehniifkbagbbombnjghhcihifij',\n    'true,Kai\
    \ Uwe Broulik <kde@privat.broulik.de>,Plasma Integration,cimiefiiaegbelhefglklhhakcgmhkai',\n\
    \    'true,Kas Elvirov,GitHub Gloc,kaodcnpebhdbpaeeemkiobcokcnegdki',\n    'true,Keepa\
    \ GmbH,Keepa - Amazon Price Tracker,neebplgakaahbhdphmkckjjcegoiijjo',\n    'true,LastPass,LastPass:\
    \ Free Password Manager,hdokiejnpimakedhajhdlcegeplioahd',\n    'true,Leadjet,Leadjet\
    \ - Make your CRM work on LinkedIn,kojhcdejfimplnokhhhekhiapceggamn',\n    'true,,Lever\
    \ Hire Extension,dgbcohbjchndmjocioegkgdniaffcaia',\n    'true,,Link to Text Fragment,pbcodcjpfjdpcineamnnmbkkmkdpajjg',\n\
    \    'true,,Lolli: Earn Bitcoin When You Shop,fleenceagaplaefnklabikkmocalkcpo',\n\
    \    'true,,Loom \u2013 Free Screen Recorder & Screen Capture,liecbddmkiiihnedobmlmillhodjkdmb',\n\
    \    'true,,Loom \u2013 Screen Recorder & Screen Capture,liecbddmkiiihnedobmlmillhodjkdmb',\n\
    \    'true,,Loom \\xE2\\x80\\x93 Screen Recorder & Screen Capture,liecbddmkiiihnedobmlmillhodjkdmb',\n\
    \    'true,,Lucidchart Diagrams,apboafhkiegglekeafbckfjldecefkhn',\n    'true,,Mailvelope,kajibbejlbohfaggdiogboambcijhkke',\n\
    \    'true,,Markdown Preview Plus,febilkbfcbhebfnokafefeacimjdckgl',\n    'true,Marker.io,Marker.io:\
    \ Visual bug reporting for websites,jofhoojcehdmaiibilpcoofpdbbddkkl',\n    'true,,Media\
    \ Hint,akipcefbjlmpbcejgdaopmmidpnjlhnb',\n    'true,,Meta Pixel Helper,fdgfkebogiimcoedlicjlajpkdmockpc',\n\
    \    'true,,Mettl Tests : Enable Screen Sharing,hkjemkcbndldepdbnbdnibeppofoooio',\n\
    \    'true,Microsoft Corporation,Microsoft 365,ndjpnladcallmjemlbaebfadecfhkepb',\n\
    \    'true,Microsoft Corporation,Microsoft Autofill,fiedbfgcleddlbcmgdigjgdfcggjcion',\n\
    \    'true,,Microsoft Single Sign On,ppnbnpeolgkicgegkbkbjmhlideopiji',\n    'true,Moustachauve,Cookie-Editor,hlkenndednhfkekhgcdicdfddnkalmdm',\n\
    \    'true,,MQTTLens,hemojaaeigabkbcookmlgmdigohjobjm',\n    'true,NortonLifeLock\
    \ Inc,Norton Safe Web,fnpbeacklnhmkkilekogeiekaglbmmka',\n    'true,,NoScript,doojmbjmlfjjnbmnoijecmcbfeoakpjm',\n\
    \    'true,,Notion Web Clipper,knheggckgoiihginacbkhaalnibhilkk',\n    'true,,Office\
    \ Editing for Docs, Sheets & Slides,gbkeegbaiigmenfmjfclcdgdpimamgkj',\n    'true,,Office\
    \ - Enable Copy and Paste,ifbmcpbgkhlpfcodhjhdbllhiaomkdej',\n    'true,,Okta\
    \ Browser Plugin,glnpjglilkicbckjpbgcfkogebgllemb',\n    'true,,OneLogin for Google\
    \ Chrome,ioalpmibngobedobkmbhgmadaphocjdn',\n    'true,,OneTab,chphlpgkkbolifaimnlloiipkdnihall',\n\
    \    'true,Opera,Cashback Assistant,ompjkhnkeoicimmaehlcmgmpghobbjoj',\n    'true,Opera\
    \ Norway AS,Opera AI Prompts,mljbnbeedpkgakdchcmfapkjhfcogaoc',\n    'true,Opera\
    \ Software AS,Rich Hints Agent,enegjkbbakeegngfapepobipndnebkdk',\n    'true,,Outbrain\
    \ Pixel Tracker,daebadnaphbiobojnpgcenlkgpihmbdc',\n    'true,,Outreach Everywhere,chmpifjjfpeodjljjadlobceoiflhdid',\n\
    \    'true,,Page Analytics (by Google),fnbdnhhicmebfgdgglcdacdapkcihcoh',\n  \
    \  'true,,Password Alert,noondiphcddnnabmjcihcjfbhfklnnep',\n    'true,Pawel Psztyc,Advanced\
    \ REST client,hgmloofddffdnphfgcellkdfbfbjeloo',\n    'true,,PhantomBuster,mdlnjfcpdiaclglfbdkbleiamdafilil',\n\
    \    'true,,Picture-in-Picture Extension (by Google),hkgfoiooedgoejojocmhlaklaeopbecg',\n\
    \    'true,,Playback Rate,jgmkoefgnppfpagkhifpialkkkgnfgag',\n    'true,,PlayTo\
    \ for Chromecast\u2122,jngkenaoceimiimeokpdbmejeonaaami',\n    'true,,Ponyrun,ohfoafaaamjfbhmceahibpppkbnohaeg',\n\
    \    'true,,Postman,fhbjgbiflinjbdggehcddcbncdddomop',\n    'true,,Privacy Badger,pkehgijcmpdhfbdbbnkijodmdjhbjlgp',\n\
    \    'true,,Private Internet Access,jplnlifepflhkbkgonidnobkakhmpnmh',\n    'true,,ProctorU,goobgennebinldhonaajgafidboenlkl',\n\
    \    'true,Pushbullet,Pushbullet,chlffgpmiacpedhhbkiomidkjlcfhogd',\n    'true,Quantier,\
    \ LLC,Vim for Google Docs\u2122,aphmodfjbhofkpibocbggkdfnpbpjmpp',\n    'true,Quantier,\
    \ LLC,Vim for Google Docs\\xE2\\x84\\xA2,aphmodfjbhofkpibocbggkdfnpbpjmpp',\n\
    \    'true,Quidco.com,Quidco Cashback Reminder,offafgdgnliocofjjiohlpjpenbogkbl',\n\
    \    'true,,QuillBot for Chrome,iidnbdjijdkbmajdffnidomddglmieko',\n    'true,Rakuten,Rakuten:\
    \ Get Cash Back For Shopping,chhjbpecpncaggjpdakmflnfcopglcmi',\n    'true,Raymond\
    \ Hill & contributors,uBlock Origin,cjpalhdlnbpafiamejdnhcphjbkeiagm',\n    'true,,React\
    \ Developer Tools,fmkadmapgofadopljbjfkapdkoienihi',\n    'true,,Reader Mode,llimhhconnjiflfimocjggfjdlmlhblm',\n\
    \    'true,,Readwise Highlighter,jjhefcfhmnkfeepcpnilbbkaadhngkbi',\n    'true,Reddit\
    \ Enhancement Suite contributors,Reddit Enhancement Suite,kbmfpngjjgdllneeigpgjifpgocmfgmb',\n\
    \    'true,,Redux DevTools,lmhkpmbekcpmknklioeibfkpmmfibljd',\n    'true,,Refined\
    \ GitHub,hlepfoohegkhhmjieoechaddaejaokhf',\n    'true,,RetailMeNot Deal Finder\u2122\
    \uFE0F,jjfblogammkiefalfpafidabbnamoknm',\n    'true,,RSS Feed Reader,pnjaodmkngahhkoihejjehlcdlnohgmp',\n\
    \    'true,,RSS Subscription Extension (by Google),nlbjncdgjeocebhnmkbbbdekmmmcbfjd',\n\
    \    'true,,SABconnect++,okphadhbbjadcifjplhifajfacbkkbod',\n    'true,,Salesforce,jjghhkepijgakdammjldcbnjehfkfmha',\n\
    \    'true,,SalesLoft Connect,cffgjgigjfgjkfdopbobbdadaelbhepo',\n    'true,,SalesLoft\
    \ Connect - Legacy,cffgjgigjfgjkfdopbobbdadaelbhepo',\n    'true,,Save to Google\
    \ Drive,gmbmikajjgmnabiglmofipeabaddhgne',\n    'true,,Save to Pinterest,gpdjojdkbbmdfjfahjcgigfpmkopogic',\n\
    \    'true,,Save to Pocket,niloccemoadcdkdjlinkgdfekeahmflj',\n    'true,,Scraper,poegfpiagjgnenagjphgdklmgcpjaofi',\n\
    \    'true,,Screen Recorder,hniebljpgcogalllopnjokppmgbhaden',\n    'true,,Screenshot\
    \ Master: Full Page Capture,ggacghlcchiiejclfdajbpkbjfgjhfol',\n    'true,,Screenshot\
    \ & Screen Video Record by Screeny,djekgpcemgcnfkjldcclcpcjhemofcib',\n    'true,,Scribe:\
    \ AI Documentation, SOPs & Screenshots,okfkdaglfjjjfefdcppliegebpoegaii',\n  \
    \  'true,,Secure Shell,iodihamcpbpeioajjeobimgagajmlibd',\n    'true,,Selenium\
    \ IDE,mooikfkahbdckldjjndioackbalphokd',\n    'true,,Send from Gmail (by Google),pgphcomnlaojlmmcjmiddhdapjpbgeoc',\n\
    \    'true,,Sendspark Video and Screen Recorder,blimjkpadkhcpmkeboeknjcmiaogbkph',\n\
    \    'true,,Send to Kindle for Google Chrome\uFFFD\uFFFD\uFFFD,cgdjpilhipecahhcilnafpblkieebhea',\n\
    \    'true,,Session Buddy,edacconmaakjimmfgnblocblbcdcpbko',\n    'true,,Set Character\
    \ Encoding,bpojelgakakmcfmjfilgdlmhefphglae',\n    'true,,Shodan,jjalcfnidlmpjhdfepjhjbhnhkbgleap',\n\
    \    'true,,SignalHire - find email or phone number,aeidadjdhppdffggfgjpanbafaedankd',\n\
    \    'true,,Simple Tab Sorter,cgfpgnepljlgenjclbekbjdlgcodfmjp',\n    'true,,Skype\
    \ Calling,blakpkgjpemejpbmfiglncklihnhjkij',\n    'true,,Slack,jeogkiiogjbmhklcnbgkdcjoioegiknm',\n\
    \    'true,,Soapbox \u2014  Video Recorder,lmepjnndgdhcgphilomlfekmgnnmngbi',\n\
    \    'true,,SSH for Google Cloud Platform,ojilllmhjhibplnppnamldakhpmdnibd',\n\
    \    'true,stefanXO,Tab Manager Plus for Chrome,cnkdjjdmfiffagllbiiilooaoofcoeff',\n\
    \    'true,,Super Dark Mode,nlgphodeccebbcnkgmokeegopgpnjfkc',\n    'true,,Superhuman,dcgcnpooblobhncpnddnhoendgbnglpn',\n\
    \    'true,Symantec Corporation,Norton Password Manager,admmjipmmciaobhojoghlmleefbicajg',\n\
    \    'true,,Tabli,igeehkedfibbnhbfponhjjplpkeomghi',\n    'true,,Tab Wrangler,egnjhciaieeiiohknchakcodbpgjnchh',\n\
    \    'true,,Tag Assistant Legacy (by Google),kejbdjndbnbjgmefkgdddjlbokphdefk',\n\
    \    'true,,Tampermonkey BETA,gcalenpjmijncebpfijmoaglllgpjagf',\n    'true,Team\
    \ Octotree,Octotree - GitHub code tree,bkhaagjahfmjljalopjnoealnfndnagc',\n  \
    \  'true,,TextExpander: Keyboard Shortcuts & Templates,mmfhhfjhpadoefoaahomoakamjcfcoil',\n\
    \    'true,,The Marvellous Suspender,noogafoofpebimajpfpamcfhoaifemoa',\n    'true,,The\
    \ Org for LinkedIn,gnkbmaifcbniminbmbmiabamggncacag',\n    'true,Thomas Rientjes,Decentraleyes,ldpochfccmkkmhdbclfhpagapcfdljkj',\n\
    \    'true,,TickTick - Todo & Task List,diankknpkndanachmlckaikddgcehkod',\n \
    \   'true,,Todoist for Chrome,jldhpllghnbhlbpcmnajkpdmadaolakh',\n    'true,,Todoist\
    \ for Gmail,clgenfnodoocmhnlnpknojdbjjnmecff',\n    'true,,Toggl Track: Productivity\
    \ & Time Tracker,oejgccbfbmkkpaidnkphaiaecficdnfn',\n    'true,Tomas Popela, tpopela@redhat.com,Fedora\
    \ User Agent,hojggiaghnldpcknpbciehjcaoafceil',\n    'true,,Touch VPN - Secure\
    \ and unlimited VPN proxy,bihmplhobchoageeokmgbdihknkjbknd',\n    'true,,Trend\
    \ Micro Ad Blocker: Powerful Ad Blocker,pmekfefnodgilnnjcfkkdjlebokonhpm',\n \
    \   'true,Tulio Ornelas <ornelas.tulio@gmail.com>,JSON Viewer,gbmdgpbipfallnflgajpaliibnhdgobh',\n\
    \    'true,,Ubiquiti Device Discovery Tool,hmpigflbjeapnknladcfphgkemopofig',\n\
    \    'true,,uBlock,epcnnfbjfcgphgdmggkamkmgojdagdnn',\n    'true,,UET Tag Helper\
    \ (by Microsoft Advertising),naijndjklgmffmpembnkfbcjbognokbf',\n    'true,,Universal\
    \ Video Downloader,cogmkaeijeflocngklepoknelfjpdjng',\n    'true,,User-Agent Switcher\
    \ for Chrome,djflhoibgkdhkhhcedjiklpkjnoahfmg',\n    'true,,Utime,kpcibgnngaaabebmcabmkocdokepdaki',\n\
    \    'true,,Vidyard - Webcam & Screen Recorder for Sales,jiihcciniecimeajcniapbngjjbonjan',\n\
    \    'true,,VidyoWebConnector,mmedphfiemffkinodeemalghecnicmnh',\n    'true,,Vimcal,akopimcimmdmklcmegcflfidpfegngke',\n\
    \    'true,,Vimeo Record - Screen & Webcam Recorder,ejfmffkmeigkphomnpabpdabfddeadcb',\n\
    \    'true,Vimeo,Vimeo Record - Screen & Webcam Recorder,ejfmffkmeigkphomnpabpdabfddeadcb',\n\
    \    'true,,Vimium,dbepggeogbaibhgnhhndojpepiihcmeb',\n    'true,,Vue.js devtools,nhdogjmejiglipccpnnnanhbledajbpd',\n\
    \    'true,Wappalyzer,Wappalyzer - Technology profiler,gppongmhjkpfnbhagpmjfkannfbllamg',\n\
    \    'true,,WAVE Evaluation Tool,jbbplnpkjmmeebjpijfedlgcdilocofh',\n    'true,,Web\
    \ Developer,bfbameneiokkgbdmiekhjnmfkcnldhhm',\n    'true,Web to Figma,Web to\
    \ Figma,mafpepbepbabkenbfpcdjmmjmeeemoal',\n    'true,,WhatFont,jabopobgcpjmedljpbcaablpmlmfcogm',\n\
    \    'true,,Wikiwand: Wikipedia Modernized,emffkefkbkpkgpdeeooapgaicgmcbolj',\n\
    \    'true,,Windows Accounts,ppnbnpeolgkicgegkbkbjmhlideopiji',\n    'true,,Windscribe\
    \ - Free Proxy and Ad Blocker,hnmpcagpplmpfojmgmnngilcnanddlhb',\n    'true,,Wisdolia,ciknpklcipibmfbgjmdmfdfalklfdlne',\n\
    \    'true,,WiseStamp email signature,pbcgnkmbeodkmiijjfnliicelkjfcldg',\n   \
    \ 'true,,Wistia Video Downloader,acbiaofoeebeinacmcknopaikmecdehl',\n    'true,,writeGPT\
    \ - ChatGPT Prompt Engineer Assistant,dflcdbibjghipieemcligeelbmackgco',\n   \
    \ 'true,,Yesware Sales Engagement,gkjnkapjmjfpipfcccnjbjcbgdnahpjp',\n    'true,Yuri\
    \ Konotopov <ykonotopov@gnome.org>,GNOME Shell integration,gphhapmejobijbbhgpjhcjognlahblep',\n\
    \    'true,,Zoom,hmbjbjdpkobdjplfobhljndfdfdipjhg',\n    'true,,ZoomInfo Engage\
    \ Chrome Extension,mnbjlpbmllanehlpbgilmbjgocpmcijp',\n    'true,,Zoom Scheduler,kgjfgplpablkjnlkjmjdecgdpfankdle',\n\
    \    'true,,Zotero Connector,ekhagklcjbdpajgpjgmbionohlpdbjgc'\n  )\n  AND NOT\
    \ (\n    exception_key IN (\n      'false,AgileBits,1Password \u2013 Password\
    \ Manager,dppgmdbiimibapkepcbdbmkaabgiofem',\n      'false,,Onion Browser Button,joijkphhgidknnmmaabfgjhjmgjiepia'\n\
    \    )\n    AND chrome_extensions.path LIKE '%/Microsoft Edge/%'\n  )\nGROUP BY\n\
    \  exception_key\n"
  tags: persistent, seldom, browser
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected crontab entries
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-cron-entries
  observer_can_run: false
  platforms: posix
  query: |
    -- Unexpected crontab entries
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1053/003/ (Scheduled Task/Job: Cron)
    --
    -- false positives:
    --   * crontab entries added by the user
    --
    -- tags: persistent filesystem state
    -- platform: posix
    SELECT
      *
    FROM
      crontab
    WHERE
      command NOT LIKE 'root%run-parts%'
      AND command NOT LIKE '%/usr/lib/php/sessionclean%'
      AND command NOT LIKE '%anacron start%'
      AND command NOT LIKE '%clamscan%'
      AND command NOT LIKE '%e2scrub%'
      AND command NOT LIKE '%freshclam%'
      AND command NOT LIKE '%gcloud compute instances stop%'
      AND command NOT LIKE '%git commit%'
      AND command NOT LIKE '%rsync%'
      AND command NOT LIKE '%zfs-linux%'
      AND command NOT LIKE 'docker run amouat/jocko%'
      AND command NOT LIKE 'gsutil %'
      AND command NOT LIKE 'root command -v debian-sa1%'
  tags: persistent, filesystem, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected world readable run locks
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-global-lock
  observer_can_run: false
  platforms: posix
  query: |
    -- Find unexpected world readable run locks
    --
    -- false positives:
    --   * none known
    --
    -- references:
    --   * https://www.deepinstinct.com/blog/bpfdoor-malware-evolves-stealthy-sniffing-backdoor-ups-its-game
    --
    -- tags: persistent filesystem state seldom
    -- platform: posix
    SELECT
      *,
      CONCAT (
        MIN(file.uid, 500),
        ",",
        file.gid,
        ",",
        file.path,
        ",",
        file.type,
        ',',
        mode
      ) AS exception_key
    FROM
      file
    WHERE
      (
        path LIKE "/tmp/%.lock"
        OR path LIKE "/var/run/%.lock"
        OR path LIKE "/var/tmp/%.lock"
        OR path LIKE "/dev/shm/%.lock"
        OR path LIKE "/dev/mqueue/%.lock"
        OR path LIKE "/tmp/.%.lock"
        OR path LIKE "/var/run/.%.lock"
        OR path LIKE "/var/tmp/.%.lock"
        OR path LIKE "/dev/shm/.%.lock"
        OR path LIKE "/dev/mqueue/.%.lock"
      )
      AND exception_key NOT IN (
        '0,0,/var/run/apport.lock,regular,0600',
        '0,0,/var/run/dnf-metadata.lock,regular,0644',
        '0,0,/var/run/ublue-update.lock,regular,0755',
        '0,0,/var/run/ufw.lock,regular,0644',
        '0,0,/var/run/unattended-upgrades.lock,regular,0640',
        '0,0,/var/run/xtables.lock,regular,0600',
        '0,1,/var/run/VMware Fusion Services.lock,regular,0600',
        '500,0,/tmp/mysql.sock.lock,regular,0600',
        '500,0,/tmp/mysqlx.sock.lock,regular,0600',
        '500,1000,/tmp/golangci-lint.lock,regular,0600',
        '500,1001,/tmp/nwg-dock.lock,regular,0600',
        '74,0,/tmp/mysql.sock.lock,regular,0600',
        '74,0,/tmp/mysqlx.sock.lock,regular,0600'
      )
      AND NOT exception_key LIKE '500,1000,/tmp/keepassxc-%.lock,regular,0644'
      AND NOT exception_key LIKE '500,1000,/tmp/keepassxc-%.lock,regular,0664'
  tags: persistent, filesystem, state, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected launchd scripts that use the 'program_arguments' field
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-launchd-program-arguments
  observer_can_run: false
  platforms: darwin
  query: |
    -- Unexpected launchd scripts that use the 'program_arguments' field
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/004/ (Create or Modify System Process: Launch Daemon)
    --
    -- false positives:
    --   * Software by new vendors which have not yet been added to the allow list
    --
    -- tags: persistent filesystem state
    -- platform: darwin
    SELECT
      l.label,
      l.name,
      l.path,
      TRIM(REGEX_SPLIT (l.program_arguments, ' -', 0)) AS program_path,
      l.program_arguments,
      l.keep_alive,
      signature.authority AS program_authority,
      hash.sha256
    FROM
      launchd l
      LEFT JOIN signature ON program_path = signature.path
      LEFT JOIN hash ON program_path = hash.path
    WHERE
      (
        run_at_load = 1
        OR keep_alive = 1
      )
      AND (
        program IS NULL
        OR program = ''
      )
      AND l.path NOT LIKE '/System/%'
      AND l.path NOT LIKE '/Library/Apple/System/%'
      AND program_authority NOT IN (
        'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: AtomicJar, Inc. (33C47PTHN6)',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59)',
        'Developer ID Application: Canva Pty Ltd (5HD2ARTBFS)',
        'Developer ID Application: Cloudflare Inc. (68WVV388M8)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: Foxit Corporation (8GN47HTP75)',
        'Developer ID Application: Fumihiko Takayama (G43BCU2T37)',
        'Developer ID Application: Google, Inc. (EQHXZ8M8AV)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Grammarly, Inc (W8F64X92K3)',
        'Developer ID Application: Hercules Labs Inc. (B8PC799ZGU)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: Kolide, Inc (X98UFR7HA3)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Krisp Technologies, Inc. (U5R26XM5Z2)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: MacPaw Inc. (S8EX82NJP6)',
        'Developer ID Application: Maxon Computer GmbH (4ZY22YGXQG)',
        'Developer ID Application: Mersive Technologies (63B5A5WDNG)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Mullvad VPN AB (CKG9MXH72F)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: OPENVPN TECHNOLOGIES, INC. (ACV7L3WCD8)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: PACE Anti-Piracy, Inc. (TFZ8226T6X)',
        'Developer ID Application: Paragon Software GmbH (LSJ6YVK468)',
        'Developer ID Application: PFU LIMITED (XW4U7W2E9L)', -- Fujitsu
        'Developer ID Application: Private Internet Access, Inc. (5357M5NW9W)',
        'Developer ID Application: Proton AG (2SB5Z68H26)',
        'Developer ID Application: Proton Technologies AG (6UN54H93QT)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Red Hat, Inc. (HYSCB8KRL2)',
        'Developer ID Application: Sanford, L.P. (N3S6676K3E)', -- DYMO
        'Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Developer ID Application: X-Rite, Incorporated (2K7GT73B4R)',
        'Software Signing', -- Apple
        'yabai-cert'
      )
      AND program_arguments NOT IN (
        '/Applications/Stream Deck.app/Contents/MacOS/Stream Deck --runinbk',
        '/Library/Application Support/WirelessAutoImport/WirelessImporterDaemon',
        '/Library/Application Support/Sony Application Launcher/SonyAutoLauncher.app/Contents/MacOS/SonyAutoLauncher',
        '/opt/homebrew/opt/dnsmasq/sbin/dnsmasq --keep-in-foreground -C /opt/homebrew/etc/dnsmasq.conf -7 /opt/homebrew/etc/dnsmasq.d,*.conf',
        '/opt/homebrew/opt/jenkins/bin/jenkins --httpListenAddress=127.0.0.1 --httpPort=8080',
        '/opt/homebrew/opt/mariadb/bin/mysqld_safe',
        '/Applications/AeroSpace.app/Contents/MacOS/AeroSpace --started-at-login',
        '/Applications/Tunnelblick.app/Contents/Resources/launchAtLogin.sh',
        '/opt/homebrew/bin/gitsign-credential-cache',
        '/opt/homebrew/opt/pueue/bin/pueued --verbose',
        '/opt/homebrew/opt/nginx/bin/nginx -g daemon off;',
        '/opt/homebrew/opt/skhd/bin/skhd',
        '/opt/homebrew/opt/tailscale/bin/tailscaled',
        '/opt/homebrew/opt/yubikey-agent/bin/yubikey-agent -l /opt/homebrew/var/run/yubikey-agent.sock',
        '/usr/local/MacGPG2/libexec/fixGpgHome'
      )
      AND program_arguments NOT LIKE '/opt/homebrew/opt/mongodb-community%/bin/mongod --config /opt/homebrew/etc/mongod.conf'
      AND program_arguments NOT LIKE '/Users/%/Library/Application Support/com.grammarly.ProjectLlama/Scripts/Grammarly Uninstaller'
      AND program_arguments NOT LIKE '/Users/%/Library/Application Support/com.grammarly.ProjectLlama/Scripts/post-uninstall.sh'
      AND program_arguments NOT LIKE '%/mysqld_safe --datadir=%'
      AND program_arguments NOT LIKE '/opt/homebrew/opt/socket_vmnet/bin/socket_vmnet --vmnet-gateway=% /opt/homebrew/var/run/socket_vmnet'
  tags: persistent, filesystem, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected launchd scripts that use the 'program' field
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-launchd-program-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Unexpected launchd scripts that use the 'program' field
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/004/ (Create or Modify System Process: Launch Daemon)
    --
    -- false positives:
    --   * Software by new vendors which have not yet been added to the allow list
    --
    -- tags: persistent filesystem state
    -- platform: darwin
    SELECT
      l.label,
      l.name,
      l.path,
      l.program,
      l.program_arguments,
      l.keep_alive,
      signature.authority AS program_authority,
      signature.identifier AS program_identifier,
      hash.sha256
    FROM
      launchd l
      LEFT JOIN signature ON l.program = signature.path
      LEFT JOIN hash ON l.path = hash.path
    WHERE
      (
        run_at_load = 1
        OR keep_alive = 1
      )
      AND l.path NOT LIKE '/System/%'
      AND program IS NOT NULL
      AND program_authority NOT IN (
        'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',
        'Developer ID Application: Bjango Pty Ltd (Y93TK974AT)',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59)',
        'Developer ID Application: Creative Labs Pte. Ltd. (5Q3552844F)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK)',
        'Developer ID Application: Hercules Labs Inc. (B8PC799ZGU)',
        'Developer ID Application: Ilya Parniuk (ACC5R6RH47)',
        'Developer ID Application: Jonathan Bullard (Z2SG5H3HC8)',
        'Developer ID Application: Kandji, Inc. (P3FGV63VK7)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Louis Pontoise (QXD7GW8FHY)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Nordvpn S.A. (W5W395V82Y)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        'Developer ID Application: PACE Anti-Piracy, Inc. (TFZ8226T6X)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Rogue Amoeba Software, Inc. (7266XEXAPM)',
        'Developer ID Application: Signify Netherlands B.V. (PREPN2W95S)',
        'Developer ID Application: TPZ Solucoes Digitais Ltda (X37R283V2T)',
        'Developer ID Application: Universal Audio (4KAC9AX6CG)',
        'Developer ID Application: Valve Corporation (MXGJJ98X76)',
        'Developer ID Application: Wireshark Foundation (7Z6EMTD2C6)',
        'Developer ID Application: Wireshark Foundation, Inc. (7Z6EMTD2C6)',
        'Developer ID Application: Y Soft Corporation, a.s. (3CPED8WGS9)',
        'Software Signing'
      )
      AND program NOT IN (
        '/usr/local/MacGPG2/libexec/shutdown-gpg-agent',
        '/usr/local/bin/warsaw/core'
      )
      AND NOT (
        l.path = '/Library/LaunchDaemons/com.docker.socket.plist'
        AND program_authority = 'Software Signing'
        AND program_identifier IN ('com.apple.ln', 'com.apple.link')
        AND program_arguments LIKE '/bin/ln -s -f /Users/%/run/docker.sock /var/run/docker.sock'
      )
    GROUP BY
      l.path
  tags: persistent, filesystem, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected programs listening on a TCP port (state-based).
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-listening-port-linux
  observer_can_run: false
  platforms: ''
  query: |
    -- Unexpected programs listening on a TCP port (state-based).
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1571/ (Non-Standard Port)
    --
    -- tags: persistent state net
    SELECT
      lp.address,
      lp.port,
      lp.protocol,
      p.euid,
      p.cgroup_path,
      p.parent,
      p.pid,
      p.name,
      p.path,
      p.cmdline AS p0_cmd,
      p_p.cmdline AS p1_cmd,
      p_p_p.cmdline AS p2_cmd,
      p.cgroup_path,
      datetime(file.mtime, 'unixepoch') AS mtime,
      p.cwd,
      hash.sha256,
      CONCAT (
        MIN(lp.port, 32768),
        ',',
        lp.protocol,
        ',',
        MIN(p.uid, 500),
        ',',
        p.name
      ) AS exception_key
    FROM
      listening_ports lp
      LEFT JOIN processes p ON lp.pid = p.pid
      LEFT JOIN processes p_p ON p.parent = p_p.pid
      LEFT JOIN processes p_p_p ON p_p.parent = p_p_p.pid
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      port != 0
      AND lp.address NOT IN ('224.0.0.251', '::1')
      AND lp.address NOT LIKE '127.0.0.%'
      AND lp.address NOT LIKE '172.1%'
      AND lp.address NOT LIKE 'fe80::%'
      AND lp.address NOT LIKE '::ffff:127.0.0.%'
      -- All outgoing UDP (protocol 17) sessions are 'listening'
      AND NOT (
        lp.protocol = 17
        AND lp.port > 1024
      )
      -- Random webservers
      AND NOT (
        p.uid > 500
        AND lp.port IN (8000, 8080)
        AND lp.protocol = 6
      )
      -- Filter out unmapped raw sockets
      AND NOT (p.pid == '')
      -- Exceptions: the uid is capped at 500 to represent regular users versus system users
      -- port is capped at 32768 to represent transient ports
      AND NOT CONCAT (
        MIN(lp.port, 32768),
        ',',
        lp.protocol,
        ',',
        MIN(p.uid, 500),
        ',',
        p.name
      ) IN (
        '10250,6,0,kubelet',
        '10250,6,500,kubelet',
        '10254,6,101,nginx-ingress-c',
        '10256,6,0,kube-proxy',
        '10256,6,500,kube-proxy',
        '1,1,500,ping',
        '1,255,500,mtr-packet',
        '1337,6,500,kdenlive',
        '1716,6,500,daemon.js',
        '1716,6,500,gjs',
        '1716,6,500,kdeconnectd',
        '17,255,0,dhcpcd',
        '17,255,0,tailscaled',
        '17,255,0,.tailscaled-wra',
        '17,255,500,dhcpcd',
        '17,255,500,mtr-packet',
        '18000,6,500,kourier',
        '22000,6,500,syncthing',
        '22,6,0,sshd',
        '22,6,0,systemd',
        '22,6,500,sshd',
        '2379,6,500,etcd',
        '2380,6,500,etcd',
        '24800,6,500,synergy-core',
        '24802,6,500,synergy-service',
        '255,255,500,mtr-packet',
        '27036,6,500,steam',
        '27500,6,500,passimd',
        '3000,6,472,grafana-server',
        '3000,6,500,grafana',
        '3000,6,500,grafana-server',
        '3000,6,500,node',
        '32768,6,0,tailscaled',
        '32768,6,0,.tailscaled-wra',
        '32768,6,500,com.docker.back',
        '32768,6,500,com.docker.backend',
        '32768,6,500,dleyna-renderer',
        '32768,6,500,java',
        '32768,6,500,jetbrains-toolb',
        '32768,6,500,spotify',
        '3551,6,0,apcupsd',
        '4143,6,500,linkerd2-proxy',
        '4191,6,500,linkerd2-proxy',
        '443,6,0,docker-proxy',
        '443,6,0,tailscaled',
        '443,6,500,jcef_helper',
        '4443,6,500,metrics-server',
        '5000,6,0,registry',
        '5000,6,500,ControlCenter',
        '5001,6,0,registry',
        '5050,6,500,rootlesskit',
        '53,17,0,coredns',
        '53,17,114,dnsmasq',
        '53,17,130,dnsmasq',
        '53,17,500,aardvark-dns',
        '53,17,500,coredns',
        '53,17,500,dnsmasq',
        '5355,6,193,systemd-resolve',
        '5355,6,500,systemd-resolve',
        '53,6,0,coredns',
        '53,6,114,dnsmasq',
        '53,6,130,dnsmasq',
        '53,6,500,coredns',
        '53,6,500,dnsmasq',
        '5432,6,70,postgres',
        '546,17,500,dhcpcd',
        '547,17,500,dnsmasq',
        '5556,6,500,dex',
        '5556,6,500,openshot-qt',
        '5558,6,500,dex',
        '58,255,0,dhcpcd',
        '58,255,0,NetworkManager',
        '58,255,100,systemd-network',
        '58,255,500,dhcpcd',
        '58,255,500,dnsmasq',
        '58,255,500,mtr-packet',
        '58,255,500,systemd-network',
        '631,17,0,cups-browsed',
        '631,17,115,cups-browsed',
        '631,17,116,cups-browsed',
        '631,17,121,cups-browsed',
        '631,17,133,cups-browsed',
        '6379,6,500,redis-server',
        '6443,6,0,kube-apiserver',
        '6443,6,500,kube-apiserver',
        '67,17,114,dnsmasq',
        '67,17,130,dnsmasq',
        '67,17,500,dnsmasq',
        '68,17,0,dhclient',
        '68,17,100,systemd-network',
        '68,17,500,dhcpcd',
        '68,17,500,systemd-network',
        '7000,6,500,ControlCenter',
        '8001,6,500,__debug_bin,',
        '8008,6,500,activator',
        '8008,6,500,autoscaler',
        '8008,6,500,controlplane',
        '8008,6,500,resolvers',
        '8008,6,500,webhook',
        '8009,6,0,java',
        '80,6,0,docker-proxy',
        '80,6,101,nginx',
        '80,6,33,apache2',
        '80,6,60,nginx',
        '8080,6,0,coredns',
        '8080,6,0,java',
        '8081,6,500,main',
        '8086,6,0,influxd',
        '8086,6,500,controller',
        '8086,6,500,influxd',
        '8090,6,500,linkerd-policy-',
        '8123,6,500,Brackets-node',
        '8181,6,0,coredns',
        '8181,6,500,coredns',
        '8443,6,0,kube-apiserver',
        '8443,6,101,nginx-ingress-c',
        '8443,6,500,controller',
        '8443,6,500,controlplane',
        '8443,6,500,webhook',
        '8834,6,0,nessusd',
        '9000,6,500,authentik-proxy',
        '9000,6,500,main',
        '9090,6,500,controlplane',
        '9153,6,0,coredns',
        '9300,6,500,authentik-proxy',
        '9880,6,500,rootlesskit'
      )
      AND NOT (
        p.path LIKE '/ko-app/%'
        AND lp.port > 1024
        and lp.protocol = 6
      )
      AND NOT (
        p.name IN (
          'caddy',
          'com.docker.back',
          'controller',
          'crane',
          'dnsmasq',
          'docker-proxy',
          'hugo',
          'kubectl',
          'nginx-ingress-c',
          'node',
          'rootlessport',
          'webhook'
        )
        AND lp.port > 1024
        and lp.protocol = 6
      )
      -- Exclude processes running inside of Docker containers
      AND NOT p.cgroup_path LIKE '/system.slice/docker-%'
      AND NOT p.cgroup_path LIKE '/user.slice/user-%.slice/user@%.service/user.slice/nerdctl-%'
      AND NOT p.cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/libpod-%'
    GROUP BY
      exception_key
  tags: persistent, state, net
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected programs listening on a TCP port.
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-listening-port-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Unexpected programs listening on a TCP port.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1571/ (Non-Standard Port)
    --
    -- tags: persistent state net low
    -- platform: darwin
    SELECT
      lp.address,
      lp.port,
      lp.protocol,
      p.uid,
      p.pid,
      p.name,
      p.path,
      p.cmdline,
      p.cwd,
      hash.sha256,
      signature.authority AS program_authority,
      CONCAT (
        MIN(lp.port, 49152),
        ',',
        lp.protocol,
        ',',
        MIN(p.uid, 500),
        ',',
        p.name,
        ',',
        signature.authority
      ) AS exception_key
    FROM
      listening_ports lp
      LEFT JOIN processes p ON lp.pid = p.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN signature ON p.path = signature.path
    WHERE
      port != 0
      AND lp.address NOT IN ('224.0.0.251', '::1')
      AND lp.address NOT LIKE '127.0.0.%'
      AND lp.address NOT LIKE '172.1%'
      AND lp.address NOT LIKE 'fe80::%'
      AND lp.address NOT LIKE '::ffff:127.0.0.%' -- All outgoing UDP (protocol 17) sessions are 'listening'
      AND NOT (
        lp.protocol = 17
        AND lp.port > 1024
      ) -- Random webservers
      AND NOT (
        p.uid > 500
        AND lp.port IN (8000, 8080)
        AND lp.protocol = 6
      ) -- Filter out unmapped raw sockets
      AND NOT (p.pid == '') -- Exceptions: the uid is capped at 500 to represent regular users versus system users
      -- port is capped at 49152 to represent transient ports
      AND NOT exception_key IN (
        '10011,6,0,launchd,Software Signing',
        '10011,6,0,webfilterproxyd,Software Signing',
        '1024,6,0,systemmigrationd,Software Signing',
        '10250,6,500,OrbStack Helper,Developer ID Application: Orbital Labs, LLC (U.S.) (HUAQ24HBR6)',
        '111,17,1,rpcbind,Software Signing',
        '111,6,1,rpcbind,Software Signing',
        '1144,6,500,fuscript,Developer ID Application: Blackmagic Design Inc (9ZGFBWLSYP)',
        '1234,6,500,qemu-system-aarch64,',
        '1313,6,500,hugo,',
        '1338,6,500,ec2-metadata-mock,',
        '1338,6,500,registry,',
        '137,17,0,launchd,Software Signing',
        '137,17,222,netbiosd,Software Signing',
        '138,17,0,launchd,Software Signing',
        '138,17,222,netbiosd,Software Signing',
        '15611,6,500,Postman,Developer ID Application: Postdot Technologies, Inc (H7H8Q7M5CK)',
        '16587,6,500,RescueTime,Developer ID Application: RescueTime, Inc (FSY4RB8H39)',
        '17500,6,500,Dropbox,Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        '1824,6,500,WaveLink,Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        '1834,6,500,Camera Hub,Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        '2112,6,500,fake,',
        '2112,6,500,rekor-server,',
        '2112,6,500,timestamp-server,',
        '22000,6,500,syncthing,',
        '22000,6,500,syncthing,Developer ID Application: Jakob Borg (LQE5SYM783)',
        '22000,6,500,syncthing,Developer ID Application: Kastelo AB (LQE5SYM783)',
        '22,6,0,launchd,Software Signing',
        '2345,6,500,dlv,',
        '24678,6,500,node,',
        '24802,6,500,synergy-service,Developer ID Application: Symless Ltd (4HX897Y6GJ)',
        '24851,6,500,HueSync,Developer ID Application: Signify Netherlands B.V. (PREPN2W95S)',
        '25565,6,500,java,',
        '26000,6,500,node20,Developer ID Application: Node.js Foundation (HX7739G8FX)',
        '27036,6,500,steam_osx,Developer ID Application: Valve Corporation (MXGJJ98X76)',
        '28197,6,500,Stream Deck,Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        '28198,6,500,Stream Deck,Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        '2968,6,500,EEventManager,Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',
        '33060,6,74,mysqld,Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        '3306,6,500,mariadbd,',
        '3306,6,74,mysqld,Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        '33333,6,500,Ultimate,',
        '3400,6,500,Sonos,Developer ID Application: Sonos, Inc. (2G4LW83Q3E)',
        '3491,6,500,MuteDeck,Developer ID Application: Martijn Smit (GX645XXEAX)',
        '3492,6,500,MuteDeck,Developer ID Application: Martijn Smit (GX645XXEAX)',
        '3493,6,500,MuteDeck,Developer ID Application: Martijn Smit (GX645XXEAX)',
        '4000,6,500,OrbStack Helper,Developer ID Application: Orbital Labs, LLC (U.S.) (HUAQ24HBR6)',
        '41949,6,500,IPNExtension,Apple Mac OS Application Signing',
        '43398,6,500,IPNExtension,Apple Mac OS Application Signing',
        '44000,6,500,Podman Desktop,Developer ID Application: Red Hat, Inc. (HYSCB8KRL2)',
        '443,6,500,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '443,6,500,crc,Developer ID Application: Red Hat, Inc. (HYSCB8KRL2)',
        '443,6,500,limactl,',
        '443,6,500,OrbStack Helper,Developer ID Application: Orbital Labs, LLC (U.S.) (HUAQ24HBR6)',
        '44450,6,500,Linear Helper,Developer ID Application: Linear Orbit, Inc. (7VZ2S3V9RV)',
        '44554,6,500,Luna Display,Developer ID Application: Astro HQ LLC (8356ZZ8Y5K)',
        '45972,6,500,IPNExtension,Apple Mac OS Application Signing',
        '46788,6,0,io.tailscale.ipn.macsys.network-extension,Developer ID Application: Tailscale Inc. (W5364U7YZB)',
        '4710,6,500,UA Mixer Engine,Developer ID Application: Universal Audio (4KAC9AX6CG)',
        '49152,6,0,AirPlayXPCHelper,Software Signing',
        '49152,6,0,io.tailscale.ipn.macsys.network-extension,Developer ID Application: Tailscale Inc. (W5364U7YZB)',
        '49152,6,0,launchd,Software Signing',
        '49152,6,0,remoted,Software Signing',
        '49152,6,0,remotepairingdeviced,Software Signing',
        '49152,6,500,AUHostingServiceXPC_arrow,Software Signing',
        '49152,6,500,CaptureCoreService,Developer ID Application: Capture One A/S (5WTDB5F65L)',
        '49152,6,500,com.adguard.mac.adguard.network-extension,Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)',
        '49152,6,500,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '49152,6,500,com.docker.supervisor,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '49152,6,500,ContinuityCaptureAgent,Software Signing',
        '49152,6,500,Cypress,Developer ID Application: Cypress.Io, Inc. (7D655LWGLY)',
        '49152,6,500,dbeaver,Developer ID Application: DBeaver Corporation (42B6MDKMW8)',
        '49152,6,500,EcammLiveRemoteXPCServer,Developer ID Application: Ecamm Network, LLC (5EJH68M642)',
        '49152,6,500,GarageBand,Apple Mac OS Application Signing',
        '49152,6,500,git-daemon,',
        '49152,6,500,idea,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        '49152,6,500,IPNExtension,Apple Mac OS Application Signing',
        '49152,6,500,java,Developer ID Application: Eclipse Foundation, Inc. (JCDTMS22B4)',
        '49152,6,500,java,Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        '49152,6,500,jetbrains-toolbox,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        '49152,6,500,Logic Pro X,Apple Mac OS Application Signing',
        '49152,6,500,LogiMgrDaemon,Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        '49152,6,500,logioptionsplus_agent,Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        '49152,6,500,Luna Display,Developer ID Application: Astro HQ LLC (8356ZZ8Y5K)',
        '49152,6,500,Music,Software Signing',
        '49152,6,500,node,',
        '49152,6,500,qemu-system-aarch64,',
        '49152,6,500,rapportd,Software Signing',
        '49152,6,500,Resolve,Developer ID Application: Blackmagic Design Inc (9ZGFBWLSYP)',
        '49152,6,500,Signal,Developer ID Application: Quiet Riddle Ventures LLC (U68MSDN6DR)',
        '49152,6,500,Signal Helper (Renderer),Developer ID Application: Quiet Riddle Ventures LLC (U68MSDN6DR)',
        '49152,6,500,siriactionsd,Software Signing',
        '49152,6,500,Sketch,Developer ID Application: Bohemian Coding (WUGMZZ5K46)',
        '49152,6,500,SketchMirrorHelper,Developer ID Application: Bohemian Coding (WUGMZZ5K46)',
        '49152,6,500,Spotify,Developer ID Application: Spotify (2FNC3A47ZF)',
        '49152,6,500,Stream Deck,Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        '49152,6,500,telepresence,',
        '49152,6,500,vpnkit-bridge,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '49152,6,500,Webcam-desktop,Developer ID Application: Shenzhen Arashi Vision Co., Ltd. (847R5ZLN8S)',
        '49152,6,500,WebexHelper,Developer ID Application: Cisco (DE8Y96K9QP)',
        '49152,6,500,WorkflowAppControl,Developer ID Application: Brother Industries, LTD. (5HCL85FLGW)',
        '49152,6,65,mDNSResponder,Software Signing',
        '5000,6,500,ControlCenter,Software Signing',
        '5001,6,500,crane,',
        '5001,6,500,gvproxy,',
        '500,6,8883,BambuStudio,BambuStudio,500u,80g',
        '5060,6,500,CommCenter,Software Signing',
        '53,17,500,dnsmasq,',
        '53,17,500,server,',
        '53,17,65,mDNSResponder,Software Signing',
        '53,6,500,dnsmasq,',
        '53,6,65,mDNSResponder,Software Signing',
        '5454,6,0,xrdd,Developer ID Application: X-Rite, Incorporated (2K7GT73B4R)',
        '546,17,0,configd,Software Signing',
        '547,17,500,dhcp6d,Software Signing',
        '5900,6,0,launchd,Software Signing',
        '5900,6,0,screensharingd,Software Signing',
        '5990,6,500,goland,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        '6000,6,500,X11.bin,Developer ID Application: Apple Inc. - XQuartz (NA574AWV7E)',
        '631,6,0,cupsd,Software Signing',
        '67,17,0,bootpd,Software Signing',
        '67,17,0,launchd,Software Signing',
        '68,17,0,configd,Software Signing',
        '6996,6,500,sourcegraph-backend,Developer ID Application: SOURCEGRAPH INC (74A5FJ7P96)',
        '7000,6,500,ControlCenter,Software Signing',
        '7265,6,500,Raycast,Developer ID Application: Raycast Technologies Inc (SY64MV22J9)',
        '8055,6,500,java,Developer ID Application: Eclipse Foundation, Inc. (JCDTMS22B4)',
        '80,6,500,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '80,6,500,crc,Developer ID Application: Red Hat, Inc. (HYSCB8KRL2)',
        '80,6,500,limactl,',
        '80,6,500,OrbStack Helper,Developer ID Application: Orbital Labs, LLC (U.S.) (HUAQ24HBR6)',
        '8081,6,500,crane,',
        '8123,6,500,Brackets-node,Developer ID Application: CORE.AI SCIENTIFIC TECHNOLOGIES PRIVATE LIMITED (8F632A866K)',
        '8125,6,500,Brackets-node,Developer ID Application: CORE.AI SCIENTIFIC TECHNOLOGIES PRIVATE LIMITED (8F632A866K)',
        '81,6,500,nginx,',
        '8770,6,500,sharingd,Software Signing',
        '8771,6,500,sharingd,Software Signing',
        '88,17,0,kdc,Software Signing',
        '8834,6,0,nessusd,Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        '88,6,0,kdc,Software Signing',
        '8888,6,500,otel-desktop-viewer,',
        '8933,6,500,WebexHelper,Developer ID Application: Cisco (DE8Y96K9QP)',
        '8934,6,500,WebexHelper,Developer ID Application: Cisco (DE8Y96K9QP)',
        '9101,6,500,github_actions_exporter,',
        '9991,6,500,sourcegraph-backend,Developer ID Application: SOURCEGRAPH INC (74A5FJ7P96)'
      )
      AND NOT exception_key LIKE '%,6,500,sourcegraph-backend,Developer ID Application: SOURCEGRAPH INC (74A5FJ7P96)'
      AND NOT exception_key LIKE '88%,6,500,Code Helper,Developer ID Application: Microsoft Corporation (UBF8T346G9)'
      AND NOT exception_key LIKE '%,0,rpc.%,Software Signing'
      AND NOT (
        signature.authority = 'Developer ID Application: Linear Orbit, Inc. (7VZ2S3V9RV)'
        AND lp.port > 1024
      )
      AND NOT (
        signature.authority = 'Developer ID Application: Microsoft Corporation (UBF8T346G9)'
        AND lp.port > 5000
      )
      AND NOT (
        exception_key LIKE '%,6,500,IPNExtension,Apple Mac OS Application Signing'
        AND lp.port > 5000
      )
      AND NOT (
        p.path LIKE ',ko-app,%'
        AND lp.port > 1024
        and lp.protocol = 6
      )
      AND NOT (
        p.name IN (
          'caddy',
          'com.docker.backend',
          'controller',
          'crane',
          'crc',
          'OrbStack Helper',
          'docker-proxy',
          'hugo',
          'kubectl',
          'node',
          'webhook'
        )
        AND lp.port > 1024
        and lp.protocol = 6
      )
      AND NOT (
        p.path LIKE '/private/var/folders/%/go-build%/exe/%'
        AND lp.port > 1024
        AND lp.protocol = 6
      )
      AND NOT (
        (
          p.cwd LIKE '/Users/%/src/%'
          OR p.cwd LIKE '/Users/%/dev/%'
        )
        AND p.cmdline LIKE './%'
        AND lp.port > 1024
        AND lp.protocol = 6
      )
      AND NOT (
        (
          p.path = '/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/MacOS/ARDAgent'
          AND lp.port = 3283
          AND lp.protocol = 6
        )
      )
    GROUP BY
      exception_key
  tags: persistent, state, net, low
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected programs with open lock files
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-lock-opener
  observer_can_run: false
  platforms: posix
  query: |
    -- Find unexpected programs with open lock files
    --
    -- false positives:
    --   * many possible
    --
    -- references:
    --   * https://www.deepinstinct.com/blog/bpfdoor-malware-evolves-stealthy-sniffing-backdoor-ups-its-game
    --
    -- tags: persistent filesystem state
    -- platform: posix
    SELECT
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path),
        ',',
        COALESCE(
          REGEX_MATCH (REPLACE(pof.path, u.directory, '~'), '(.*)/.*', 1),
          REPLACE(pof.path, u.directory, '~')
        )
      ) AS exception_key,
      pof.path AS lock,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN users u ON p0.euid = u.uid
      LEFT JOIN process_open_files pof ON p0.pid = pof.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      pof.path LIKE "%.lock"
      AND NOT pof.path NOT LIKE "/run/user/%/%.lock"
      AND NOT p0.path LIKE '/System/%'
      AND NOT exception_key IN (
        '0,com.apple.MobileSoftwareUpdate.CryptegraftService,/private/var/db/softwareupdate/SplunkHistory',
        '0,snapd,/var/lib/snapd',
        '120,gnome-shell,/run/user/120',
        '500,kwin_wayland_wrapper,/run/user/1000',
        '200,NRDUpdated,/private~/SplunkHistory',
        '200,softwareupdated,/private~/SplunkHistory',
        '500,Adobe Premiere Pro 2023,~/Library/Caches/Adobe/Premiere Pro/23.0/SentryIO-db',
        '500,Beeper,~/Library/Application Support/Beeper/EventStore',
        '500,bridge-gui,~/Library/Application Support/protonmail/bridge-v3/sentry_cache',
        '500,bridge-gui,~/Library/Caches/protonmail/bridge-v3',
        '500,bridge,~/Library/Application Support/protonmail/bridge-v3/sentry_cache',
        '500,bridge,~/Library/Caches/protonmail/bridge-v3',
        '500,buildkitd,~/.local/share/buildkit',
        '500,Clipy,~/Library/Application Support/com.clipy-app.Clipy',
        '500,com.docker.backend,~/Library/Containers/com.docker.docker',
        '500,com.docker.build,~/.docker/desktop-build',
        '500,Craft,~/Library/Containers/com.lukilabs.lukiapp/Data/Library/Application Support/com.lukilabs.lukiapp',
        '500,Ecamm Live Stream Deck Plugin,~/Library/Application Support/com.elgato.StreamDeck/Sentry',
        '500,flyctl,~/.fly',
        '500,Hyprland,/run/user/1000',
        '127,pipewire,/run/user/127',
        '500,gnome-shell,/run/user/1000',
        '120,pipewire,/run/user/120',
        '500,iMovie,~/Movies/iMovie Library.imovielibrary',
        '500,Opera,~/Library/Application Support/com.operasoftware.Opera',
        '500,photolibraryd,~/Library/Photos/Libraries/Syndication.photoslibrary/database',
        '500,photolibraryd,~/Pictures/Photos Library.photoslibrary/database',
        '500,pipewire,/run/user/1000',
        '500,reMarkable,~/Library/Application Support/remarkable/desktop',
        '500,Stream Deck,~/Library/Application Support/com.elgato.StreamDeck/Sentry',
        '500,TwitchStudioStreamDeck,~/Library/Application Support/com.elgato.StreamDeck/Sentry'
      )
      AND NOT exception_key LIKE '500,com.apple.Virtualization.VirtualMachine,~/%'
      AND NOT exception_key LIKE '500,iMovie,%.imovielibrary'
      AND NOT exception_key LIKE '500,go,~/go/pkg/mod/cache/download/%'
      AND NOT exception_key LIKE '500,remindd,/private/var/folders/%/T/.AddressBookLocks'
      AND NOT exception_key LIKE '500,com.apple.Virtualization.VirtualMachine,/private/var/folders/%'
      AND NOT exception_key LIKE '500,lua-language-server,~/%'
      AND NOT exception_key LIKE '500,ykman-gui,/private/var/folders/%/T'
      AND NOT exception_key LIKE '500,golangci-lint,/private/var/folders/%/T'
      AND NOT exception_key LIKE '0,prl_disp_service,/Users/%/Parallels/%.pvm'
      AND NOT exception_key LIKE '500,iTermServer-%,~/Library/Application Support/iTerm2'
      AND NOT exception_key LIKE '500,%,/private/var/folders/%/T/Sentry_StreamDeck'
      AND NOT exception_key LIKE '500,gnome-software,/var/tmp/flatpak-cache-%'
      AND NOT exception_key LIKE '%,gnome-shell,/run/user/%'
      AND NOT exception_key LIKE '%,pipewire%,/run/user/%'
      AND NOT exception_key LIKE '500,com.docker.backend,/private/var/folders/%/go/pkg/mod/cache/%'
    GROUP BY
      p0.path,
      pof.path
  tags: persistent, filesystem, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find unexpected SSH authorized keys
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-ssh-authorized-keys
  observer_can_run: false
  platforms: posix
  query: |
    -- Find unexpected SSH authorized keys
    --
    -- references:
    --   * https://socradar.io/linux-malware-rapperbot-brute-forcing-ssh-servers/
    --   * https://www.countercraftsec.com/blog/dota3-malware-again-and-again/
    --   * https://attack.mitre.org/techniques/T1098/004/
    --   * https://www.trendmicro.com/en_us/research/21/j/actors-target-huawei-cloud-using-upgraded-linux-malware-.html
    --
    -- tags: persistent state filesystem
    -- platform: posix
    SELECT
      file.path,
      file.uid,
      file.gid,
      file.atime,
      file.mtime,
      file.ctime,
      file.size,
      hash.sha256,
      users.username,
      users.uid AS u_uid
    FROM
      users
      JOIN file ON file.path = users.directory || "/.ssh/authorized_keys"
      JOIN hash ON file.path = hash.path
    WHERE
      file.size > 0
      AND (
        file.uid != u_uid
        OR file.uid < 500
        OR (
          file.path NOT LIKE '/home/%'
          AND file.path NOT LIKE '/Users/%'
        )
      )
  tags: persistent, state, filesystem
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Suspicious calls to systemctl(event-based)
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-systemctl-calls-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Suspicious calls to systemctl(event-based)
    --
    -- refs:
    --   * https://attack.mitre.org/techniques/T1543/002/ (Create or Modify System Process: Systemd Service)
    --
    -- tags: transient process state often
    -- platform: linux
    -- interval: 300
    SELECT -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      uptime.total_seconds > 30 -- NOTE: The remainder of this query is synced with unexpected-fetcher-parents
      AND pe.path IN (
        '/usr/bin/systemctl',
        '/bin/systemctl',
        '/sbin/systemctl'
      )
      AND pe.cmdline != ''
      AND pe.time > (strftime('%s', 'now') -300)
      AND NOT exception_key IN (
        'systemctl,0,,containerd-shim-runc-v2',
        'systemctl,0,apt-helper,',
        'systemctl,0,bash,pacman',
        'systemctl,0,dash,logrotate',
        'systemctl,0,kubeadm,containerd-shim-runc-v2',
        'systemctl,0,pacman,pacman',
        'systemctl,0,pacman,sudo',
        'systemctl,0,snapd,systemd',
        'systemctl,0,tailscaled,',
        'systemctl,500,strace,bash',
        'systemctl,127,snap,systemd',
        'systemctl,120,systemd-executor,systemd',
        'systemctl,128,systemd,systemd',
        'systemctl,500,snapd,systemd',
        'systemctl,500,systemd,systemd',
        'systemctl,500,bash,gnome-terminal-server',
        'systemctl,500,snap,systemd',
        'systemctl,500,systemd,',
        'systemctl,500,zsh,tmux'
      )
      AND NOT p0_cmd IN (
        '/bin/systemctl is-enabled -q whoopsie.path',
        '/bin/systemctl -q is-enabled whoopsie.path',
        '/bin/systemctl --quiet is-enabled whoopsie.path',
        '/bin/systemctl stop --no-block nvidia-persistenced',
        '/sbin/runlevel',
        'systemctl is-active systemd-resolved.service',
        'systemctl is-enabled power-profiles-daemon.service',
        'systemctl is-enabled snapd.apparmor',
        'systemctl is-enabled systemd-rfkill.service',
        'systemctl is-enabled systemd-rfkill.socket',
        'systemctl is-enabled tlp.service',
        'systemctl kill -s HUP rsyslog.service',
        'systemctl -p LoadState show cups.service',
        'systemctl -q is-enabled whoopsie',
        'systemctl --quiet is-enabled cups.service',
        'systemctl reboot',
        'systemctl restart cups.service',
        'systemctl restart NetworkManager.service',
        'systemctl restart reflector.service',
        'systemctl status kubelet',
        'systemctl stop kubelet',
        'systemctl stop libvirtd.service',
        'systemctl --system daemon-reexec',
        'systemctl --user import-environment DISPLAY XAUTHORITY',
        '/usr/bin/systemctl try-reload-or-restart dbus',
        '/usr/bin/systemctl --user is-active slack'
      ) -- apt-helper form
      AND NOT p0_cmd LIKE '%systemctl is-active -q %.service'
      AND NOT p0_cmd LIKE '%systemctl show --property=%'
      AND NOT p0_cmd LIKE '/usr/bin/systemctl --user set-environment%'
      AND NOT p0_cmd LIKE '%systemctl % snap-kubectl-%.mount'
      AND NOT p0_cmd LIKE '%systemctl --user set-environment DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%/bus'
    GROUP BY
      pe.pid
  tags: transient, process, state, often
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected long-running processes running as root
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-uid0-daemon-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Unexpected long-running processes running as root
    --
    -- false positives:
    --   * new software requiring escalated privileges
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/
    --
    -- tags: persistent process state
    -- platform: linux
    SELECT
      CONCAT (
        p0.name,
        ',',
        REPLACE(
          p0.path,
          COALESCE(
            REGEX_MATCH (p0.path, "/nix/store/(.*?)/.*", 1),
            REGEX_MATCH (p0.path, "(\d[\.\d]+)/.*", 1),
            "3.11"
          ),
          "__VERSION__"
        ),
        ',',
        -- This is intentionally not euid, as everything is euid 0
        p0.uid,
        ',',
        CONCAT (
          SPLIT (p0.cgroup_path, "/", 0),
          ",",
          SPLIT (p0.cgroup_path, "/", 1)
        ),
        ',',
        f.mode
      ) AS exception_key,
      DATETIME(f.ctime, 'unixepoch') AS p0_changed,
      DATETIME(f.mtime, 'unixepoch') AS p0_modified,
      (strftime('%s', 'now') - p0.start_time) AS p0_runtime_s,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.euid = 0
      AND p0.parent > 0
      AND p0.path != ""
      AND p0.start_time < (strftime('%s', 'now') - 1200)
      AND exception_key NOT IN (
        '(sd-pam),/usr/lib/systemd/systemd,0,user.slice,user-0.slice,0755',
        '.tailscaled-wra,/nix/store/__VERSION__/bin/.tailscaled-wrapped,0,system.slice,tailscaled.service,0555',
        '/usr/bin/monito,/usr/bin/perl,0,system.slice,monitorix.service,0755',
        'DisplayLinkMana,/usr/libexec/displaylink/DisplayLinkManager,0,system.slice,displaylink.service,0755',
        'ModemManager,/usr/sbin/ModemManager,0,system.slice,ModemManager.service,0755',
        'NetworkManager,/usr/bin/NetworkManager,0,system.slice,NetworkManager.service,0755',
        'NetworkManager,/usr/sbin/NetworkManager,0,system.slice,NetworkManager.service,0755',
        'X,/nix/store/__VERSION__/bin/Xorg,0,system.slice,display-manager.service,0555',
        'Xorg,/usr/lib/Xorg,0,system.slice,lightdm.service,0755',
        'Xorg,/usr/lib/Xorg,0,system.slice,sddm.service,0755',
        'Xorg,/usr/lib/xorg/Xorg,0,system.slice,sddm.service,0755',
        'abrt-dump-journ,/usr/bin/abrt-dump-journal-core,0,system.slice,abrt-journal-core.service,0755',
        'abrt-dump-journ,/usr/bin/abrt-dump-journal-oops,0,system.slice,abrt-oops.service,0755',
        'abrt-dump-journ,/usr/bin/abrt-dump-journal-xorg,0,system.slice,abrt-xorg.service,0755',
        'abrtd,/usr/sbin/abrtd,0,system.slice,abrtd.service,0755',
        'accounts-daemon,/nix/store/__VERSION__/libexec/accounts-daemon,0,system.slice,accounts-daemon.service,0555',
        'accounts-daemon,/usr/lib/accounts-daemon,0,system.slice,accounts-daemon.service,0755',
        'accounts-daemon,/usr/libexec/accounts-daemon,0,system.slice,accounts-daemon.service,0755',
        'acpid,/usr/sbin/acpid,0,system.slice,acpid.service,0755',
        'agetty,/nix/store/__VERSION__/bin/agetty,0,system.slice,system-getty.slice,0555',
        'agetty,/usr/bin/agetty,0,system.slice,system-getty.slice,0755',
        'agetty,/usr/sbin/agetty,0,system.slice,system-getty.slice,0755',
        'agetty,/usr/sbin/agetty,0,system.slice,system-serial\x2dgetty.slice,0755',
        'alsactl,/usr/sbin/alsactl,0,system.slice,alsa-state.service,0755',
        'anacron,/usr/bin/anacron,0,system.slice,cronie.service,0755',
        'anacron,/usr/sbin/anacron,0,system.slice,crond.service,0755',
        'apcupsd,/usr/bin/apcupsd,0,system.slice,apcupsd.service,0755',
        'atd,/usr/sbin/atd,0,system.slice,atd.service,0755',
        'auditd,/usr/bin/auditd,0,system.slice,auditd.service,0755',
        'auditd,/usr/sbin/auditd,0,system.slice,auditd.service,0755',
        'bash,/usr/bin/bash,0,user.slice,user-1000.slice,0755',
        'blueman-mechani,/usr/bin/python3.10,0,system.slice,blueman-mechanism.service,0755',
        'blueman-mechanism.service,Bluetooth management mechanism,,200',
        'bluetoothd,/usr/lib/bluetooth/bluetoothd,0,system.slice,bluetooth.service,0755',
        'bluetoothd,/usr/libexec/bluetooth/bluetoothd,0,system.slice,bluetooth.service,0755',
        'boltd,/usr/lib/boltd,0,system.slice,bolt.service,0755',
        'boltd,/usr/libexec/boltd,0,system.slice,bolt.service,0755',
        'bpfilter_umh,/bpfilter_umh,0,,,',
        'canonical-livep,/snap/canonical-livepatch/__VERSION__/canonical-livepatchd,0,system.slice,snap.canonical-livepatch.canonical-livepatchd.service,0755',
        'chainctl,/usr/local/bin/chainctl,0,user.slice,user-1000.slice,0755',
        'containerd,/nix/store/__VERSION__/bin/containerd,0,system.slice,docker.service,0555',
        'containerd,/usr/bin/containerd,0,system.slice,containerd.service,0755',
        'containerd,/usr/bin/containerd,0,system.slice,docker.service,0755',
        'containerd-shim,/usr/bin/containerd-shim-runc-v2,0,system.slice,containerd.service,0755',
        'containerd-shim,/usr/bin/containerd-shim-runc-v2,0,system.slice,docker.service,0755',
        'cron,/usr/sbin/cron,0,system.slice,cron.service,0755',
        'crond,/usr/bin/crond,0,system.slice,cronie.service,0755',
        'crond,/usr/sbin/crond,0,system.slice,crond.service,0755',
        'cups-browsed,/usr/sbin/cups-browsed,0,system.slice,cups-browsed.service,0755',
        'cupsd,/usr/bin/cupsd,0,system.slice,cups.service,0700',
        'cupsd,/usr/sbin/cupsd,0,system.slice,cups.service,0755',
        'dbus-daemon,/usr/bin/dbus-daemon,0,user.slice,user-1000.slice,0755',
        'dbus-launch,/usr/bin/dbus-launch,0,user.slice,user-1000.slice,0755',
        'dconf-service,/usr/libexec/dconf-service,0,user.slice,user-1000.slice,0755',
        'dhclient,/usr/sbin/dhclient,0,system.slice,networking.service,0755',
        'dhcpcd,/nix/store/__VERSION__/bin/dhcpcd,0,system.slice,dhcpcd.service,0555',
        'dirmngr,/usr/bin/dirmngr,0,system.slice,archlinux-keyring-wkd-sync.service,0755',
        'dirmngr,/usr/bin/dirmngr,0,system.slice,system-dirmngr.slice,0755',
        'dnf,/usr/bin/python__VERSION__,0,user.slice,user-1000.slice,0755',
        'dnsmasq,/usr/bin/dnsmasq,0,system.slice,libvirtd.service,0755',
        'dnsmasq,/usr/sbin/dnsmasq,0,system.slice,libvirtd.service,0755',
        'doas,/usr/bin/doas,1000,user.slice,user-1000.slice,4755',
        'docker,/usr/bin/docker,0,user.slice,user-1000.slice,0755',
        'docker,/usr/local/bin/docker,0,user.slice,user-1000.slice,0755',
        'docker-proxy,/usr/bin/docker-proxy,0,system.slice,docker.service,0755',
        'docker-proxy,/usr/libexec/docker/docker-proxy,0,system.slice,docker.service,0755',
        'dockerd,/nix/store/__VERSION__/libexec/docker/dockerd,0,system.slice,docker.service,0555',
        'dockerd,/usr/bin/dockerd,0,system.slice,docker.service,0755',
        'elastic-endpoin,/opt/Elastic/Endpoint/elastic-endpoint,0,elasticendpoint,,0500',
        'elastic-endpoin,/opt/Elastic/Endpoint/elastic-endpoint,0,system.slice,ElasticEndpoint.service,0500',
        'elastic-endpoin,/var/opt/Elastic/Endpoint/elastic-endpoint,0,elasticendpoint,,0500',
        'firewalld,/usr/bin/python3.10,0,system.slice,firewalld.service,0755',
        'firewalld,/usr/bin/python3.12,0,system.slice,firewalld.service,0755',
        'firewalld,/usr/bin/python__VERSION__,0,system.slice,firewalld.service,0755',
        'fish,/usr/bin/fish,0,user.slice,user-1000.slice,0755',
        'flatpak-system-,/usr/lib/flatpak-system-helper,0,system.slice,flatpak-system-helper.service,0755',
        'flatpak-system-,/usr/libexec/flatpak-system-helper,0,system.slice,flatpak-system-helper.service,0755',
        'fprintd,/usr/libexec/fprintd,0,system.slice,fprintd.service,0755',
        'fstrim,/usr/sbin/fstrim,0,system.slice,fstrim.service,0755',
        'fusermount,/usr/bin/fusermount,1000,user.slice,user-1000.slice,4755',
        'fwupd,/usr/lib/fwupd/fwupd,0,system.slice,fwupd.service,0755',
        'fwupd,/usr/libexec/fwupd/fwupd,0,system.slice,fwupd.service,0755',
        'gdm,/usr/bin/gdm,0,system.slice,gdm.service,0755',
        'gdm,/usr/sbin/gdm,0,system.slice,gdm.service,0755',
        'gdm-session-wor,/usr/lib/gdm-session-worker,0,user.slice,user-1000.slice,0755',
        'gdm-session-wor,/usr/lib/gdm-session-worker,0,user.slice,user-120.slice,0755',
        'gdm-session-wor,/usr/libexec/gdm-session-worker,0,user.slice,user-1000.slice,0755',
        'gdm-session-wor,/usr/libexec/gdm-session-worker,0,user.slice,user-1001.slice,0755',
        'gdm-session-wor,/usr/libexec/gdm-session-worker,0,user.slice,user-120.slice,0755',
        'gdm-session-wor,/usr/libexec/gdm-session-worker,0,user.slice,user-42.slice,0755',
        'gdm3,/usr/sbin/gdm3,0,system.slice,gdm.service,0755',
        'geoclue.service,Location Lookup Service,geoclue,500',
        'gnome-keyring-d,/usr/bin/gnome-keyring-daemon,0,user.slice,user-1000.slice,0755',
        'gpg-agent,/usr/bin/gpg-agent,0,system.slice,fwupd.service,0755',
        'gpg-agent,/usr/bin/gpg-agent,0,system.slice,packagekit.service,0755',
        'gpg-agent,/usr/bin/gpg-agent,0,user.slice,user-1000.slice,0755',
        'gssproxy,/usr/sbin/gssproxy,0,system.slice,gssproxy.service,0755',
        'gvfsd,/usr/libexec/gvfsd,0,user.slice,user-1000.slice,0755',
        'gvfsd-fuse,/usr/libexec/gvfsd-fuse,0,user.slice,user-1000.slice,0755',
        'haproxy,/usr/sbin/haproxy,0,system.slice,haproxy.service,0755',
        'iio-sensor-prox,/usr/lib/iio-sensor-proxy,0,system.slice,iio-sensor-proxy.service,0755',
        'iio-sensor-prox,/usr/libexec/iio-sensor-proxy,0,system.slice,iio-sensor-proxy.service,0755',
        'incusd,/opt/incus/bin/incusd,0,lxc.monitor.dashing-bat,,0755',
        'incusd,/opt/incus/bin/incusd,0,lxc.monitor.j1,,0755',
        'incusd,/opt/incus/bin/incusd,0,lxc.monitor.j1c,,0755',
        'incusd,/opt/incus/bin/incusd,0,system.slice,incus.service,0755',
        'incusd,/usr/libexec/incus/incusd,0,lxc.monitor.cheerful-parakeet,,0755',
        'incusd,/usr/libexec/incus/incusd,0,lxc.monitor.pure-dodo,,0755',
        'incusd,/usr/libexec/incus/incusd,0,system.slice,incus.service,0755',
        'ir_agent,/opt/rapid7/ir_agent/components/insight_agent/__VERSION__/ir_agent,0,system.slice,ir_agent.service,',
        'ir_agent,/opt/rapid7/ir_agent/components/insight_agent/__VERSION__/ir_agent,0,system.slice,ir_agent.service,0700',
        'ir_agent,/opt/rapid7/ir_agent/ir_agent,0,system.slice,ir_agent.service,',
        'ir_agent,/opt/rapid7/ir_agent/ir_agent,0,system.slice,ir_agent.service,0700',
        'irqbalance,/usr/sbin/irqbalance,0,system.slice,irqbalance.service,0755',
        'iwd,/usr/lib/iwd/iwd,0,system.slice,iwd.service,0755',
        'launcher,/opt/kolide-k2/bin/launcher,0,system.slice,launcher.kolide-k2.service,0755',
        'launcher,/opt/kolide-k2/bin/launcher-updates/__VERSION__/launcher,0,system.slice,launcher.kolide-k2.service,0755',
        'launcher,/usr/lib/opt/kolide-k2/bin/launcher,0,system.slice,launcher.kolide-k2.service,0755',
        'launcher,/usr/local/kolide-k2/bin/launcher,0,system.slice,launcher.kolide-k2.service,0755',
        'launcher,/usr/local/kolide-k2/bin/launcher-updates/__VERSION__/launcher,0,system.slice,launcher.kolide-k2.service,0755',
        'launcher,/var/kolide-k2/k2device.kolide.com/updates/launcher/__VERSION__/launcher,0,system.slice,launcher.kolide-k2.service,0755',
        'libvirtd,/usr/bin/libvirtd,0,system.slice,libvirtd.service,0755',
        'lightdm,/nix/store/__VERSION__/bin/lightdm,0,system.slice,display-manager.service,0555',
        'lightdm,/nix/store/__VERSION__/bin/lightdm,0,user.slice,user-1000.slice,0555',
        'lightdm,/nix/store/__VERSION__/bin/lightdm,0,user.slice,user-78.slice,0555',
        'lightdm,/usr/bin/lightdm,0,system.slice,lightdm.service,0755',
        'lightdm,/usr/bin/lightdm,0,user.slice,user-1000.slice,0755',
        'lightdm,/usr/bin/lightdm,0,user.slice,user-974.slice,0755',
        'lima-guestagent,/usr/local/bin/lima-guestagent,0,system.slice,lima-guestagent.service,0755',
        'login,/usr/bin/login,0,user.slice,user-1000.slice,0755',
        'low-memory-moni,/usr/libexec/low-memory-monitor,0,system.slice,low-memory-monitor.service,0755',
        'lxc-monitord,/usr/lib/x86_64-linux-gnu/lxc/lxc-monitord,0,system.slice,lxc-monitord.service,0755',
        'lxc-monitord,/usr/libexec/lxc/lxc-monitord,0,system.slice,lxc-monitord.service,0755',
        'lxcfs,/opt/incus/bin/lxcfs,0,system.slice,incus-lxcfs.service,0755',
        'lxcfs,/usr/bin/lxcfs,0,system.slice,lxcfs.service,0755',
        'mbim-proxy,/usr/libexec/mbim-proxy,0,system.slice,ModemManager.service,0755',
        'mcelog,/usr/sbin/mcelog,0,system.slice,mcelog.service,0755',
        'multipathd,/usr/sbin/multipathd,0,system.slice,multipathd.service,0755',
        'nessus-service,/opt/nessus/sbin/nessus-service,0,system.slice,nessusd.service,0755',
        'nessusd,/opt/nessus/sbin/nessusd,0,system.slice,nessusd.service,0755',
        'networkd-dispat,/usr/bin/python3.10,0,system.slice,networkd-dispatcher.service,0755',
        'networkd-dispat,/usr/bin/python3.12,0,system.slice,networkd-dispatcher.service,0755',
        'networkd-dispat,/usr/bin/python__VERSION__,0,system.slice,networkd-dispatcher.service,0755',
        'newgrp,/usr/bin/newgrp,1000,user.slice,user-1000.slice,4755',
        'nix-daemon,/nix/store/__VERSION__/bin/nix,0,system.slice,nix-daemon.service,0555',
        'nm-dispatcher,/usr/lib/nm-dispatcher,0,system.slice,NetworkManager-dispatcher.service,0755',
        'nm-dispatcher,/usr/libexec/nm-dispatcher,0,system.slice,NetworkManager-dispatcher.service,0755',
        'nm-openvpn-serv,/usr/libexec/nm-openvpn-service,0,system.slice,NetworkManager.service,0755',
        'nvidia-powerd,/usr/bin/nvidia-powerd,0,system.slice,nvidia-powerd.service,0755',
        'orbit,/opt/orbit/bin/orbit/linux/stable/orbit,0,system.slice,orbit.service,0755',
        'osquery-extensi,/nix/store/__VERSION__/bin/osquery-extension.ext,0,system.slice,kolide-launcher.service,0555',
        'osqueryd,/nix/store/__VERSION__/bin/osqueryd,0,system.slice,kolide-launcher.service,0555',
        'osqueryd,/opt/orbit/bin/osqueryd/linux/stable/osqueryd,0,system.slice,orbit.service,0755',
        'osqueryd,/usr/lib/opt/kolide-k2/bin/osqueryd,0,system.slice,launcher.kolide-k2.service,0755',
        'osqueryd,/usr/local/kolide-k2/bin/osqueryd,0,system.slice,launcher.kolide-k2.service,0755',
        'osqueryd,/usr/local/kolide-k2/bin/osqueryd-updates/__VERSION__/osqueryd,0,system.slice,launcher.kolide-k2.service,0755',
        'osqueryd,/var/kolide-k2/k2device.kolide.com/updates/osqueryd/__VERSION__/osqueryd,0,system.slice,launcher.kolide-k2.service,0755',
        'osqueryi,/usr/bin/osqueryd,0,user.slice,user-1000.slice,0755',
        'ostree,/usr/bin/ostree,0,system.slice,ostree-finalize-staged-hold.service,0755',
        'packagekitd,/usr/libexec/packagekitd,0,system.slice,packagekit.service,0755',
        'pacman,/usr/bin/pacman,0,user.slice,user-1000.slice,0755',
        'pcscd,/snap/yubioath-desktop/__VERSION__/usr/sbin/pcscd,0,system.slice,snap.yubioath-desktop.pcscd.service,0755',
        'pcscd,/usr/sbin/pcscd,0,system.slice,pcscd.service,0755',
        'perl,/nix/store/__VERSION__/bin/perl,0,system.slice,znapzend.service,0555',
        'pmdakvm,/usr/libexec/pcp/pmdas/kvm/pmdakvm,0,system.slice,pmcd.service,0755',
        'pmdalinux,/usr/libexec/pcp/pmdas/linux/pmdalinux,0,system.slice,pmcd.service,0755',
        'pmdaproc,/usr/libexec/pcp/pmdas/proc/pmdaproc,0,system.slice,pmcd.service,0755',
        'pmdaroot,/usr/libexec/pcp/pmdas/root/pmdaroot,0,system.slice,pmcd.service,0755',
        'pmdaxfs,/usr/libexec/pcp/pmdas/xfs/pmdaxfs,0,system.slice,pmcd.service,0755',
        'polkitd,/usr/libexec/polkitd,0,system.slice,polkit.service,0755',
        'power-profiles-,/usr/lib/power-profiles-daemon,0,system.slice,power-profiles-daemon.service,0755',
        'power-profiles-,/usr/libexec/power-profiles-daemon,0,system.slice,power-profiles-daemon.service,0755',
        'pwrstatd,/usr/sbin/pwrstatd,0,system.slice,pwrstatd.service,0700',
        'python3,/usr/bin/python__VERSION__,0,system.slice,ubuntu-advantage.service,0755',
        'qualys-cloud-ag,/usr/local/qualys/cloud-agent/bin/qualys-cloud-agent,0,system.slice,qualys-cloud-agent.service,0700',
        'rapid7_endpoint,/opt/rapid7/ir_agent/components/endpoint_broker/__VERSION__/rapid7_endpoint_broker,0,system.slice,ir_agent.service,0744',
        'rsyslogd,/usr/sbin/rsyslogd,0,system.slice,rsyslog.service,0755',
        'runc,/usr/bin/runc,0,system.slice,docker.service,0755',
        'scdaemon,/usr/libexec/scdaemon,0,system.slice,packagekit.service,0755',
        'scdaemon,/usr/libexec/scdaemon,0,user.slice,user-1000.slice,0755',
        'sddm,/usr/bin/sddm,0,system.slice,sddm.service,0755',
        'sddm-helper,/usr/lib/sddm/sddm-helper,0,user.slice,user-1000.slice,0755',
        'sddm-helper,/usr/lib/x86_64-linux-gnu/sddm/sddm-helper,0,user.slice,user-1000.slice,0755',
        'sddm-helper,/usr/libexec/sddm-helper,0,user.slice,user-1000.slice,0755',
        'sedispatch,/usr/sbin/sedispatch,0,system.slice,auditd.service,0755',
        'sh,/nix/store/__VERSION__/bin/bash,0,system.slice,znapzend.service,0555',
        'smartd,/usr/sbin/smartd,0,system.slice,smartd.service,0755',
        'smartd,/usr/sbin/smartd,0,system.slice,smartmontools.service,0755',
        'snapd,/snap/snapd/__VERSION__/usr/lib/snapd/snapd,0,system.slice,snapd.service,0755',
        'snapd,/usr/lib/snapd/snapd,0,system.slice,snapd.service,0755',
        'snapd,/usr/libexec/snapd/snapd,0,system.slice,snapd.service,0755',
        'ssh,/nix/store/__VERSION__/bin/ssh,0,system.slice,znapzend.service,0555',
        'sshd,/nix/store/__VERSION__/bin/sshd,0,system.slice,sshd.service,0555',
        'sshd,/nix/store/__VERSION__/bin/sshd,0,user.slice,user-1000.slice,0555',
        'sshd,/usr/bin/sshd,0,system.slice,sshd.service,0755',
        'sshd,/usr/bin/sshd,0,user.slice,user-1000.slice,0755',
        'sshd,/usr/sbin/sshd,0,system.slice,ssh.service,0755',
        'sshd,/usr/sbin/sshd,0,system.slice,sshd.service,0755',
        'sshd,/usr/sbin/sshd,0,user.slice,user-1000.slice,0755',
        'sshd,/usr/sbin/sshd,0,user.slice,user-501.slice,0755',
        'sssd_kcm,/usr/libexec/sssd/sssd_kcm,0,system.slice,sssd-kcm.service,0755',
        'su,/usr/bin/su,0,user.slice,user-1000.slice,4755',
        'sudo,/usr/bin/sudo,1000,user.slice,user-1000.slice,4111',
        'sudo,/usr/bin/sudo,1000,user.slice,user-1000.slice,4755',
        'supergfxd,/usr/bin/supergfxd,0,system.slice,supergfxd.service,0755',
        'switcheroo-cont,/usr/libexec/switcheroo-control,0,system.slice,switcheroo-control.service,0755',
        'systemd,/usr/lib/systemd/systemd,0,user.slice,user-0.slice,0755',
        'systemd-coredum,/nix/store/__VERSION__/lib/systemd/systemd-coredump,0,,,0555',
        'systemd-homed,/usr/lib/systemd/systemd-homed,0,system.slice,systemd-homed.service,0755',
        'systemd-hostnam,/usr/lib/systemd/systemd-hostnamed,0,system.slice,systemd-hostnamed.service,0755',
        'systemd-journal,/nix/store/__VERSION__/lib/systemd/systemd-journald,0,system.slice,systemd-journald.service,0555',
        'systemd-journal,/usr/lib/systemd/systemd-journald,0,system.slice,systemd-journald.service,0755',
        'systemd-localed,/usr/lib/systemd/systemd-localed,0,system.slice,systemd-localed.service,0755',
        'systemd-logind,/nix/store/__VERSION__/lib/systemd/systemd-logind,0,system.slice,systemd-logind.service,0555',
        'systemd-logind,/usr/lib/systemd/systemd-logind,0,system.slice,systemd-logind.service,0755',
        'systemd-machine,/usr/lib/systemd/systemd-machined,0,system.slice,systemd-machined.service,0755',
        'systemd-sleep,/usr/lib/systemd/systemd-sleep,0,system.slice,systemd-suspend.service,0755',
        'systemd-udevd,/nix/store/__VERSION__/bin/udevadm,0,system.slice,systemd-udevd.service,0555',
        'systemd-udevd,/usr/bin/udevadm,0,system.slice,systemd-udevd.service,0755',
        'systemd-userdbd,/usr/lib/systemd/systemd-userdbd,0,system.slice,systemd-userdbd.service,0755',
        'systemd-userwor,/usr/lib/systemd/systemd-userwork,0,system.slice,systemd-userdbd.service,0755',
        'tailscaled,/usr/bin/tailscaled,0,system.slice,tailscaled.service,0755',
        'tailscaled,/usr/sbin/tailscaled,0,system.slice,tailscaled.service,0755',
        'tcpdump,/usr/bin/tcpdump,0,user.slice,user-1000.slice,0755',
        'osqueryi,/var/usrlocal/bin/osqueryi,0,user.slice,user-1000.slice,0755',
        'thermald,/usr/sbin/thermald,0,system.slice,thermald.service,0755',
        'tuned,/usr/bin/python3.12,0,system.slice,tuned.service,0755',
        'udisksd,/nix/store/__VERSION__/libexec/udisks2/udisksd,0,system.slice,udisks2.service,0555',
        'udisksd,/usr/lib/udisks2/udisksd,0,system.slice,udisks2.service,0755',
        'udisksd,/usr/libexec/udisks2/udisksd,0,system.slice,udisks2.service,0755',
        'unattended-upgr,/usr/bin/python3.10,0,system.slice,unattended-upgrades.service,0755',
        'unattended-upgr,/usr/bin/python3.12,0,system.slice,unattended-upgrades.service,0755',
        'unattended-upgr,/usr/bin/python3.9,0,system.slice,unattended-upgrades.service,0755',
        'unattended-upgr,/usr/bin/python__VERSION__,0,system.slice,unattended-upgrades.service,0755',
        'upowerd,/usr/lib/upowerd,0,system.slice,upower.service,0755',
        'upowerd,/usr/libexec/upowerd,0,system.slice,upower.service,0755',
        'uresourced,/usr/libexec/uresourced,0,system.slice,uresourced.service,0755',
        'v4l2-relayd,/usr/bin/v4l2-relayd,0,system.slice,v4l2-relayd.service,0755',
        'velociraptor_cl,/usr/local/bin/velociraptor,0,system.slice,velociraptor_client.service,0700',
        'virtiofsd,/opt/incus/bin/virtiofsd,0,system.slice,incus.service,0755',
        'virtlogd,/usr/bin/virtlogd,0,system.slice,virtlogd.service,0755',
        'wpa_supplicant,/usr/bin/wpa_supplicant,0,system.slice,wpa_supplicant.service,0755',
        'wpa_supplicant,/usr/sbin/wpa_supplicant,0,system.slice,wpa_supplicant.service,0755',
        'xdg-desktop-por,/usr/libexec/xdg-desktop-portal,0,user.slice,user-1000.slice,0755',
        'xdg-desktop-por,/usr/libexec/xdg-desktop-portal-gnome,0,user.slice,user-1000.slice,0755',
        'xdg-desktop-por,/usr/libexec/xdg-desktop-portal-gtk,0,user.slice,user-1000.slice,0755',
        'xdg-document-po,/usr/libexec/xdg-document-portal,0,user.slice,user-1000.slice,0755',
        'xdg-permission-,/usr/libexec/xdg-permission-store,0,user.slice,user-1000.slice,0755',
        'yum,/usr/bin/python__VERSION__,0,user.slice,user-1000.slice,0755',
        'zed,/nix/store/__VERSION__/bin/zed,0,system.slice,zfs-zed.service,0555',
        'zed,/usr/sbin/zed,0,system.slice,zfs-zed.service,0755',
        'zfs,/nix/store/__VERSION__/bin/zfs,0,system.slice,zfs-snapshot-frequent.service,0555',
        'zfs,/nix/store/__VERSION__/bin/zfs,0,system.slice,zfs-snapshot-hourly.service,0555',
        'zfs,/nix/store/__VERSION__/bin/zfs,0,system.slice,znapzend.service,0555',
        'zfs-auto-snapsh,/nix/store/__VERSION__/bin/ruby,0,system.slice,zfs-snapshot-frequent.service,0555',
        'zfs-auto-snapsh,/nix/store/__VERSION__/bin/ruby,0,system.slice,zfs-snapshot-hourly.service,0555'
      )
      AND NOT exception_key LIKE '%beat,%/opt/Elastic/Agent/data/elastic-%/components/%beat,0,system.slice,elastic-agent.service,%'
      AND NOT exception_key LIKE 'abrt-dbus,/usr/sbin/abrt-dbus,0,system.slice,system-dbus%org.freedesktop.problems.slice,%'
      AND NOT exception_key LIKE 'elastic-agent,%/opt/Elastic/Agent/data/elastic-agent%/elastic-agent,0,system.slice,elastic-agent.service,%'
      AND NOT exception_key LIKE 'fusermount3,/usr/bin/fusermount3,%,user.slice,user-%.slice,4755'
      AND NOT exception_key LIKE 'incusd,%/bin/incusd,0,lxc.monitor.%,,0755'
      AND NOT exception_key LIKE 'osquery-extensi,/opt/Elastic/Agent/data/elastic-agent-%/components/osquery-extension.ext,0,system.slice,elastic-agent.service,0750'
      AND NOT exception_key LIKE 'osqueryd,/opt/Elastic/Agent/data/elastic-agent-%/components/osqueryd,0,system.slice,elastic-agent.service,0750'
      AND NOT p0.path IN ('/bin/bash', '/usr/bin/bash')
      AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
    GROUP BY
      p0.pid
  tags: persistent, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Unexpected long-running processes running as root
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - unexpected-uid0-daemon-macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Unexpected long-running processes running as root
    --
    -- false positives:
    --   * new software requiring escalated privileges
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/
    --
    -- tags: persistent process state
    -- platform: darwin
    SELECT
      s.authority AS p0_auth,
      s.identifier AS p0_id,
      DATETIME(f.ctime, 'unixepoch') AS p0_changed,
      DATETIME(f.mtime, 'unixepoch') AS p0_modified,
      (strftime('%s', 'now') - p0.start_time) AS p0_runtime_s,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE -- Focus on longer-running programs
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          euid = 0
          AND start_time < (strftime('%s', 'now') - 900)
          AND parent != 0 -- Assume STP
          AND path NOT IN (
            '/Applications/Foxit PDF Reader.app/Contents/MacOS/FoxitPDFReaderUpdateService.app/Contents/MacOS/FoxitPDFReaderUpdateService',
            '/Applications/OneDrive.app/Contents/StandaloneUpdaterDaemon.xpc/Contents/MacOS/StandaloneUpdaterDaemon',
            '/Applications/Opal.app/Contents/Library/LaunchServices/com.opalcamera.cameraExtensionShim',
            '/Applications/Parallels Desktop.app/Contents/MacOS/Parallels Service.app/Contents/MacOS/prl_disp_service',
            '/Applications/Parallels Desktop.app/Contents/MacOS/prl_naptd',
            '/Applications/VMware Fusion.app/Contents/Library/vmware-vmx',
            '/bin/bash',
            '/Library/Apple/System/Library/CoreServices/XProtect.app/Contents/MacOS/XProtect',
            '/Library/Apple/System/Library/CoreServices/XProtect.app/Contents/XPCServices/XProtectPluginService.xpc/Contents/MacOS/XProtectPluginService',
            '/Library/Application Support/Adobe/Adobe Desktop Common/ElevationManager/Adobe Installer',
            '/Library/Application Support/Fortinet/FortiClient/bin/fcconfig',
            '/Library/Application Support/Fortinet/FortiClient/bin/fctservctl',
            '/Library/Application Support/Objective Development/Little Snitch/Components/at.obdev.littlesnitch.daemon.bundle/Contents/MacOS/at.obdev.littlesnitch.daemon',
            '/Library/Application Support/Paragon Software/com.paragon-software.extfsd',
            '/Library/Application Support/Paragon Software/com.paragon-software.ntfsd',
            '/Library/Application Support/VMware/VMware Fusion/Services/Contents/Library/vmnet-bridge',
            '/Library/Application Support/VMware/VMware Fusion/Services/Contents/Library/vmnet-dhcpd',
            '/Library/Application Support/VMware/VMware Fusion/Services/Contents/Library/vmnet-natd',
            '/Library/Application Support/VMware/VMware Fusion/Services/Contents/Library/vmware-usbarbitrator',
            '/Library/Application Support/X-Rite/Frameworks/XRiteDevice.framework/Versions/B/Resources/xrdd',
            '/Library/Audio/Plug-Ins/HAL/SolsticeDesktopSpeakers.driver/Contents/XPCServices/RelayXpc.xpc/Contents/MacOS/RelayXpc',
            '/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Resources/Java Updater.app/Contents/MacOS/Java Updater',
            '/Library/Nessus/run/sbin/nessusd',
            '/Library/Nessus/run/sbin/nessus-service',
            '/Library/PrivilegedHelperTools/com.adobe.acc.installer.v2',
            '/Library/PrivilegedHelperTools/com.docker.vmnetd',
            '/Library/PrivilegedHelperTools/com.fortinet.forticlient.macos.PrivilegedHelper',
            '/Library/PrivilegedHelperTools/com.macpaw.CleanMyMac4.Agent',
            '/Library/PrivilegedHelperTools/keybase.Helper',
            '/Library/PrivilegedHelperTools/licenseDaemon.app/Contents/MacOS/licenseDaemon',
            '/Library/PrivilegedHelperTools/MHLinkServer.app/Contents/MacOS/MHLinkServer',
            '/Library/SystemExtensions/0FDB5206-860F-465C-B4D3-D6A0F43F4302/com.google.one.NetworkExtension.systemextension/Contents/MacOS/com.google.one.NetworkExtension',
            '/Library/SystemExtensions/2DA71D8A-7905-4012-A7D5-0B246D5AA77B/at.obdev.littlesnitch.networkextension.systemextension/Contents/MacOS/at.obdev.littlesnitch.networkextension',
            '/Library/SystemExtensions/4D1BF33A-9817-45D7-A242-8C39810C7F11/com.redcanary.agent.securityextension.systemextension/Contents/MacOS/com.redcanary.agent.securityextension',
            '/Library/SystemExtensions/CC9A335C-A6D0-4C87-B902-45EBDF4BFD85/com.google.one.NetworkExtension.systemextension/Contents/MacOS/com.google.one.NetworkExtension',
            '/opt/homebrew/Cellar/telepresence-arm64/2.7.6/bin/telepresence',
            '/opt/osquery/lib/osquery.app/Contents/MacOS/osqueryd',
            '/opt/socket_vmnet/bin/socket_vmnet',
            '/sbin/launchd',
            '/System/Library/CoreServices/backupd.bundle/Contents/Resources/backupd',
            '/System/Library/CoreServices/backupd.bundle/Contents/Resources/backupd-helper',
            '/System/Library/CoreServices/CrashReporterSupportHelper',
            '/System/Library/CoreServices/iconservicesagent',
            '/System/Library/CoreServices/launchservicesd',
            '/System/Library/CoreServices/logind',
            '/System/Library/CoreServices/loginwindow.app/Contents/MacOS/loginwindow',
            '/System/Library/CoreServices/osanalyticshelper',
            '/System/Library/CoreServices/powerd.bundle/powerd',
            '/System/Library/CoreServices/ReportCrash',
            '/System/Library/CoreServices/sharedfilelistd',
            '/System/Library/CoreServices/Software Update.app/Contents/Resources/suhelperd',
            '/System/Library/CoreServices/SubmitDiagInfo',
            '/System/Library/CryptoTokenKit/com.apple.ifdreader.slotd/Contents/MacOS/com.apple.ifdreader',
            '/System/Library/CryptoTokenKit/com.apple.ifdreader.slotd/Contents/XPCServices/com.apple.ifdbundle.xpc/Contents/MacOS/com.apple.ifdbundle',
            '/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/XPCServices/com.apple.hiservices-xpcservice.xpc/Contents/MacOS/com.apple.hiservices-xpcservice',
            '/System/Library/Frameworks/AudioToolbox.framework/AudioComponentRegistrar',
            '/System/Library/Frameworks/AudioToolbox.framework/XPCServices/CAReportingService.xpc/Contents/MacOS/CAReportingService',
            '/System/Library/Frameworks/AudioToolbox.framework/XPCServices/com.apple.audio.SandboxHelper.xpc/Contents/MacOS/com.apple.audio.SandboxHelper',
            '/System/Library/Frameworks/ColorSync.framework/Versions/A/XPCServices/com.apple.ColorSyncXPCAgent.xpc/Contents/MacOS/com.apple.ColorSyncXPCAgent',
            '/System/Library/Frameworks/CoreMediaIO.framework/Versions/A/Resources/com.apple.cmio.registerassistantservice',
            '/System/Library/Frameworks/CoreMediaIO.framework/Versions/A/Resources/iOSScreenCapture.plugin/Contents/Resources/iOSScreenCaptureAssistant',
            '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/Support/coreservicesd',
            '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/XPCServices/csnameddatad.xpc/Contents/MacOS/csnameddatad',
            '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/FSEvents.framework/Versions/A/Support/fseventsd',
            '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Support/mds',
            '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Support/mds_stores',
            '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Support/mdsync',
            '/System/Library/Frameworks/CryptoTokenKit.framework/ctkahp.bundle/Contents/MacOS/ctkahp',
            '/System/Library/Frameworks/GSS.framework/Helpers/GSSCred',
            '/System/Library/Frameworks/LocalAuthentication.framework/Support/coreauthd',
            '/System/Library/Frameworks/Metal.framework/Versions/A/XPCServices/MTLCompilerService.xpc/Contents/MacOS/MTLCompilerService',
            '/System/Library/Frameworks/NetFS.framework/Versions/A/XPCServices/PlugInLibraryService.xpc/Contents/MacOS/PlugInLibraryService',
            '/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/CVMServer',
            '/System/Library/Frameworks/PCSC.framework/Versions/A/XPCServices/com.apple.ctkpcscd.xpc/Contents/MacOS/com.apple.ctkpcscd',
            '/System/Library/Frameworks/PreferencePanes.framework/Versions/A/XPCServices/cacheAssistant.xpc/Contents/MacOS/cacheAssistant',
            '/System/Library/Frameworks/Security.framework/Versions/A/XPCServices/authd.xpc/Contents/MacOS/authd',
            '/System/Library/Frameworks/Security.framework/Versions/A/XPCServices/com.apple.CodeSigningHelper.xpc/Contents/MacOS/com.apple.CodeSigningHelper',
            '/System/Library/Frameworks/SystemExtensions.framework/Versions/A/Helpers/sysextd',
            '/System/Library/PrivateFrameworks/AccountPolicy.framework/XPCServices/com.apple.AccountPolicyHelper.xpc/Contents/MacOS/com.apple.AccountPolicyHelper',
            '/System/Library/PrivateFrameworks/AmbientDisplay.framework/Versions/A/XPCServices/com.apple.AmbientDisplayAgent.xpc/Contents/MacOS/com.apple.AmbientDisplayAgent',
            '/System/Library/PrivateFrameworks/AppleCredentialManager.framework/AppleCredentialManagerDaemon',
            '/System/Library/PrivateFrameworks/AppleNeuralEngine.framework/XPCServices/ANECompilerService.xpc/Contents/MacOS/ANECompilerService',
            '/System/Library/PrivateFrameworks/AppleNeuralEngine.framework/XPCServices/ANEStorageMaintainer.xpc/Contents/MacOS/ANEStorageMaintainer',
            '/System/Library/PrivateFrameworks/ApplePushService.framework/apsd',
            '/System/Library/PrivateFrameworks/AppSSO.framework/Support/AppSSODaemon',
            '/System/Library/PrivateFrameworks/AppStoreDaemon.framework/Versions/A/XPCServices/com.apple.AppStoreDaemon.StorePrivilegedTaskService.xpc/Contents/MacOS/com.apple.AppStoreDaemon.StorePrivilegedTaskService',
            '/System/Library/PrivateFrameworks/AssetCacheServicesExtensions.framework/Versions/A/XPCServices/AssetCacheManagerService.xpc/Contents/MacOS/AssetCacheManagerService',
            '/System/Library/PrivateFrameworks/AssetCacheServicesExtensions.framework/Versions/A/XPCServices/AssetCacheTetheratorService.xpc/Contents/MacOS/AssetCacheTetheratorService',
            '/System/Library/PrivateFrameworks/AuthKit.framework/Versions/A/Support/akd',
            '/System/Library/PrivateFrameworks/BackgroundTaskManagement.framework/Versions/A/Resources/backgroundtaskmanagementd',
            '/System/Library/PrivateFrameworks/BridgeOSInstallReporting.framework/Versions/A/Resources/bosreporter',
            '/System/Library/PrivateFrameworks/CacheDelete.framework/deleted_helper',
            '/System/Library/PrivateFrameworks/CloudKitDaemon.framework/Support/cloudd',
            '/System/Library/PrivateFrameworks/CoreAccessories.framework/Support/accessoryd',
            '/System/Library/PrivateFrameworks/CoreDuetContext.framework/Versions/A/Resources/contextstored',
            '/System/Library/PrivateFrameworks/CoreKDL.framework/Support/corekdld',
            '/System/Library/PrivateFrameworks/CoreSymbolication.framework/coresymbolicationd',
            '/System/Library/PrivateFrameworks/FamilyControls.framework/Versions/A/Resources/parentalcontrolsd',
            '/System/Library/PrivateFrameworks/FindMyMac.framework/Versions/A/Resources/FindMyMacd',
            '/System/Library/PrivateFrameworks/GenerationalStorage.framework/Versions/A/Support/revisiond',
            '/System/Library/PrivateFrameworks/GeoServices.framework/Versions/A/XPCServices/com.apple.geod.xpc/Contents/MacOS/com.apple.geod',
            '/System/Library/PrivateFrameworks/Heimdal.framework/Helpers/kdc',
            '/System/Library/PrivateFrameworks/InstallerDiagnostics.framework/Versions/A/Resources/installerdiagd',
            '/System/Library/PrivateFrameworks/InstallerDiagnostics.framework/Versions/A/Resources/installerdiagwatcher',
            '/System/Library/PrivateFrameworks/MediaRemote.framework/Support/mediaremoted',
            '/System/Library/PrivateFrameworks/MobileInstallation.framework/XPCServices/com.apple.MobileInstallationHelperService.xpc/Contents/MacOS/com.apple.MobileInstallationHelperService',
            '/System/Library/PrivateFrameworks/MobileSoftwareUpdate.framework/Versions/A/XPCServices/com.apple.MobileSoftwareUpdate.CleanupPreparePathService.xpc/Contents/MacOS/com.apple.MobileSoftwareUpdate.CleanupPreparePathService',
            '/System/Library/PrivateFrameworks/Noticeboard.framework/Versions/A/Resources/nbstated',
            '/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/Resources/installd',
            '/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/Resources/system_installd',
            '/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/XPCServices/package_script_service.xpc/Contents/MacOS/package_script_service',
            '/System/Library/PrivateFrameworks/SiriInference.framework/Support/siriinferenced',
            '/System/Library/PrivateFrameworks/SkyLight.framework/Versions/A/Resources/WindowServer',
            '/System/Library/PrivateFrameworks/StorageKit.framework/Versions/A/Resources/storagekitd',
            '/System/Library/PrivateFrameworks/SystemAdministration.framework/XPCServices/writeconfig.xpc/Contents/MacOS/writeconfig',
            '/System/Library/PrivateFrameworks/SystemMigration.framework/Versions/A/Resources/systemmigrationd',
            '/System/Library/PrivateFrameworks/SystemStatusServer.framework/Support/systemstatusd',
            '/System/Library/PrivateFrameworks/TCC.framework/Support/tccd',
            '/System/Library/PrivateFrameworks/Uninstall.framework/Versions/A/Resources/uninstalld',
            '/System/Library/PrivateFrameworks/ViewBridge.framework/Versions/A/XPCServices/ViewBridgeAuxiliary.xpc/Contents/MacOS/ViewBridgeAuxiliary',
            '/System/Library/PrivateFrameworks/WiFiPolicy.framework/XPCServices/WiFiCloudAssetsXPCService.xpc/Contents/MacOS/WiFiCloudAssetsXPCService',
            '/System/Library/PrivateFrameworks/WirelessDiagnostics.framework/Support/awdd',
            '/System/Library/PrivateFrameworks/XprotectFramework.framework/Versions/A/XPCServices/XProtectBehaviorService.xpc/Contents/MacOS/XProtectBehaviorService',
            '/System/Library/PrivateFrameworks/XprotectFramework.framework/Versions/A/XPCServices/XprotectService.xpc/Contents/MacOS/XprotectService',
            '/usr/bin/login',
            '/usr/bin/sudo',
            '/usr/bin/sysdiagnose',
            '/usr/libexec/AirPlayXPCHelper',
            '/usr/libexec/airportd',
            '/usr/libexec/amfid',
            '/usr/libexec/aned',
            '/usr/libexec/apfsd',
            '/usr/libexec/applessdstatistics',
            '/usr/libexec/ApplicationFirewall/socketfilterfw',
            '/usr/libexec/ASPCarryLog',
            '/usr/libexec/autofsd',
            '/usr/libexec/automountd',
            '/usr/libexec/batteryintelligenced',
            '/usr/libexec/biokitaggdd',
            '/usr/libexec/biometrickitd',
            '/usr/libexec/bootinstalld',
            '/usr/libexec/colorsyncd',
            '/usr/libexec/colorsync.displayservices',
            '/usr/libexec/configd',
            '/usr/libexec/containermanagerd',
            '/usr/libexec/corebrightnessd',
            '/usr/libexec/coreduetd',
            '/usr/libexec/corestoraged',
            '/usr/libexec/cryptexd',
            '/usr/libexec/dasd',
            '/usr/libexec/dirhelper',
            '/usr/libexec/diskarbitrationd',
            '/usr/libexec/diskmanagementd',
            '/usr/libexec/dprivacyd',
            '/usr/libexec/endpointsecurityd',
            '/usr/libexec/findmydeviced',
            '/usr/libexec/firmwarecheckers/ethcheck/ethcheck',
            '/usr/libexec/InternetSharing',
            '/usr/libexec/IOMFB_bics_daemon',
            '/usr/libexec/ioupsd',
            '/usr/libexec/kernelmanagerd',
            '/usr/libexec/keybagd',
            '/usr/libexec/logd',
            '/usr/libexec/logd_helper',
            '/usr/libexec/lsd',
            '/usr/libexec/mdmclient',
            '/usr/libexec/memoryanalyticsd',
            '/usr/libexec/microstackshot',
            '/usr/libexec/misagent',
            '/usr/libexec/mobileactivationd',
            '/usr/libexec/mobileassetd',
            '/usr/libexec/multiversed',
            '/usr/libexec/nehelper',
            '/usr/libexec/nesessionmanager',
            '/usr/libexec/online-authd',
            '/usr/libexec/opendirectoryd',
            '/usr/libexec/PerfPowerServices',
            '/usr/libexec/periodic-wrapper',
            '/usr/libexec/powerdatad',
            '/usr/libexec/PowerUIAgent',
            '/usr/libexec/remoted',
            '/usr/libexec/rtcreportingd',
            '/usr/libexec/runningboardd',
            '/usr/libexec/sandboxd',
            '/usr/libexec/searchpartyd',
            '/usr/libexec/secinitd',
            '/usr/libexec/securityd_service',
            '/usr/libexec/smd',
            '/usr/libexec/storagekitd',
            '/usr/libexec/symptomsd-diag',
            '/usr/libexec/sysmond',
            '/Library/Application Support/iStat Menus 7/com.bjango.istatmenus.daemon',
            '/usr/libexec/syspolicyd',
            '/usr/libexec/tailspind',
            '/usr/libexec/taskgated',
            '/usr/libexec/thermald',
            '/Applications/Tailscale.app/Contents/Frameworks/Sparkle.framework/Versions/B/Autoupdate',
            '/usr/libexec/thermalmonitord',
            '/usr/libexec/TouchBarServer',
            '/usr/libexec/trustdFileHelper',
            '/usr/libexec/tzd',
            '/usr/libexec/tzlinkd',
            '/usr/libexec/usbd',
            '/usr/libexec/UserEventAgent',
            '/usr/libexec/usermanagerd',
            '/usr/libexec/warmd',
            '/usr/libexec/watchdogd',
            '/usr/libexec/wifianalyticsd',
            '/usr/libexec/wifip2pd',
            '/usr/libexec/wifivelocityd',
            '/usr/local/bin/warsaw/core',
            '/usr/local/kolide-k2/bin/osquery-extension.ext',
            '/usr/local/sbin/velociraptor',
            '/usr/sbin/aslmanager',
            '/usr/sbin/audioclocksyncd',
            '/usr/sbin/auditd',
            '/usr/sbin/BlueTool',
            '/usr/sbin/bluetoothd',
            '/usr/sbin/BTLEServer',
            '/usr/sbin/cfprefsd',
            '/usr/sbin/distnoted',
            '/usr/sbin/filecoordinationd',
            '/usr/sbin/KernelEventAgent',
            '/usr/sbin/mDNSResponderHelper',
            '/usr/sbin/notifyd',
            '/usr/sbin/securityd',
            '/usr/sbin/spindump',
            '/usr/sbin/sshd',
            '/usr/sbin/syslogd',
            '/usr/sbin/systemsoundserverd',
            '/usr/sbin/systemstats',
            '/usr/sbin/WirelessRadioManagerd'
          )
          AND NOT path LIKE '/nix/store/%-nix-%/bin/nix'
          AND NOT path LIKE '/opt/homebrew/Cellar/btop/%/bin/btop'
          AND NOT path LIKE '/opt/homebrew/Cellar/htop/%/bin/htop'
          AND NOT path LIKE '/opt/homebrew/Cellar/mtr/%/sbin/%'
          AND NOT path LIKE '/opt/homebrew/Cellar/socket_vmnet/%/bin/socket_vmnet'
          AND NOT path LIKE '/usr/local/Cellar/btop/%/bin/btop'
          AND NOT path LIKE '/usr/local/Cellar/htop/%/bin/htop'
          AND NOT path LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/Kolide.app/Contents/MacOS/launcher'
          AND NOT path LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
        GROUP BY
          path
      )
      AND NOT s.authority IN (
        'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',
        'Developer ID Application: Bjango Pty Ltd (Y93TK974AT)',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59)',
        'Developer ID Application: Cloudflare Inc. (68WVV388M8)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Creative Labs Pte. Ltd. (5Q3552844F)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: Ecamm Network, LLC (5EJH68M642)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK)',
        'Developer ID Application: Foxit Corporation (8GN47HTP75)',
        'Developer ID Application: Fumihiko Takayama (G43BCU2T37)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Ilya Parniuk (ACC5R6RH47)',
        'Developer ID Application: Kandji, Inc. (P3FGV63VK7)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: Kolide, Inc (X98UFR7HA3)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: MacPaw Inc. (S8EX82NJP6)',
        'Developer ID Application: Mersive Technologies (63B5A5WDNG)',
        'Developer ID Application: Metric Halo Distribution, Inc. (X7EY8SFM86)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Mullvad VPN AB (CKG9MXH72F)',
        'Developer ID Application: Nordvpn S.A. (W5W395V82Y)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: OPENVPN TECHNOLOGIES, INC. (ACV7L3WCD8)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: Parallels International GmbH (4C6364ACXT)',
        'Developer ID Application: Private Internet Access, Inc. (5357M5NW9W)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Ryan Hanson (XSYZ3E4B7D)',
        'Developer ID Application: Slack Technologies, Inc. (BQR82RBBHL)',
        'Developer ID Application: Tailscale Inc. (W5364U7YZB)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Developer ID Application: X-Rite, Incorporated (2K7GT73B4R)',
        'Developer ID Application: Y Soft Corporation, a.s. (3CPED8WGS9)',
        'Software Signing'
      )
      AND NOT (
        p0.path = '/Library/Printers/DYMO/Utilities/pnpd'
        AND s.identifier = 'pnpd'
        AND s.authority = 'Developer ID Application: Sanford, L.P. (N3S6676K3E)'
      )
    GROUP BY
      p0.path
  tags: persistent, process, state
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Linux program uses LibTomCrypt (rare)
  discard_data: false
  interval: 3600
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - yara-libtomcrypt-process
  observer_can_run: false
  platforms: posix
  query: |
    -- Linux program uses LibTomCrypt (rare)
    --
    -- reference:
    --   * https://www.deepinstinct.com/blog/bpfdoor-malware-evolves-stealthy-sniffing-backdoor-ups-its-game
    --
    -- tags: persistent
    -- interval: 3600
    -- platform: posix
    SELECT
      yara.strings,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN yara ON p0.path = yara.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > (strftime('%s', 'now') - 3600)
          AND path != ""
        GROUP BY
          path
      )
      AND yara.sigrule = '
          rule redflags {
          strings:
              $libtomcrypt = "LibTomCrypt"
              $email = "tomstdenis@gmail.com"
          condition:
              filesize < 10MB and 1 of them
      }'
      AND yara.count > 0
  tags: persistent
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Currently running program with Linux red flags
  discard_data: false
  interval: 7200
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - persistence - yara-suspicious-strings-process-linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Currently running program with Linux red flags
    --
    -- reference:
    --   * https://github.com/timb-machine/linux-malware/blob/725aad34e216cc024c93b04964b289f10f819e6e/defensive/yara/personal-malware-bazaar/unixredflags3.yara
    --
    -- tags: persistent extra
    -- interval: 7200
    -- platform: linux
    SELECT
      yara.strings,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN yara ON p0.path = yara.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > (strftime('%s', 'now') - 7200)
          AND path != ""
        GROUP BY
          path
      )
      AND yara.sigrule = '
        rule redflags {
        strings:
            $bash_history = ".bash_history"
            $google_chrome = "google-chrome"
            $cron = "cron"
            $dev_shm = "/dev/shm"
            $dev_tcp = "/dev/tcp"
            $dev_udp = "/dev/udp"
            $iptables = "iptables"
            $ld_so = "ld.so.conf"
            $proc = "/proc"
            $sudo = "sudo"
            $systemctl = "systemctl"
            $useradd = "useradd"
            $var_tmp = "/var/tmp"
            $var_run = "/var/run"
            $dev_mqueue = "/dev/mqueue"
            $bin_sh = "/bin/sh"
            $pickup = "pickup -l"
            $avahi = "avahi-daemon:"
            $redhat4 = "Red Hat 4"
        condition:
            filesize < 25MB and 5 of them
    }'
      AND yara.count > 0
      AND p0.name NOT IN (
        'chrome_crashpad',
        'X',
        'emacs',
        'git',
        'systemd',
        'NetworkManager',
        'systemd-journal',
        'Xorg',
        'slirp4netns',
        'nacl_helper'
      )
      AND p0.path NOT LIKE '%/google/chrome/%'
      AND p0.path NOT LIKE '%/chrome_crashpad_handler'
      AND p0.path NOT LIKE '/nix/store/%/bin/%'
      AND p0.path NOT LIKE '/nix/store/%/libexec/%'
      AND p0.path NOT LIKE '/usr/local/aws-cli/%/aws'
      AND p0.path NOT LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/launcher'
      AND p0.path NOT IN (
        '/bin/bash',
        '/bin/containerd-shim-runc-v2',
        '/bin/fish',
        '/bin/dash',
        '/bin/sh',
        '/usr/bin/bash',
        '/usr/lib/snapd/snapd',
        '/usr/bin/snap',
        '/usr/bin/containerd-shim-runc-v2',
        '/usr/bin/docker-proxy',
        '/usr/bin/fish',
        '/usr/bin/docker',
        '/usr/bin/gnome-software',
        '/usr/bin/gpg-agent',
        '/usr/bin/ibus-daemon',
        '/usr/bin/make',
        '/usr/bin/NetworkManager',
        '/usr/bin/nvidia-persistenced',
        '/usr/bin/nvim',
        '/opt/Elastic/Endpoint/elastic-endpoint',
        '/usr/bin/pulseaudio',
        '/usr/bin/sshd',
        '/usr/bin/sudo',
        '/usr/bin/udevadm',
        '/usr/bin/update-notifier',
        '/usr/bin/Xwayland',
        '/usr/lib/bluetooth/bluetoothd',
        '/usr/lib/bluetooth/obexd',
        '/usr/libexec/accounts-daemon',
        '/usr/libexec/bluetooth/bluetoothd',
        '/usr/libexec/bluetooth/obexd',
        '/usr/libexec/flatpak-system-helper',
        '/usr/libexec/sssd/sssd_kcm',
        '/usr/libexec/xdg-desktop-portal',
        '/usr/lib/systemd/systemd',
        '/usr/lib/systemd/systemd-journald',
        '/usr/lib/systemd/systemd-machined',
        '/usr/local/bin/rootlesskit',
        '/usr/local/kolide-k2/bin/launcher',
        '/usr/sbin/acpid',
        '/usr/sbin/auditd',
        '/usr/sbin/cron',
        '/usr/sbin/crond',
        '/usr/sbin/gdm',
        '/usr/sbin/gssproxy',
        '/usr/sbin/mcelog',
        '/usr/sbin/NetworkManager',
        '/usr/sbin/rsyslogd',
        '/usr/sbin/smartd'
      )
  tags: persistent, extra
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Detect the execution of a Docker containing mounting the root filesystem
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - privesc - docker-container-mounting-root
  observer_can_run: false
  platforms: linux
  query: |
    -- Detect the execution of a Docker containing mounting the root filesystem
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1611/
    --   * https://github.com/liamg/traitor/blob/main/pkg/exploits/dockersock/exploit.go
    --
    -- This attack is very quick, so the likelihood of finding a culprit is entirely
    -- dependent on the polling time.
    --
    -- platform: linux
    -- tags: transient container escalation
    SELECT
      command,
      image_id,
      path,
      source,
      destination,
      security_options,
      started_at,
      image
    FROM
      docker_container_mounts AS dcm
      LEFT JOIN docker_containers dc ON dcm.id = dc.id
    WHERE
      dcm.source = "/"
  tags: transient, container, escalation
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find setuid events with large cmdlines
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - privesc - setxid-cmdline-overflow-attempt
  observer_can_run: false
  platforms: posix
  query: |
    -- Find setuid events with large cmdlines
    --
    -- platform: posix
    -- interval: 300
    SELECT
      file.mode AS p0_binary_mode,
      pe.cmdline_size AS p0_cmd_size,
      pe.time AS p0_time,
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN file ON pe.path = file.path
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -300)
      AND file.mode NOT LIKE '0%'
      AND pe.cmdline_size > 2048
      AND p0_cmd NOT LIKE '%sudo dpkg %'
      AND p0_cmd NOT LIKE '%sudo %--vmodule=% --audit-policy-file=%kube%'
  tags: ''
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find setuid process events with large environment sizes
  discard_data: false
  interval: 60
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - privesc - setxid-env-overflow-attempt
  observer_can_run: false
  platforms: posix
  query: |
    -- Find setuid process events with large environment sizes
    --
    -- ******************************************************************
    -- NOTE: This is a rare case of a non-working query. It does not work
    -- in my environment (osquery 5.5.1 running with Kolide) as
    -- process_events.env_size is NULL. I believe this to be a bug, but
    -- requires more investigation.
    -- ******************************************************************
    --
    -- tags: events process escalation disabled seldom
    -- platform: posix
    --
    -- Uncomment once the underlying problem is addressed:
    -- interval: 60
    SELECT
      file.mode AS p0_binary_mode,
      pe.env AS p0_env,
      pe.time AS p0_time,
      pe.env_size AS p0_env_size,
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.euid AS p0_euid,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN file ON pe.path = file.path
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -60)
      AND file.mode NOT LIKE '0%'
      AND pe.env_size > 3500
  tags: events, process, escalation, disabled, seldom
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Detect the execution of a Docker containing mounting the root filesystem
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - privesc - sketchy-docker-image-creator
  observer_can_run: false
  platforms: linux
  query: |
    -- Detect the execution of a Docker containing mounting the root filesystem
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1611/
    --   * https://github.com/liamg/traitor/blob/main/pkg/exploits/dockersock/exploit.go
    --
    -- This attack is very quick, so the likelihood of finding a culprit is entirely
    -- dependent on the polling time. The number of "tags" you see associated to an image
    -- may reflect the number of times the attack has been attempted.
    --
    -- platform: linux
    -- tags: transient
    SELECT
      *
    FROM
      docker_image_history
    WHERE
      created > (strftime('%s', 'now') -86400)
      -- This signature is used by Traitor: https://github.com/liamg/traitor/
      AND created_by LIKE '%/bin/sh%/lol%';
  tags: transient
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find processes that run with a lower effective UID than their parent
    (event-based)
  discard_data: false
  interval: 600
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - privesc - unexpected-elevated-children-events_linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Find processes that run with a lower effective UID than their parent (event-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1548/001/ (Setuid and Setgid)
    --   * https://cybersecurity.att.com/blogs/labs-research/shikitega-new-stealthy-malware-targeting-linux
    --
    -- related:
    --   * unexpected-privilege-escalation.sql
    --
    -- False positives:
    --   * On some hosts this ocassionally gets the parenting relationship confused
    --
    -- tags: events process escalation disabled
    -- platform: linux
    -- interval: 600
    SELECT
      file.mode AS p0_binary_mode,
      -- Child
      pe.path AS p0_path,
      pe.time AS p0_time,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.uid AS p0_uid,
      pe.euid AS p0_euid,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p1.euid, pe1.euid) AS p1_euid,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN file ON pe.path = file.path
      LEFT JOIN processes p ON pe.pid = pe.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.pid IN (
        SELECT
          pid
        FROM
          process_events
        WHERE
          time > (strftime('%s', 'now') -600)
          AND syscall = "execve"
          AND euid < 500
          AND (
            uid = 0
            OR euid < uid
          )
      )
      AND pe.time > (strftime('%s', 'now') -600)
      AND pe.syscall = "execve"
      AND pe.euid < 500
      AND (
        pe.euid < pe.uid
        OR pe.euid < p1_euid
        OR pe.euid < pe1.euid
      )
      AND pe.path NOT IN (
        '/bin/ps',
        '/opt/1Password/1Password-KeyringHelper',
        '/usr/bin/doas',
        '/usr/bin/su',
        '/usr/bin/fusermount',
        '/usr/bin/fusermount3',
        '/usr/bin/gpg',
        '/usr/bin/gpgconf',
        '/usr/bin/gpgsm',
        '/usr/bin/i3lock',
        '/usr/bin/login',
        '/usr/bin/nvidia-modprobe',
        '/usr/bin/sudo',
        '/usr/bin/top',
        '/usr/bin/unix_chkpwd',
        '/usr/lib/slack/chrome-sandbox',
        '/usr/lib/snapd/snap-confine',
        '/usr/lib/snapd/snap-update-ns',
        '/usr/lib/systemd/systemd',
        '/usr/lib/Xorg.wrap',
        '/usr/lib/xorg/Xorg.wrap'
      )
      AND pe.path NOT LIKE '/nix/store/%/bin/sudo'
      AND pe.path NOT LIKE '/nix/store/%/bin/dhcpcd'
      AND pe.path NOT LIKE '/snap/snapd/%/usr/lib/snapd/snap-confine'
      AND pe.path NOT LIKE '/snap/snapd/%/usr/lib/snapd/snap-update-ns'
      AND NOT p1_cmd IN (
        '/usr/lib/systemd/systemd --user',
        '/bin/sh -c /usr/bin/pkexec /usr/share/apport/apport-gtk'
      )
      AND NOT p0_cmd = '/usr/bin/pkexec /usr/lib/update-notifier/package-system-locked'
      AND NOT (
        p0_name = 'polkit-agent-helper-1'
        AND p1_path IN (
          '/usr/bin/gnome-shell',
          '/usr/lib/gvfsd',
          '/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1'
        )
      )
      AND NOT (
        p0_name = 'fusermount3'
        AND p1_path = '/usr/lib/xdg-document-portal'
      )
      AND NOT (
        p0_name IN ('dash', 'pkexec')
        AND p1_path = '/usr/bin/update-notifier'
      ) -- A bizarro persistent false-positive from an Arch linux host
      AND NOT (
        p.cgroup_path = "/init.scope"
        AND p1.cgroup_path != "/init.scope"
      )
      AND NOT p.cgroup_path LIKE '/system.slice/docker-%'
      AND NOT p1.cgroup_path LIKE '/system.slice/docker-%'
    GROUP BY
      pe.pid
  tags: events, process, escalation, disabled
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find processes that run with a lower effective UID than their parent
    (event-based)
  discard_data: false
  interval: 300
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - privesc - unexpected-elevated-children-events_macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find processes that run with a lower effective UID than their parent (event-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1548/001/ (Setuid and Setgid)
    --   * https://cybersecurity.att.com/blogs/labs-research/shikitega-new-stealthy-malware-targeting-linux
    --
    -- related:
    --   * unexpected-privilege-escalation.sql
    --
    -- tags: events process escalation disabled
    -- platform: darwin
    -- interval: 300
    SELECT -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.uid AS p0_uid,
      pe.euid AS p0_euid,
      s.authority AS p0_authority,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p1.euid, pe1.euid) AS p1_euid,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      pe_sig1.authority AS p1_authority,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(
        p1_p2_sig.authority,
        pe1_p2_sig.authority,
        pe1_pe2_sig.authority
      ) AS p2_authority,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN signature s ON pe.path = s.path -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      AND p1.start_time <= pe.time
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.time <= pe.time
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid
      AND p1_p2.start_time <= p1.start_time
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid
      AND pe1_p2.start_time <= pe1.time
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      LEFT JOIN signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path
      LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path
      LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path
    WHERE
      pe.time > (strftime('%s', 'now') -300)
      AND p0_euid < p1_euid
      AND pe.status = 0
      AND pe.parent > 0
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND p1_path NOT IN (
        '/Applications/LogiTune.app/Contents/MacOS/LogiTune',
        '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Support/mdworker_shared',
        '/System/Library/PrivateFrameworks/AOSKit.framework/Versions/A/XPCServices/com.apple.iCloudHelper.xpc/Contents/MacOS/com.apple.iCloudHelper',
        '/Library/Apple/System/Library/CoreServices/XProtect.app/Contents/XPCServices/XProtectPluginService.xpc/Contents/MacOS/XProtectPluginService',
        '/usr/bin/login',
        '/usr/bin/su',
        '/usr/bin/sudo',
        '/usr/libexec/mdmclient',
        '/usr/libexec/PerfPowerServicesExtended',
        '/usr/local/bin/doas'
      ) -- Exclude weird bad data we've seen due to badly recorded macOS parent/child relationships, fixable by reboot
      AND NOT p0_cmd IN (
        '/usr/sbin/cupsd -l',
        '/usr/sbin/cfprefsd agent',
        '/usr/libexec/wifip2pd',
        '/System/Library/CoreServices/iconservicesd',
        '/System/Library/PrivateFrameworks/InstallCoordination.framework/Support/installcoordinationd',
        '/System/Library/PrivateFrameworks/CoreSymbolication.framework/coresymbolicationd',
        '/usr/libexec/PerfPowerServicesExtended',
        '/usr/libexec/mdmclient daemon',
        '/System/Library/Frameworks/CoreServices.framework/Frameworks/Metadata.framework/Versions/A/Support/mdworker_shared -s mdworker -c MDSImporterWorker -m com.apple.mdworker.shared'
      )
      AND NOT exception_key IN (
        'amfid,0,com.docker.backend,Docker',
        'biometrickitd,0,LogiTune,launchd',
        'bioutil,0,callservicesd,launchd',
        'com.apple.geod,0,fmfd,launchd',
        'trustd,205,trustd,launchd',
        'CAReportingService,0,LogiTune,launchd',
        'efilogin-helper,0,containermanagerd,launchd',
        'com.apple.AccountPolicyHelper,0,LogiTune,launchd',
        'com.apple.geod,262,com.docker.backend,Docker',
        'com.apple.WebKit.WebContent,200,zsh,Emacs-arm64-11',
        'containermanagerd,262,com.docker.backend,Docker',
        'dprivacyd,0,com.docker.backend,Docker',
        'SCHelper,0,com.docker.backend,Docker',
        'suhelperd,0,LogiTune,launchd',
        'sysextd,0,LogiTune,launchd',
        'system_profiler,0,callservicesd,launchd'
      )
      AND NOT (
        pe.euid = 262 -- core media helper id
        AND pe.path = '/System/Library/Frameworks/CoreMediaIO.framework/Versions/A/Resources/AppleCamera.plugin/Contents/Resources/AppleCameraAssistant'
      )
  tags: events, process, escalation, disabled
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find processes that run with a lower effective UID than their parent
    (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - privesc - unexpected-privilege-escalation_linux
  observer_can_run: false
  platforms: linux
  query: |
    -- Find processes that run with a lower effective UID than their parent (state-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1548/001/ (Setuid and Setgid)
    --   * https://cybersecurity.att.com/blogs/labs-research/shikitega-new-stealthy-malware-targeting-linux
    --
    -- related:
    --   * unexpected-privilege-escalation-events.sql
    --
    -- tags: transient state process escalation
    -- platform: linux
    SELECT
      p0.uid AS p0_uid,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          euid < uid
          AND NOT path IN (
            '/bin/ps',
            '/opt/1Password/1password',
            '/usr/bin/doas',
            '/usr/bin/fusermount',
            '/usr/bin/fusermount3',
            '/usr/bin/newgrp',
            '/usr/bin/login',
            '/usr/bin/su',
            '/usr/bin/sudo',
            '/usr/bin/top',
            '/usr/libexec/Xorg',
            '/usr/lib/xorg/Xorg'
          ) -- doas may be in the process of being upgraded
          AND NOT path LIKE '/nix/store/%/bin/sudo'
          AND NOT path LIKE '/nix/store/%/bin/dhcpcd'
          AND NOT path LIKE '/snap/snapd/%/usr/lib/snapd/snap-confine'
          AND NOT name IN ('doas', 'sudo')
      )
      AND NOT (
        p0.cmdline LIKE '%pacman%'
        AND p1.cmdline LIKE 'yay%'
      )
      AND NOT (
        p0.name = 'polkit-agent-he'
        AND p1.path = '/usr/bin/gnome-shell'
      )
      AND NOT (
        p0.name = 'fusermount3'
        AND p1.path = '/usr/lib/xdg-document-portal'
      )
      AND NOT (
        p0.path = '/usr/bin/pkexec'
        AND p1.path = '/usr/bin/update-notifier'
      )
      AND NOT (
        p0.path = '/usr/libexec/xdg-permission-store'
        AND p1.path = '/usr/lib/systemd/systemd'
      )
  tags: transient, state, process, escalation
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Find processes that run with a lower effective UID than their parent
    (state-based)
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - privesc - unexpected-privilege-escalation_macos
  observer_can_run: false
  platforms: darwin
  query: |
    -- Find processes that run with a lower effective UID than their parent (state-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1548/001/ (Setuid and Setgid)
    --   * https://cybersecurity.att.com/blogs/labs-research/shikitega-new-stealthy-malware-targeting-linux
    --
    -- related:
    --   * unexpected-privilege-escalation-events.sql
    --
    -- tags: transient state process escalation
    -- platform: darwin
    SELECT
      s.authority AS p0_auth,
      s.identifier AS p0_id,
      p0.uid AS p0_uid,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.euid < p0.uid
      AND p0.path NOT IN (
        '',
        '/bin/ps',
        '/Applications/Parallels Desktop.app/Contents/MacOS/Parallels Service',
        '/Library/Application Support/org.pqrs/Karabiner-Elements/bin/karabiner_session_monitor',
        '/Library/DropboxHelperTools/Dropbox_u501/dbkextd',
        '/usr/bin/login',
        '/usr/bin/su',
        '/usr/bin/sudo',
        '/usr/bin/top',
        '/usr/local/bin/doas',
        '/Applications/VMware Fusion.app/Contents/Library/vmware-vmx'
      )
      AND NOT (
        p0.path LIKE '/var/folders/%/T/CanonOFI_TEMP/Data/Software/Install/UniversalInstaller.app/Contents/Frameworks/UIx.framework/Resources/relay'
        AND s.authority = 'Developer ID Application: Canon Inc. (XE2XNRRXZ5)'
      )
  tags: transient, state, process, escalation
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Detect the execution of privileged Docker containers which can be used
    to escape to the host.
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - privesc - unexpected-privileged-containers
  observer_can_run: false
  platforms: linux
  query: |
    -- Detect the execution of privileged Docker containers which can be used to escape to the host.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1611/
    --
    -- false-positives:
    --   * Nested Kubernetes Environments
    --   * Containerized builds
    --
    -- This query works on macOS as well, but is only an in-the-wild security problem on Linux,
    -- where the kernel namespaces can be shared. These kind of attacks tend to be
    --
    -- platform: linux
    -- tags: transient state container escalation
    SELECT
      command,
      image_id,
      path,
      security_options,
      started_at,
      image,
      COALESCE(REGEX_MATCH (image, '(.*?):', 1), image) AS image_name
    FROM
      docker_containers
    WHERE
      privileged = 1
      AND image_name NOT IN (
        'cgr.dev/chainguard-private/python',
        'cgr.dev/chainguard/apko',
        'cgr.dev/chainguard/k3s',
        'cgr.dev/chainguard/melange',
        'cgr.dev/chainguard/python',
        'cgr.dev/chainguard/sdk',
        'cgr.dev/chainguard/wolfi-base',
        'distroless.dev/melange',
        'docker.io/library/registry',
        'docker.io/rancher/k3s',
        'gcr.io/k8s-minikube/kicbase',
        'ghcr.io/wolfi-dev/sdk',
        'ghcr.io/wolfi-dev/sdk@sha256',
        'kindest/node',
        'ligfx/k3d-registry-dockerd',
        'moby/buildkit',
        'wolfi'
      )
      AND image NOT LIKE 'ghcr.io/k3d-io/k3d-%'
      AND image NOT LIKE 'ghcr.io/wolfi-dev/%'
      AND image NOT LIKE 'melange-%'
      AND image NOT LIKE 'k3d-k3d.localhost:%'
      AND command NOT LIKE '/usr/bin/melange build %'
  tags: transient, state, container, escalation
  team: ''
---
apiVersion: v1
kind: query
spec:
  automations_enabled: false
  description: Processes running that originate from setuid/setgid programs
  discard_data: false
  interval: '0'
  logging: snapshot
  min_osquery_version: 5.7.0
  name: chainguard - privesc - unexpected-setxid-process
  observer_can_run: false
  platforms: posix
  query: |
    -- Processes running that originate from setuid/setgid programs
    --
    -- false-positives:
    --   * an unlisted setuid binary
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1548/001/ (Setuid and Setgid)
    --
    -- tags: persistent state process escalation
    -- platform: posix
    SELECT
      p.pid,
      p.name,
      p.path,
      p.cmdline,
      f.ctime,
      p.cwd,
      p.uid,
      f.mode,
      hash.sha256
    FROM
      processes p
      JOIN file f ON p.path = f.path
      JOIN hash ON p.path = hash.path
    WHERE
      f.mode NOT LIKE '0%'
      AND f.path NOT IN (
        '/Applications/Parallels Desktop.app/Contents/MacOS/Parallels Service',
        '/Applications/VMware Fusion.app/Contents/Library/vmware-vmx',
        '/bin/ps',
        '/Library/Application Support/org.pqrs/Karabiner-Elements/bin/karabiner_session_monitor',
        '/Library/DropboxHelperTools/Dropbox_u501/dbkextd',
        '/opt/1Password/1Password-BrowserSupport',
        '/usr/lib/opt/1Password/1Password-BrowserSupport',
        '/opt/1Password/1Password-KeyringHelper',
        '/opt/google/chrome/chrome-sandbox',
        '/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/MacOS/ARDAgent',
        '/usr/bin/doas',
        '/usr/bin/crontab',
        '/usr/bin/fusermount',
        '/usr/bin/fusermount3',
        '/usr/bin/keybase-redirector',
        '/usr/bin/login',
        '/usr/bin/mount',
        '/usr/bin/op',
        '/opt/zoom/cef/chrome-sandbox',
        '/usr/bin/ssh-agent',
        '/usr/bin/su',
        '/usr/bin/sudo',
        '/usr/bin/top',
        '/usr/lib/electron22/chrome-sandbox',
        '/usr/lib/electron/chrome-sandbox',
        '/usr/lib/polkit-1/polkit-agent-helper-1',
        '/usr/lib/slack/chrome-sandbox',
        '/usr/lib/xf86-video-intel-backlight-helper',
        '/usr/lib/Xorg.wrap',
        '/usr/sbin/traceroute'
      )
      AND f.path NOT LIKE '/Users/%/homebrew/Cellar/socket_vmnet/%/bin/socket_vmnet'
      AND f.path NOT LIKE '/opt/homebrew/Cellar/dnsmasq/%/sbin/dnsmasq'
      AND f.path NOT LIKE '/opt/homebrew/Cellar/socket_vmnet/%/bin/socket_vmnet'
  tags: persistent, state, process, escalation
  team: ''
